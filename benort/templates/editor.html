<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Benort</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script>
    window.BENORT_COMPONENT_LIBRARY = {{ (component_library or {})|tojson }};
    window.BENORT_UI_THEME = {{ (ui_theme or {})|tojson }};
    window.BENORT_LLM_PROVIDERS = {{ (llm_providers or [])|tojson }};
    window.BENORT_LLM_DEFAULT = {{ (llm_default_state or {})|tojson }};
    window.BENORT_DEFAULT_WORKSPACE = {{ (default_workspace or none)|tojson }};
    window.BENORT_PORTABLE_ERROR = {{ (portable_workspace_error or "")|tojson }};
  </script>
  <style>
    /* CSS 基础讲解：每个规则都像 “选择器 { 属性: 值; }”，用分号隔开。变量写作 --name 在 :root 定义，引用时用 var(--name, 备选值) */
    /* 下面的内容主要通过自定义属性（变量）+ 选择器组合，统一控制颜色、间距与布局，便于前端小白逐步修改 */
    /* === UI tokens & skins === */
    /* :root 代表文档根，定义的 --变量 可以在任何地方用 var(--变量) 调用，方便集中调整主题 */
    :root {
      --editor-preview-weight: 7;
      --script-pane-weight: 3;
      --shell-bg: #f5f7fb;
      --shell-text: #0f172a;
      --surface-1: rgba(255, 255, 255, 0.9);
      --surface-2: rgba(255, 255, 255, 0.86);
      --surface-border: rgba(148, 163, 184, 0.18);
      --surface-shadow: 0 16px 36px rgba(15, 23, 42, 0.18);
      --accent: #2563eb;
      --accent-strong: #1d4ed8;
      --muted: #475569;
      --nav-surface: linear-gradient(180deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.96) 100%);
      --nav-border: rgba(148, 163, 184, 0.25);
      --nav-btn-font-size: 0.95rem;
      --nav-btn-padding-y: 6px;
      --nav-btn-padding-x: 14px;
      --nav-btn-radius: var(--bs-border-radius, 0.5rem);
      --app-font-size: 16px;
      --pane-inner-padding: 0.75rem;
      --preview-bg: var(--surface-2);
      --preview-border: var(--surface-border);
      --preview-muted: color-mix(in srgb, var(--shell-text) 60%, transparent);
      --preview-code-bg: color-mix(in srgb, var(--surface-2) 85%, #000 5%);
      --preview-table-bg: color-mix(in srgb, var(--surface-2) 92%, #000 4%);
      --preview-table-head: color-mix(in srgb, var(--surface-2) 80%, var(--accent) 10%);
      --preview-table-row: color-mix(in srgb, var(--surface-2) 86%, var(--accent) 6%);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 82%, var(--accent) 18%); /* 按钮底色带一点主题色，减少灰块感 */
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 82%, var(--accent-strong) 18%); /* 边框轻微染色以贴合皮肤色 */
      --btn-chrome-text: var(--shell-text); /* 文本色跟随整体文字 */
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 68%, var(--accent) 32%); /* 悬停时更明显的主题色 */
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 54%, var(--accent-strong) 46%); /* 按下时保持浓度但不突兀 */
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 68%, var(--accent-strong) 32%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 54%, var(--accent-strong) 46%);
      --btn-chrome-shadow: none; /* 去除阴影，保持平 */
    }
    /* Skin + mode tokens 用带 data-ui-skin 和 data-bs-theme 的属性选择器，按皮肤/明暗覆盖上面的变量值 */
    body[data-ui-skin="default"][data-bs-theme="light"],
    body:not([data-ui-skin])[data-bs-theme="light"] {
      --shell-bg: #f5f7fb;
      --shell-text: #0f172a;
      --surface-1: rgba(255, 255, 255, 0.9);
      --surface-2: rgba(255, 255, 255, 0.86);
      --surface-border: rgba(148, 163, 184, 0.18);
      --surface-shadow: 0 16px 36px rgba(15, 23, 42, 0.18);
      --nav-surface: linear-gradient(180deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.96) 100%);
      --nav-border: rgba(148, 163, 184, 0.25);
      --accent: #2563eb;
      --accent-strong: #1d4ed8;
      --preview-bg: var(--surface-2);
      --preview-border: var(--surface-border);
      --preview-code-bg: #f5f7fb;
      --preview-table-bg: rgba(244, 247, 255, 0.95);
      --preview-table-head: rgba(224, 231, 255, 0.92);
      --preview-table-row: rgba(234, 240, 255, 0.9);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 72%, var(--accent) 28%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 65%, var(--accent-strong) 35%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 54%, var(--accent) 46%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 42%, var(--accent-strong) 58%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 52%, var(--accent-strong) 48%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 40%, var(--accent-strong) 60%);
    }
    body[data-ui-skin="default"][data-bs-theme="dark"],
    body:not([data-ui-skin])[data-bs-theme="dark"] {
      --shell-bg: #0f172a;
      --shell-text: #e2e8f0;
      --surface-1: rgba(23, 32, 48, 0.9);
      --surface-2: rgba(17, 24, 39, 0.9);
      --surface-border: rgba(148, 163, 184, 0.28);
      --surface-shadow: 0 16px 40px rgba(4, 6, 20, 0.55);
      --nav-surface: linear-gradient(120deg, rgba(15, 23, 42, 0.95) 0%, rgba(17, 34, 64, 0.96) 55%, rgba(11, 25, 60, 0.98) 100%);
      --nav-border: rgba(96, 165, 250, 0.28);
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --preview-bg: rgba(18, 28, 48, 0.9);
      --preview-border: rgba(148, 163, 184, 0.32);
      --preview-code-bg: rgba(24, 36, 60, 0.92);
      --preview-table-bg: rgba(20, 30, 52, 0.92);
      --preview-table-head: rgba(28, 43, 73, 0.96);
      --preview-table-row: rgba(26, 40, 68, 0.9);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 68%, var(--accent) 32%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 60%, var(--accent-strong) 40%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 50%, var(--accent) 50%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 38%, var(--accent-strong) 62%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 48%, var(--accent-strong) 52%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 38%, var(--accent-strong) 62%);
    }
    body[data-ui-skin="pastel"][data-bs-theme="light"] {
      --shell-bg: #fff1f5;
      --shell-text: #3b0d25;
      --surface-1: rgba(255, 241, 245, 0.96);
      --surface-2: rgba(255, 250, 252, 0.94);
      --surface-border: rgba(244, 114, 182, 0.35);
      --surface-shadow: 0 18px 38px rgba(236, 72, 153, 0.22);
      --nav-surface: linear-gradient(120deg, #fff1f5, #ffe4f0);
      --nav-border: rgba(244, 114, 182, 0.38);
      --accent: #ec4899;
      --accent-strong: #db2777;
      --preview-bg: rgba(255, 245, 249, 0.96);
      --preview-border: rgba(244, 114, 182, 0.32);
      --preview-code-bg: rgba(255, 240, 248, 0.96);
      --preview-table-bg: rgba(255, 235, 247, 0.94);
      --preview-table-head: rgba(255, 225, 241, 0.94);
      --preview-table-row: rgba(255, 232, 244, 0.9);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 70%, var(--accent) 30%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 62%, var(--accent-strong) 38%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 52%, var(--accent) 48%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 40%, var(--accent-strong) 60%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 48%, var(--accent-strong) 52%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 40%, var(--accent-strong) 60%);
    }
    body[data-ui-skin="pastel"][data-bs-theme="dark"] {
      --shell-bg: #2b1021;
      --shell-text: #fde7f3;
      --surface-1: rgba(43, 16, 33, 0.92);
      --surface-2: rgba(52, 18, 40, 0.9);
      --surface-border: rgba(244, 114, 182, 0.42);
      --surface-shadow: 0 18px 44px rgba(190, 24, 93, 0.45);
      --nav-surface: linear-gradient(120deg, #3f0f2c, #2b1021);
      --nav-border: rgba(244, 114, 182, 0.45);
      --accent: #f472b6;
      --accent-strong: #e11d48;
      --preview-bg: rgba(44, 18, 34, 0.92);
      --preview-border: rgba(244, 114, 182, 0.38);
      --preview-code-bg: rgba(52, 22, 40, 0.94);
      --preview-table-bg: rgba(48, 20, 37, 0.92);
      --preview-table-head: rgba(68, 28, 50, 0.94);
      --preview-table-row: rgba(60, 24, 45, 0.92);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 66%, var(--accent) 34%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 58%, var(--accent-strong) 42%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 48%, var(--accent) 52%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 36%, var(--accent-strong) 64%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 46%, var(--accent-strong) 54%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 36%, var(--accent-strong) 64%);
    }
    body[data-ui-skin="paper"][data-bs-theme="light"] {
      --shell-bg: #f6f1e9;
      --shell-text: #2f2418;
      --surface-1: rgba(255, 255, 255, 0.9);
      --surface-2: rgba(250, 247, 240, 0.95);
      --surface-border: rgba(120, 98, 76, 0.25);
      --surface-shadow: 0 14px 28px rgba(101, 67, 33, 0.18);
      --nav-surface: linear-gradient(120deg, #fef3c7, #f5e6cc);
      --nav-border: rgba(217, 119, 6, 0.35);
      --accent: #d97706;
      --accent-strong: #b45309;
      --preview-bg: rgba(254, 250, 242, 0.96);
      --preview-border: rgba(217, 119, 6, 0.28);
      --preview-code-bg: rgba(248, 244, 236, 0.96);
      --preview-table-bg: rgba(250, 244, 233, 0.94);
      --preview-table-head: rgba(248, 231, 202, 0.92);
      --preview-table-row: rgba(248, 235, 214, 0.9);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 72%, var(--accent) 28%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 64%, var(--accent-strong) 36%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 54%, var(--accent) 46%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 42%, var(--accent-strong) 58%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 50%, var(--accent-strong) 50%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 40%, var(--accent-strong) 60%);
    }
    body[data-ui-skin="paper"][data-bs-theme="dark"] {
      --shell-bg: #2a2117;
      --shell-text: #f8ede0;
      --surface-1: rgba(42, 33, 23, 0.92);
      --surface-2: rgba(50, 40, 28, 0.9);
      --surface-border: rgba(248, 180, 107, 0.3);
      --surface-shadow: 0 16px 40px rgba(120, 73, 34, 0.45);
      --nav-surface: linear-gradient(120deg, #3c2f1f, #2a2117);
      --nav-border: rgba(234, 179, 8, 0.32);
      --accent: #fbbf24;
      --accent-strong: #d97706;
      --preview-bg: rgba(46, 36, 24, 0.92);
      --preview-border: rgba(234, 179, 8, 0.32);
      --preview-code-bg: rgba(52, 41, 28, 0.94);
      --preview-table-bg: rgba(48, 38, 26, 0.92);
      --preview-table-head: rgba(70, 54, 36, 0.94);
      --preview-table-row: rgba(60, 46, 30, 0.92);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 68%, var(--accent) 32%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 60%, var(--accent-strong) 40%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 50%, var(--accent) 50%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 38%, var(--accent-strong) 62%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 48%, var(--accent-strong) 52%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 38%, var(--accent-strong) 62%);
    }
    body[data-ui-skin="ocean"][data-bs-theme="light"] {
      --shell-bg: #e0f2fe;
      --shell-text: #06283a;
      --surface-1: rgba(224, 242, 254, 0.95);
      --surface-2: rgba(236, 254, 255, 0.94);
      --surface-border: rgba(14, 165, 233, 0.28);
      --surface-shadow: 0 18px 38px rgba(14, 165, 233, 0.22);
      --nav-surface: linear-gradient(120deg, #bfdbfe, #0ea5e9);
      --nav-border: rgba(14, 165, 233, 0.4);
      --accent: #0ea5e9;
      --accent-strong: #2563eb;
      --preview-bg: rgba(228, 245, 255, 0.95);
      --preview-border: rgba(14, 165, 233, 0.32);
      --preview-code-bg: rgba(216, 240, 255, 0.96);
      --preview-table-bg: rgba(214, 242, 255, 0.94);
      --preview-table-head: rgba(202, 232, 255, 0.92);
      --preview-table-row: rgba(208, 236, 255, 0.9);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 70%, var(--accent) 30%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 64%, var(--accent-strong) 36%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 52%, var(--accent) 48%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 40%, var(--accent-strong) 60%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 48%, var(--accent-strong) 52%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 38%, var(--accent-strong) 62%);
    }
    body[data-ui-skin="ocean"][data-bs-theme="dark"] {
      --shell-bg: #0f172a;
      --shell-text: #e2e8f0;
      --surface-1: rgba(15, 23, 42, 0.92);
      --surface-2: rgba(19, 32, 54, 0.92);
      --surface-border: rgba(94, 234, 212, 0.26);
      --surface-shadow: 0 18px 44px rgba(8, 47, 73, 0.5);
      --nav-surface: linear-gradient(120deg, #0ea5e9, #0f172a);
      --nav-border: rgba(34, 211, 238, 0.42);
      --accent: #22d3ee;
      --accent-strong: #0ea5e9;
      --preview-bg: rgba(20, 30, 52, 0.9);
      --preview-border: rgba(94, 234, 212, 0.28);
      --preview-code-bg: rgba(26, 38, 64, 0.92);
      --preview-table-bg: rgba(22, 34, 58, 0.92);
      --preview-table-head: rgba(28, 46, 78, 0.94);
      --preview-table-row: rgba(24, 40, 70, 0.92);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 68%, var(--accent) 32%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 60%, var(--accent-strong) 40%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 50%, var(--accent) 50%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 38%, var(--accent-strong) 62%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 48%, var(--accent-strong) 52%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 38%, var(--accent-strong) 62%);
    }
    body[data-ui-skin="forest"][data-bs-theme="light"] {
      --shell-bg: #e8fff6;
      --shell-text: #0f2d21;
      --surface-1: rgba(232, 255, 246, 0.96);
      --surface-2: rgba(222, 252, 241, 0.94);
      --surface-border: rgba(52, 211, 153, 0.32);
      --surface-shadow: 0 18px 38px rgba(34, 197, 94, 0.18);
      --nav-surface: linear-gradient(120deg, #bbf7d0, #059669);
      --nav-border: rgba(16, 185, 129, 0.35);
      --accent: #10b981;
      --accent-strong: #047857;
      --preview-bg: rgba(226, 250, 240, 0.95);
      --preview-border: rgba(52, 211, 153, 0.32);
      --preview-code-bg: rgba(216, 244, 234, 0.96);
      --preview-table-bg: rgba(210, 244, 230, 0.94);
      --preview-table-head: rgba(198, 238, 222, 0.92);
      --preview-table-row: rgba(204, 240, 226, 0.9);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 70%, var(--accent) 30%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 62%, var(--accent-strong) 38%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 52%, var(--accent) 48%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 40%, var(--accent-strong) 60%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 48%, var(--accent-strong) 52%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 40%, var(--accent-strong) 60%);
    }
    body[data-ui-skin="forest"][data-bs-theme="dark"] {
      --shell-bg: #0b1f1a;
      --shell-text: #d1fae5;
      --surface-1: rgba(12, 33, 27, 0.92);
      --surface-2: rgba(16, 43, 35, 0.9);
      --surface-border: rgba(52, 211, 153, 0.4);
      --surface-shadow: 0 18px 40px rgba(6, 95, 70, 0.48);
      --nav-surface: linear-gradient(120deg, #064e3b, #0b1f1a);
      --nav-border: rgba(52, 211, 153, 0.42);
      --accent: #34d399;
      --accent-strong: #10b981;
      --preview-bg: rgba(18, 44, 35, 0.92);
      --preview-border: rgba(52, 211, 153, 0.38);
      --preview-code-bg: rgba(22, 52, 41, 0.94);
      --preview-table-bg: rgba(20, 48, 38, 0.92);
      --preview-table-head: rgba(28, 64, 50, 0.94);
      --preview-table-row: rgba(24, 56, 44, 0.92);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 66%, var(--accent) 34%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 58%, var(--accent-strong) 42%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 48%, var(--accent) 52%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 36%, var(--accent-strong) 64%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 46%, var(--accent-strong) 54%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 36%, var(--accent-strong) 64%);
    }
    body[data-ui-skin="sunset"][data-bs-theme="light"] {
      --shell-bg: #fff7ed;
      --shell-text: #3b2008;
      --surface-1: rgba(255, 247, 237, 0.95);
      --surface-2: rgba(255, 239, 223, 0.94);
      --surface-border: rgba(251, 146, 60, 0.32);
      --surface-shadow: 0 18px 38px rgba(234, 88, 12, 0.2);
      --nav-surface: linear-gradient(120deg, #ffedd5, #fdba74);
      --nav-border: rgba(234, 88, 12, 0.35);
      --accent: #ea580c;
      --accent-strong: #c2410c;
      --preview-bg: rgba(255, 243, 229, 0.95);
      --preview-border: rgba(251, 146, 60, 0.32);
      --preview-code-bg: rgba(254, 236, 220, 0.96);
      --preview-table-bg: rgba(254, 229, 210, 0.94);
      --preview-table-head: rgba(252, 220, 194, 0.92);
      --preview-table-row: rgba(253, 225, 202, 0.9);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 70%, var(--accent) 30%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 62%, var(--accent-strong) 38%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 52%, var(--accent) 48%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 40%, var(--accent-strong) 60%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 48%, var(--accent-strong) 52%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 40%, var(--accent-strong) 60%);
    }
    body[data-ui-skin="sunset"][data-bs-theme="dark"] {
      --shell-bg: #2b1606;
      --shell-text: #ffe8d5;
      --surface-1: rgba(43, 22, 6, 0.92);
      --surface-2: rgba(52, 26, 6, 0.9);
      --surface-border: rgba(251, 146, 60, 0.38);
      --surface-shadow: 0 18px 44px rgba(185, 73, 12, 0.5);
      --nav-surface: linear-gradient(120deg, #431407, #2b1606);
      --nav-border: rgba(249, 115, 22, 0.4);
      --accent: #fb923c;
      --accent-strong: #ea580c;
      --preview-bg: rgba(46, 26, 10, 0.92);
      --preview-border: rgba(249, 115, 22, 0.38);
      --preview-code-bg: rgba(52, 30, 12, 0.94);
      --preview-table-bg: rgba(50, 28, 12, 0.92);
      --preview-table-head: rgba(64, 36, 16, 0.94);
      --preview-table-row: rgba(56, 32, 14, 0.92);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 66%, var(--accent) 34%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 58%, var(--accent-strong) 42%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 48%, var(--accent) 52%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 36%, var(--accent-strong) 64%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 46%, var(--accent-strong) 54%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 36%, var(--accent-strong) 64%);
    }
    body[data-ui-skin="slate"][data-bs-theme="light"] {
      --shell-bg: #e2e8f0;
      --shell-text: #0f172a;
      --surface-1: rgba(248, 250, 252, 0.95);
      --surface-2: rgba(241, 245, 249, 0.94);
      --surface-border: rgba(148, 163, 184, 0.28);
      --surface-shadow: 0 18px 38px rgba(51, 65, 85, 0.16);
      --nav-surface: linear-gradient(120deg, #cbd5e1, #475569);
      --nav-border: rgba(100, 116, 139, 0.35);
      --accent: #475569;
      --accent-strong: #1e293b;
      --preview-bg: rgba(245, 248, 252, 0.95);
      --preview-border: rgba(148, 163, 184, 0.28);
      --preview-code-bg: rgba(236, 242, 248, 0.96);
      --preview-table-bg: rgba(234, 240, 247, 0.94);
      --preview-table-head: rgba(220, 228, 240, 0.92);
      --preview-table-row: rgba(226, 232, 241, 0.9);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 72%, var(--accent) 28%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 64%, var(--accent-strong) 36%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 54%, var(--accent) 46%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 42%, var(--accent-strong) 58%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 50%, var(--accent-strong) 50%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 40%, var(--accent-strong) 60%);
    }
    body[data-ui-skin="slate"][data-bs-theme="dark"] {
      --shell-bg: #0f172a;
      --shell-text: #e2e8f0;
      --surface-1: rgba(15, 23, 42, 0.92);
      --surface-2: rgba(30, 41, 59, 0.9);
      --surface-border: rgba(148, 163, 184, 0.32);
      --surface-shadow: 0 18px 44px rgba(15, 23, 42, 0.5);
      --nav-surface: linear-gradient(120deg, #1e293b, #0f172a);
      --nav-border: rgba(148, 163, 184, 0.35);
      --accent: #818cf8;
      --accent-strong: #6366f1;
      --preview-bg: rgba(19, 27, 44, 0.92);
      --preview-border: rgba(148, 163, 184, 0.32);
      --preview-code-bg: rgba(24, 33, 52, 0.94);
      --preview-table-bg: rgba(22, 31, 50, 0.92);
      --preview-table-head: rgba(34, 45, 68, 0.94);
      --preview-table-row: rgba(28, 39, 60, 0.92);
      --btn-chrome-bg: color-mix(in srgb, var(--surface-2) 66%, var(--accent) 34%);
      --btn-chrome-border: color-mix(in srgb, var(--surface-border) 58%, var(--accent-strong) 42%);
      --btn-chrome-hover-bg: color-mix(in srgb, var(--surface-2) 48%, var(--accent) 52%);
      --btn-chrome-active-bg: color-mix(in srgb, var(--surface-2) 36%, var(--accent-strong) 64%);
      --btn-chrome-hover-border: color-mix(in srgb, var(--surface-border) 46%, var(--accent-strong) 54%);
      --btn-chrome-active-border: color-mix(in srgb, var(--surface-border) 36%, var(--accent-strong) 64%);
    }
    
    
    /* html, body 组合选择器让页面填满屏幕，并关闭默认 margin 以便自己控制 layout */
    html, body {
      margin: 0;
      height: 100vh;
      overflow: auto;
    }
    /* body 设置背景/文字颜色和 flex 布局，配合 CSS 变量保证主题一致。display:flex 用于垂直堆叠主内容。 */
    body {
      background: var(--shell-bg);
      color: var(--shell-text);
      min-height: 100vh;
      height: 100vh;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
      font-size: var(--app-font-size, 16px);
    }
    body.modal-open {
      overflow: hidden;
    }
    body.modal-open #app-shell {
      overflow: hidden;
    }
    /* .modal.show/.modal-dialog 等控制弹窗位置、滚动区，Bootstrap 的 class 通过这里细化样式 */
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-dialog {
      margin: 1.25rem auto;
      max-height: calc(100vh - 2rem);
    }
    /* 这里再强调 modal-content 用 surface 变量统一背景和边框，防止不一致 */
    .modal-content {
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 2rem);
      overflow: hidden;
      width: 100%;
    }
    /* modal-body 控制弹窗内部的背景色和文字，确保蹦出层统一 */
    .modal-body {
      min-height: 0;
      flex: 1 1 auto;
      overflow-x: hidden;
      overflow-y: auto;
    }
    /* #app-shell 是整个编辑器的主容器，这里用 flex 让中间内容扩大，transition 负责淡入效果 */
    #app-shell {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      height: 100%;
      transition: filter 0.3s ease, opacity 0.3s ease;
    }
    /* #main-layout 继续沿用 flex，gap/padding/overflow 控制主界面左右布局和滚动区域 */
    #main-layout {
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 0;
      min-height: 0;
      padding: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
    }
    /* #editor-preview-wrapper 用 flex 排列编辑和预览面板，并加 padding/box-shadow 做卡片效果 */
    #editor-preview-wrapper {
      display: flex;
      flex-direction: row;
      flex-wrap: nowrap;
      align-items: stretch;
      gap: 1rem;
      position: relative;
      width: 100%;
      min-height: 0;
      margin: 0 !important;
      padding: 1.1rem;
      border-radius: 1rem;
      background: var(--surface-1);
      box-shadow: var(--surface-shadow);
      height: 100%;
      border: 1px solid var(--surface-border);
      box-sizing: border-box;
      flex: var(--editor-preview-weight) 1 0;
    }
    .editor-pane,
    .preview-pane {
      flex: 1 1 0;
      min-height: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    /* markdown-sync-toggle-wrapper 通过绝对定位 + translate 让按钮居中响应用户操作 */
    .markdown-sync-toggle-wrapper {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      z-index: 5;
      width: 0;
      height: 0;
    }
    /* markdown-sync-toggle 控制按钮外观/悬停, color 表示文字, padding 让触控区域更大 */
    .markdown-sync-toggle {
      border: none;
      background: transparent;
      color: var(--accent, #6366f1);
      font-size: 0.85rem;
      padding: 0.2rem 0.35rem;
      border-radius: 999px;
      opacity: 0.45;
      cursor: pointer;
      text-decoration: none;
      letter-spacing: 0.08em;
      font-weight: 500;
      pointer-events: auto;
      transition: color 0.2s ease, opacity 0.2s ease, text-shadow 0.3s ease, transform 0.2s ease;
    }
    .markdown-sync-toggle:hover,
    .markdown-sync-toggle:focus {
      opacity: 0.85;
      color: var(--accent-strong, #4f46e5);
      transform: scale(1.05);
    }
    .markdown-sync-toggle:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.25);
    }
    .markdown-sync-toggle.active {
      color: var(--accent-strong, #2563eb);
      opacity: 0.95;
      text-shadow: 0 0 6px rgba(37, 99, 235, 0.4);
    }
    body.theme-dark .markdown-sync-toggle {
      color: #93c5fd;
    }
    body.theme-dark .markdown-sync-toggle:hover,
    body.theme-dark .markdown-sync-toggle:focus {
      color: #bfdbfe;
    }
    body.theme-dark .markdown-sync-toggle.active {
      color: #38bdf8;
      text-shadow: 0 0 8px rgba(56, 189, 248, 0.48);
    }
    /* .nav-flex-wrap 把导航菜单做成 flex 行列，并用 gap 控制按钮间距 */
    .nav-flex-wrap {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.5rem;
      padding: 0;
    }
    .navbar .container-fluid {
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 0.5rem;
    }
    .nav-flex-wrap > li {
      list-style: none;
      margin: 0;
    }
    .nav-flex-wrap .btn {
      white-space: nowrap;
    }
    /* .navbar 使用 position:sticky 固定在顶部，backdrop-filter/box-shadow 增加高亮通透感 */
    .navbar {
      margin-bottom: -1px; /* eliminate visible gap with content */
      flex-shrink: 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--nav-border, rgba(148, 163, 184, 0.25));
      background: var(--nav-surface, #f8f9fa);
      border-radius: 0 0 1rem 1rem;
    }
    .navbar .btn {
      background: var(--btn-chrome-bg) !important;
      color: var(--btn-chrome-text) !important;
      border-color: var(--btn-chrome-border) !important;
      box-shadow: none !important;
    }
    .navbar .btn:hover,
    .navbar .btn:focus,
    .navbar .btn:focus-visible {
      background: var(--btn-chrome-hover-bg) !important;
      color: var(--btn-chrome-text) !important;
      border-color: var(--btn-chrome-hover-border, var(--btn-chrome-border)) !important;
    }
    nav.navbar + #main-layout {
      margin-top: 0;
    }
    body.theme-dark #editor-preview-wrapper {
      background: var(--surface-1);
      box-shadow: var(--surface-shadow);
    }
    /* .actionable-card 处理可点击卡片的边框/圆角/hover 反馈 */
    .actionable-card {
      position: relative;
      border-radius: 0.75rem;
      transition: background-color 0.18s ease, box-shadow 0.18s ease;
    }
    .actionable-card:hover {
      background-color: color-mix(in srgb, var(--accent) 12%, transparent);
    }
    .actionable-card--active {
      background-color: color-mix(in srgb, var(--accent) 18%, transparent);
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent) 32%, transparent);
    }
    body.theme-dark .actionable-card:hover {
      background-color: color-mix(in srgb, var(--accent) 18%, transparent);
    }
    body.theme-dark .actionable-card--active {
      background-color: color-mix(in srgb, var(--accent) 22%, transparent);
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-strong) 38%, transparent);
    }
    /* .action-bubble 控制提示气泡的弹出动作，opacity/transform 搭配 transition 实现淡入动画 */
    .action-bubble {
      position: absolute;
      z-index: 2050;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      padding: 0.35rem 0.5rem;
      border-radius: 999px;
      background: var(--surface-1);
      box-shadow: var(--surface-shadow);
      border: 1px solid color-mix(in srgb, var(--accent) 18%, var(--surface-border));
      color: var(--shell-text);
      opacity: 0;
      transform: translateY(-4px) scale(0.96);
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
    }
    body.theme-dark .action-bubble {
      background: var(--surface-2);
      border-color: color-mix(in srgb, var(--accent-strong) 24%, var(--surface-border));
      box-shadow: var(--surface-shadow);
    }
    .action-bubble--visible {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }
    .action-bubble--align-left {
      transform-origin: 100% 50%;
    }
    .action-bubble__btn {
      font-size: 0.82rem;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      white-space: nowrap;
    }
    .action-bubble__btn + .action-bubble__btn {
      margin-left: 0;
    }
    @media (max-width: 640px) {
      .action-bubble {
        flex-direction: column;
        align-items: stretch;
        border-radius: 0.9rem;
        gap: 0.35rem;
        padding: 0.45rem 0.6rem;
      }
      .action-bubble__btn {
        width: 100%;
        text-align: center;
      }
    }
    /* .learning-prompt-card 是提示卡片，border/radius/background/transition 让它变得软萌 */
    .learning-prompt-card {
      position: relative;
      padding: 0.95rem 1.1rem;
      border: 1px solid color-mix(in srgb, var(--accent) 24%, var(--surface-border));
      border-radius: 0.85rem;
      background: color-mix(in srgb, var(--surface-1) 88%, var(--accent) 12%);
      min-width: min(100%, 240px);
      max-width: 100%;
      cursor: pointer;
      transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
    }
    .learning-prompt-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px color-mix(in srgb, var(--accent) 20%, rgba(15, 23, 42, 0.12));
      border-color: color-mix(in srgb, var(--accent-strong) 32%, var(--surface-border));
    }
    .learning-prompt-card--stacked {
      width: 100%;
    }
    .learning-prompt-card__title {
      font-weight: 600;
      color: var(--shell-text);
      margin-bottom: 0.25rem;
    }
    .learning-prompt-card__description {
      color: color-mix(in srgb, var(--shell-text) 78%, transparent);
      font-size: 0.85rem;
      margin-bottom: 0.35rem;
    }
    .learning-prompt-card__meta {
      color: color-mix(in srgb, var(--shell-text) 65%, transparent);
      font-size: 0.75rem;
      letter-spacing: 0.01em;
    }
    body.theme-dark .learning-prompt-card {
      background: color-mix(in srgb, var(--surface-1) 82%, var(--accent) 18%);
      border-color: color-mix(in srgb, var(--accent-strong) 36%, var(--surface-border));
    }
    body.theme-dark .learning-prompt-card__title {
      color: var(--shell-text);
    }
    body.theme-dark .learning-prompt-card__description,
    body.theme-dark .learning-prompt-card__meta {
      color: color-mix(in srgb, var(--shell-text) 82%, transparent);
    }
    /* .ai-learn-temp-card 组合渐变背景与阴影，常用于展示学习提示 */
    .ai-learn-temp-card {
      border: 1px solid color-mix(in srgb, var(--accent-strong) 32%, var(--surface-border));
      border-radius: 1rem;
      background: linear-gradient(135deg, color-mix(in srgb, var(--surface-1) 86%, var(--accent) 14%), color-mix(in srgb, var(--surface-1) 80%, var(--accent-strong) 20%));
      box-shadow: 0 16px 38px color-mix(in srgb, var(--accent) 18%, rgba(15, 23, 42, 0.18));
    }
    body.theme-dark .ai-learn-temp-card {
      border-color: color-mix(in srgb, var(--accent-strong) 42%, var(--surface-border));
      background: radial-gradient(circle at 18% 12%, color-mix(in srgb, var(--surface-2) 70%, var(--accent) 30%), color-mix(in srgb, var(--surface-2) 62%, var(--accent-strong) 38%));
      box-shadow: 0 18px 44px color-mix(in srgb, var(--accent) 22%, rgba(8, 47, 73, 0.6));
      color: #e2e8f0;
    }
    .ai-learn-temp-card h6 {
      margin-bottom: 0.2rem;
    }
    .ai-learn-temp-card small {
      color: #6b7280;
    }
    body.theme-dark .ai-learn-temp-card small {
      color: #cbd5e1;
    }
    /* #ai-learn-temp-prompt 控制文本区的最小高度与字体，使用 monospace 字体方便复制粘贴 */
    #ai-learn-temp-prompt {
      min-height: 120px;
      font-family: var(--bs-font-monospace);
      background: color-mix(in srgb, var(--surface-2) 92%, var(--accent) 8%);
      border-color: color-mix(in srgb, var(--surface-border) 68%, var(--accent-strong) 32%);
      color: var(--shell-text);
    }
    body.theme-dark #ai-learn-temp-prompt {
      background: color-mix(in srgb, var(--surface-2) 86%, var(--accent) 14%);
      border-color: color-mix(in srgb, var(--surface-border) 60%, var(--accent-strong) 40%);
      color: var(--shell-text);
    }
    .ai-learn-temp-actions .btn {
      min-width: 112px;
    }
    /* .ai-assistant-answer 让 AI 回答区域有边框、圆角、monospace 字体，有利于看代码/公式 */
    .ai-assistant-answer {
      min-height: 180px;
      border-radius: 0.75rem;
      border: 1px solid rgba(148, 163, 184, 0.55);
      padding: 0.75rem 0.9rem;
      background: rgba(255, 255, 255, 0.92);
      font-family: var(--bs-font-monospace);
      line-height: 1.55;
      width: 100%;
      resize: vertical;
    }
    body.theme-dark .ai-assistant-answer {
      background: rgba(17, 24, 39, 0.9);
      color: #e2e8f0;
      border-color: rgba(148, 163, 184, 0.35);
    }
    .ai-assistant-context-toggle {
      font-size: 0.9rem;
    }
    .ai-assistant-contexts-collapsed {
      border-top: 1px dashed rgba(148, 163, 184, 0.5);
      padding-top: 0.35rem;
      margin-top: 0.25rem;
    }
    body.theme-dark .ai-assistant-contexts-collapsed {
      border-color: rgba(148, 163, 184, 0.3);
    }
    /* .ai-assistant-context 设定上下文区域的内边距/边框/背景，保证可读性 */
    .ai-assistant-context {
      border: 1px solid rgba(148, 163, 184, 0.35);
      border-radius: 0.75rem;
      padding: 0.65rem 0.75rem;
      margin-bottom: 0.5rem;
      background: rgba(241, 245, 249, 0.85);
    }
    body.theme-dark .ai-assistant-context {
      background: rgba(30, 41, 59, 0.65);
      border-color: rgba(148, 163, 184, 0.45);
    }
    .ai-assistant-context__title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    .ai-assistant-context__meta {
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 0.35rem;
    }
    body.theme-dark .ai-assistant-context__meta {
      color: #cbd5e1;
    }
    .ai-assistant-status {
      font-weight: 600;
      letter-spacing: 0.01em;
      color: color-mix(in srgb, var(--shell-text) 74%, transparent);
    }
    .ai-assistant-status--info,
    .ai-assistant-status--success {
      color: color-mix(in srgb, var(--accent) 78%, var(--shell-text) 22%);
    }
    .ai-assistant-status--warning {
      color: color-mix(in srgb, var(--accent-strong) 76%, var(--shell-text) 24%);
    }
    .ai-assistant-status--danger {
      color: color-mix(in srgb, #ef4444 78%, var(--shell-text) 22%);
    }
    .ai-assistant-status--secondary {
      color: color-mix(in srgb, var(--accent-strong) 62%, var(--shell-text) 38%);
    }
    .ai-assistant-status--muted {
      color: color-mix(in srgb, var(--shell-text) 70%, transparent);
    }
    #ai-assistant-context-count,
    .ai-assistant-context-count {
      background: color-mix(in srgb, var(--accent) 20%, var(--surface-1));
      color: color-mix(in srgb, var(--accent-strong) 75%, var(--shell-text));
      border: 1px solid color-mix(in srgb, var(--accent-strong) 40%, var(--surface-border));
      box-shadow: 0 8px 20px color-mix(in srgb, var(--accent) 16%, transparent);
    }
    body.theme-dark #ai-assistant-context-count,
    body.theme-dark .ai-assistant-context-count {
      background: color-mix(in srgb, var(--accent) 26%, var(--surface-2));
      color: color-mix(in srgb, var(--shell-text) 85%, var(--accent-strong));
      border-color: color-mix(in srgb, var(--accent-strong) 48%, var(--surface-border));
      box-shadow: 0 10px 24px color-mix(in srgb, var(--accent) 20%, transparent);
    }
    /* 下面这个组合选择器作用于编辑器/讲稿/预览容器，统一设置边框、背景和滚动行为 */
    #editor-container,
    #pdf-container,
    /* #markdown-preview 继续强制竖直排列内部内容，方便预览里的多个区域 */
    #markdown-preview {
      flex: 1 1 auto;
      min-height: 0;
      height: 100%;
      border: 1px solid var(--preview-border);
      border-radius: 0.75rem;
      background: var(--preview-bg);
      padding: var(--pane-inner-padding);
      overflow: auto;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      display: flex;
      flex-direction: column;
    }
    #markdown-preview {
      display: flex;
      flex-direction: column;
    }
    /* .CodeMirror 系列是 CodeMirror 编辑器本身的类，调整背景/文字/边线让其融入主题 */
    .CodeMirror,
    .CodeMirror-scroll,
    /* gutter 右侧 line-number 边框 */
    .CodeMirror-gutters {
      background: var(--preview-bg) !important;
      color: var(--shell-text);
    }
    .CodeMirror-gutters {
      border-right: 1px solid var(--preview-border);
    }
    /* .modal-header/footer 控制弹窗头部/脚部的背景和边框 */
    .modal-header,
    .modal-footer {
      border-color: var(--preview-border);
      background: var(--surface-1);
      color: var(--shell-text);
    }
    /* 这个组合选择器统一控制各种 modal 的背景/颜色/边框，避免不同弹窗样式漂移 */
    .workspace-modal .modal-content,
    #remoteWorkspaceModal .modal-content,
    #resourcesModal .modal-content,
    #attachmentsModal .modal-content,
    #tabsModal .modal-content,
    #componentModal .modal-content,
    #templateModal .modal-content,
    #llmModal .modal-content,
    #llmConfigModal .modal-content,
    #aiScriptModal .modal-content,
    #exportModal .modal-content,
    #bibModal .modal-content,
    #attachmentsModal .modal-content,
    #markdownImageModal .modal-content,
    /* 同时设定表格弹窗的圆角/边框/背景 */
    #markdownTableModal .modal-content {
      background: var(--surface-1);
      color: var(--shell-text);
      border: 1px solid var(--surface-border);
    }
    /* 模型配置弹窗的折叠区域与内容底色（随主题） */
    #llmModal .accordion-item {
      background: color-mix(in srgb, var(--surface-1) 92%, var(--accent) 8%);
      border: 1px solid var(--surface-border);
      border-radius: 0.75rem;
      overflow: hidden;
    }
    #llmModal .accordion-button {
      background: color-mix(in srgb, var(--surface-1) 90%, var(--accent) 10%);
      color: var(--shell-text);
      border-bottom: 1px solid var(--surface-border);
      box-shadow: inset 0 -1px 0 color-mix(in srgb, var(--accent) 10%, var(--surface-border));
    }
    #llmModal .accordion-body {
      background: color-mix(in srgb, var(--surface-2) 88%, var(--accent) 12%);
      border-top: 1px solid color-mix(in srgb, var(--surface-border) 78%, var(--accent) 22%);
      box-shadow: inset 0 1px 0 color-mix(in srgb, var(--accent) 12%, transparent);
      color: var(--shell-text);
    }
    /* .workspace-form 控制工作区相关表单的统一背景与边框 */
    .workspace-form {
      background: var(--preview-bg);
      border-color: var(--preview-border);
    }
    /* #tex-form / #pages-list 通过 flex 让内部内容响应式填满高度 */
    #tex-form {
      flex: 1 1 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }
    /* #pages-list 是包含多个页面的容器，用 flex column 垂直堆叠 */
    #pages-list {
      flex: 1 1 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }
    #pages-list > * {
      flex: 1 1 auto;
      min-height: 0;
      display: flex;
      flex-direction: column;
      margin: 0 !important;
    }
    /* .page-script-container 用于讲稿区域，border/shadow/background 加强层级感 */
    .page-script-container {
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow: hidden;
      padding: var(--pane-inner-padding);
      border-radius: 0.75rem;
      background: var(--surface-2);
      box-shadow: var(--surface-shadow);
      border: 1px solid var(--surface-border);
      height: 100%;
      flex: var(--script-pane-weight) 1 0;
    }
    body.theme-dark .page-script-container {
      background: var(--surface-2);
      box-shadow: var(--surface-shadow);
      border-color: var(--surface-border);
    }
    /* #page-script 是讲稿 textarea，为了能滚动保留高度设置 overflow */
    #page-script {
      flex: 1 1 auto;
      min-height: 0;
      height: 100%;
      overflow: auto;
      resize: none;
    }
    /* .markdown-sync-glow 通过 box-shadow 实现同步提醒的发光效果 */
    .markdown-sync-glow {
      border-color: color-mix(in srgb, var(--accent, #2563eb) 70%, transparent) !important;
      box-shadow:
        0 0 16px color-mix(in srgb, var(--accent, #2563eb) 26%, transparent),
        0 0 6px color-mix(in srgb, var(--accent-strong, var(--accent, #2563eb)) 36%, transparent);
    }
    /* body.theme-dark 结合 class 控制深色模式时的背景/颜色切换 */
    body.theme-dark {
      background: var(--shell-bg);
      color: var(--shell-text);
    }
    /* 深色模式下 nav 也需要单独调整，避免背景变黑看不清 */
    body.theme-dark .navbar {
      background: var(--nav-surface);
      border-bottom: 1px solid var(--nav-border, rgba(96, 165, 250, 0.25));
      box-shadow: 0 10px 28px rgba(8, 47, 73, 0.35);
    }
    .modal-content {
      background: var(--surface-1);
      color: var(--shell-text);
      border: 1px solid var(--surface-border);
    }
    .modal-body {
      background: var(--surface-1);
      color: var(--shell-text);
    }
    /* modal-backdrop 是背景遮罩，透明度让弹窗浮在上层 */
    .modal-backdrop.show {
      background: rgba(15, 23, 42, 0.35);
    }
    /* 表单控件（输入框/下拉）使用变量固定背景、边框和文字，让它们跟随皮肤/明暗 */
    body.theme-dark .form-control,
    body.theme-dark .form-select,
    body.theme-dark .input-group-text,
    body[data-bs-theme="light"] .form-control,
    body[data-bs-theme="light"] .form-select,
    body[data-bs-theme="light"] .input-group-text {
      background-color: var(--surface-2); /* 输入类控件底色（随明暗/皮肤变化） */
      border-color: var(--surface-border); /* 输入类边框色 */
      color: var(--shell-text); /* 输入类文字色 */
    }
    /* ::file-selector-button 是 input[type=file] 的按钮，用来统一按钮样式 */
    .form-control::file-selector-button {
      background: var(--btn-chrome-bg); /* 文件按钮与输入框同底色 */
      color: var(--btn-chrome-text);
      border: 1px solid var(--btn-chrome-border); /* 文件选择按钮同输入框 */
      border-inline-end: none;
      border-radius: calc(var(--bs-border-radius, 0.5rem) - 1px) 0 0 calc(var(--bs-border-radius, 0.5rem) - 1px);
      transition: background-color 0.14s ease, border-color 0.14s ease, color 0.14s ease;
    }
    /* :hover/:focus-visible 让文件按钮在交互时也能看出变化 */
    .form-control::file-selector-button:hover,
    .form-control::file-selector-button:focus-visible {
      background: var(--btn-chrome-hover-bg);
      color: var(--btn-chrome-text);
      border-color: var(--btn-chrome-hover-border, color-mix(in srgb, var(--surface-border) 92%, var(--accent-strong) 8%));
    }
    /* .list-group-item 是 Bootstrap 列表项，设置背景/文字/边框跟整体一致 */
    .list-group-item {
      background-color: var(--surface-2);
      color: var(--shell-text);
      border-color: var(--surface-border);
    }
    .list-group-item.active,
    .list-group-item.active:focus,
    .list-group-item.active:hover {
      background: color-mix(in srgb, var(--surface-2) 55%, var(--accent) 45%);
      border-color: color-mix(in srgb, var(--surface-border) 55%, var(--accent-strong) 45%);
      color: color-mix(in srgb, var(--shell-text) 88%, var(--accent-strong));
      box-shadow: inset 0 1px 0 color-mix(in srgb, var(--accent) 22%, transparent);
    }
    /* hover/focus 状态通过 color-mix 调整背景，使列表项在互动时有高亮 */
    .list-group-item-action:hover,
    .list-group-item-action:focus {
      background-color: color-mix(in srgb, var(--surface-2) 80%, var(--accent) 20%);
    }
    /* focus 状态加边框/阴影，告诉用户当前输入的控件 */
    .form-control:focus,
    .form-select:focus,
    .form-check-input:focus {
      border-color: color-mix(in srgb, var(--accent-strong, #2563eb) 70%, transparent);
      box-shadow: 0 0 0 0.2rem color-mix(in srgb, var(--accent, #2563eb) 30%, transparent);
    }
    .form-select option:checked,
    .form-select option:hover {
      background-color: color-mix(in srgb, var(--accent) 24%, var(--surface-1)) !important;
      color: var(--shell-text);
    }
    .form-check-input {
      background-color: color-mix(in srgb, var(--surface-2) 88%, var(--accent) 12%);
      border-color: var(--surface-border);
    }
    /* 选中状态的复选框/单选按钮直接用 accent 颜色填充 */
    .form-check-input:checked {
      background-color: var(--accent, #2563eb);
      border-color: var(--accent-strong, #1d4ed8);
    }
    /* 手风琴组件（accordion）展开时改变背景/颜色，保持边框 */
    .accordion-button:not(.collapsed) {
      color: var(--shell-text);
      background: color-mix(in srgb, var(--accent) 14%, var(--surface-1));
      box-shadow: inset 0 -1px 0 var(--surface-border);
    }
    /* focus 时加 glow，帮助键盘用户定位 */
    .accordion-button:focus {
      border-color: color-mix(in srgb, var(--accent-strong) 60%, var(--surface-border));
      box-shadow: 0 0 0 0.15rem color-mix(in srgb, var(--accent) 28%, transparent);
    }
    /* .surface-card 是通用卡片，border/shadow/rounded 提升层次感 */
    .surface-card {
      background: var(--surface-1);
      border: 1px solid var(--surface-border);
      border-radius: 0.75rem;
      color: var(--shell-text);
      box-shadow: var(--surface-shadow);
    }
    body.theme-dark .surface-card {
      background: var(--surface-1);
      border-color: var(--surface-border);
    }
    /* .llm-provider-label 是小字标签，通过 letter-spacing/text-transform 提示是辅助信息 */
    .llm-provider-label {
      font-size: 0.78rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--accent);
    }
    body.theme-dark .llm-provider-label {
      color: var(--accent);
    }
    /* provider chip 使用 inline-flex 保持内容居中，border-radius=999px 变成胶囊 */
    .llm-provider-chip {
      display: inline-flex;
      align-items: center;
      padding: 0.15rem 0.6rem;
      border-radius: 999px;
      border: 1px solid color-mix(in srgb, var(--accent) 24%, var(--surface-border));
      background: color-mix(in srgb, var(--surface-1) 90%, transparent);
      font-size: 0.78rem;
      color: var(--shell-text);
    }
    body.theme-dark .llm-provider-chip {
      background: color-mix(in srgb, var(--surface-2) 90%, transparent);
      border-color: color-mix(in srgb, var(--accent-strong) 32%, var(--surface-border));
      color: var(--shell-text);
    }
    /* 通用主题色标签（资源/附件/状态） */
    .tag-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.18rem 0.6rem;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.82rem;
      background: color-mix(in srgb, var(--surface-2) 78%, var(--accent) 22%);
      border: 1px solid color-mix(in srgb, var(--surface-border) 70%, var(--accent-strong) 30%);
      color: color-mix(in srgb, var(--accent-strong) 78%, var(--shell-text));
      box-shadow: 0 8px 18px color-mix(in srgb, var(--accent) 18%, transparent);
    }
    body.theme-dark .tag-chip {
      background: color-mix(in srgb, var(--surface-2) 72%, var(--accent) 28%);
      border-color: color-mix(in srgb, var(--surface-border) 62%, var(--accent-strong) 38%);
      color: color-mix(in srgb, var(--shell-text) 86%, var(--accent-strong));
      box-shadow: 0 10px 22px color-mix(in srgb, var(--accent) 22%, transparent);
    }
    .tag-chip--muted {
      background: color-mix(in srgb, var(--surface-2) 88%, var(--accent) 12%);
      border-color: color-mix(in srgb, var(--surface-border) 80%, var(--accent) 20%);
      color: color-mix(in srgb, var(--shell-text) 82%, var(--accent));
    }
    .tag-chip--warning {
      background: color-mix(in srgb, var(--surface-2) 70%, var(--accent-strong) 30%);
      border-color: color-mix(in srgb, var(--surface-border) 58%, var(--accent-strong) 42%);
      color: color-mix(in srgb, var(--shell-text) 82%, var(--accent-strong));
    }
    .tag-chip--info {
      background: color-mix(in srgb, var(--surface-2) 74%, var(--accent) 26%);
      border-color: color-mix(in srgb, var(--surface-border) 62%, var(--accent-strong) 38%);
      color: color-mix(in srgb, var(--shell-text) 84%, var(--accent-strong));
    }
    /* badge 状态色也用主题混色，覆盖模型配置等场景 */
    .llm-modal-provider-status.badge,
    #llm-modal-api-status {
      background: color-mix(in srgb, var(--accent) 18%, var(--surface-1)) !important;
      border: 1px solid color-mix(in srgb, var(--accent-strong) 36%, var(--surface-border)) !important;
      color: color-mix(in srgb, var(--accent-strong) 78%, var(--shell-text)) !important;
      box-shadow: 0 8px 18px color-mix(in srgb, var(--accent) 16%, transparent);
    }
    body.theme-dark .llm-modal-provider-status.badge,
    body.theme-dark #llm-modal-api-status {
      background: color-mix(in srgb, var(--surface-2) 72%, var(--accent) 28%) !important;
      border-color: color-mix(in srgb, var(--surface-border) 62%, var(--accent-strong) 38%) !important;
      color: color-mix(in srgb, var(--shell-text) 86%, var(--accent-strong)) !important;
    }
    /* 这里定义状态 Badge 的字体粗细与字间距 */
    .llm-modal-provider-status.badge {
      font-weight: 600;
      letter-spacing: 0.04em;
    }
    body.theme-dark .llm-modal-provider-status.badge.bg-warning {
      color: #111827 !important;
    }
    /* .oss-diff-scroll 满足 diff 区域高滚动条需求 */
    .oss-diff-scroll {
      max-height: 220px;
      overflow: auto;
    }
    /* resource list 的项用 flex horizontal layout，wrap 以防按钮溢出 */
    .resource-list .resource-item {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      gap: 0.75rem;
    }
    /* resource-name 设置文本换行与最小宽度，避免长名称溢出 */
    .resource-list .resource-name {
      flex: 1 1 240px;
      min-width: 0;
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    /* 继承上面那条，链接不要额外截断 */
    .resource-list .resource-name a {
      word-break: inherit;
      overflow-wrap: inherit;
    }
    /* actions 区域靠右排列，margin-left:auto 保证按钮贴边 */
    .resource-list .resource-actions {
      flex: 0 0 auto;
      margin-left: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    /* 这里清除 Bootstrap 给按钮的 margin-right，保持 layout 紧凑 */
    .resource-list .resource-actions .btn {
      margin-right: 0;
    }
    /* 预览新名称也允许换行，避免长内容撑坏布局 */
    #resource-rename-preview {
      word-break: break-word;
      overflow-wrap: anywhere;
    }
    /* js-nav-btn 控制导航栏按钮的 padding/line-height，保持按钮一致大小 */
    .js-nav-btn {
      min-height: 34px;
      padding: var(--nav-btn-padding-y) var(--nav-btn-padding-x);
      border-radius: var(--nav-btn-radius, 999px);
      font-weight: 600;
      font-size: var(--nav-btn-font-size);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1.25;
      transition: background-color 0.18s ease, color 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease;
    }
    /* 移动端的翻页按钮组用 gap 控制间距 */
    .mobile-page-control-group {
      gap: 0.5rem;
    }
    .mobile-page-control-group .mobile-page-btn {
      margin-right: 0;
    }
    /* dropdown-menu 用 surface 变量设置背景/边框，box-shadow 提升层次 */
    .dropdown-menu {
      background: var(--surface-1);
      border: 1px solid var(--surface-border);
      box-shadow: 0 12px 26px rgba(15, 23, 42, 0.2);
    }
    /* 让下拉项继承主题文字颜色 */
    .dropdown-item,
    .dropdown-item-text {
      color: var(--shell-text);
    }
    /* hover/focus/active 状态改变背景，便于用户知道当前选项 */
    .dropdown-item:hover,
    .dropdown-item:focus,
    .dropdown-item.active {
      background: color-mix(in srgb, var(--accent) 18%, transparent);
      color: var(--shell-text);
    }
    /* 统一按钮与输入框：重写 Bootstrap 变量，让所有按钮用 surface 颜色，不要额外渐变 */
    .btn {
      --bs-btn-color: var(--btn-chrome-text);
      --bs-btn-bg: var(--btn-chrome-bg);
      --bs-btn-border-color: var(--btn-chrome-border);
      --bs-btn-hover-bg: var(--btn-chrome-hover-bg);
      --bs-btn-hover-border-color: var(--btn-chrome-hover-border, var(--btn-chrome-border));
      --bs-btn-active-bg: var(--btn-chrome-active-bg);
      --bs-btn-active-border-color: var(--btn-chrome-active-border, var(--btn-chrome-border));
      --bs-btn-disabled-bg: var(--btn-chrome-bg);
      --bs-btn-disabled-border-color: var(--btn-chrome-border);
      --bs-btn-disabled-color: color-mix(in srgb, var(--btn-chrome-text) 70%, transparent);
      background: var(--btn-chrome-bg) !important; /* 底色 = surface-2（随明暗/皮肤变化） */
      background-color: var(--btn-chrome-bg) !important;
      background-image: none !important; /* 去掉 Bootstrap 渐变 */
      color: var(--btn-chrome-text) !important; /* 文本与主文字一致 */
      border: 1px solid var(--btn-chrome-border) !important; /* 边框 = surface-border */
      box-shadow: none !important; /* 不要阴影，避免突出 */
      transition: background-color 0.18s ease, border-color 0.18s ease, color 0.18s ease, opacity 0.18s ease;
      border-radius: var(--bs-border-radius, 0.5rem); /* 圆角与输入框一致 */
    }
    /* hover/focus 时继续使用变量并保持高亮边框，避免 Bootstrap 默认阴影 */
    .btn:hover,
    .btn:focus,
    /* focus-visible 是键盘导航显式轮廓，这里用 glow 替代 outline */
    .btn:focus-visible {
      background: var(--btn-chrome-hover-bg) !important;
      background-color: var(--btn-chrome-hover-bg) !important;
      border-color: var(--btn-chrome-hover-border, var(--btn-chrome-border)) !important; /* 悬停边框轻微染色 */
      color: var(--btn-chrome-text) !important;
    }
    .btn:focus-visible {
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent, #2563eb) 26%, transparent) !important;
      outline: none;
    }
    /* 需要被点击或激活的按钮也用 active 背景，保持视觉一致 */
    .btn:active,
    .btn.active,
    .btn.show,
    .btn-check:checked + .btn,
    .btn-check:active + .btn {
      background: var(--btn-chrome-active-bg) !important;
      background-color: var(--btn-chrome-active-bg) !important;
      border-color: var(--btn-chrome-active-border, var(--btn-chrome-border)) !important;
      color: var(--btn-chrome-text) !important;
    }
    /* 禁用状态降低透明度和阴影 */
    .btn:disabled,
    .btn.disabled {
      opacity: 0.65;
      box-shadow: none;
    }
    /* 所有语义按钮（primary/outline 等）都继承上面的统一 chrome 样式 */
    .btn-primary,
    .btn-secondary,
    .btn-success,
    .btn-danger,
    .btn-warning,
    .btn-info,
    .btn-light,
    .btn-dark,
    .btn-outline-primary,
    .btn-outline-secondary,
    .btn-outline-success,
    .btn-outline-danger,
    .btn-outline-warning,
    .btn-outline-info,
    .btn-outline-light,
    .btn-outline-dark,
    .btn-theme {
      background: var(--btn-chrome-bg) !important;
      background-color: var(--btn-chrome-bg) !important;
      color: var(--btn-chrome-text) !important;
      border-color: var(--btn-chrome-border) !important;
      box-shadow: none !important;
    }
    /* 深色模式的 CodeMirror 再单独调背景与光标 */ 
    body.theme-dark .CodeMirror {
      background: #0b1120;
      color: #e2e8f0;
    }
    /* gutter 是行号左侧那块，去掉明亮背景更容易读 */
    body.theme-dark .CodeMirror-gutters {
      background: #0b1120;
      border-right: 1px solid #1f2937;
      color: #64748b;
    }
    /* 行号让文字颜色偏灰，以免抢眼 */
    body.theme-dark .CodeMirror-linenumber {
      color: #475569;
    }
    /* 光标用亮色描边便于在深色背景中看见 */
    body.theme-dark .CodeMirror-cursor {
      border-left: 2px solid #f8fafc;
    }
    /* 选中区域背景用半透明蓝，保持与 accent 颜色一致 */
    body.theme-dark .CodeMirror-selected {
      background: rgba(59, 130, 246, 0.25) !important;
    }
    /* 深色预览区域的颜色、链接、图片在 dark 模式里也单独处理 */
    body.theme-dark .markdown-preview-content {
      color: #e2e8f0;
    }
    /* 里面的 a 链接用亮色，更显眼 */
    body.theme-dark .markdown-preview-content a {
      color: #93c5fd;
    }
    /* 图片加阴影让深色背景下仍突出 */
    body.theme-dark .markdown-preview-content img {
      box-shadow: 0 24px 60px rgba(8, 47, 73, 0.55);
    }
    /* figcaption 也跟随深色，文字调灰 */
    body.theme-dark .markdown-preview-content figcaption {
      color: #94a3b8;
    }
    /* 移除深色模式下对 outline-light 的特殊填充，保持统一色系 */
    #editor-container {
      background: var(--surface-2);
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    .CodeMirror {
      height: 100% !important;
    }
    .CodeMirror-scroll {
      height: 100% !important;
      min-height: 0;
    }
    #pdf-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      background: var(--preview-bg);
      border-color: var(--preview-border);
      color: var(--shell-text);
    }
    #markdown-preview {
      padding: 0;
      flex: 1 1 0;
      min-height: 0 !important;
      background: var(--preview-bg);
      border-color: var(--preview-border);
      color: var(--shell-text);
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    /* #markdown-preview-content 用 padding/overflow 让生成的 Markdown 内容可滚动显示 */
    #markdown-preview-content {
      flex: 1 1 0;
      min-height: 0 !important;
      max-height: 100%;
      width: 100%;
      overflow: auto;
      padding: var(--pane-inner-padding);
    }
    /* markdown-preview-content 作为容器设置 line-height、color 让文本更易读 */
    .markdown-preview-content {
      position: relative;
      width: 100%;
      color: var(--shell-text);
      line-height: 1.6;
    }
    /* 代码块用 background + padding + overflow 控制滚动 */
    .markdown-preview-content pre {
      background: var(--preview-code-bg);
      border-radius: 4px;
      padding: 0.75rem;
      overflow: auto;
    }
    /* 图片默认最大宽度限制，自动居中加圆角与阴影 */
    .markdown-preview-content img {
      max-width: min(100%, 720px);
      height: auto;
      display: block;
      margin: 1.25rem auto;
      border-radius: 0.75rem;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
      cursor: zoom-in;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    /* 鼠标移上图片时稍微放大并加强阴影 */
    .markdown-preview-content img:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 24px 55px rgba(15, 23, 42, 0.24);
    }
    /* 聚焦图片时用 outline 告知用户当前元素 */
    .markdown-preview-content img:focus {
      outline: 3px solid rgba(59, 130, 246, 0.45);
      outline-offset: 4px;
    }
    /* figure 用 margin/align 控制图片＋说明上下间距 */
    .markdown-preview-content figure {
      margin: 1.5rem auto;
      text-align: center;
    }
    /* figcaption 给图片的说明设置 font-size 和 muted 颜色 */
    .markdown-preview-content figcaption {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: var(--preview-muted);
    }
    /* markdown-heading-with-copy 让标题右侧出现复制按钮 */
    .markdown-heading-with-copy {
      position: relative;
      padding-right: 2.5rem;
    }
    /* markdown-heading-copy-btn 定位复制按钮，opacity 默认隐藏使界面简洁 */
    .markdown-heading-copy-btn {
      position: absolute;
      top: 50%;
      right: 0.25rem;
      transform: translateY(-50%);
      font-size: 0.8rem;
      padding: 0.2rem 0.55rem;
      border-radius: 999px;
      border: 1px solid color-mix(in srgb, var(--accent) 45%, transparent);
      background: color-mix(in srgb, var(--accent) 12%, transparent);
      color: color-mix(in srgb, var(--accent-strong) 90%, var(--shell-text));
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease, background 0.18s ease, color 0.18s ease, border-color 0.18s ease;
    }
    /* hover/focus 后让按钮 fade in */
    .markdown-heading-copy-btn:focus,
    .markdown-heading-copy-btn:hover {
      background: color-mix(in srgb, var(--accent) 22%, transparent);
      color: color-mix(in srgb, var(--accent-strong) 85%, var(--shell-text));
      border-color: color-mix(in srgb, var(--accent) 65%, transparent);
    }
    /* 当标题 hover 或复制按钮 focus 让其显现 */
    .markdown-heading-with-copy:hover .markdown-heading-copy-btn,
    .markdown-heading-copy-btn:focus {
      opacity: 1;
      pointer-events: auto;
    }
    /* 深色下再调复制按钮的边框/背景/文字，保持可读 */
    body.theme-dark .markdown-heading-copy-btn {
      border-color: color-mix(in srgb, var(--accent) 48%, transparent);
      background: color-mix(in srgb, var(--accent) 18%, transparent);
      color: color-mix(in srgb, var(--accent-strong) 82%, var(--shell-text));
    }
    /* 深色模式下的 hover/focus */
    body.theme-dark .markdown-heading-copy-btn:hover,
    body.theme-dark .markdown-heading-copy-btn:focus {
      background: color-mix(in srgb, var(--accent) 32%, transparent);
      color: var(--shell-text);
      border-color: color-mix(in srgb, var(--accent-strong) 72%, transparent);
    }
    /* Heading highlight 用 box-shadow + background 帮助滚动定位 */
    .markdown-preview-content .markdown-heading-highlight {
      background: rgba(191, 219, 254, 0.45);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
      border-radius: 0.5rem;
      transition: background 1.2s ease, box-shadow 1.2s ease;
    }
    /* 表格外壳设置 border、padding、scrollbar，保证表格也不会撑破界面 */
    .markdown-preview-table-wrapper {
      position: relative;
      margin: 1.25rem 0;
      border: 1px solid var(--preview-border);
      border-radius: 0.9rem;
      background: var(--preview-table-bg);
      overflow: auto;
      max-width: 100%;
      max-height: clamp(320px, 58vh, 640px);
      box-shadow: 0 18px 42px rgba(15, 23, 42, 0.12);
      padding: 1.75rem 1rem 1.4rem;
      scrollbar-width: thin;
      scrollbar-color: color-mix(in srgb, var(--accent) 55%, transparent) transparent;
    }
    /* WebKit 特有的滚动条样式，使滚动条看起来更细 */
    .markdown-preview-table-wrapper::-webkit-scrollbar {
      height: 8px;
      width: 8px;
    }
    /* 滚动条滑块颜色也用 accent，让它和主题统一 */
    .markdown-preview-table-wrapper::-webkit-scrollbar-thumb {
      background: color-mix(in srgb, var(--accent) 45%, transparent);
      border-radius: 4px;
    }
    /* 轨道保持透明，避免抢眼 */
    .markdown-preview-table-wrapper::-webkit-scrollbar-track {
      background: transparent;
    }
    /* 表格本身宽度设置、颜色继承 */
    .markdown-preview-table-wrapper table {
      width: 100%;
      min-width: 100%;
      border-collapse: collapse;
      background: var(--preview-bg);
      table-layout: auto;
      color: var(--shell-text);
    }
    /* caption 用加粗/左对齐做标题 */
    .markdown-preview-table-wrapper caption {
      caption-side: top;
      text-align: left;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--shell-text);
    }
    /* 设定 thead sticky 让表格表头固定在可见区域 */
    .markdown-preview-table-wrapper thead th {
      position: sticky;
      top: 0;
      z-index: 5;
      background: var(--preview-table-head);
      color: var(--shell-text);
      box-shadow: inset 0 -1px 0 color-mix(in srgb, var(--preview-border) 80%, transparent);
    }
    /* 让奇数行背景稍微不同，增强可读性 */
    .markdown-preview-table-wrapper tbody tr:nth-child(odd) {
      background: var(--preview-table-row);
    }
    /* th/td 共享的 border/padding/word-break 设置，避免内容撑破单元格 */
    .markdown-preview-table-wrapper th,
    .markdown-preview-table-wrapper td {
      border: 1px solid var(--preview-border);
      padding: 0.6rem 0.75rem;
      text-align: left;
      vertical-align: middle;
      word-break: break-word;
      white-space: normal;
      color: var(--shell-text);
    }
    /* markdown-table-expand-btn 是浮在表格上的扩展按钮，设置 padding + backdrop-filter */
    .markdown-table-expand-btn {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      z-index: 10;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.3rem 0.75rem;
      font-size: 0.8rem;
      font-weight: 600;
      background: color-mix(in srgb, var(--accent) 12%, transparent);
      border: 1px solid color-mix(in srgb, var(--accent-strong) 38%, transparent);
      border-radius: 999px;
      color: color-mix(in srgb, var(--accent-strong) 86%, var(--shell-text));
      backdrop-filter: blur(6px);
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }
    /* hover/focus 用更浓的 accent 显示，提升可点击提示 */
    .markdown-table-expand-btn:hover,
    .markdown-table-expand-btn:focus {
      background: color-mix(in srgb, var(--accent) 22%, transparent);
      border-color: color-mix(in srgb, var(--accent-strong) 55%, transparent);
      color: var(--shell-text);
      outline: none;
    }
    /* focus-visible 再加个 glow，帮助键盘用户 */
    .markdown-table-expand-btn:focus-visible {
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent) 35%, transparent);
    }
    /* copy-trigger-wrapper 包裹复制按钮，绝对定位使按钮悬在右上 */
    .copy-trigger-wrapper {
      position: relative;
      display: block;
    }
    /* inline-copy 版本用于行内代码块，不用 block 流布局 */
    .copy-trigger-wrapper.inline-copy {
      display: inline-block;
      vertical-align: baseline;
    }
    /* copy-trigger-btn 初始 opacity=0，hover/focus 再让它看见 */
    .copy-trigger-btn {
      position: absolute;
      top: 0.35rem;
      right: 0.35rem;
      opacity: 0;
      transition: opacity 0.2s ease;
      padding: 0.1rem 0.4rem;
      line-height: 1.2;
      font-size: 0.75rem;
    }
    /* hover/focus 让按钮淡入，保证可点击 */
    .copy-trigger-wrapper:hover .copy-trigger-btn,
    .copy-trigger-btn:focus {
      opacity: 1;
    }
    /* PDF 浏览区域宽度铺满 */
    #pdf-pages {
      width: 100%;
    }
    /* pdf-page-canvas 确保画布自适应宽度和自动高度 */
    .pdf-page-canvas {
      max-width: 100%;
      height: auto;
      background: #fff;
    }
    /* navbar-nav 控制菜单项的排列和间距 */
    .navbar-nav {
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    /* nav-item 默认 flex 让按钮垂直居中 */
    .navbar-nav .nav-item {
      display: flex;
      align-items: center;
    }
    /* dropdown-divider 控制栏内分割线高度和 margin */
    .navbar-nav .dropdown-divider {
      height: 1.5rem;
      margin: 0 0.35rem;
    }
    /* 响应式媒体查询：小屏幕时让导航换方向以免挤在一起 */
    @media (max-width: 991.98px) {
      .navbar-nav {
        flex-direction: row;
        justify-content: flex-start;
      }
    }
    /* 更小的手机屏幕再缩小 gap */
    @media (max-width: 575.98px) {
      .navbar-nav {
        gap: 0.4rem;
      }
    }
    /* 图片模态框的 dialog 最大宽度限制，避免铺满屏幕 */
    #markdownImageModal .modal-dialog {
      max-width: min(92vw, 1080px);
    }
    /* 设置图像弹窗的背景/圆角/阴影，同时用 backdrop-filter 添加磨砂感 */
    #markdownImageModal .modal-content {
      background: var(--surface-1);
      color: var(--shell-text);
      border: 1px solid var(--surface-border);
      border-radius: 1rem;
      backdrop-filter: blur(12px);
      position: relative;
      overflow: hidden;
      box-shadow: var(--surface-shadow);
    }
    /* modal-body 加 padding 和 gap 让图片+说明依次排列 */
    #markdownImageModal .modal-body {
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: transparent;
    }
    /* image-wrapper 用 flex 居中图片，同时用渐变背景框住 */
    #markdownImageModal .image-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      background: color-mix(in srgb, var(--surface-2) 92%, var(--accent) 6%);
      border-radius: 0.75rem;
      padding: 1rem;
      border: 1px solid var(--surface-border);
    }
    /* image-wrapper img 控制 max-width/max-height，辅助 zoom 效果 shadow */
    #markdownImageModal .image-wrapper img {
      max-width: 100%;
      max-height: 80vh;
      width: auto;
      height: auto;
      border-radius: 0.5rem;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.45);
    }
    /* 图注用 small 字号和 muted 颜色 */
    #markdownImageCaption {
      font-size: 0.95rem;
      text-align: center;
      color: var(--preview-muted);
    }
    /* 表格模态框设定最大宽度避免撑破 */
    #markdownTableModal .modal-dialog {
      max-width: min(95vw, 1280px);
    }
    #markdownTableModal .modal-content {
      border-radius: 1rem;
      border: 1px solid var(--surface-border);
      background: var(--surface-1);
      box-shadow: var(--surface-shadow);
      color: var(--shell-text);
    }
    /* modal-body 负责内部 padding 与垂直间距 */
    #markdownTableModal .modal-body {
      padding: 1.75rem;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }
    /* #markdownTableModalBody 是可滚动的表格容器，设定最大高度 + 内边距 */
    #markdownTableModalBody {
      max-height: 80vh;
      overflow: auto;
      border-radius: 0.9rem;
      border: 1px solid var(--preview-border);
      background: var(--preview-bg);
      padding: 1.25rem;
      box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--accent) 22%, transparent);
    }
    /* 这里的 table 是弹窗内的表格，设置固定 min-width 保证列不挤 */
    #markdownTableModalBody table {
      width: max-content;
      min-width: min(1080px, 100%);
      max-width: none;
      border-collapse: collapse;
      margin: 0 auto;
      background: var(--preview-table-bg);
      color: var(--shell-text);
    }
    /* th/td 共享边框/内边距，保持表格整齐 */
    #markdownTableModalBody th,
    #markdownTableModalBody td {
      border: 1px solid var(--preview-border);
      padding: 0.65rem 0.85rem;
      text-align: left;
      vertical-align: middle;
      color: var(--shell-text);
    }
    /* 弹窗表格也为奇数行加背景色 */
    #markdownTableModalBody tbody tr:nth-child(odd) {
      background: var(--preview-table-row);
    }
    /* caption 在弹窗表格用右对齐、加粗 */
    #markdownTableModalBody caption {
      caption-side: top;
      text-align: left;
      font-weight: 600;
      margin-bottom: 0.75rem;
      color: var(--shell-text);
    }
    /* thead th 设为 sticky，让表头始终可见 */
    #markdownTableModalBody thead th {
      position: sticky;
      top: 0;
      background: var(--preview-table-head);
      z-index: 3;
      color: var(--shell-text);
      box-shadow: inset 0 -1px 0 color-mix(in srgb, var(--preview-border) 72%, transparent);
    }
    /* 弹窗底部的说明文字也用 muted 颜色 */
    #markdownTableModalCaption {
      font-size: 0.95rem;
      text-align: right;
      color: var(--preview-muted);
    }
    /* tabs 模态的 dialog 宽度限制，防止过分拉伸 */
    #tabsModal .modal-dialog {
      max-width: min(900px, 96vw);
    }
    /* modal-body 设置可滚动且有最大高度，避免列表撑破弹窗 */
    #tabsModal .modal-body {
      max-height: min(70vh, 560px);
      overflow: auto;
    }
    /* page-tabs 用 CSS Grid 平铺小标签，auto-fit+minmax 保持弹性数量 */
    #tabsModal #page-tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(64px, 1fr));
      gap: 0.5rem;
      align-items: stretch;
      margin-bottom: 0.5rem;
    }
    /* page-tab 设定最小高度、圆角、背景和可抓取 cursor */
    #tabsModal #page-tabs .page-tab {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 44px;
      padding: 0.55rem 0.75rem;
      font-size: 1rem;
      font-weight: 700;
      border-radius: 1.5rem;
      cursor: grab;
      user-select: none;
      background: color-mix(in srgb, var(--surface-2) 88%, var(--accent) 12%);
      border: 1px solid color-mix(in srgb, var(--surface-border) 70%, var(--accent) 24%);
      color: var(--shell-text);
      box-shadow: inset 0 1px 0 color-mix(in srgb, var(--accent) 10%, transparent);
      transition: transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
    }
    /* hover/focus-visible 增加阴影/位移提示是可交互项 */
    #tabsModal #page-tabs .page-tab:hover,
    #tabsModal #page-tabs .page-tab:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 8px 18px color-mix(in srgb, var(--accent) 18%, transparent);
      outline: none;
    }
    /* is-active 状态用 accent 背景强调当前页 */
    #tabsModal #page-tabs .page-tab.is-active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent-strong);
      box-shadow: 0 10px 26px color-mix(in srgb, var(--accent) 28%, transparent);
    }
    /* dragger 状态 cursor: grabbing 提示正在拖拽 */
    #tabsModal #page-tabs .page-tab:active {
      cursor: grabbing;
    }
    /* workspace-modal 的 dialog 确保在大屏时有空隙，并用 flex 让内容撑满 */
    .workspace-modal .modal-dialog {
      max-width: min(960px, calc(100% - 2rem));
      margin: 1.5rem auto;
      height: calc(100% - 3rem);
      display: flex;
    }
    /* workspace-modal 本身用 overflow:hidden 锁定滚动 */
    .workspace-modal {
      overflow: hidden;
      padding: 0 !important;
    }
    /* workspace-modal 内部用渐变背景和大圆角，用 flex column 承载 header + actions */
    .workspace-modal .modal-content {
      border-radius: 24px;
      border: 1px solid var(--surface-border);
      background: color-mix(in srgb, var(--surface-1) 92%, var(--accent) 6%);
      color: var(--shell-text);
      box-shadow: var(--surface-shadow);
      width: 100%;
      display: flex;
      flex-direction: column;
      max-height: 100%;
      height: 100%;
    }
    /* workspace-overlay-header 只负责固定顶部的标题区域 */
    .workspace-modal .workspace-overlay-header {
      flex-shrink: 0;
    }
    /* overlay-actions 区域可以滚动，padding-right 防止滚动条遮挡内容 */
    .workspace-modal .workspace-overlay-actions {
      overflow-y: auto;
      padding-right: 0.25rem;
      flex: 1;
    }
    /* 768px 以下让 workspace dialog 占满高度 */
    @media (max-width: 768px) {
      .workspace-modal .modal-dialog {
        height: 100%;
        margin: 0 auto;
      }
    }
    /* workspace-modal-title 使用 clamp 让字号在不同屏幕自动缩放 */
    .workspace-modal-title {
      font-size: clamp(1.6rem, 3vw, 2rem);
    }
    .workspace-form {
      background: var(--surface-2);
      border-radius: 1rem;
      border: 1px solid var(--surface-border);
      color: var(--shell-text);
      box-shadow: inset 0 1px 0 color-mix(in srgb, var(--accent) 12%, transparent);
    }
    /* overlay-status 表示状态文字高度 */
    .workspace-overlay-status {
      min-height: 1.5rem;
    }
    /* workspace-button-highlight 用 animation 提醒用户注意 */
    .workspace-button-highlight {
      animation: workspacePulse 1.4s ease-in-out 2;
      box-shadow: 0 0 0 0 color-mix(in srgb, var(--accent) 45%, transparent);
    }
    /* workspacePulse 动画通过 box-shadow 扩散来吸引视线 */
    @keyframes workspacePulse {
      0% {
        box-shadow: 0 0 0 0 color-mix(in srgb, var(--accent) 45%, transparent);
      }
      70% {
        box-shadow: 0 0 0 12px color-mix(in srgb, var(--accent) 0%, transparent);
      }
      100% {
        box-shadow: 0 0 0 0 color-mix(in srgb, var(--accent) 0%, transparent);
      }
    }
    /* 远程工作区列表项使用 flex+gap，保持横/竖 layout 兼容 */
    #remote-workspace-list .list-group-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      background: var(--surface-1);
      border: 1px solid var(--surface-border);
      border-radius: 0.9rem;
      box-shadow: var(--surface-shadow);
      color: var(--shell-text);
    }
    /* 多加一行 text-muted 的 margin-bottom 0 保持紧凑 */
    #remote-workspace-list .list-group-item .text-muted {
      margin-bottom: 0;
    }
    /* 远程列表里的按钮用 min-width 保持一致大小 */
    #remote-workspace-list .list-group-item .btn {
      min-width: 96px;
    }
    /* 远程工作区弹窗也用一套变量以便后面统一替换 */
    #remoteWorkspaceModal {
      --remote-surface: var(--surface-2);
      --remote-border: var(--surface-border);
    }
    /* 远程 workspace 弹窗内容区域 */
    #remoteWorkspaceModal .modal-content {
      border-radius: 20px;
      border: 1px solid var(--remote-border);
      background: color-mix(in srgb, var(--surface-1) 94%, var(--accent) 6%);
      box-shadow: var(--surface-shadow);
      color: var(--shell-text);
    }
    /* 远程 workspace 表单背景也要跟 surface 保持一致 */
    #remoteWorkspaceModal .workspace-form {
      background: var(--remote-surface);
      border-color: var(--remote-border);
      color: var(--shell-text);
    }
    /* #status-area 固定在顶部，用高 z-index 确保通知在最上层 */
    #status-area {
      top: 14px;
      z-index: 5000 !important;
      pointer-events: none;
    }
    /* status-area 里的 alert 控制通知样式和阴影 */
    #status-area .alert {
      pointer-events: auto;
      min-width: 320px;
      box-shadow: var(--surface-shadow);
      background: var(--surface-1);
      color: var(--shell-text);
      border: 1px solid var(--surface-border);
    }
    /* review-session-top 控制复习相关 modal 的 z-index */
    .review-session-top {
      z-index: 2050;
    }
    /* backdrop 继续保持高 z-index 以覆盖其他浮层 */
    .review-session-backdrop {
      z-index: 2040 !important;
    }
    /* review modal dialog 限制宽度 */
    .review-session-top .modal-dialog {
      max-width: 1080px;
    }
    /* review modal 内容区圆角+阴影+背景 */
    .review-session-top .modal-content {
      border-radius: 18px;
      border: 1px solid var(--surface-border);
      box-shadow: var(--surface-shadow);
      background: color-mix(in srgb, var(--surface-1) 94%, var(--accent) 6%);
      color: var(--shell-text);
    }
    /* review-surface 就是带阴影和背景的写字区域 */
    .review-surface {
      min-height: 190px;
      border-radius: 16px;
      padding: 14px 16px;
      background: color-mix(in srgb, var(--surface-2) 90%, var(--accent) 10%);
      border: 1px solid var(--surface-border);
      box-shadow: inset 0 1px 0 color-mix(in srgb, var(--accent) 12%, transparent);
      overflow-y: auto;
      max-height: 320px;
      white-space: pre-wrap;
      line-height: 1.55;
      color: var(--shell-text);
    }
    /* mini-text 版本把高度减小 */
    .review-surface.review-mini-text {
      min-height: 120px;
      max-height: 220px;
    }
    /* review-note 提供一个较高的最小高度 */
    .review-note {
      min-height: 140px;
    }
    /* review-meta-card 用 dashed border 提示辅助信息 */
    .review-meta-card {
      border-radius: 12px;
      border: 1px dashed var(--surface-border);
      padding: 10px 12px;
      background: color-mix(in srgb, var(--surface-1) 88%, transparent);
      color: var(--shell-text);
    }
    /* review-score-btn 用 flex 拉伸按钮，并在 hover 时移动 */
    .review-score-btn {
      flex: 1 1 0;
      border-width: 2px;
      font-weight: 700;
      letter-spacing: 0.02em;
      transition: transform 0.12s ease, box-shadow 0.2s ease;
    }
    /* hover/focus-visible 让按钮微微抬起 */
    .review-score-btn:hover,
    .review-score-btn:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px color-mix(in srgb, var(--accent) 22%, transparent);
    }
    /* review-badge 只是为了让标签更粗一点 */
    .review-badge {
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    /* review-mini-text 是更小的文字，用于提示 */
    .review-mini-text {
      font-size: 0.9rem;
    }
    /* review-prompt-toggle 用 dashed border 提示可交互 */
    .review-prompt-toggle {
      border: 1px dashed var(--surface-border);
    }
    /* alert-accent 用 accent 颜色 + box-shadow 做弹出通知 */
    .alert-accent {
      background: color-mix(in srgb, var(--accent) 12%, var(--surface-1));
      border: 1px solid color-mix(in srgb, var(--accent-strong) 35%, transparent);
      color: var(--shell-text);
      box-shadow: 0 10px 26px color-mix(in srgb, var(--accent) 14%, transparent);
    }
    /* 深色模式下的 alert 也需要相应的边框/阴影颜色 */
    body.theme-dark .alert-accent {
      background: color-mix(in srgb, var(--accent) 16%, var(--surface-1));
      border-color: color-mix(in srgb, var(--accent-strong) 45%, transparent);
      box-shadow: 0 10px 26px color-mix(in srgb, var(--accent) 18%, transparent);
    }
    /* ai-learn-review-fav 是点赞按钮，hover/active 加一点立体感 */
    .ai-learn-review-fav {
      transition: transform 0.12s ease, box-shadow 0.2s ease;
    }
    /* hover/focus-visible 让按钮稍微抬起/发光 */
    .ai-learn-review-fav:hover,
    .ai-learn-review-fav:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px color-mix(in srgb, var(--accent) 20%, transparent);
    }
    /* 激活状态加更强 box-shadow 表示已点赞 */
    .ai-learn-review-fav.active {
      box-shadow: 0 12px 26px color-mix(in srgb, var(--accent-strong) 24%, transparent);
    }
  </style>




























</head>
<body class="{% if ui_theme and ui_theme.get('color_mode') == 'dark' %}theme-dark{% endif %}" data-bs-theme="{{ ui_theme.get('color_mode', 'light') if ui_theme else 'light' }}" {% if ui_theme and ui_theme.get('skin') and ui_theme.get('skin') != 'default' %}data-ui-skin="{{ ui_theme.get('skin') }}"{% endif %}>
<div class="modal fade workspace-modal" id="workspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content p-4 p-md-5">
      <div class="workspace-overlay-header mb-4 text-center text-md-start">
        <h1 class="workspace-modal-title mb-2">选择工作区</h1>
        <p class="mb-0 text-muted">打开或创建一个 <code>.benort</code> 文件以开始编辑。</p>
      </div>
      <div class="workspace-overlay-actions">
        <div class="workspace-form p-3 mb-3" id="local-workspace-browser">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h5 class="mb-1">本地工作区</h5>
              <p class="text-muted small mb-0">应用会自动扫描项目根目录下的 <code>.benort</code> 文件。</p>
            </div>
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-outline-secondary btn-sm" id="local-workspace-refresh">刷新列表</button>
            </div>
          </div>
          <div id="local-workspace-status" class="text-muted small mb-2"></div>
          <div id="local-workspace-list" class="list-group"></div>
        </div>
        <form id="local-workspace-create-form" class="workspace-form p-3 mb-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">新建本地工作区</h5>
            <span class="badge bg-primary">根目录</span>
          </div>
          <div class="mb-2">
            <label for="local-workspace-create-name" class="form-label small text-muted">文件名（自动追加 <code>.benort</code>）</label>
            <input type="text" class="form-control" id="local-workspace-create-name" placeholder="my-project" autocomplete="off">
          </div>
          <div class="mb-3">
            <label for="local-workspace-create-display" class="form-label small text-muted">显示名称（可选）</label>
            <input type="text" class="form-control" id="local-workspace-create-display" placeholder="工作区标题" autocomplete="off">
          </div>
          <div class="mb-2 text-muted small" id="local-workspace-create-hint"></div>
          <div class="text-muted small mb-2" id="local-workspace-create-status"></div>
          <button type="submit" class="btn btn-outline-primary w-100">创建并打开</button>
        </form>
        <div id="workspace-overlay-status" class="workspace-overlay-status text-muted small mb-2"></div>
        <div id="workspace-current-info" class="workspace-form p-3 d-none">
          <div class="text-muted small mb-2">当前工作区</div>
          <div class="fw-semibold" id="workspace-current-name">--</div>
          <div class="text-muted small" id="workspace-current-path"></div>
          <div class="mt-3 d-flex gap-2">
            <button type="button" class="btn btn-outline-secondary flex-fill" id="workspace-refresh-btn">重新加载</button>
            <button type="button" class="btn btn-outline-danger flex-fill" id="workspace-close-btn">关闭工作区</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="remoteWorkspaceModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg">
    <div class="modal-content p-4 p-md-4">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-3">
        <div>
          <h2 class="h4 mb-1">远程工作区</h2>
          <p class="text-muted mb-0">列出 OSS 中的 <code>.benort</code> 文件，可直接打开或创建。</p>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary" id="remote-workspace-refresh">刷新</button>
          <button type="button" class="btn btn-outline-dark" data-bs-dismiss="modal">关闭</button>
        </div>
      </div>
      <div class="workspace-form p-3 mb-3">
        <div class="text-muted small mb-1">OSS 路径</div>
        <div id="remote-workspace-prefix" class="fw-semibold small text-break"></div>
      </div>
      <div id="remote-workspace-status" class="text-muted small mb-2"></div>
      <div id="remote-workspace-list" class="list-group mb-4"></div>
      <form id="remote-workspace-create-form" class="workspace-form p-3">
        <h5 class="mb-3">新建远程工作区</h5>
        <div class="mb-2">
          <label for="remote-workspace-create-name" class="form-label small text-muted">文件名</label>
          <input type="text" class="form-control" id="remote-workspace-create-name" placeholder="my-workspace" autocomplete="off">
          <div class="form-text">系统会自动添加 <code>.benort</code> 后缀。</div>
        </div>
        <div class="mb-3">
          <label for="remote-workspace-create-display" class="form-label small text-muted">显示名称（可选）</label>
          <input type="text" class="form-control" id="remote-workspace-create-display" placeholder="工作区标题" autocomplete="off">
        </div>
        <button type="submit" class="btn btn-primary w-100">创建并打开</button>
      </form>
    </div>
  </div>
</div>
<div id="app-shell">
<div id="status-area" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:2000;"></div>
 
<nav class="navbar navbar-expand-lg">
  <div class="container-fluid">
    <div class="navbar-collapse show w-100">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0 nav-flex-wrap w-100">
        <li class="nav-item">
          <div class="dropdown">
            <button class="btn btn-outline-primary fw-semibold px-3 js-nav-btn nav-btn" id="project-dropdown" data-bs-toggle="dropdown" aria-expanded="false">Benort</button>
            <ul class="dropdown-menu" id="project-menu" aria-labelledby="project-dropdown">
              <li><h6 class="dropdown-header">工作区</h6></li>
              <li><span class="dropdown-item-text text-muted">当前：未选择</span></li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <button type="button" class="dropdown-item d-flex align-items-center gap-2 workspace-menu-action" id="workspace-open-local-btn" data-workspace-action="local">
                  <span class="text-primary">📁</span><span>打开本地工作区</span>
                </button>
              </li>
              <li>
                <button type="button" class="dropdown-item d-flex align-items-center gap-2 workspace-menu-action" id="workspace-open-remote-btn" data-workspace-action="remote">
                  <span class="text-info">☁️</span><span>打开远程工作区</span>
                </button>
              </li>
            </ul>
          </div>
        </li>

        <li class="nav-item mobile-allowed">
          <div class="mobile-page-control-group d-flex align-items-center">
            <button class="btn btn-outline-primary js-nav-btn mobile-page-btn" id="prev-page" title="上一页">上</button>
            <button type="button" class="btn btn-outline-primary js-nav-btn mobile-page-btn" id="page-status" >
              <span id="page-num">1</span> / <span id="page-count">1</span>
            </button>
            <button class="btn btn-outline-primary js-nav-btn mobile-page-btn" id="next-page" title="下一页">下</button>
          </div>
        </li>
        <li class="nav-item d-flex align-items-center">
          <button class="btn btn-outline-primary me-2 js-nav-btn" id="project-search-btn" title="检索当前项目">检索</button>
        </li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2 js-nav-btn" id="mode-switch-btn" title="切换LaTeX/Markdown">模式</button></li>
        <li class="nav-item"><button class="btn btn-outline-secondary me-2 js-nav-btn" id="add-page" title="添加新页">加页</button></li>
        <li class="nav-item"><button class="btn btn-outline-warning me-2 js-nav-btn" id="insert-component" title="插入常用组件">插入</button></li>
        <li class="nav-item"><button class="btn btn-outline-info me-2 js-nav-btn" id="edit-template" title="编辑LaTeX样式模板">样式</button></li>
        <li><hr class="dropdown-divider m-1"></li>

        <li class="nav-item"><button class="btn btn-outline-success me-2 js-nav-btn" id="export-btn" title="导出">导出</button></li>
        <li><hr class="dropdown-divider m-1"></li>

        <li class="nav-item">
          <button class="btn btn-outline-primary me-2 js-nav-btn" id="llm-manage-btn" title="管理模型配置">
            模型配置
          </button>
        </li>
        <li><hr class="dropdown-divider m-1"></li>

        <li class="nav-item"><button class="btn btn-outline-danger me-2 js-nav-btn" id="ai-optimize" title="Latex优化">tex优化</button></li>
        <li class="nav-item"><button class="btn btn-outline-secondary me-2 js-nav-btn" id="ai-note-optimize" title="Markdown优化">md优化</button></li>
        <li class="nav-item"><button class="btn btn-outline-secondary me-2 js-nav-btn" id="ai-script-optimize" title="Speech script优化">script优化</button></li>
        <li class="nav-item"><button class="btn btn-outline-success me-2 js-nav-btn" id="ai-learn-helper" title="AI 学习">AI学习</button></li>
        <li class="nav-item"><button class="btn btn-outline-info me-2 js-nav-btn" id="ai-learn-review-btn" title="AI 复习">AI复习</button></li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2 js-nav-btn" id="ai-assistant-btn" title="AI 助理（可选 RAG）">AI助理</button></li>
        <li><hr class="dropdown-divider m-1"></li>
        <li class="nav-item"><button class="btn btn-outline-danger me-2 js-nav-btn" id="play-note" title="播放当前页讲稿">播放讲稿</button></li>
        <li><hr class="dropdown-divider m-1"></li>

        <li class="nav-item"><button class="btn btn-outline-primary me-2 js-nav-btn" id="edit-bib" title="管理文献">管理文献</button></li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2 js-nav-btn" id="manage-resources" title="管理资源">管理资源</button></li>
        <li class="nav-item"><button class="btn btn-outline-primary me-2 js-nav-btn" id="manage-attachments" title="管理附件">管理附件</button></li>
        <li><hr class="dropdown-divider m-1"></li>
        <li class="nav-item">
          <button class="btn btn-outline-secondary me-2 js-nav-btn" id="ui-settings-btn" title="切换页面外观和布局">外观配置</button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- UI Config Modal -->
<div class="modal fade" id="uiConfigModal" tabindex="-1" aria-labelledby="uiConfigModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uiConfigModalLabel">网页外观配置</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-semibold" for="ui-theme-select">配色风格</label>
          <select id="ui-theme-select" class="form-select">
            <option value="default">经典默认</option>
            <option value="pastel">粉粉少女</option>
            <option value="paper">暖纸温感</option>
            <option value="ocean">深海霓虹</option>
            <option value="forest">森林青翠</option>
            <option value="sunset">暖阳日落</option>
            <option value="slate">冷峻石板</option>
          </select>
          <div class="form-text">整体风格（含菜单栏与按钮配色）可一键切换。</div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-semibold" for="ui-color-mode-select">明暗模式</label>
          <select id="ui-color-mode-select" class="form-select">
            <option value="light">浅色</option>
            <option value="dark">深色</option>
            <option value="system">跟随系统</option>
          </select>
        </div>
        <div class="row g-3">
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="ui-pane-ratio-select">编辑/预览/讲稿比例</label>
            <select id="ui-pane-ratio-select" class="form-select">
              <option value="editor-wide">编辑预览优先（8:2）</option>
              <option value="balanced">均衡（7:3）</option>
              <option value="preview-wide">讲稿偏宽（6:4）</option>
              <option value="equal">对半分（5:5）</option>
            </select>
            <div class="form-text">始终保持左右布局，不会纵向堆叠。</div>
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label fw-semibold" for="ui-font-size-select">字号 & 菜单占用</label>
            <select id="ui-font-size-select" class="form-select">
              <option value="compact">紧凑（小字号，小按钮）</option>
              <option value="standard">标准</option>
              <option value="relaxed">宽松（大字号，大按钮）</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="ui-config-reset">恢复默认</button>
        <button type="button" class="btn btn-primary" id="ui-config-apply">应用</button>
      </div>
    </div>
  </div>
</div>

      <div class="modal fade" id="bibModal" tabindex="-1" aria-labelledby="bibModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="bibModalLabel">参考文献管理</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-2 align-items-center mb-3">
                <div class="col-12 col-lg">
                  <input id="bib-input" class="form-control" placeholder="输入DOI、文献链接或完整bibtex">
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                  <select id="bib-scope" class="form-select">
                    <option value="global">全局</option>
                    <option value="page">本页</option>
                  </select>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                  <button class="btn btn-primary w-100" id="add-bib-btn">AI生成</button>
                </div>
                <div class="col-6 col-sm-4 col-lg-2">
                  <button class="btn btn-outline-primary w-100" id="add-url-bib-btn">直接保存</button>
                </div>
              </div>
              <div class="row g-2 mb-3">
                <div class="col-12 col-md-6">
                  <input id="bib-label-input" class="form-control" placeholder="可选：给文献起一个记忆用的名字">
                </div>
                <div class="col-12 col-md-6">
                  <input id="bib-note-input" class="form-control" placeholder="可选：备注这篇文献的重点">
                </div>
              </div>
              <div id="bib-list" class="d-flex flex-column gap-3">
                <div>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">本页文献</h6>
                    <small class="text-muted" id="bib-page-count"></small>
                  </div>
                  <div id="bib-page-list" class="list-group"></div>
                </div>
                <div>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">全局文献</h6>
                    <small class="text-muted" id="bib-global-count"></small>
                  </div>
                  <div id="bib-global-list" class="list-group"></div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="bibEntryModal" tabindex="-1" aria-labelledby="bibEntryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="bibEntryModalLabel">编辑文献信息</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="bib-edit-label" class="form-label">文献名称</label>
            <input type="text" class="form-control" id="bib-edit-label" placeholder="输入显示名称">
          </div>
          <div class="mb-3">
            <label for="bib-edit-note" class="form-label">备注</label>
            <textarea class="form-control" id="bib-edit-note" rows="3" placeholder="补充这篇文献的重点"></textarea>
          </div>
          <div class="border rounded p-3 bg-light" id="bib-edit-details">
            <div class="text-muted">暂无文献信息</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" id="bib-edit-save">保存</button>
        </div>
      </div>
    </div>
  </div>
  
      <!-- Resources Modal -->
      <div class="modal fade" id="resourcesModal" tabindex="-1" aria-labelledby="resourcesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="resourcesModalLabel">资源管理</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3 text-muted">当前页: <span id="resources-current-page">1</span></div>

                  <div class="input-group mb-2">
                    <input id="modal-resource-upload-input" type="file" class="form-control" multiple />
                    <button id="modal-resource-select-folder-btn" class="btn btn-outline-secondary" type="button" title="选择文件夹上传">选择文件夹</button>
                    <button id="modal-resource-upload-btn" class="btn btn-primary" type="button">上传到本页</button>
                    <button id="modal-resource-upload-global-btn" class="btn btn-secondary" type="button">上传为全局</button>
                  </div>
                  <input id="modal-resource-upload-dir-input" type="file" class="d-none" multiple webkitdirectory />
                  <div class="form-text text-muted mb-3" id="modal-resource-upload-hint">可一次选择多个文件，或使用“选择文件夹”上传整个目录结构。</div>

                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">本页资源</h6>
                    <small class="text-muted" id="resources-page-count"></small>
                  </div>
                  <div id="resources-page-list" class="list-group mb-3 resource-list"></div>

                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">全局资源</h6>
                    <small class="text-muted" id="resources-global-count"></small>
                  </div>
                  <div id="resources-global-list" class="list-group resource-list"></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
              </div>
            </div>
          </div>

      <!-- Resource Preview Modal -->
      <div class="modal fade" id="resourcePreviewModal" tabindex="-1" aria-labelledby="resourcePreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="resourcePreviewModalLabel">资源预览</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <img id="resource-preview-image" src="" alt="preview" class="img-fluid" style="max-height:70vh;" />
              <div class="text-muted small mt-2" id="resource-preview-meta"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <a id="resource-preview-open" href="#" target="_blank" class="btn btn-primary">新标签页打开</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Resource Rename Modal -->
      <div class="modal fade" id="resourceRenameModal" tabindex="-1" aria-labelledby="resourceRenameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="resourceRenameModalLabel">重命名资源</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="resource-rename-input" class="form-label">新文件名</label>
                <input type="text" class="form-control" id="resource-rename-input" />
                <div class="form-text">名称会自动清理非法字符，请保留正确的扩展名。</div>
                <div class="form-text text-break mt-2" id="resource-rename-preview"></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="resource-rename-confirm">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Attachments Modal -->
      <div class="modal fade" id="attachmentsModal" tabindex="-1" aria-labelledby="attachmentsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="attachmentsModalLabel">附件管理</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="input-group input-group-sm mb-3">
                <span class="input-group-text">筛选</span>
                <input id="attachment-filter-input" type="search" class="form-control" placeholder="输入关键词快速查找附件">
                <button class="btn btn-outline-secondary" type="button" id="attachment-filter-clear">清除</button>
              </div>
              <div class="input-group mb-3">
                <input id="modal-attachment-upload-input" type="file" class="form-control" />
                <button id="modal-attachment-upload-btn" class="btn btn-primary">上传附件</button>
              </div>
              <div id="attachments-usage-hint" class="alert alert-warning d-none small py-2 px-3"></div>
              <div id="attachments-list-modal" class="list-group"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>


      <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="searchModalLabel">内容检索</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="input-group input-group-sm mb-3">
                <input type="search" class="form-control" id="search-modal-input" placeholder="输入关键词检索当前项目" autocomplete="off">
                <button class="btn btn-outline-primary" type="button" id="search-modal-submit">检索</button>
              </div>
              <div class="mb-3 text-muted" id="search-summary">请输入关键词后检索当前项目。</div>
              <div id="search-results" class="list-group"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      
          <div class="modal fade" id="aiNoteModal" tabindex="-1" aria-labelledby="aiNoteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiNoteModalLabel">笔记AI优化结果</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <textarea id="ai-note-result" class="form-control" rows="8"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="apply-ai-note-result">应用到当前笔记</button>
            </div>
          </div>
        </div>
      </div>  

      <div class="modal fade" id="aiModal" tabindex="-1" aria-labelledby="aiModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiModalLabel">AI优化结果</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <textarea id="ai-result" class="form-control" rows="8"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="apply-ai-result">应用到当前页</button>
            </div>
          </div>
        </div>
      </div>
    
      <div class="modal fade" id="aiLearnModal" tabindex="-1" aria-labelledby="aiLearnModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiLearnModalLabel">AI 学习助手</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-lg-6">
                  <label for="ai-learn-content" class="form-label">学习内容</label>
                  <textarea id="ai-learn-content" class="form-control" rows="8" placeholder="在此输入或粘贴想要学习的内容"></textarea>
                  <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted" id="ai-learn-content-hint">可自动捕获选中内容；包含图片时会尝试内嵌为 data URL。</small>
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="ai-learn-fill-selection">获取选中内容</button>
                  </div>
                </div>
                <div class="col-lg-6">
                  <label for="ai-learn-context" class="form-label">上下文（可选）</label>
                  <textarea id="ai-learn-context" class="form-control" rows="8" placeholder="添加额外背景、页面内容或你的学习目标，以便获得更精确的回答。"></textarea>
                  <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">上下文会一并发送给 AI，可包含当前页 LaTeX、笔记、讲稿等信息。</small>
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="ai-learn-fetch-context">获取上下文</button>
                  </div>
                </div>
              </div>
              <hr class="my-3">
              <div class="ai-learn-temp-card surface-card mb-3 p-3 p-md-4">
                <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                  <div>
                    <h6 class="mb-1">临时提示词</h6>
                    <small>不写死在提示库，自动套用“学习内容 / 上下文”，支持 {content} 与 {context} 占位符。</small>
                  </div>
                  <div class="d-flex align-items-center gap-2 ai-learn-temp-actions">
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="ai-learn-temp-reset">恢复默认</button>
                    <button class="btn btn-sm btn-primary" type="button" id="ai-learn-run-temp">使用临时提示词</button>
                  </div>
                </div>
                <textarea id="ai-learn-temp-prompt" class="form-control mt-3" rows="4" placeholder="例如：用费曼技巧讲解上述内容，拆成提纲、要点和练习题，并生成 3 个自测问题。支持 {content}/{context} 占位符。"></textarea>
              </div>
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h6 class="mb-0">默认提示词</h6>
                <div class="d-flex align-items-center gap-2">
                  <button class="btn btn-sm btn-outline-secondary" type="button" id="ai-learn-refresh-prompts">刷新</button>
                </div>
              </div>
              <div id="ai-learn-default-prompts" class="d-flex flex-wrap gap-2 mt-2"></div>
              <div class="mt-4 d-flex justify-content-between align-items-center flex-wrap gap-2">
                <h6 class="mb-0">自定义提示词</h6>
                <button class="btn btn-sm btn-outline-primary" type="button" id="ai-learn-add-prompt">新增提示词</button>
              </div>
              <div id="ai-learn-custom-prompts" class="d-flex flex-column gap-2 mt-2"></div>
              <div class="alert alert-accent my-3 mb-0">
                可直接填写上方“临时提示词”或点击任意提示词即可开始学习，进度会在后台运行。结果准备就绪后会自动弹窗提醒，你可以在弹窗中立即收藏、分类或应用到页面。
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="aiLearnPromptModal" tabindex="-1" aria-labelledby="aiLearnPromptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiLearnPromptModalLabel">新增提示词</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="ai-learn-prompt-name" class="form-label">名称</label>
                <input type="text" class="form-control" id="ai-learn-prompt-name" placeholder="例如：雅思口语练习">
              </div>
              <div class="mb-3">
                <label for="ai-learn-prompt-description" class="form-label">用途描述（可选）</label>
                <input type="text" class="form-control" id="ai-learn-prompt-description" placeholder="提示词的适用场景或目标">
              </div>
              <div class="mb-3">
                <label for="ai-learn-prompt-system" class="form-label">系统提示（可选）</label>
                <textarea id="ai-learn-prompt-system" class="form-control" rows="3" placeholder="指定 AI 扮演的角色或总体风格，留空则使用默认导师提示。"></textarea>
              </div>
              <div class="mb-3">
                <label for="ai-learn-prompt-template" class="form-label">用户提示模板</label>
                <textarea id="ai-learn-prompt-template" class="form-control" rows="8" placeholder="可以使用 {content} 和 {context} 作为占位符。"></textarea>
                <div class="form-text">模板示例：<code>请分析以下内容：\n{content}\n\n上下文：\n{context}</code></div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="ai-learn-prompt-save">保存</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="aiLearnResultModal" tabindex="-1" aria-labelledby="aiLearnResultModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <div>
                <h5 class="modal-title" id="aiLearnResultModalLabel">AI 学习结果</h5>
                <div class="text-muted small" id="ai-learn-result-meta"></div>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="ai-learn-result-text" class="form-label">学习结果</label>
                <textarea id="ai-learn-result-text" class="form-control" rows="14"></textarea>
              </div>
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label for="ai-learn-result-method" class="form-label">学习方法（可选）</label>
                  <input type="text" id="ai-learn-result-method" class="form-control" placeholder="例：费曼技巧、番茄复盘...">
                </div>
                <div class="col-md-4">
                  <label for="ai-learn-result-category" class="form-label">分类</label>
                  <input type="text" id="ai-learn-result-category" class="form-control" list="ai-learn-category-options" placeholder="输入或选择一个分类">
                  <datalist id="ai-learn-category-options"></datalist>
                </div>
                <div class="col-md-4">
                  <div class="form-check mt-4 pt-1">
                    <input class="form-check-input" type="checkbox" id="ai-learn-result-favorite">
                    <label class="form-check-label" for="ai-learn-result-favorite">收藏，长期保留</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer flex-wrap gap-2">
              <button type="button" class="btn btn-outline-secondary" id="ai-learn-result-copy">复制</button>
              <button type="button" class="btn btn-outline-primary" id="ai-learn-result-apply">一键替换</button>
              <button type="button" class="btn btn-primary" id="ai-learn-result-save">保存记录</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="aiLearnReviewModal" tabindex="-1" aria-labelledby="aiLearnReviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <div>
                <h5 class="modal-title" id="aiLearnReviewModalLabel">AI 复习</h5>
                <p class="text-muted small mb-0">按学习方法、分类关键词、搜索或收藏状态，快速复盘历史学习成果。</p>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3 align-items-end">
                <div class="col-lg-7 col-12">
                  <label for="ai-learn-review-search" class="form-label">搜索</label>
                  <input type="search" id="ai-learn-review-search" class="form-control" placeholder="输入关键字（内容 / 提示词 / 方法 / 分类）">
                </div>
                <div class="col-lg-5 col-12">
                  <label for="ai-learn-review-method" class="form-label">学习方法</label>
                  <select id="ai-learn-review-method" class="form-select">
                    <option value="">全部方法</option>
                  </select>
                </div>
              </div>
              <div class="d-flex flex-wrap align-items-center gap-3 mt-3">
                <div class="form-check mb-0">
                  <input class="form-check-input" type="checkbox" id="ai-learn-review-favorite">
                  <label class="form-check-label" for="ai-learn-review-favorite">仅看收藏</label>
                </div>
                <div class="form-check mb-0">
                  <input class="form-check-input" type="checkbox" id="ai-learn-review-due">
                  <label class="form-check-label" for="ai-learn-review-due">仅看到期</label>
                </div>
              </div>
              <div class="alert alert-accent mt-3 mb-2 py-2 small" id="ai-learn-review-hint">
                收藏的学习结果会永久保留，未收藏的会在 30 天后自动清理。点击“复习”将打开顶层复习卡片，可记录笔记并安排下一次复习。
              </div>
              <div id="ai-learn-review-empty" class="text-center text-muted small py-4">暂无学习记录，完成一次 AI 学习后即可在此复盘。</div>
              <div id="ai-learn-review-list" class="d-flex flex-column gap-3"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade review-session-top" id="aiLearnReviewSessionModal" tabindex="-1" aria-labelledby="aiLearnReviewSessionModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <div>
                <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                  <span class="badge bg-primary-subtle text-primary review-badge d-none" id="ai-review-category-badge"></span>
                  <span class="badge bg-secondary-subtle text-secondary review-badge d-none" id="ai-review-method-badge"></span>
                  <span class="badge bg-warning-subtle text-dark review-badge d-none" id="ai-review-due-badge"></span>
                  <span class="badge bg-success-subtle text-success review-badge d-none" id="ai-review-status-badge"></span>
                  <span class="badge review-badge d-none" id="ai-review-last-badge"></span>
                </div>
                <h5 class="modal-title" id="aiLearnReviewSessionModalLabel">复习模式</h5>
                <div class="text-muted small" id="ai-review-meta">根据历史学习结果生成复习卡片，记录复盘过程。</div>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-lg-7">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="text-muted small">知识卡片</div>
                    <div class="d-flex gap-2">
                      <button type="button" class="btn btn-sm btn-outline-secondary" id="ai-review-copy-output">复制</button>
                    </div>
                  </div>
                  <div class="review-surface" id="ai-review-output"></div>
                  <button class="btn btn-sm btn-outline-secondary mt-3 review-prompt-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#ai-review-input-collapse" aria-expanded="false" aria-controls="ai-review-input-collapse">
                    查看原始输入 / 上下文
                  </button>
                  <div class="collapse mt-2" id="ai-review-input-collapse">
                    <div class="text-muted small mb-1">学习输入</div>
                    <div class="review-surface review-mini-text mb-2" id="ai-review-input"></div>
                    <div class="text-muted small mb-1">上下文</div>
                    <div class="review-surface review-mini-text" id="ai-review-context"></div>
                  </div>
                </div>
                <div class="col-lg-5">
                  <div class="mb-3">
                    <label class="form-label" for="ai-review-note">复习笔记</label>
                    <textarea class="form-control review-note" id="ai-review-note" rows="6" placeholder="记录新的例子、未掌握的点、记忆钩子..."></textarea>
                  </div>
                  <div class="mb-3">
                    <label class="form-label" for="ai-review-category">分类（可编辑）</label>
                    <input type="text" class="form-control" id="ai-review-category" list="ai-learn-category-options" placeholder="输入或选择分类">
                    <div class="form-text">修改后会同步更新记录，方便筛选。</div>
                  </div>
                  <div class="review-meta-card mb-3">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <div class="text-muted small">上次复习</div>
                        <div class="fw-semibold" id="ai-review-last">未复习</div>
                      </div>
                      <div class="text-end">
                        <div class="text-muted small">下次复习</div>
                        <div class="fw-semibold" id="ai-review-next">尚未排期</div>
                      </div>
                    </div>
                    <div class="text-muted small mt-2" id="ai-review-interval"></div>
                  </div>
                  <div class="d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-outline-secondary flex-grow-1" id="ai-review-save-note">保存笔记</button>
                  </div>
                </div>
              </div>
              <div class="mt-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                  <div class="text-muted small" id="ai-review-hint">选择符合记忆状态的按钮即可记录复习效果并安排下一次复习。</div>
                  <div class="badge bg-info text-dark review-badge d-none" id="ai-review-session-status"></div>
                </div>
                <div class="d-flex gap-2 flex-column flex-md-row">
                  <button type="button" class="btn btn-outline-danger review-score-btn" data-review-score="again">再来（效果 1）</button>
                  <button type="button" class="btn btn-outline-warning review-score-btn" data-review-score="hard">较难（效果 2）</button>
                  <button type="button" class="btn btn-outline-success review-score-btn" data-review-score="good">良好（效果 4）</button>
                  <button type="button" class="btn btn-outline-primary review-score-btn" data-review-score="easy">轻松（效果 5）</button>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <div class="text-muted small me-auto" id="ai-review-footnote"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="aiAssistantModal" tabindex="-1" aria-labelledby="aiAssistantModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <div>
                <h5 class="modal-title" id="aiAssistantModalLabel">AI 助理</h5>
                <div class="text-muted small" id="ai-assistant-rag-hint">索引当前已解锁工作区的 Markdown 笔记，可切换仅当前页；也可以手动填写问答并保存到 AI 复习。</div>
              </div>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="ai-assistant-message" class="form-label">我的问题</label>
                <textarea id="ai-assistant-message" class="form-control" rows="5" placeholder="输入要询问的问题，或粘贴需要总结/整理的内容"></textarea>
              </div>
              <div class="d-flex align-items-center gap-3 flex-wrap mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="ai-assistant-use-rag" checked>
                  <label class="form-check-label" for="ai-assistant-use-rag">使用 RAG（Markdown 笔记）</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="ai-assistant-page-only" disabled>
                  <label class="form-check-label" for="ai-assistant-page-only">仅当前页 Markdown</label>
                </div>
                <div class="small ai-assistant-status ai-assistant-status--muted" id="ai-assistant-status">准备就绪</div>
              </div>
              <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                  <label class="form-label mb-0">回复（可编辑后保存到复习）</label>
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary" id="ai-assistant-save">保存到 AI 复习</button>
                    <button type="button" class="btn btn-outline-secondary" id="ai-assistant-copy">复制</button>
                  </div>
                </div>
                <textarea id="ai-assistant-answer" class="form-control ai-assistant-answer" placeholder="AI 回复会出现在这里，也可手动输入答案后直接保存"></textarea>
              </div>
              <div class="mb-2 d-flex justify-content-between align-items-center">
                <div class="form-label mb-0">命中的上下文</div>
                <span class="badge ai-assistant-context-count" id="ai-assistant-context-count">0</span>
              </div>
              <div class="text-muted small mb-2">仅索引 Markdown，默认展示最相关的 3 条，其余折叠；若为空则自动回退为普通对话。</div>
              <div id="ai-assistant-contexts"></div>
            </div>
            <div class="modal-footer">
              <div class="text-muted small me-auto" id="ai-assistant-meta"></div>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="ai-assistant-run">发送</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Attachment Preview Modal -->
      <div class="modal fade" id="attachmentPreviewModal" tabindex="-1" aria-labelledby="attachmentPreviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="attachmentPreviewModalLabel">附件预览</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
              <img id="attachment-preview-image" src="" alt="preview" class="img-fluid" style="max-height:70vh;" />
              <div class="text-muted small mt-2" id="attachment-preview-meta"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <a id="attachment-preview-open" href="#" target="_blank" class="btn btn-primary">新标签页打开</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Attachment Rename Modal -->
      <div class="modal fade" id="attachmentRenameModal" tabindex="-1" aria-labelledby="attachmentRenameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="attachmentRenameModalLabel">重命名附件</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="attachment-rename-input" class="form-label">新文件名</label>
                <input type="text" class="form-control" id="attachment-rename-input" />
                <div class="form-text">名称会自动清理非法字符，请保留正确的扩展名。</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="attachment-rename-confirm">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Create Modal -->
      <div class="modal fade" id="projectCreateModal" tabindex="-1" aria-labelledby="projectCreateModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectCreateModalLabel">新建项目</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <label for="project-create-name" class="form-label">项目名称</label>
              <input type="text" class="form-control" id="project-create-name" placeholder="请输入项目名称" />
              <div class="form-text">名称仅支持字母、数字、下划线和中划线。</div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-create-confirm">创建</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Rename Modal -->
      <div class="modal fade" id="projectRenameModal" tabindex="-1" aria-labelledby="projectRenameModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectRenameModalLabel">重命名项目</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="mb-2" id="project-rename-current"></p>
              <label for="project-rename-name" class="form-label">新名称</label>
              <input type="text" class="form-control" id="project-rename-name" placeholder="请输入新名称" />
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-rename-confirm">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Delete Modal -->
      <div class="modal fade" id="projectDeleteModal" tabindex="-1" aria-labelledby="projectDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectDeleteModalLabel">删除项目</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p class="text-danger" id="project-delete-warning">此操作无法撤销。</p>
              <label for="project-delete-confirm-name" class="form-label">请输入项目名称以确认删除</label>
              <input type="text" class="form-control" id="project-delete-confirm-name" />
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-danger" id="project-delete-confirm">删除</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Password Modal -->
      <div class="modal fade" id="projectPasswordModal" tabindex="-1" aria-labelledby="projectPasswordModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectPasswordModalLabel">工作区密码</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label for="project-password-current" class="form-label">当前密码（若已有密码）</label>
                <input type="password" class="form-control" id="project-password-current" autocomplete="current-password" />
              </div>
              <div class="mb-3">
                <label for="project-password-new" class="form-label">新密码</label>
                <input type="password" class="form-control" id="project-password-new" autocomplete="new-password" />
              </div>
              <div class="mb-3">
                <label for="project-password-confirm" class="form-label">确认新密码</label>
                <input type="password" class="form-control" id="project-password-confirm" autocomplete="new-password" />
              </div>
              <div class="alert alert-warning d-none" id="project-password-warning"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-danger me-auto" id="project-password-remove">移除密码</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-password-save">保存</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Project Unlock Modal -->
      <div class="modal fade" id="projectUnlockModal" tabindex="-1" aria-labelledby="projectUnlockModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="projectUnlockModalLabel">解锁工作区</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <p id="project-unlock-target" class="mb-2"></p>
              <label for="project-unlock-password" class="form-label">输入工作区密码</label>
              <input type="password" class="form-control" id="project-unlock-password" autocomplete="current-password" />
              <div class="alert alert-danger d-none mt-3" id="project-unlock-error"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
              <button type="button" class="btn btn-primary" id="project-unlock-confirm">解锁</button>
            </div>
          </div>
        </div>
      </div>

      <!-- LLM Settings Modal -->
      <div class="modal fade" id="llmModal" tabindex="-1" aria-labelledby="llmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="llmModalLabel">模型配置</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label fw-semibold">选择提供方</label>
                <div id="llm-modal-provider-list" class="d-flex flex-column gap-2"></div>
              </div>
              <div class="accordion" id="llmConfigAccordion">
                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingChat">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseChat" aria-expanded="true" aria-controls="collapseChat">
                      聊天模型
                    </button>
                  </h2>
                  <div id="collapseChat" class="accordion-collapse collapse show" aria-labelledby="headingChat" data-bs-parent="#llmConfigAccordion">
                    <div class="accordion-body">
                      <div class="mb-3">
                        <label class="form-label fw-semibold" for="llm-modal-provider-select-chat">提供方</label>
                        <select class="form-select" id="llm-modal-provider-select-chat"></select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label fw-semibold" for="llm-modal-model-select">模型</label>
                        <select class="form-select" id="llm-modal-model-select"></select>
                        <div class="form-text" id="llm-modal-model-hint">选择后将随项目保存，前端调用同一模型。</div>
                      </div>
                      <div class="mb-3 small">
                        <div>
                          API Key 环境变量：
                          <code id="llm-modal-api-env">--</code>
                          <span class="badge bg-secondary ms-2" id="llm-modal-api-status">未检测</span>
                        </div>
                        <div class="mt-1 text-muted" id="llm-modal-endpoint"></div>
                      </div>
                      <div class="surface-card p-2 small">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                          <button type="button" class="btn btn-outline-primary btn-sm" id="llm-modal-test-btn">连通性测试</button>
                          <span class="flex-grow-1 text-muted" id="llm-modal-test-result"></span>
                        </div>
                        <div class="mt-2 text-muted">
                          测试会发送最小化请求验证聊天接口可用性。
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingEmbed">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmbed" aria-expanded="false" aria-controls="collapseEmbed">
                      Embedding
                    </button>
                  </h2>
                  <div id="collapseEmbed" class="accordion-collapse collapse" aria-labelledby="headingEmbed" data-bs-parent="#llmConfigAccordion">
                    <div class="accordion-body">
                      <div class="mb-3">
                        <label class="form-label fw-semibold" for="llm-embed-provider">提供方</label>
                        <select class="form-select" id="llm-embed-provider"></select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label fw-semibold" for="llm-embed-model">Embedding 模型</label>
                        <input type="text" class="form-control" id="llm-embed-model" list="llm-embed-model-options" placeholder="如 text-embedding-3-large">
                        <datalist id="llm-embed-model-options"></datalist>
                        <div class="form-text" id="llm-modal-embedding-hint">可选内置或自定义；留空则使用提供方默认 embedding。</div>
                      </div>
                      <div class="small mb-2" id="llm-embed-endpoint"></div>
                      <div class="surface-card p-2 small">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                          <button type="button" class="btn btn-outline-primary btn-sm" id="llm-embed-test-btn">测试 Embedding</button>
                          <span class="flex-grow-1 text-muted" id="llm-embed-test-result"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item">
                  <h2 class="accordion-header" id="headingTts">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTts" aria-expanded="false" aria-controls="collapseTts">
                      TTS
                    </button>
                  </h2>
                  <div id="collapseTts" class="accordion-collapse collapse" aria-labelledby="headingTts" data-bs-parent="#llmConfigAccordion">
                    <div class="accordion-body">
                      <div class="mb-3">
                        <label class="form-label fw-semibold" for="llm-tts-provider">提供方</label>
                        <select class="form-select" id="llm-tts-provider"></select>
                      </div>
                      <div class="mb-3">
                        <label class="form-label fw-semibold" for="llm-tts-model">TTS 模型</label>
                        <input type="text" class="form-control" id="llm-tts-model" list="llm-tts-model-options" placeholder="如 tts-1">
                        <datalist id="llm-tts-model-options"></datalist>
                        <div class="form-text" id="llm-modal-tts-hint">可选内置或自定义；留空则使用提供方默认 TTS。</div>
                      </div>
                      <div class="small mb-2" id="llm-tts-endpoint"></div>
                      <div class="surface-card p-2 small">
                        <div class="d-flex flex-wrap align-items-center gap-2">
                          <button type="button" class="btn btn-outline-primary btn-sm" id="llm-tts-test-btn">测试 TTS</button>
                          <span class="flex-grow-1 text-muted" id="llm-tts-test-result"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Script Modal (optimized speaking script) -->
      <div class="modal fade" id="aiScriptModal" tabindex="-1" aria-labelledby="aiScriptModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="aiScriptModalLabel">讲稿 AI 优化结果</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <textarea id="ai-script-result" class="form-control" rows="8"></textarea>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="apply-ai-script-result">应用到当前讲稿</button>
            </div>
          </div>
        </div>
      </div>
<div class="container-fluid" id="main-layout">
  <div id="editor-preview-wrapper">
    <div class="editor-pane">
      
      <form id="tex-form" class="flex-grow-1 d-flex flex-column">
        <div id="editor-container">
          <div id="pages-list"></div>
        </div>
      </form>

      <div class="modal fade" id="tabsModal" tabindex="-1" aria-labelledby="tabsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="tabsModalLabel">页面拖拽排序</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="page-tabs" class="d-flex flex-wrap"></div>
              <div class="text-muted mt-2">拖动页码标签可调整顺序，点击页码可跳转</div>
              <div class="d-flex flex-wrap gap-2 mt-3" id="tabs-actions">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="tabs-copy-page-id">复制 pageId</button>
                <button type="button" class="btn btn-outline-danger btn-sm" id="tabs-delete-page">删除当前页</button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="tabs-copy-page-link">复制打开链接</button>
              </div>
              <div class="form-text mt-1" id="tabs-actions-hint">复制后的链接包含项目与 pageId，可分享给他人直接打开该页。</div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="componentModal" tabindex="-1" aria-labelledby="componentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="componentModalLabel">插入常用页面组件</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="list-group" id="component-list">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="templateModal" tabindex="-1" aria-labelledby="templateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="templateModalLabel">编辑样式模板</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">选择基础模板</label>
                <select id="template-select" class="form-select mb-2">
                  <option value="">自定义（当前模板）</option>
                </select>
                <div class="form-text" id="template-helper-text">选择后仍可在下方继续调整。</div>
              </div>
              <div id="template-latex-fields">
                <label class="form-label">文档头部（第一页前）</label>
                <textarea id="template-header" class="form-control mb-2" rows="4"></textarea>
                <label class="form-label">文档主体（每页前）</label>
                <textarea id="template-before-pages" class="form-control mb-2" rows="2"></textarea>
                <label class="form-label">文档结尾（最后一页后）</label>
                <textarea id="template-footer" class="form-control" rows="2"></textarea>
              </div>
              <div id="template-markdown-fields" class="d-none">
                <label class="form-label">Markdown 全局 CSS</label>
                <textarea id="template-markdown-css" class="form-control mb-2" rows="10" placeholder="为预览页面定义全局样式"></textarea>
                <div class="form-text">CSS 会实时应用于右侧预览，同时随项目一同保存。</div>
                <label class="form-label">预览容器附加 class（可选）</label>
                <input type="text" id="template-markdown-wrapper" class="form-control mb-2" placeholder="例如：markdown-note prose">
                <div class="form-text">指定多个 class 时使用空格分隔，将添加在 Markdown 预览根节点上。</div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
              <button type="button" class="btn btn-primary" id="save-template">保存模板</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="markdown-sync-toggle-wrapper">
      <button type="button" id="markdown-sync-toggle" class="markdown-sync-toggle" aria-label="切换 Markdown 编辑器与预览的同步滚动" aria-pressed="false">
        <span aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 20 20" role="presentation" focusable="false">
            <path d="M6.2 10a2.3 2.3 0 0 1 0-3.25l2.1-2.1a2.3 2.3 0 0 1 3.25 0c.9.9.9 2.35 0 3.25l-.9.9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M13.8 10a2.3 2.3 0 0 1 0 3.25l-2.1 2.1a2.3 2.3 0 0 1-3.25 0c-.9-.9-.9-2.35 0-3.25l.9-.9" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="8" y1="10" x2="12" y2="10" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </span>
        <span class="visually-hidden">同步预览</span>
      </button>
    </div>

    <div class="preview-pane">
      
      <div id="pdf-container" class="d-none">
        <div id="pdf-pages" class="w-100 d-flex flex-column align-items-center gap-3"></div>
      </div>
      <div id="markdown-preview">
        <div id="markdown-preview-content" class="markdown-preview-content"></div>
      </div>
    </div>
  </div>

  <div class="page-script-container">
    <textarea id="page-script" class="form-control" rows="4" placeholder="这里是本页的讲稿，支持导出语音。"></textarea>
  </div>
  
  <!-- Export Modal -->
  <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exportModalLabel">导出选项</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportPagePdfOption" value="page_pdf" checked>
            <label class="form-check-label" for="exportPagePdfOption">导出 当前页 PDF</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportPageNotesOption" value="page_notes">
            <label class="form-check-label" for="exportPageNotesOption">导出 当前页 Markdown</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportPageNotesHtmlOption" value="page_notes_html">
            <label class="form-check-label" for="exportPageNotesHtmlOption">导出 当前页 HTML</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportPageAudioOption" value="page_audio">
            <label class="form-check-label" for="exportPageAudioOption">导出 当前页讲稿语音 (MP3)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportNotesOption" value="notes">
            <label class="form-check-label" for="exportNotesOption">导出 全部页 Markdown</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportNotesHtmlOption" value="notes_html">
            <label class="form-check-label" for="exportNotesHtmlOption">导出 全部页 HTML</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportTexOption" value="tex">
            <label class="form-check-label" for="exportTexOption">导出 全部页 TeX</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportLearnOption" value="learn">
            <label class="form-check-label" for="exportLearnOption">导出 学习复习记录 (YAML)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportProjectDataOption" value="project_bundle_data">
            <label class="form-check-label" for="exportProjectDataOption">导出 工作区文件（.benort）</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="exportOption" id="exportAudioOption" value="audio">
            <label class="form-check-label" for="exportAudioOption">导出 完整讲稿语音 (MP3)</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          <button type="button" class="btn btn-primary" id="doExportBtn">开始导出</button>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="markdownImageModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-body">
        <div class="image-wrapper">
          <img id="markdownImageModalImg" class="img-fluid" alt="">
        </div>
        <div id="markdownImageCaption" class="d-none"></div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="markdownTableModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-xl">
    <div class="modal-content">
      <div class="modal-body">
        <div id="markdownTableModalBody"></div>
        <div id="markdownTableModalCaption" class="d-none"></div>
      </div>
    </div>
  </div>
</div>


























<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/stex/stex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/markdown/markdown.min.js"></script>
<script src="{{ url_for('static', filename='vendor/marked.min.js') }}"></script>
<script>
  if (typeof window.marked === 'undefined') {
    document.write('<script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"><\\/script>');
  }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script>
  if (window.hljs) {
    hljs.configure({ignoreUnescapedHTML: true});
  }
</script>
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      processEscapes: true
    },
    svg: { fontCache: 'global' }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  marked.setOptions({
    breaks: true,
    gfm: true,
    highlight: function(code, lang) {
      if (window.hljs) {
        try {
          if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, {language: lang}).value;
          }
          return hljs.highlightAuto(code).value;
        } catch (err) {
          console.warn('代码高亮失败', err);
        }
      }
      return code;
    }
  });

  (function registerMarkdownCallouts() {
    const CALLOUT_TYPE_PATTERN = /:::(info|tip|warning)/i;
    const CALLOUT_BLOCK_PATTERN = /^:::(info|tip|warning)(?:[^\S\r\n]+([^\n]+))?\r?\n([\s\S]+?)\r?\n:::(?:[^\S\r\n]*(?=\r?\n|$))/i;
    const calloutExtension = {
      name: 'markdownCallout',
      level: 'block',
      start(src) {
        const match = src.match(CALLOUT_TYPE_PATTERN);
        return match ? match.index : undefined;
      },
      tokenizer(src) {
        const match = CALLOUT_BLOCK_PATTERN.exec(src);
        if (!match) return undefined;
        return {
          type: 'markdownCallout',
          raw: match[0],
          calloutType: match[1].toLowerCase(),
          title: match[2] ? match[2].trim() : '',
          text: match[3] || '',
        };
      },
      renderer(token) {
        const type = token.calloutType || 'info';
        const titleHtml = token.title
          ? `<div class="markdown-callout-title">${marked.parseInline(token.title)}</div>`
          : '';
        const bodyHtml = token.text ? marked.parse(token.text) : '';
        return `<div class="markdown-callout ${type}">${titleHtml}<div class="markdown-callout-body">${bodyHtml}</div></div>`;
      },
    };
    marked.use({ extensions: [calloutExtension] });
  })();

  function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    return String(text).replace(/[&<"'>]/g, function(ch) {
      switch (ch) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return ch;
      }
    });
  }

  function highlightExcerptText(excerpt, query) {
    if (!excerpt) return '';
    if (!query) return escapeHtml(excerpt);
    try {
      const escapedQuery = query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
      if (!escapedQuery) return escapeHtml(excerpt);
      const regex = new RegExp(escapedQuery, 'gi');
      let cursor = 0;
      let html = '';
      let match;
      while ((match = regex.exec(excerpt)) !== null) {
        const chunk = excerpt.slice(cursor, match.index);
        html += escapeHtml(chunk);
        html += '<mark>' + escapeHtml(match[0]) + '</mark>';
        cursor = match.index + match[0].length;
        if (regex.lastIndex === match.index) {
          regex.lastIndex += 1;
        }
      }
      html += escapeHtml(excerpt.slice(cursor));
      return html || escapeHtml(excerpt);
    } catch (err) {
      return escapeHtml(excerpt);
    }
  }

  // Action bubble helpers (used for card hover/menus)
  let activeActionBubble = null;
  let activeActionBubbleAnchor = null;

  function closeActionBubble() {
    if (activeActionBubble) {
      activeActionBubble.remove();
      activeActionBubble = null;
    }
    if (activeActionBubbleAnchor) {
      activeActionBubbleAnchor.classList.remove('actionable-card--active');
      activeActionBubbleAnchor = null;
    }
    document.removeEventListener('click', handleActionBubbleOutside, true);
    document.removeEventListener('keydown', handleActionBubbleKeydown, true);
    window.removeEventListener('resize', handleActionBubbleWindowChange);
    window.removeEventListener('scroll', handleActionBubbleWindowChange, true);
  }

  function handleActionBubbleOutside(event) {
    if (!activeActionBubble) return;
    if (activeActionBubble.contains(event.target)) return;
    if (activeActionBubbleAnchor && activeActionBubbleAnchor.contains(event.target)) return;
    closeActionBubble();
  }

  function handleActionBubbleKeydown(event) {
    if (event.key === 'Escape') {
      closeActionBubble();
    }
  }

  function handleActionBubbleWindowChange() {
    if (!activeActionBubble || !activeActionBubbleAnchor) {
      closeActionBubble();
      return;
    }
    positionActionBubble(activeActionBubble, activeActionBubbleAnchor);
  }

  function resolveActionBubbleButtonClass(action) {
    const base = ['btn', 'btn-sm', 'action-bubble__btn'];
    const variant = (action && action.variant) || 'outline-primary';
    switch (variant) {
      case 'primary':
        base.push('btn-primary');
        break;
      case 'danger':
        base.push('btn-danger');
        break;
      case 'warning':
        base.push('btn-warning');
        break;
      case 'outline-secondary':
        base.push('btn-outline-secondary');
        break;
      case 'outline-success':
        base.push('btn-outline-success');
        break;
      case 'outline-danger':
        base.push('btn-outline-danger');
        break;
      case 'outline-primary':
      default:
        base.push('btn-outline-primary');
        break;
    }
    return base.join(' ');
  }

  function positionActionBubble(bubble, anchor) {
    if (!bubble || !anchor) return;
    bubble.style.left = '-9999px';
    bubble.style.top = '-9999px';
    bubble.classList.remove('action-bubble--align-left');
    const rect = anchor.getBoundingClientRect();
    const bubbleRect = bubble.getBoundingClientRect();
    const viewportWidth = document.documentElement.clientWidth;
    const viewportScrollY = window.scrollY || window.pageYOffset || 0;
    const viewportScrollX = window.scrollX || window.pageXOffset || 0;
    const margin = 14;
    let left = viewportScrollX + rect.right + margin;
    let top = viewportScrollY + rect.top + rect.height / 2 - bubbleRect.height / 2;

    if (left + bubbleRect.width > viewportScrollX + viewportWidth - margin) {
      left = viewportScrollX + rect.left - bubbleRect.width - margin;
      bubble.classList.add('action-bubble--align-left');
    }
    const maxTop = viewportScrollY + window.innerHeight - bubbleRect.height - margin;
    const minTop = viewportScrollY + margin;
    if (top < minTop) top = minTop;
    if (top > maxTop) top = maxTop;
    bubble.style.left = `${Math.max(left, viewportScrollX + margin)}px`;
    bubble.style.top = `${top}px`;
  }

  function openActionBubble(anchorElement, actions) {
    if (!anchorElement) return;
    const resolved = typeof actions === 'function' ? actions(anchorElement) : actions;
    const list = Array.isArray(resolved) ? resolved.filter(Boolean) : [];
    if (!list.length) {
      closeActionBubble();
      return;
    }
    if (activeActionBubbleAnchor === anchorElement) {
      closeActionBubble();
      return;
    }
    closeActionBubble();
    const bubble = document.createElement('div');
    bubble.className = 'action-bubble';
    list.forEach(action => {
      const label = typeof action?.label === 'function' ? action.label(anchorElement) : action?.label;
      if (!label) return;
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = resolveActionBubbleButtonClass(action);
      if (action?.title) {
        btn.title = action.title;
      }
      if (action?.disabled) {
        btn.disabled = true;
      }
      const icon = action?.icon ? String(action.icon).trim() : '';
      const text = String(label).trim();
      btn.textContent = icon ? `${icon} ${text}` : text;
      btn.addEventListener('click', event => {
        event.stopPropagation();
        if (btn.disabled) return;
        closeActionBubble();
        if (typeof action?.onClick === 'function') {
          action.onClick(anchorElement, action);
        }
      });
      bubble.appendChild(btn);
    });
    if (!bubble.childElementCount) {
      return;
    }
    document.body.appendChild(bubble);
    activeActionBubble = bubble;
    activeActionBubbleAnchor = anchorElement;
    anchorElement.classList.add('actionable-card--active');
    positionActionBubble(bubble, anchorElement);
    requestAnimationFrame(() => bubble.classList.add('action-bubble--visible'));
    document.addEventListener('click', handleActionBubbleOutside, true);
    document.addEventListener('keydown', handleActionBubbleKeydown, true);
    window.addEventListener('resize', handleActionBubbleWindowChange);
    window.addEventListener('scroll', handleActionBubbleWindowChange, true);
  }

  function bindActionBubbleTrigger(element, actionsBuilder) {
    if (!element) return;
    element.classList.add('actionable-card');
    if (!element.hasAttribute('tabindex')) {
      element.setAttribute('tabindex', '0');
    }
    element.addEventListener('click', event => {
      if (event.defaultPrevented) return;
      if (event.target && activeActionBubble && activeActionBubble.contains(event.target)) {
        return;
      }
      const anchor = event.target.closest('a[href]');
      if (anchor) {
        if (event.metaKey || event.ctrlKey || anchor.dataset.actionBubbleAllowNav === 'true') {
          closeActionBubble();
          return;
        }
        event.preventDefault();
      }
      openActionBubble(element, typeof actionsBuilder === 'function' ? () => actionsBuilder(element, event) : actionsBuilder);
    });
    element.addEventListener('keydown', event => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        openActionBubble(element, typeof actionsBuilder === 'function' ? () => actionsBuilder(element, event) : actionsBuilder);
      } else if (event.key === 'Escape') {
        closeActionBubble();
      }
    });
  }


  function updatePageNumLabel() {
    const pageNumEl = document.getElementById('page-num');
    const pageCountEl = document.getElementById('page-count');
    const totalPages = Array.isArray(pagesData) ? pagesData.length : 0;
    const currentPageNumber = totalPages ? Math.min(currentPageIdx + 1, totalPages) : 0;
    if(pageNumEl) pageNumEl.textContent = currentPageNumber;
    if(pageCountEl) pageCountEl.textContent = totalPages;
  }

function jumpToPage(targetIdx) {
  if (!Array.isArray(pagesData) || !pagesData.length) return;
  let idx = Number(targetIdx);
  if (!Number.isFinite(idx)) idx = 0;
  idx = Math.trunc(idx);
  if (idx < 0) idx = 0;
  if (idx >= pagesData.length) idx = pagesData.length - 1;
  if (idx === currentPageIdx) return;
  currentPageIdx = idx;
  renderSingleEditor();
  updatePageNumLabel();
  refreshPreview();
}

  
  const COMPONENT_LIBRARY = window.BENORT_COMPONENT_LIBRARY || {};
  let markdownImageModalInstance = null;
  let markdownTableModalInstance = null;

  function getComponentGroups(mode) {
    if (mode === 'markdown') {
      return Array.isArray(COMPONENT_LIBRARY.markdown) ? COMPONENT_LIBRARY.markdown : [];
    }
    return Array.isArray(COMPONENT_LIBRARY.latex) ? COMPONENT_LIBRARY.latex : [];
  }

  document.getElementById('insert-component').onclick = function() {
    const list = document.getElementById('component-list');
    list.innerHTML = '';
    const mode = currentEditMode === 'markdown' ? 'markdown' : 'latex';
    const groups = getComponentGroups(mode);
    const modalLabel = document.getElementById('componentModalLabel');
    if (modalLabel) {
      modalLabel.textContent = mode === 'markdown' ? '插入 Markdown 片段' : '插入 LaTeX 组件';
    }
    if (!groups.length) {
      list.innerHTML = '<div class="text-center text-muted py-3">暂无可用组件</div>';
      const fallbackModal = new bootstrap.Modal(document.getElementById('componentModal'));
      fallbackModal.show();
      return;
    }

    const container = document.createElement('div');
    container.className = 'd-flex';
    const nav = document.createElement('div');
    nav.className = 'list-group me-3';
    nav.style.minWidth = '140px';
    const compArea = document.createElement('div');
    compArea.style.flex = '1';

    function renderCompList(idx) {
      compArea.innerHTML = '';
      const currentGroup = groups[idx];
      if (!currentGroup || !Array.isArray(currentGroup.items)) {
        compArea.innerHTML = '<div class="text-muted">该分类暂无片段</div>';
        return;
      }
      currentGroup.items.forEach(comp => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'list-group-item list-group-item-action mb-1 text-start';
        btn.textContent = comp.name;
        btn.onclick = function() {
          if(singleEditor) {
            const doc = singleEditor.getDoc();
            const cursor = doc.getCursor();
            const snippet = typeof comp.code === 'string' ? comp.code : '';
            let extra = '';
            if (!snippet.endsWith('\n')) {
              extra += '\n';
            }
            if (mode === 'markdown') {
              extra += '\n';
            }
            doc.replaceRange(snippet + extra, cursor);
          }
          const modalInstance = bootstrap.Modal.getInstance(document.getElementById('componentModal'));
          if (modalInstance) modalInstance.hide();
        };
        compArea.appendChild(btn);
      });
    }

    groups.forEach((group, idx) => {
      const navBtn = document.createElement('button');
      navBtn.type = 'button';
      navBtn.className = 'list-group-item list-group-item-action' + (idx === 0 ? ' active' : '');
      navBtn.textContent = group.group;
      navBtn.onclick = function() {
        Array.from(nav.children).forEach(btn => btn.classList.remove('active'));
        navBtn.classList.add('active');
        renderCompList(idx);
      };
      nav.appendChild(navBtn);
    });

    renderCompList(0);
    container.appendChild(nav);
    container.appendChild(compArea);
    list.appendChild(container);
    const modal = new bootstrap.Modal(document.getElementById('componentModal'));
    modal.show();
  };
  let pagesData = [];

  function generatePageId() {
    if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
      return crypto.randomUUID();
    }
    const rand = Math.random().toString(16).slice(2);
    return 'pg_' + rand + Date.now().toString(16);
  }
  let globalResources = [];
  let latexTemplate = {
    header: '\\documentclass{beamer}\n\\usepackage[utf8]{inputenc}\n\\usetheme{Madrid}',
    beforePages: '\\begin{document}',
    footer: '\\end{document}'
  };
  let markdownTemplate = {
    css: '',
    wrapperClass: ''
  };


  let currentPageIdx = 0;
  let singleEditor = null;
  const MARKDOWN_SCROLL_BLOCK_TYPES = new Set(['heading', 'paragraph', 'code', 'blockquote', 'list', 'table', 'hr', 'html']);
  const MARKDOWN_SCROLL_THRESHOLD = 3; // px tolerance to avoid jitter when syncing
  const MARKDOWN_HEADING_TYPES = new Set(['heading']);
  const markdownScrollSyncState = {
    anchors: [],
    boundEditor: null,
    editorHandler: null,
    rafHandle: 0,
    pendingEditor: null,
    sourceLineCount: 0,
    enabled: false,
    button: null,
    previewContainer: null,
    previewHandler: null,
    isSyncingFromEditor: false,
    isSyncingFromPreview: false,
    editorScroller: null,
    editorScrollHandler: null,
    editorCMHandler: null,
    lastScrollLeader: '',
    previewLeaderTimer: null
  };
  let currentEditMode = 'markdown';
  let currentProject = '';
  const INITIAL_URL_STATE = (() => {
    try {
      const url = new URL(window.location.href);
      const params = url.searchParams;
      const projectParam = (params.get('project') || params.get('proj') || '').trim();
      let combined = '';
      if (url.search) combined += url.search;
      if (url.hash) combined += url.hash;
      const deepLink = combined ? parseMarkdownInternalLink(combined) : null;
      return {project: projectParam, deepLink};
    } catch (err) {
      return {project: '', deepLink: null};
    }
  })();
  if (INITIAL_URL_STATE.project) {
    currentProject = INITIAL_URL_STATE.project;
  }
  let initialDeepLinkTarget = INITIAL_URL_STATE.deepLink;
  let initialDeepLinkApplied = false;
  let compileTimer = null;
  let isCompiling = false;
  let compilePending = false;
  let availableTemplates = { latex: [], markdown: [] };
  let templatesLoaded = false;
  let selectedTemplateName = { latex: '', markdown: '' };
  let saveProjectTimer = null;
  let saveRequestQueue = Promise.resolve();
  let pendingSaveCallbacks = [];
  let searchModalInstance = null;
  let searchResultsCache = [];
  let searchQueryCache = '';
  let searchAbortController = null;
  let searchRequestId = 0;
  let searchDebounceTimer = null;
  let markdownHeadingHighlightTimer = null;
  let markdownHeadingActiveEl = null;

  let resourceRenameTarget = null;
  let resourceRenameBasePath = '';
  let attachmentRenameTarget = null;
  let attachmentsCache = [];
  let attachmentsFilterTerm = '';
  let unusedAttachmentsCache = [];
  let clearingUnusedAttachments = false;
  const attachmentUrlIndex = new Map();
  let attachmentIndexPromise = null;
  let attachmentIndexWorkspaceId = '';
  const SCRIPT_ROOT = {{ request.script_root|tojson }} || '';
  function buildApiUrl(path){
    if(!path) return SCRIPT_ROOT || '';
    if(path.startsWith('http://') || path.startsWith('https://')) return path;
    if(path.startsWith('/')) return (SCRIPT_ROOT || '') + path;
    return (SCRIPT_ROOT || '') + '/' + path;
  }
  const PROJECT_ENDPOINTS = {
    project: null,
    projectSave: null,
  };
  const WORKSPACE_ENDPOINTS = {
    list: buildApiUrl('/workspaces'),
    open: buildApiUrl('/workspaces/open'),
    create: buildApiUrl('/workspaces/create'),
    discover: buildApiUrl('/workspaces/discover'),
    password: (workspaceId) => {
      if(!workspaceId) return null;
      return buildApiUrl(`/workspaces/${encodeURIComponent(workspaceId)}/password`);
    },
    unlock: (workspaceId) => {
      if(!workspaceId) return null;
      return buildApiUrl(`/workspaces/${encodeURIComponent(workspaceId)}/unlock`);
    },
  };
  const REMOTE_WORKSPACE_ENDPOINTS = {
    list: buildApiUrl('/workspaces/remote'),
    open: buildApiUrl('/workspaces/remote/open'),
    create: buildApiUrl('/workspaces/remote/create'),
  };
  let currentWorkspace = null;
  function workspaceIsCloud(){
    return !!(currentWorkspace && currentWorkspace.mode === 'cloud');
  }
  const workspaceChangeHandlers = [];
  function onWorkspaceChange(handler, options = {}) {
    if (typeof handler !== 'function') return;
    workspaceChangeHandlers.push(handler);
    if (options && options.immediate) {
      try {
        handler(currentWorkspace);
      } catch (err) {
        console.warn('workspace change handler error', err);
      }
    }
  }
  function notifyWorkspaceChangeHandlers() {
    workspaceChangeHandlers.forEach(handler => {
      try {
        handler(currentWorkspace);
      } catch (err) {
        console.warn('workspace change handler error', err);
      }
    });
  }
  let pendingDefaultWorkspace = window.BENORT_DEFAULT_WORKSPACE || null;
  let defaultWorkspaceApplied = false;
  let registeredWorkspaces = [];
  let workspaceAutoRestoreAttempted = false;
  let remoteWorkspaceMeta = {prefix: '', bucket: ''};
  let localWorkspaceRootPath = '';
  const workspaceModalEl = document.getElementById('workspaceModal');
  let workspaceModalInstance = null;
  if(workspaceModalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal){
    workspaceModalInstance = bootstrap.Modal.getOrCreateInstance(workspaceModalEl);
    workspaceModalEl.addEventListener('shown.bs.modal', () => {
      fetchLocalWorkspaceList();
    });
  }
  const workspaceOverlayStatus = document.getElementById('workspace-overlay-status');
  const workspaceCurrentInfo = document.getElementById('workspace-current-info');
  const workspaceCurrentName = document.getElementById('workspace-current-name');
  const workspaceCurrentPath = document.getElementById('workspace-current-path');
  const workspaceCloseBtn = document.getElementById('workspace-close-btn');
  const workspaceRefreshBtn = document.getElementById('workspace-refresh-btn');
  const localWorkspaceRefreshBtn = document.getElementById('local-workspace-refresh');
  const localWorkspaceStatusEl = document.getElementById('local-workspace-status');
  const localWorkspaceListEl = document.getElementById('local-workspace-list');
  const localWorkspaceCreateForm = document.getElementById('local-workspace-create-form');
  const localWorkspaceCreateNameInput = document.getElementById('local-workspace-create-name');
  const localWorkspaceCreateDisplayInput = document.getElementById('local-workspace-create-display');
  const localWorkspaceCreateStatusEl = document.getElementById('local-workspace-create-status');
  const localWorkspaceCreateHintEl = document.getElementById('local-workspace-create-hint');
  updateLocalWorkspaceCreateHint();
  const projectDropdownBtn = document.getElementById('project-dropdown');
  const projectMenuEl = document.getElementById('project-menu');
  const remoteWorkspaceModalEl = document.getElementById('remoteWorkspaceModal');
  let remoteWorkspaceModalInstance = null;
  if(remoteWorkspaceModalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal){
    remoteWorkspaceModalInstance = bootstrap.Modal.getOrCreateInstance(remoteWorkspaceModalEl);
  }
  const remoteWorkspaceListEl = document.getElementById('remote-workspace-list');
  const remoteWorkspaceStatusEl = document.getElementById('remote-workspace-status');
  const remoteWorkspaceRefreshBtn = document.getElementById('remote-workspace-refresh');
  const remoteWorkspaceCreateForm = document.getElementById('remote-workspace-create-form');
  const remoteWorkspaceCreateNameInput = document.getElementById('remote-workspace-create-name');
  const remoteWorkspaceCreateDisplayInput = document.getElementById('remote-workspace-create-display');
  const remoteWorkspacePrefixEl = document.getElementById('remote-workspace-prefix');

  function workspaceCloseEndpoint(id){
    return buildApiUrl(`/workspaces/${encodeURIComponent(id)}`);
  }

  function setWorkspaceOverlayMessage(message, variant = 'muted'){
    if(!workspaceOverlayStatus) return;
    workspaceOverlayStatus.textContent = message || '';
    workspaceOverlayStatus.className = `workspace-overlay-status text-${variant} small mb-2`;
    if(!message){
      workspaceOverlayStatus.classList.add('d-none');
    } else {
      workspaceOverlayStatus.classList.remove('d-none');
    }
  }

  function showWorkspaceOverlay(){
    if(workspaceModalInstance){
      workspaceModalInstance.show();
    } else if(workspaceModalEl){
      workspaceModalEl.classList.add('show');
      workspaceModalEl.style.display = 'block';
    }
  }

  function hideWorkspaceOverlay(){
    if(workspaceModalInstance){
      workspaceModalInstance.hide();
    } else if(workspaceModalEl){
      workspaceModalEl.classList.remove('show');
      workspaceModalEl.style.display = 'none';
    }
  }

  function normalizeWorkspace(handle){
    if(!handle) return null;
    const workspaceId = handle.workspace_id || handle.workspaceId || handle.workspace;
    if(!workspaceId) return null;
    return {
      workspace_id: workspaceId,
      display_name: handle.display_name || handle.displayName || handle.name || `Workspace ${workspaceId.slice(0, 6)}`,
      source: handle.source || '',
      localPath: handle.localPath || handle.local_path || '',
      remote_key: handle.remote_key || handle.remoteKey || null,
      mode: handle.mode || 'local',
      locked: Boolean(handle.locked),
      unlocked: handle.unlocked !== false,
    };
  }

  function getWorkspaceLockSuffix(handle){
    if(!handle || !handle.locked) return '';
    return handle.unlocked ? ' · 已解锁' : ' · 已加密';
  }

  function updateWorkspaceSecurityState(patch){
    if(!currentWorkspace) return;
    if(patch && Object.prototype.hasOwnProperty.call(patch, 'locked')){
      currentWorkspace.locked = !!patch.locked;
    }
    if(patch && Object.prototype.hasOwnProperty.call(patch, 'unlocked')){
      currentWorkspace.unlocked = !!patch.unlocked;
    }
    if(currentProject){
      projectMetadata[currentProject] = {
        locked: !!currentWorkspace.locked,
        unlocked: !!currentWorkspace.unlocked,
      };
    }
    updateProjectButtonLabel();
  }

  const WORKSPACE_COOKIE_NAME = 'benortWorkspace';
  const WORKSPACE_COOKIE_MAX_AGE = 30 * 24 * 60 * 60;

  function readWorkspacePreference(){
    try {
      const escaped = WORKSPACE_COOKIE_NAME.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const match = document.cookie.match(new RegExp(`(?:^|; )${escaped}=([^;]*)`));
      if(!match) return null;
      return JSON.parse(decodeURIComponent(match[1]));
    } catch (err) {
      console.warn('readWorkspacePreference failed', err);
      return null;
    }
  }

  function writeWorkspacePreference(data){
    try{
      const payload = encodeURIComponent(JSON.stringify(data));
      document.cookie = `${WORKSPACE_COOKIE_NAME}=${payload}; path=/; max-age=${WORKSPACE_COOKIE_MAX_AGE}`;
    }catch(err){
      console.warn('writeWorkspacePreference failed', err);
    }
  }

  function clearWorkspacePreference(){
    document.cookie = `${WORKSPACE_COOKIE_NAME}=; path=/; max-age=0`;
  }

  function persistWorkspacePreference(ws){
    if(!ws){
      clearWorkspacePreference();
      return;
    }
    const payload = {
      mode: ws.mode || 'local',
      displayName: ws.display_name || ws.workspace_id,
      localPath: ws.mode === 'cloud' ? '' : (ws.source || ws.localPath || ''),
      remoteKey: ws.mode === 'cloud' ? (ws.remote_key || ws.source || '') : '',
      timestamp: Date.now(),
    };
    if(payload.localPath || payload.remoteKey){
      writeWorkspacePreference(payload);
    }
  }

  function getWorkspaceDisplayPath(ws){
    if(!ws) return '';
    if(ws.mode === 'cloud'){
      return ws.source || ws.remote_key || '';
    }
    return ws.source || ws.localPath || '';
  }

  async function restoreWorkspaceFromPreference(){
    if(workspaceAutoRestoreAttempted){
      return false;
    }
    workspaceAutoRestoreAttempted = true;
    const pref = readWorkspacePreference();
    if(!pref) return false;
    const target = pref.mode === 'cloud' ? (pref.remoteKey || pref.source) : (pref.localPath || pref.source);
    if(!target) return false;
    const label = pref.displayName || target;
    showStatus(`正在恢复上次的工作区：${label}`, 'info', 4000);
    let success = false;
    if(pref.mode === 'cloud'){
      success = await openRemoteWorkspace(target, {silent: true});
    } else {
      success = await openWorkspaceByPath(target, {silent: true});
    }
    if(!success){
      clearWorkspacePreference();
      showStatus('自动恢复工作区失败，请手动选择', 'warning', 5000);
    }
    return success;
  }

  function formatFileSize(bytes){
    const value = Number(bytes);
    if(!Number.isFinite(value) || value <= 0) return '';
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let size = value;
    let idx = 0;
    while(size >= 1024 && idx < units.length - 1){
      size /= 1024;
      idx += 1;
    }
    const precision = idx === 0 ? 0 : 1;
    return `${size.toFixed(precision)} ${units[idx]}`;
  }

  function updateWorkspaceEndpoints(){
    if(currentWorkspace && currentWorkspace.workspace_id){
      const encoded = encodeURIComponent(currentWorkspace.workspace_id);
      const projectPath = `/workspaces/${encoded}/project`;
      PROJECT_ENDPOINTS.project = buildApiUrl(projectPath);
      PROJECT_ENDPOINTS.projectSave = PROJECT_ENDPOINTS.project;
    } else {
      PROJECT_ENDPOINTS.project = null;
      PROJECT_ENDPOINTS.projectSave = null;
    }
  }

  function updateWorkspaceUi(){
    const name = currentWorkspace ? (currentWorkspace.display_name || currentWorkspace.workspace_id) : '';
    const suffix = currentWorkspace && currentWorkspace.mode === 'cloud' ? '（云端）' : '';
    const workspacePath = getWorkspaceDisplayPath(currentWorkspace);
    if(projectDropdownBtn){
      projectDropdownBtn.textContent = name ? `${name}${suffix}` : '选择工作区';
    }
    if(projectMenuEl){
      buildProjectMenu(projectMenuEl);
    }
    if(workspaceCurrentInfo){
      if(currentWorkspace){
        workspaceCurrentInfo.classList.remove('d-none');
        if(workspaceCurrentName) workspaceCurrentName.textContent = name || '--';
        if(workspaceCurrentPath) workspaceCurrentPath.textContent = workspacePath || '';
      } else {
        workspaceCurrentInfo.classList.add('d-none');
      }
    }
  }

  function ensureWorkspaceReady(options = {}){
    if(currentWorkspace && currentWorkspace.workspace_id){
      return true;
    }
    if(!options.silent){
      promptWorkspaceSelection('请先通过“打开本地工作区”选择 .benort 文件');
    }
    return false;
  }

  function setWorkspace(handle){
    const normalized = normalizeWorkspace(handle);
    currentWorkspace = normalized;
    updateWorkspaceEndpoints();
    updateWorkspaceUi();
    notifyWorkspaceChangeHandlers();
    if(currentWorkspace){
      persistWorkspacePreference(currentWorkspace);
      currentProject = currentWorkspace.display_name || currentWorkspace.workspace_id;
      if(currentProject){
        projectMetadata[currentProject] = {
          locked: !!currentWorkspace.locked,
          unlocked: !!currentWorkspace.unlocked,
        };
      }
      handleLearningProjectSwitch(currentProject, {force: true});
      hideWorkspaceOverlay();
      loadProject();
    } else {
      clearWorkspacePreference();
      promptWorkspaceSelection('请通过“打开本地工作区”按钮选择 .benort 文件');
    }
  }

  function applyDefaultWorkspaceIfNeeded(){
    if(!pendingDefaultWorkspace || currentWorkspace){
      pendingDefaultWorkspace = null;
      return;
    }
    setWorkspace(pendingDefaultWorkspace);
    pendingDefaultWorkspace = null;
    defaultWorkspaceApplied = true;
    workspaceAutoRestoreAttempted = true;
  }

  async function fetchRemoteWorkspaceList(){
    const url = REMOTE_WORKSPACE_ENDPOINTS.list;
    if(remoteWorkspaceStatusEl){
      remoteWorkspaceStatusEl.textContent = '正在加载远程工作区...';
      remoteWorkspaceStatusEl.classList.remove('text-danger');
    }
    if(remoteWorkspaceListEl){
      remoteWorkspaceListEl.innerHTML = '<div class="list-group-item text-muted text-center">加载中...</div>';
    }
    try{
      const res = await fetch(url);
      const data = await res.json();
      if(!res.ok){
        throw new Error((data && data.error) ? data.error : (`HTTP ${res.status}`));
      }
      if(data && data.ossConfigured === false){
        remoteWorkspaceMeta = {prefix: '', bucket: ''};
        updateRemoteWorkspacePrefix();
        if(remoteWorkspaceStatusEl){
          remoteWorkspaceStatusEl.textContent = '尚未配置 OSS，无法使用远程工作区。';
          remoteWorkspaceStatusEl.classList.remove('text-danger');
        }
        if(remoteWorkspaceListEl){
          remoteWorkspaceListEl.innerHTML = '<div class="list-group-item text-muted text-center">请先配置 OSS</div>';
        }
        return;
      }
      remoteWorkspaceMeta = {
        prefix: (data && typeof data.prefix === 'string') ? data.prefix : '',
        bucket: (data && typeof data.bucket === 'string') ? data.bucket : '',
      };
      updateRemoteWorkspacePrefix();
      const items = Array.isArray(data.workspaces) ? data.workspaces : [];
      renderRemoteWorkspaceList(items);
      if(remoteWorkspaceStatusEl){
        remoteWorkspaceStatusEl.textContent = items.length ? '' : '当前 OSS 下暂无 .benort 工作区';
        remoteWorkspaceStatusEl.classList.remove('text-danger');
      }
    }catch(e){
      if(remoteWorkspaceStatusEl){
        remoteWorkspaceStatusEl.textContent = e.message || '远程列表加载失败';
        remoteWorkspaceStatusEl.classList.add('text-danger');
      }
      if(remoteWorkspaceListEl){
        remoteWorkspaceListEl.innerHTML = '<div class="list-group-item text-danger text-center">无法读取远程工作区</div>';
      }
    }
  }

  function renderRemoteWorkspaceList(items){
    if(!remoteWorkspaceListEl) return;
    remoteWorkspaceListEl.innerHTML = '';
    if(!Array.isArray(items) || !items.length){
      remoteWorkspaceListEl.innerHTML = '<div class="list-group-item text-muted text-center">暂无 .benort 工作区，可在下方创建</div>';
      return;
    }
    items.forEach(item => {
      const row = document.createElement('div');
      row.className = 'list-group-item';
      const infoBox = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'fw-semibold';
      title.textContent = item.displayName || item.relativeName || item.name || '';
      const subtitle = document.createElement('div');
      subtitle.className = 'text-muted small';
      const detailParts = [];
      const relativeLabel = item.relativeName || item.name || '';
      const fullPath = buildRemoteWorkspacePath(item);
      if(fullPath){
        detailParts.push(fullPath);
      } else if(relativeLabel){
        detailParts.push(relativeLabel);
      }
      const humanSize = formatFileSize(item.size);
      if(humanSize) detailParts.push(humanSize);
      if(item.lastModified){
        try{
          const dt = new Date(item.lastModified);
          if(!isNaN(dt.getTime())){
            detailParts.push(dt.toLocaleString());
          }
        }catch(_) {}
      }
      subtitle.textContent = detailParts.join(' · ');
      infoBox.appendChild(title);
      infoBox.appendChild(subtitle);

      const actions = document.createElement('div');
      actions.className = 'd-flex gap-2';
      const openBtn = document.createElement('button');
      openBtn.type = 'button';
      openBtn.className = 'btn btn-sm btn-primary';
      openBtn.textContent = '打开';
      if(item.name){
        openBtn.dataset.remoteOpen = item.name;
      } else {
        openBtn.disabled = true;
      }
      actions.appendChild(openBtn);

      row.appendChild(infoBox);
      row.appendChild(actions);
      remoteWorkspaceListEl.appendChild(row);
    });
  }

  function updateRemoteWorkspacePrefix(){
    if(remoteWorkspacePrefixEl){
      const parts = [];
      if(remoteWorkspaceMeta.bucket){
        parts.push(`oss://${remoteWorkspaceMeta.bucket}`);
      }
      if(remoteWorkspaceMeta.prefix){
        parts.push(remoteWorkspaceMeta.prefix);
      }
      remoteWorkspacePrefixEl.textContent = parts.join('/') || '';
    }
  }

  function buildRemoteWorkspacePath(item){
    if(!item) return '';
    const parts = [];
    if(remoteWorkspaceMeta.bucket){
      parts.push(`oss://${remoteWorkspaceMeta.bucket}`);
    }
    if(remoteWorkspaceMeta.prefix){
      parts.push(remoteWorkspaceMeta.prefix.replace(/^\/+|\/+$/g, ''));
    }
    const rel = (item.name || item.relativeName || '').replace(/^\/+/, '');
    if(rel){
      parts.push(rel);
    }
    return parts.join('/');
  }

  function renderLocalWorkspaceList(items){
    if(!localWorkspaceListEl) return;
    localWorkspaceListEl.innerHTML = '';
    if(!Array.isArray(items) || !items.length){
      localWorkspaceListEl.innerHTML = '<div class="list-group-item text-muted text-center">未发现 .benort 文件</div>';
      return;
    }
    items.forEach(item => {
      const row = document.createElement('div');
      row.className = 'list-group-item d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2';
      const metaBox = document.createElement('div');
      const title = document.createElement('div');
      title.className = 'fw-semibold';
      title.textContent = item.displayName || item.name || '';
      const subtitle = document.createElement('div');
      subtitle.className = 'text-muted small';
      const details = [];
      if(item.path){
        details.push(item.path);
      }
      const sizeLabel = formatFileSize(item.size);
      if(sizeLabel) details.push(sizeLabel);
      if(item.lastModified){
        try{
          const dt = new Date(item.lastModified);
          if(!isNaN(dt.getTime())){
            details.push(dt.toLocaleString());
          }
        }catch(_) {}
      }
      subtitle.textContent = details.join(' · ');
      metaBox.appendChild(title);
      metaBox.appendChild(subtitle);
      const actions = document.createElement('div');
      actions.className = 'd-flex gap-2';
      const openBtn = document.createElement('button');
      openBtn.type = 'button';
      openBtn.className = 'btn btn-sm btn-outline-primary';
      openBtn.textContent = '打开';
      if(item.path){
        openBtn.dataset.localOpen = item.path;
      } else {
        openBtn.disabled = true;
      }
      actions.appendChild(openBtn);
      row.appendChild(metaBox);
      row.appendChild(actions);
      localWorkspaceListEl.appendChild(row);
    });
  }

  function updateLocalWorkspaceCreateHint(){
    if(!localWorkspaceCreateHintEl) return;
    if(localWorkspaceRootPath){
      localWorkspaceCreateHintEl.textContent = `保存路径：${localWorkspaceRootPath}`;
      localWorkspaceCreateHintEl.className = 'text-muted small';
    } else {
      localWorkspaceCreateHintEl.textContent = '请先点击“刷新列表”以加载项目根目录。';
      localWorkspaceCreateHintEl.className = 'text-warning small';
    }
  }

  function setLocalWorkspaceCreateStatus(message, variant = 'muted'){
    if(!localWorkspaceCreateStatusEl) return;
    const classes = {
      danger: 'text-danger',
      success: 'text-success',
      warning: 'text-warning',
      info: 'text-info',
      muted: 'text-muted',
    };
    const textClass = classes[variant] || 'text-muted';
    localWorkspaceCreateStatusEl.textContent = message || '';
    localWorkspaceCreateStatusEl.className = `${textClass} small`;
  }

  function buildLocalWorkspacePath(filename){
    if(!filename) return '';
    const trimmed = filename.trim();
    if(!trimmed) return '';
    const sanitizedName = trimmed.replace(/[\\/]+/g, '-');
    if(!sanitizedName) return '';
    const ensured = sanitizedName.toLowerCase().endsWith('.benort') ? sanitizedName : `${sanitizedName}.benort`;
    if(!localWorkspaceRootPath){
      return ensured;
    }
    const normalizedRoot = localWorkspaceRootPath.replace(/[\\/]+$/, '');
    if(!normalizedRoot){
      return ensured;
    }
    const separator = normalizedRoot.includes('\\') ? '\\' : '/';
    return `${normalizedRoot}${separator}${ensured}`;
  }

  async function fetchLocalWorkspaceList(options = {}){
    const {preserveCreateStatus = false} = options || {};
    if(!localWorkspaceListEl) return;
    if(localWorkspaceStatusEl){
      localWorkspaceStatusEl.textContent = '正在扫描项目根目录...';
      localWorkspaceStatusEl.classList.remove('text-danger');
    }
    if(!preserveCreateStatus){
      setLocalWorkspaceCreateStatus('', 'muted');
    }
    localWorkspaceListEl.innerHTML = '<div class="list-group-item text-muted text-center">扫描中...</div>';
    try{
      const res = await fetch(WORKSPACE_ENDPOINTS.discover);
      const data = await res.json();
      if(!res.ok){
        throw new Error((data && data.error) ? data.error : (`HTTP ${res.status}`));
      }
      localWorkspaceRootPath = (data && (data.root || data.base)) ? (data.root || data.base) : '';
      updateLocalWorkspaceCreateHint();
      renderLocalWorkspaceList(Array.isArray(data.workspaces) ? data.workspaces : []);
      if(localWorkspaceStatusEl){
        if(!data || data.exists === false){
          localWorkspaceStatusEl.textContent = '项目根目录不存在，无法扫描本地工作区';
          localWorkspaceStatusEl.classList.add('text-danger');
        } else if(Array.isArray(data.workspaces) && !data.workspaces.length){
          const baseLabel = localWorkspaceRootPath ? `（${localWorkspaceRootPath}）` : '';
          localWorkspaceStatusEl.textContent = `项目根目录${baseLabel}下未找到 .benort 文件`;
          localWorkspaceStatusEl.classList.remove('text-danger');
        } else {
          const baseLabel = localWorkspaceRootPath ? `扫描路径：${localWorkspaceRootPath}` : '';
          localWorkspaceStatusEl.textContent = baseLabel;
          localWorkspaceStatusEl.classList.remove('text-danger');
        }
      }
    }catch(e){
      localWorkspaceRootPath = '';
      updateLocalWorkspaceCreateHint();
      if(localWorkspaceStatusEl){
        localWorkspaceStatusEl.textContent = e.message || '扫描失败';
        localWorkspaceStatusEl.classList.add('text-danger');
      }
      localWorkspaceListEl.innerHTML = '<div class="list-group-item text-danger text-center">无法读取项目根目录</div>';
    }
  }

  async function openRemoteWorkspace(name, options = {}){
    const {silent = false} = options;
    if(!name){
      if(!silent){
        showStatus('请选择远程工作区', 'danger', 4000);
      }
      return false;
    }
    try{
      const res = await fetch(REMOTE_WORKSPACE_ENDPOINTS.open, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name}),
      });
      const parsed = await parseJsonSafe(res);
      if(res.ok && (!parsed.json || parsed.json.success !== false)){
        const payload = parsed.json || {};
        const info = payload.info || {};
        setWorkspace(info);
        if(!silent){
          showStatus('远程工作区已打开', 'success', 3000);
        }
        return true;
      }
      const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
      if(!silent){
        showStatus('打开远程工作区失败：' + message, 'danger', 5000);
      }
    }catch(e){
      if(!silent){
        showStatus('打开远程工作区失败：' + (e.message || e), 'danger', 5000);
      }
    }
    return false;
  }

  async function openRemoteWorkspaceEntry(name, trigger){
    if(!name) return;
    const btn = trigger;
    if(btn) btn.disabled = true;
    const success = await openRemoteWorkspace(name);
    if(btn) btn.disabled = false;
    if(success){
      if(remoteWorkspaceModalInstance){
        remoteWorkspaceModalInstance.hide();
      }
      fetchRemoteWorkspaceList();
    }
  }

  async function createRemoteWorkspaceEntry(name, displayName){
    if(!name){
      showStatus('请输入远程工作区文件名', 'warning', 4000);
      return;
    }
    try{
      const res = await fetch(REMOTE_WORKSPACE_ENDPOINTS.create, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name, displayName}),
      });
      const parsed = await parseJsonSafe(res);
      if(res.ok && (!parsed.json || parsed.json.success !== false)){
        const info = (parsed.json && parsed.json.info) ? parsed.json.info : {};
        setWorkspace(info);
        if(remoteWorkspaceModalInstance){
          remoteWorkspaceModalInstance.hide();
        }
        if(remoteWorkspaceCreateNameInput) remoteWorkspaceCreateNameInput.value = '';
        if(remoteWorkspaceCreateDisplayInput) remoteWorkspaceCreateDisplayInput.value = '';
        showStatus('远程工作区已创建并打开', 'success', 4000);
        fetchRemoteWorkspaceList();
      } else {
        const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
        showStatus('创建远程工作区失败：' + message, 'danger', 5000);
      }
    }catch(e){
      showStatus('创建远程工作区失败：' + e.message, 'danger', 5000);
    }
  }

  async function openWorkspaceByPath(path, options = {}){
    const {silent = false} = options;
    if(!path){
      if(!silent){
        setWorkspaceOverlayMessage('请输入要打开的文件路径', 'danger');
      }
      return false;
    }
    if(!silent){
      setWorkspaceOverlayMessage('正在打开工作区...', 'info');
    }
    try{
      const res = await fetch(WORKSPACE_ENDPOINTS.open, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({path}),
      });
      const parsed = await parseJsonSafe(res);
      if(res.ok && (!parsed.json || parsed.json.success !== false)){
        const payload = parsed.json || {};
        const info = payload.info || {};
        if(!info.workspace_id && payload.workspace){
          info.workspace_id = payload.workspace;
        }
        setWorkspace(info);
        if(!silent){
          setWorkspaceOverlayMessage('工作区已打开', 'success');
        } else {
          showStatus('已恢复上次的本地工作区', 'success', 2500);
        }
        return true;
      } else {
        const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
        if(!silent){
          setWorkspaceOverlayMessage(message, 'danger');
        } else {
          showStatus('打开本地工作区失败：' + message, 'danger', 5000);
        }
      }
    }catch(e){
      if(!silent){
        setWorkspaceOverlayMessage(e.message, 'danger');
      } else {
        showStatus('打开本地工作区失败：' + (e.message || e), 'danger', 5000);
      }
    }
    return false;
  }

  async function closeCurrentWorkspace(){
    if(!currentWorkspace || !currentWorkspace.workspace_id){
      setWorkspace(null);
      return;
    }
    try{
      await fetch(workspaceCloseEndpoint(currentWorkspace.workspace_id), {method: 'DELETE'});
    }catch(e){
      console.warn('close workspace failed', e);
    }
    setWorkspace(null);
    setWorkspaceOverlayMessage('已关闭当前工作区', 'info');
  }

  function promptWorkspaceSelection(message){
    showStatus(message || '请使用“打开本地工作区”完成此操作', 'info', 5000);
    if(projectDropdownBtn){
      projectDropdownBtn.classList.add('workspace-button-highlight');
      setTimeout(() => projectDropdownBtn.classList.remove('workspace-button-highlight'), 1500);
    }
  }

  if(workspaceCloseBtn){
    workspaceCloseBtn.addEventListener('click', () => {
      closeCurrentWorkspace();
    });
  }

  if(workspaceRefreshBtn){
    workspaceRefreshBtn.addEventListener('click', () => {
      if(ensureWorkspaceReady()) loadProject();
    });
  }

  if(localWorkspaceRefreshBtn){
    localWorkspaceRefreshBtn.addEventListener('click', () => {
      fetchLocalWorkspaceList();
    });
  }

  if(localWorkspaceListEl){
    localWorkspaceListEl.addEventListener('click', event => {
      const btn = event.target.closest('[data-local-open]');
      if(!btn) return;
      const path = btn.getAttribute('data-local-open');
      if(path){
        openWorkspaceByPath(path);
      }
    });
  }

  if(localWorkspaceCreateForm){
    localWorkspaceCreateForm.addEventListener('submit', async event => {
      event.preventDefault();
      if(!localWorkspaceRootPath){
        setLocalWorkspaceCreateStatus('尚未加载项目根目录，请先刷新列表。', 'warning');
        return;
      }
      const filename = localWorkspaceCreateNameInput ? localWorkspaceCreateNameInput.value.trim() : '';
      if(!filename){
        setLocalWorkspaceCreateStatus('请输入文件名', 'danger');
        return;
      }
      const displayName = localWorkspaceCreateDisplayInput ? localWorkspaceCreateDisplayInput.value.trim() : '';
      const fullPath = buildLocalWorkspacePath(filename);
      if(!fullPath){
        setLocalWorkspaceCreateStatus('文件名无效', 'danger');
        return;
      }
      const submitBtn = localWorkspaceCreateForm.querySelector('button[type="submit"]');
      if(submitBtn){
        submitBtn.disabled = true;
        submitBtn.dataset.originalLabel = submitBtn.dataset.originalLabel || submitBtn.textContent || '';
        submitBtn.textContent = '创建中...';
      }
      setLocalWorkspaceCreateStatus('正在创建工作区...', 'muted');
      try{
        const payload = {path: fullPath};
        if(displayName){
          payload.name = displayName;
        }
        const res = await fetch(WORKSPACE_ENDPOINTS.create, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          const info = (parsed.json && parsed.json.info) ? parsed.json.info : {};
          if(!info.workspace_id && parsed.json && parsed.json.workspace){
            info.workspace_id = parsed.json.workspace;
          }
          setWorkspace(info);
          setLocalWorkspaceCreateStatus('新工作区已创建并打开', 'success');
          if(localWorkspaceCreateNameInput) localWorkspaceCreateNameInput.value = '';
          if(localWorkspaceCreateDisplayInput) localWorkspaceCreateDisplayInput.value = '';
          fetchLocalWorkspaceList({preserveCreateStatus: true});
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
          setLocalWorkspaceCreateStatus(message, 'danger');
        }
      }catch(err){
        setLocalWorkspaceCreateStatus(err?.message || '创建失败', 'danger');
      }finally{
        if(submitBtn){
          submitBtn.disabled = false;
          submitBtn.textContent = submitBtn.dataset.originalLabel || '创建并打开';
        }
      }
    });
  }

  function appendWorkspaceQuery(url){
    if(!url || !currentWorkspace || !currentWorkspace.workspace_id) return url;
    const separator = url.includes('?') ? '&' : '?';
    return `${url}${separator}workspace=${encodeURIComponent(currentWorkspace.workspace_id)}`;
  }

  function withWorkspacePayload(payload){
    if(!currentWorkspace || !currentWorkspace.workspace_id) return payload;
    if(payload instanceof FormData){
      if(!payload.has('workspace')){
        payload.append('workspace', currentWorkspace.workspace_id);
      }
      return payload;
    }
    if(payload && typeof payload === 'object' && !Array.isArray(payload)){
      return {...payload, workspace: currentWorkspace.workspace_id};
    }
    return payload;
  }

  function rememberAttachmentUrl(entry) {
    if (!entry) return;
    const workspaceId = currentWorkspace && currentWorkspace.workspace_id ? currentWorkspace.workspace_id : '';
    if (!workspaceId) return;
    let name = entry.name || entry.filename || entry.path || '';
    if (!name) return;
    name = String(name).trim();
    if (!name) return;
    if (name.includes('/')) {
      name = name.split('/').pop() || name;
    }
    const preferRemote = workspaceIsCloud();
    const url = preferRemote
      ? (entry.preferredUrl || entry.ossUrl || entry.url || entry.localUrl)
      : (entry.localUrl || entry.preferredUrl || entry.url || entry.ossUrl);
    if (!url) return;
    attachmentUrlIndex.set(name, url);
    attachmentIndexWorkspaceId = workspaceId;
  }

  function bulkSetAttachmentUrls(list) {
    attachmentUrlIndex.clear();
    const workspaceId = currentWorkspace && currentWorkspace.workspace_id ? currentWorkspace.workspace_id : '';
    attachmentIndexWorkspaceId = workspaceId || '';
    if (!workspaceId || !Array.isArray(list)) return;
    list.forEach(item => rememberAttachmentUrl(item));
  }

  function normalizeAttachmentSnippet(snippet, attachments) {
    if (!snippet || typeof snippet !== 'string') return snippet;
    if (!Array.isArray(attachments) || !attachments.length) return snippet;
    let rewritten = snippet;
    attachments.forEach(item => {
      if (!item) return;
      rememberAttachmentUrl(item);
      const preferRemote = workspaceIsCloud();
      const sourceUrl = preferRemote
        ? (item.preferredUrl || item.ossUrl || item.url || item.localUrl)
        : (item.localUrl || item.preferredUrl || item.url || item.ossUrl);
      const name = item.name || '';
      if (!sourceUrl || !name) return;
      const relativeLink = name;
      rewritten = rewritten.split(sourceUrl).join(relativeLink);
    });
    return rewritten;
  }

  async function primeAttachmentUrlIndex(options = {}) {
    if(!ensureWorkspaceReady({silent: true})) {
      attachmentUrlIndex.clear();
      attachmentIndexWorkspaceId = '';
      return null;
    }
    const workspaceId = currentWorkspace.workspace_id;
    if (attachmentIndexWorkspaceId && attachmentIndexWorkspaceId !== workspaceId) {
      attachmentUrlIndex.clear();
    }
    if (attachmentIndexPromise && !options.force) {
      return attachmentIndexPromise;
    }
    const url = appendWorkspaceQuery(buildApiUrl('/attachments/list'));
    attachmentIndexPromise = fetch(url)
      .then(res => res.ok ? res.json() : null)
      .then(data => {
        if(currentWorkspace && currentWorkspace.workspace_id === workspaceId && data && Array.isArray(data.files)){
          bulkSetAttachmentUrls(data.files);
          if(options.reRender && currentEditMode === 'markdown'){
            renderMarkdownPreview();
          }
        }
        attachmentIndexPromise = null;
        return data;
      })
      .catch(err => {
        console.warn('预加载附件索引失败', err);
        attachmentIndexPromise = null;
        return null;
      });
    return attachmentIndexPromise;
  }

  onWorkspaceChange(workspace => {
    attachmentUrlIndex.clear();
    attachmentIndexWorkspaceId = workspace && workspace.workspace_id ? workspace.workspace_id : '';
    attachmentsCache = [];
    attachmentsFilterTerm = '';
    unusedAttachmentsCache = [];
    clearingUnusedAttachments = false;
    if(workspace && workspace.workspace_id){
      primeAttachmentUrlIndex({force: true, reRender: currentEditMode === 'markdown'});
    }
  }, {immediate: true});

  if(remoteWorkspaceRefreshBtn){
    remoteWorkspaceRefreshBtn.addEventListener('click', () => fetchRemoteWorkspaceList());
  }

  if(remoteWorkspaceListEl){
    remoteWorkspaceListEl.addEventListener('click', event => {
      const btn = event.target.closest('[data-remote-open]');
      if(!btn) return;
      const name = btn.getAttribute('data-remote-open');
      if(name){
        openRemoteWorkspaceEntry(name, btn);
      }
    });
  }

  if(remoteWorkspaceCreateForm){
    remoteWorkspaceCreateForm.addEventListener('submit', e => {
      e.preventDefault();
      const name = remoteWorkspaceCreateNameInput ? remoteWorkspaceCreateNameInput.value.trim() : '';
      const displayName = remoteWorkspaceCreateDisplayInput ? remoteWorkspaceCreateDisplayInput.value.trim() : '';
      if(remoteWorkspaceCreateNameInput) remoteWorkspaceCreateNameInput.value = name;
      createRemoteWorkspaceEntry(name, displayName);
    });
  }
  let llmProviders = Array.isArray(window.BENORT_LLM_PROVIDERS) ? window.BENORT_LLM_PROVIDERS.slice() : [];
  function ensureDefaultProviders(){
    const list = Array.isArray(llmProviders) ? llmProviders : [];
    const idSet = new Set(list.map(p => (p && typeof p.id === 'string') ? p.id.toLowerCase() : ''));
    const defaults = [
      {id: 'openai', label: 'OpenAI', models: ['gpt-4o', 'gpt-4o-mini'], defaultModel: 'gpt-4o', defaultEmbeddingModel: 'text-embedding-3-large', defaultTtsModel: 'tts-1', embeddingModels: ['text-embedding-3-large', 'text-embedding-3-small'], ttsModels: ['tts-1', 'tts-1-hd']},
      {id: 'chatanywhere', label: 'ChatAnywhere', models: ['gpt-4o'], defaultModel: 'gpt-4o', defaultEmbeddingModel: 'text-embedding-3-large', defaultTtsModel: 'tts-1', embeddingModels: ['text-embedding-3-large', 'text-embedding-3-small'], ttsModels: ['tts-1']},
      {id: 'mock-local', label: 'Mock Local', models: ['gpt-4o'], defaultModel: 'gpt-4o', defaultEmbeddingModel: 'text-embedding-3-large', defaultTtsModel: 'tts-1', embeddingModels: ['text-embedding-3-large', 'text-embedding-3-small'], ttsModels: ['tts-1']},
    ];
    defaults.forEach(p => {
      if(!idSet.has(p.id)){
        list.push(p);
        idSet.add(p.id);
      }
    });
    llmProviders = list;
    return llmProviders;
  }
  ensureDefaultProviders();
  const llmDefaultState = (window.BENORT_LLM_DEFAULT && typeof window.BENORT_LLM_DEFAULT === 'object') ? {...window.BENORT_LLM_DEFAULT} : {};
  let llmSettings = {};
  const llmManageBtn = document.getElementById('llm-manage-btn');
  const llmProviderLabelEl = document.getElementById('llm-provider-label');
  const llmModalEl = document.getElementById('llmModal');
  const llmModalProviderList = document.getElementById('llm-modal-provider-list'); // legacy chat radio
  const llmModalModelSelect = document.getElementById('llm-modal-model-select'); // chat model select
  const llmModalEmbeddingInput = document.getElementById('llm-embed-model');
  const llmModalTtsInput = document.getElementById('llm-tts-model');
  const llmModalEmbeddingOptions = document.getElementById('llm-embed-model-options');
  const llmModalTtsOptions = document.getElementById('llm-tts-model-options');
  const llmModalApiEnv = document.getElementById('llm-modal-api-env');
  const llmModalApiStatus = document.getElementById('llm-modal-api-status');
  const llmModalEndpoint = document.getElementById('llm-modal-endpoint');
  const llmModalTestBtn = document.getElementById('llm-modal-test-btn');
  const llmModalTestResult = document.getElementById('llm-modal-test-result');
  const llmChatProviderSelect = document.getElementById('llm-modal-provider-select-chat');
  const llmEmbedProviderSelect = document.getElementById('llm-embed-provider');
  const llmEmbedEndpoint = document.getElementById('llm-embed-endpoint');
  const llmEmbedTestBtn = document.getElementById('llm-embed-test-btn');
  const llmEmbedTestResult = document.getElementById('llm-embed-test-result');
  const llmTtsProviderSelect = document.getElementById('llm-tts-provider');
  const llmTtsEndpoint = document.getElementById('llm-tts-endpoint');
  const llmTtsTestBtn = document.getElementById('llm-tts-test-btn');
  const llmTtsTestResult = document.getElementById('llm-tts-test-result');

  function getLlmProviderMeta(id){
    if(!id) return null;
    const target = String(id).trim().toLowerCase();
    if(!target) return null;
    for(const provider of llmProviders){
      if(provider && typeof provider.id === 'string' && provider.id.toLowerCase() === target){
        return provider;
      }
    }
    return null;
  }

  function normalizeLlmSettings(raw){
    const state = {
      chatProvider: '',
      chatModel: '',
      embeddingProvider: '',
      embeddingModel: '',
      ttsProvider: '',
      ttsModel: '',
    };
    const src = (raw && typeof raw === 'object') ? raw : {};
    const chatBlock = (src.chat && typeof src.chat === 'object') ? src.chat : {};
    const embedBlock = (src.embedding && typeof src.embedding === 'object') ? src.embedding : {};
    const ttsBlock = (src.tts && typeof src.tts === 'object') ? src.tts : {};
    state.chatProvider = (src.chatProvider || chatBlock.provider || src.provider || '').trim();
    state.chatModel = (src.chatModel || chatBlock.model || src.model || '').trim();
    state.embeddingProvider = (src.embeddingProvider || embedBlock.provider || src.provider || '').trim();
    state.embeddingModel = (src.embeddingModel || embedBlock.model || src.embedding_model || '').trim();
    state.ttsProvider = (src.ttsProvider || ttsBlock.provider || src.provider || '').trim();
    state.ttsModel = (src.ttsModel || ttsBlock.model || src.tts_model || '').trim();
    return state;
  }

  llmSettings = normalizeLlmSettings(llmDefaultState);

  function ensureLlmSettingsDefaults(){
    if(!llmSettings || typeof llmSettings !== 'object'){
      llmSettings = normalizeLlmSettings({});
    }
    const usages = [
      {providerKey: 'chatProvider', modelKey: 'chatModel', defaultProvider: llmDefaultState.chatProvider, defaultModel: llmDefaultState.chatModel, modelSource: 'defaultModel', modelsField: 'models'},
      {providerKey: 'embeddingProvider', modelKey: 'embeddingModel', defaultProvider: llmDefaultState.embeddingProvider, defaultModel: llmDefaultState.embeddingModel, modelSource: 'defaultEmbeddingModel', modelsField: 'embeddingModels'},
      {providerKey: 'ttsProvider', modelKey: 'ttsModel', defaultProvider: llmDefaultState.ttsProvider, defaultModel: llmDefaultState.ttsModel, modelSource: 'defaultTtsModel', modelsField: 'ttsModels'},
    ];
    usages.forEach(entry => {
      const providerKey = entry.providerKey;
      const modelKey = entry.modelKey;
      let providerId = (typeof llmSettings[providerKey] === 'string' && llmSettings[providerKey].trim()) ? llmSettings[providerKey].trim().toLowerCase() : '';
      let meta = getLlmProviderMeta(providerId);
      if(!meta){
        const fallback = (typeof entry.defaultProvider === 'string' && getLlmProviderMeta(entry.defaultProvider)) ? entry.defaultProvider : '';
        if(fallback){
          providerId = fallback;
        } else if(llmProviders.length > 0 && typeof llmProviders[0].id === 'string'){
          providerId = llmProviders[0].id;
        }
        meta = getLlmProviderMeta(providerId);
      }
      llmSettings[providerKey] = providerId || '';
      if(meta){
        const currentModel = (typeof llmSettings[modelKey] === 'string' && llmSettings[modelKey].trim()) ? llmSettings[modelKey].trim() : '';
        if(!currentModel){
          const defaultField = entry.modelSource || 'defaultModel';
          const listField = entry.modelsField || 'models';
          const defaultModel = (typeof (entry.defaultModel || meta[defaultField]) === 'string' && (entry.defaultModel || meta[defaultField]).trim())
            ? (entry.defaultModel || meta[defaultField]).trim()
            : '';
          const modelList = Array.isArray(meta[listField]) ? meta[listField].filter(m => typeof m === 'string' && m.trim()) : [];
          if(defaultModel){
            llmSettings[modelKey] = defaultModel;
          } else if(modelList.length){
            llmSettings[modelKey] = modelList[0];
          } else {
            llmSettings[modelKey] = '';
          }
        }
      }
    });
  }

  function getLlmPayload(){
    const payload = {
      chat: {
        provider: (llmSettings.chatProvider || '').trim() || undefined,
        model: (llmSettings.chatModel || '').trim() || undefined,
      },
      embedding: {
        provider: (llmSettings.embeddingProvider || '').trim() || undefined,
        model: (llmSettings.embeddingModel || '').trim() || undefined,
      },
      tts: {
        provider: (llmSettings.ttsProvider || '').trim() || undefined,
        model: (llmSettings.ttsModel || '').trim() || undefined,
      },
    };
    // legacy flatten
    payload.provider = payload.chat.provider;
    payload.model = payload.chat.model;
    payload.embeddingModel = payload.embedding.model;
    payload.ttsModel = payload.tts.model;
    payload.embeddingProvider = payload.embedding.provider;
    payload.ttsProvider = payload.tts.provider;
    return payload;
  }

  function updateLlmButtonLabel(){
    const chatMeta = getLlmProviderMeta(llmSettings && llmSettings.chatProvider);
    const embedMeta = getLlmProviderMeta(llmSettings && llmSettings.embeddingProvider);
    const ttsMeta = getLlmProviderMeta(llmSettings && llmSettings.ttsProvider);
    const chatLabel = chatMeta ? (chatMeta.label || chatMeta.id) : '--';
    const embedLabel = embedMeta ? (embedMeta.label || embedMeta.id) : '--';
    const ttsLabel = ttsMeta ? (ttsMeta.label || ttsMeta.id) : '--';
    const summary = `聊:${chatLabel} · 嵌:${embedLabel} · 音:${ttsLabel}`;
    if(llmProviderLabelEl){
      llmProviderLabelEl.textContent = summary;
    }
    if(llmManageBtn){
      const parts = [];
      const chatModel = (llmSettings && typeof llmSettings.chatModel === 'string') ? llmSettings.chatModel.trim() : '';
      const embedModel = (llmSettings && typeof llmSettings.embeddingModel === 'string') ? llmSettings.embeddingModel.trim() : '';
      const ttsModel = (llmSettings && typeof llmSettings.ttsModel === 'string') ? llmSettings.ttsModel.trim() : '';
      parts.push(`聊天: ${chatLabel}${chatModel ? ` / ${chatModel}` : ''}`);
      parts.push(`Embedding: ${embedLabel}${embedModel ? ` / ${embedModel}` : ''}`);
      parts.push(`TTS: ${ttsLabel}${ttsModel ? ` / ${ttsModel}` : ''}`);
      llmManageBtn.title = parts.join(' · ');
    }
  }

  function renderLlmModalProviders(){
    if(!llmModalProviderList) return;
    llmModalProviderList.innerHTML = '<div class="text-muted small">请使用下方各折叠面板的“提供方”下拉选择。</div>';
  }

  function renderLlmProviderSelect(selectEl, activeId){
    if(!selectEl) return;
    ensureDefaultProviders();
    const current = (activeId || '').toLowerCase();
    selectEl.innerHTML = '';
    llmProviders.forEach(provider => {
      if(!provider || typeof provider.id !== 'string') return;
      const opt = document.createElement('option');
      opt.value = provider.id;
      opt.textContent = provider.label || provider.id;
      selectEl.appendChild(opt);
    });
    if(current){
      selectEl.value = current;
    } else if(selectEl.options.length){
      selectEl.selectedIndex = 0;
    }
    selectEl.disabled = selectEl.options.length === 0;
  }

  function renderLlmModalModels(){
    if(!llmModalModelSelect) return;
    const meta = getLlmProviderMeta(llmSettings && llmSettings.chatProvider);
    const models = Array.isArray(meta && meta.models) ? meta.models.filter(model => typeof model === 'string') : [];
    const current = (typeof llmSettings.chatModel === 'string' && llmSettings.chatModel.trim()) ? llmSettings.chatModel.trim() : '';
    llmModalModelSelect.innerHTML = '';
    if(!models.length){
      const fallback = current || (meta && typeof meta?.defaultModel === 'string' && meta.defaultModel.trim() ? meta.defaultModel.trim() : '');
      const option = document.createElement('option');
      option.value = fallback || '';
      option.textContent = fallback || '无可用模型';
      llmModalModelSelect.appendChild(option);
      llmModalModelSelect.disabled = true;
      llmModalModelSelect.value = fallback || '';
      return;
    }
    models.forEach(model => {
      const option = document.createElement('option');
      option.value = model;
      option.textContent = model;
      llmModalModelSelect.appendChild(option);
    });
    if(current && !models.includes(current)){
      const customOption = document.createElement('option');
      customOption.value = current;
      customOption.textContent = `${current}（自定义）`;
      llmModalModelSelect.appendChild(customOption);
    }
    const target = current || (meta && typeof meta.defaultModel === 'string' && meta.defaultModel.trim() ? meta.defaultModel.trim() : models[0]);
    if(target){
      llmModalModelSelect.value = target;
    }
    llmModalModelSelect.disabled = llmModalModelSelect.options.length <= 1;
  }

  function renderLlmModalEmbedding(){
    if(!llmModalEmbeddingInput) return;
    const current = (typeof llmSettings.embeddingModel === 'string' && llmSettings.embeddingModel.trim()) ? llmSettings.embeddingModel.trim() : '';
    const meta = getLlmProviderMeta(llmSettings && llmSettings.embeddingProvider);
    if(llmEmbedProviderSelect){
      renderLlmProviderSelect(llmEmbedProviderSelect, llmSettings.embeddingProvider);
    }
    const fallback = (meta && typeof meta.defaultEmbeddingModel === 'string' && meta.defaultEmbeddingModel.trim()) ? meta.defaultEmbeddingModel.trim() : '';
    if(llmModalEmbeddingOptions){
      llmModalEmbeddingOptions.innerHTML = '';
      const options = Array.isArray(meta && meta.embeddingModels) ? meta.embeddingModels.filter(m => typeof m === 'string' && m.trim()) : [];
      options.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        llmModalEmbeddingOptions.appendChild(opt);
      });
    }
    llmModalEmbeddingInput.value = current || fallback || '';
    llmModalEmbeddingInput.placeholder = fallback || 'text-embedding-3-large';
    const hint = document.getElementById('llm-modal-embedding-hint');
    if(hint){
      const path = meta && meta.embeddingPath ? meta.embeddingPath : '/embeddings';
      hint.textContent = `不填则使用默认：${fallback || 'text-embedding-3-large'}（路径 ${path}）`;
    }
    if(llmEmbedEndpoint){
      const base = meta && meta.baseUrl ? meta.baseUrl : '';
      const path = meta && meta.embeddingPath ? meta.embeddingPath : '/embeddings';
      llmEmbedEndpoint.textContent = `接口：${base}${path}`;
    }
  }

  function renderLlmModalTts(){
    if(!llmModalTtsInput) return;
    const current = (typeof llmSettings.ttsModel === 'string' && llmSettings.ttsModel.trim()) ? llmSettings.ttsModel.trim() : '';
    const meta = getLlmProviderMeta(llmSettings && llmSettings.ttsProvider);
    if(llmTtsProviderSelect){
      renderLlmProviderSelect(llmTtsProviderSelect, llmSettings.ttsProvider);
    }
    const fallback = (meta && typeof meta.defaultTtsModel === 'string' && meta.defaultTtsModel.trim()) ? meta.defaultTtsModel.trim() : '';
    if(llmModalTtsOptions){
      llmModalTtsOptions.innerHTML = '';
      const options = Array.isArray(meta && meta.ttsModels) ? meta.ttsModels.filter(m => typeof m === 'string' && m.trim()) : [];
      options.forEach(val => {
        const opt = document.createElement('option');
        opt.value = val;
        llmModalTtsOptions.appendChild(opt);
      });
    }
    llmModalTtsInput.value = current || fallback || '';
    llmModalTtsInput.placeholder = fallback || 'tts-1';
    const hint = document.getElementById('llm-modal-tts-hint');
    if(hint){
        const path = meta && meta.ttsPath ? meta.ttsPath : '/audio/speech';
        hint.textContent = `不填则使用默认：${fallback || 'tts-1'}（路径 ${path}）`;
    }
    if(llmTtsEndpoint){
      const base = meta && meta.baseUrl ? meta.baseUrl : '';
      const path = meta && meta.ttsPath ? meta.ttsPath : '/audio/speech';
      llmTtsEndpoint.textContent = `接口：${base}${path}`;
    }
  }

  function updateLlmModalMeta(){
    const meta = getLlmProviderMeta(llmSettings && llmSettings.chatProvider);
    if(llmModalApiEnv){
      llmModalApiEnv.textContent = meta && meta.apiKeyEnv ? meta.apiKeyEnv : '未配置';
    }
    if(llmModalApiStatus){
      const classes = ['badge', 'llm-modal-provider-status'];
      if(meta && meta.hasApiKey){
        classes.push('bg-success');
        llmModalApiStatus.textContent = '已配置';
      } else {
        classes.push('bg-warning', 'text-dark');
        llmModalApiStatus.textContent = '未检测到密钥';
      }
      llmModalApiStatus.className = classes.join(' ');
    }
    if(llmModalEndpoint){
      const base = meta && meta.baseUrl ? meta.baseUrl : '';
      const path = meta && meta.chatPath ? meta.chatPath : '';
      const endpointText = `${base || ''}${path || ''}`.trim();
      llmModalEndpoint.textContent = endpointText ? `聊天接口：${endpointText}` : '';
    }
    if(llmModalTestBtn){
      llmModalTestBtn.disabled = !(meta && meta.hasApiKey);
    }
  }

  function renderLlmModal(){
    ensureLlmSettingsDefaults();
    renderLlmModalProviders();
    renderLlmProviderSelect(llmChatProviderSelect, llmSettings.chatProvider);
    renderLlmModalModels();
    renderLlmModalEmbedding();
    renderLlmModalTts();
    updateLlmModalMeta();
  }

  function clearLlmTestResult(){
    if(!llmModalTestResult) return;
    llmModalTestResult.className = 'flex-grow-1 text-muted small';
    llmModalTestResult.textContent = '';
  }

  function setLlmTestResult(message, tone){
    if(!llmModalTestResult) return;
    const classes = ['flex-grow-1', 'small'];
    if(tone === 'success'){
      classes.push('text-success');
    } else if(tone === 'danger'){
      classes.push('text-danger');
    } else {
      classes.push('text-muted');
    }
    llmModalTestResult.className = classes.join(' ');
    llmModalTestResult.textContent = message || '';
  }

  function setGenericTestResult(el, message, tone){
    if(!el) return;
    const classes = ['flex-grow-1', 'small'];
    if(tone === 'success'){
      classes.push('text-success');
    } else if(tone === 'danger'){
      classes.push('text-danger');
    } else if(tone === 'warning'){
      classes.push('text-warning');
    } else {
      classes.push('text-muted');
    }
    el.className = classes.join(' ');
    el.textContent = message || '';
  }

  function handleLlmProviderSelect(providerId){
    const meta = getLlmProviderMeta(providerId);
    if(!meta){
      showStatus('未找到匹配的 LLM 提供方', 'danger', 4000);
      return;
    }
    if(!llmSettings || typeof llmSettings !== 'object'){
      llmSettings = normalizeLlmSettings({});
    }
    const previousProvider = (typeof llmSettings.chatProvider === 'string') ? llmSettings.chatProvider.trim().toLowerCase() : '';
    const previousModel = (typeof llmSettings.chatModel === 'string') ? llmSettings.chatModel.trim() : '';
    llmSettings.chatProvider = meta.id.trim().toLowerCase();
    if(meta.defaultModel && typeof meta.defaultModel === 'string' && meta.defaultModel.trim()){
      llmSettings.chatModel = meta.defaultModel.trim();
    } else if(Array.isArray(meta.models) && meta.models.length > 0 && typeof meta.models[0] === 'string'){
      llmSettings.chatModel = meta.models[0];
    } else {
      llmSettings.chatModel = '';
    }
    const nextModel = (typeof llmSettings.chatModel === 'string') ? llmSettings.chatModel : '';
    refreshLlmUi();
    clearLlmTestResult();
    if(previousProvider !== llmSettings.chatProvider || previousModel !== nextModel){
      saveProject();
      showStatus(`已切换至 ${meta.label || meta.id}`, 'success', 2000);
    }
  }

  function withLlmConfig(payload){
    const base = (payload && typeof payload === 'object') ? {...payload} : {};
    const llmPayload = getLlmPayload();
    base.llm = llmPayload;
    base.llmProvider = (llmPayload.chat && llmPayload.chat.provider) || undefined;
    base.llmModel = (llmPayload.chat && llmPayload.chat.model) || undefined;
    base.embeddingModel = (llmPayload.embedding && llmPayload.embedding.model) || undefined;
    base.embeddingProvider = (llmPayload.embedding && llmPayload.embedding.provider) || undefined;
    base.ttsModel = (llmPayload.tts && llmPayload.tts.model) || undefined;
    base.ttsProvider = (llmPayload.tts && llmPayload.tts.provider) || undefined;
    return base;
  }

  function refreshLlmUi(){
    ensureLlmSettingsDefaults();
    updateLlmButtonLabel();
    if(llmModalEl && llmModalEl.classList.contains('show')){
      renderLlmModal();
    }
  }

  if(llmManageBtn && llmModalEl){
    llmManageBtn.addEventListener('click', () => {
      renderLlmModal();
      clearLlmTestResult();
      const modal = bootstrap.Modal.getOrCreateInstance(llmModalEl);
      modal.show();
    });
  }

  if(llmModalEl){
    llmModalEl.addEventListener('hidden.bs.modal', () => {
      clearLlmTestResult();
    });
    llmModalEl.addEventListener('shown.bs.modal', () => {
      renderLlmModal();
    });
  }

  if(llmModalModelSelect && !llmModalModelSelect.dataset.bound){
    llmModalModelSelect.dataset.bound = 'true';
    llmModalModelSelect.addEventListener('change', () => {
      const value = (llmModalModelSelect.value || '').trim();
      if(value && llmSettings){
        const previous = (typeof llmSettings.chatModel === 'string') ? llmSettings.chatModel.trim() : '';
        if(previous !== value){
          llmSettings.chatModel = value;
          saveProject();
          refreshLlmUi();
        }
      }
      clearLlmTestResult();
    });
  }

  if(llmModalEmbeddingInput && !llmModalEmbeddingInput.dataset.bound){
    llmModalEmbeddingInput.dataset.bound = 'true';
    llmModalEmbeddingInput.addEventListener('change', () => {
      const value = (llmModalEmbeddingInput.value || '').trim();
      const previous = (typeof llmSettings.embeddingModel === 'string') ? llmSettings.embeddingModel.trim() : '';
      if(value){
        if(value !== previous){
          llmSettings.embeddingModel = value;
          saveProject();
          refreshLlmUi();
        }
      } else if(previous){
        delete llmSettings.embeddingModel;
        saveProject();
        refreshLlmUi();
      }
      clearLlmTestResult();
    });
  }

  if(llmModalTtsInput && !llmModalTtsInput.dataset.bound){
    llmModalTtsInput.dataset.bound = 'true';
    llmModalTtsInput.addEventListener('change', () => {
      const value = (llmModalTtsInput.value || '').trim();
      const previous = (typeof llmSettings.ttsModel === 'string') ? llmSettings.ttsModel.trim() : '';
      if(value){
        if(value !== previous){
          llmSettings.ttsModel = value;
          saveProject();
          refreshLlmUi();
        }
      } else if(previous){
        delete llmSettings.ttsModel;
        saveProject();
        refreshLlmUi();
      }
      clearLlmTestResult();
    });
  }

  if(llmChatProviderSelect && !llmChatProviderSelect.dataset.bound){
    llmChatProviderSelect.dataset.bound = 'true';
    llmChatProviderSelect.addEventListener('change', () => {
      const value = (llmChatProviderSelect.value || '').trim();
      if(value){
        handleLlmProviderSelect(value);
        renderLlmModalModels();
        clearLlmTestResult();
      }
    });
  }

  if(llmEmbedProviderSelect && !llmEmbedProviderSelect.dataset.bound){
    llmEmbedProviderSelect.dataset.bound = 'true';
    llmEmbedProviderSelect.addEventListener('change', () => {
      const value = (llmEmbedProviderSelect.value || '').trim();
      const meta = getLlmProviderMeta(value);
      if(!meta) return;
      llmSettings.embeddingProvider = value;
      const defaultModel = (meta.defaultEmbeddingModel && typeof meta.defaultEmbeddingModel === 'string') ? meta.defaultEmbeddingModel.trim() : '';
      const list = Array.isArray(meta.embeddingModels) ? meta.embeddingModels.filter(m => typeof m === 'string' && m.trim()) : [];
      if(defaultModel){
        llmSettings.embeddingModel = defaultModel;
      } else if(list.length){
        llmSettings.embeddingModel = list[0];
      }
      saveProject();
      refreshLlmUi();
      renderLlmModalEmbedding();
      clearLlmTestResult();
      if(llmEmbedTestResult) llmEmbedTestResult.textContent = '';
    });
  }

  if(llmTtsProviderSelect && !llmTtsProviderSelect.dataset.bound){
    llmTtsProviderSelect.dataset.bound = 'true';
    llmTtsProviderSelect.addEventListener('change', () => {
      const value = (llmTtsProviderSelect.value || '').trim();
      const meta = getLlmProviderMeta(value);
      if(!meta) return;
      llmSettings.ttsProvider = value;
      const defaultModel = (meta.defaultTtsModel && typeof meta.defaultTtsModel === 'string') ? meta.defaultTtsModel.trim() : '';
      const list = Array.isArray(meta.ttsModels) ? meta.ttsModels.filter(m => typeof m === 'string' && m.trim()) : [];
      if(defaultModel){
        llmSettings.ttsModel = defaultModel;
      } else if(list.length){
        llmSettings.ttsModel = list[0];
      }
      saveProject();
      refreshLlmUi();
      renderLlmModalTts();
      clearLlmTestResult();
      if(llmTtsTestResult) llmTtsTestResult.textContent = '';
    });
  }

  if(llmModalTestBtn && !llmModalTestBtn.dataset.bound){
    llmModalTestBtn.dataset.bound = 'true';
    llmModalTestBtn.addEventListener('click', async function(){
      if(this.disabled) return;
      if(!ensureWorkspaceReady({silent: false})){
        return;
      }
      clearLlmTestResult();
      setLlmTestResult('测试中...', 'muted');
      this.disabled = true;
      try{
        const payload = withWorkspacePayload(withLlmConfig({type: 'chat'}));
        const res = await fetch(appendWorkspaceQuery('/llm/test'), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && parsed.json && parsed.json.success !== false){
          const result = parsed.json.result || {};
          const latency = typeof result.latencyMs === 'number' ? `${result.latencyMs.toFixed(1)} ms` : '未知延迟';
          const preview = typeof result.preview === 'string' && result.preview ? ` 返回示例：${result.preview}` : '';
          setLlmTestResult(`连通正常（${latency}）。${preview}`.trim(), 'success');
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || `HTTP ${res.status}`);
          setLlmTestResult(`测试失败：${message}`, 'danger');
        }
      }catch(e){
        const msg = e && e.message ? e.message : String(e || '未知错误');
        setLlmTestResult(`测试失败：${msg}`, 'danger');
      }
      this.disabled = false;
    });
  }

  if(llmEmbedTestBtn && !llmEmbedTestBtn.dataset.bound){
    llmEmbedTestBtn.dataset.bound = 'true';
    llmEmbedTestBtn.addEventListener('click', async function(){
      if(this.disabled) return;
      if(!ensureWorkspaceReady({silent: false})) return;
      setGenericTestResult(llmEmbedTestResult, '测试中...', 'muted');
      this.disabled = true;
      try{
        const payload = withWorkspacePayload(withLlmConfig({type: 'embedding'}));
        const res = await fetch(appendWorkspaceQuery('/llm/test'), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && parsed.json && parsed.json.success !== false){
          const result = parsed.json.result || {};
          const latency = typeof result.latencyMs === 'number' ? `${result.latencyMs.toFixed(1)} ms` : '未知延迟';
          setGenericTestResult(llmEmbedTestResult, `连通正常（${latency}）`, 'success');
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || `HTTP ${res.status}`);
          setGenericTestResult(llmEmbedTestResult, `测试失败：${message}`, 'danger');
        }
      } catch(e){
        const msg = e && e.message ? e.message : String(e || '未知错误');
        setGenericTestResult(llmEmbedTestResult, `测试失败：${msg}`, 'danger');
      }
      this.disabled = false;
    });
  }

  if(llmTtsTestBtn && !llmTtsTestBtn.dataset.bound){
    llmTtsTestBtn.dataset.bound = 'true';
    llmTtsTestBtn.addEventListener('click', async function(){
      if(this.disabled) return;
      if(!ensureWorkspaceReady({silent: false})) return;
      setGenericTestResult(llmTtsTestResult, '测试中...', 'muted');
      this.disabled = true;
      try{
        const payload = withWorkspacePayload(withLlmConfig({type: 'tts'}));
        const res = await fetch(appendWorkspaceQuery('/llm/test'), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const parsed = await parseJsonSafe(res);
        if(res.ok && parsed.json && parsed.json.success !== false){
          const result = parsed.json.result || {};
          const latency = typeof result.latencyMs === 'number' ? `${result.latencyMs.toFixed(1)} ms` : '未知延迟';
          setGenericTestResult(llmTtsTestResult, `连通正常（${latency}）`, 'success');
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || `HTTP ${res.status}`);
          setGenericTestResult(llmTtsTestResult, `测试失败：${message}`, 'danger');
        }
      } catch(e){
        const msg = e && e.message ? e.message : String(e || '未知错误');
        setGenericTestResult(llmTtsTestResult, `测试失败：${msg}`, 'danger');
      }
      this.disabled = false;
    });
  }

  refreshLlmUi();
  const resourceRenameModalEl = document.getElementById('resourceRenameModal');
  const resourceRenameInput = document.getElementById('resource-rename-input');
  const resourceRenamePreview = document.getElementById('resource-rename-preview');
  const resourceRenameConfirm = document.getElementById('resource-rename-confirm');
  const resourceUploadInput = document.getElementById('modal-resource-upload-input');
  const resourceUploadDirInput = document.getElementById('modal-resource-upload-dir-input');
  const resourceUploadSelectFolderBtn = document.getElementById('modal-resource-select-folder-btn');
  const resourceUploadHint = document.getElementById('modal-resource-upload-hint');
  if(resourceRenameInput){
    resourceRenameInput.addEventListener('input', () => updateResourceRenamePreviewText(resourceRenameInput.value));
  }
  if(resourceUploadInput){
    resourceUploadInput.addEventListener('change', () => {
      if(resourceUploadDirInput){
        resourceUploadDirInput.value = '';
      }
      updateResourceUploadHint();
    });
  }
  if(resourceUploadDirInput){
    resourceUploadDirInput.addEventListener('change', () => {
      if(resourceUploadInput){
        resourceUploadInput.value = '';
      }
      updateResourceUploadHint();
    });
  }
  if(resourceUploadSelectFolderBtn && resourceUploadDirInput){
    resourceUploadSelectFolderBtn.addEventListener('click', () => {
      resourceUploadDirInput.value = '';
      if(resourceUploadInput){
        resourceUploadInput.value = '';
      }
      updateResourceUploadHint();
      resourceUploadDirInput.click();
    });
  }
  updateResourceUploadHint();
  const resourcePreviewModalEl = document.getElementById('resourcePreviewModal');
  const resourcePreviewImage = document.getElementById('resource-preview-image');
  const resourcePreviewMeta = document.getElementById('resource-preview-meta');
  const resourcePreviewOpen = document.getElementById('resource-preview-open');
  const attachmentRenameModalEl = document.getElementById('attachmentRenameModal');
  const attachmentRenameInput = document.getElementById('attachment-rename-input');
  const attachmentRenameConfirm = document.getElementById('attachment-rename-confirm');
  const attachmentPreviewModalEl = document.getElementById('attachmentPreviewModal');
  const attachmentPreviewImage = document.getElementById('attachment-preview-image');
  const attachmentPreviewMeta = document.getElementById('attachment-preview-meta');
  const attachmentPreviewOpen = document.getElementById('attachment-preview-open');
  const searchInputEl = document.getElementById('search-modal-input');
  const searchSubmitBtn = document.getElementById('search-modal-submit');
  function goToPrevPage(){
    if(currentPageIdx > 0){
      currentPageIdx -= 1;
      renderSingleEditor();
      refreshPreview();
      updatePageNumLabel();
    }
  }

  function goToNextPage(){
    const total = Array.isArray(pagesData) ? pagesData.length : 0;
    if(currentPageIdx < total - 1){
      currentPageIdx += 1;
      renderSingleEditor();
      refreshPreview();
      updatePageNumLabel();
    }
  }
  const prevPageBtn = document.getElementById('prev-page');
  if(prevPageBtn){
    prevPageBtn.addEventListener('click', () => {
      goToPrevPage();
    });
  }
  const nextPageBtn = document.getElementById('next-page');
  if(nextPageBtn){
    nextPageBtn.addEventListener('click', () => {
      goToNextPage();
    });
  }

  let projectMetadata = {};
  let projectListCache = [];
  let projectRenameTarget = '';
  let projectDeleteTarget = '';
  let projectPasswordTarget = '';
  let projectUnlockTargetName = '';
  const projectCreateModalEl = document.getElementById('projectCreateModal');
  const projectCreateNameInput = document.getElementById('project-create-name');
  const projectCreateConfirmBtn = document.getElementById('project-create-confirm');
  const projectRenameModalEl = document.getElementById('projectRenameModal');
  const projectRenameCurrent = document.getElementById('project-rename-current');
  const projectRenameInput = document.getElementById('project-rename-name');
  const projectRenameConfirmBtn = document.getElementById('project-rename-confirm');
  const projectDeleteModalEl = document.getElementById('projectDeleteModal');
  const projectDeleteWarning = document.getElementById('project-delete-warning');
  const projectDeleteConfirmInput = document.getElementById('project-delete-confirm-name');
  const projectDeleteConfirmBtn = document.getElementById('project-delete-confirm');
  const projectPasswordModalEl = document.getElementById('projectPasswordModal');
  const projectPasswordCurrentInput = document.getElementById('project-password-current');
  const projectPasswordNewInput = document.getElementById('project-password-new');
  const projectPasswordConfirmInput = document.getElementById('project-password-confirm');
  const projectPasswordWarning = document.getElementById('project-password-warning');
  const projectPasswordSaveBtn = document.getElementById('project-password-save');
  const projectPasswordRemoveBtn = document.getElementById('project-password-remove');
  const projectUnlockModalEl = document.getElementById('projectUnlockModal');
  const projectUnlockTargetLabel = document.getElementById('project-unlock-target');
  const projectUnlockPasswordInput = document.getElementById('project-unlock-password');
  const projectUnlockErrorBox = document.getElementById('project-unlock-error');
  const projectUnlockConfirmBtn = document.getElementById('project-unlock-confirm');

  if(resourceRenameModalEl){
    resourceRenameModalEl.addEventListener('hidden.bs.modal', () => {
      resourceRenameTarget = null;
      resourceRenameBasePath = '';
      if(resourceRenameInput) {
        resourceRenameInput.value = '';
        resourceRenameInput.removeAttribute('title');
      }
      if(resourceRenamePreview) resourceRenamePreview.textContent = '';
    });
    resourceRenameModalEl.addEventListener('shown.bs.modal', () => {
      if(!resourceRenameInput) return;
      requestAnimationFrame(() => {
        resourceRenameInput.focus();
        resourceRenameInput.select();
      });
    });
  }

  if(resourceRenameInput && resourceRenamePreview && !resourceRenameInput.dataset.previewBound){
    resourceRenameInput.dataset.previewBound = 'true';
    resourceRenameInput.addEventListener('input', () => {
      const currentValue = resourceRenameInput.value;
      resourceRenamePreview.textContent = currentValue ? `完整名称：${currentValue}` : '';
      if(currentValue){
        resourceRenameInput.title = currentValue;
      } else {
        resourceRenameInput.removeAttribute('title');
      }
    });
  }
  if(resourcePreviewModalEl){
    resourcePreviewModalEl.addEventListener('hidden.bs.modal', () => {
      if(resourcePreviewImage) resourcePreviewImage.removeAttribute('src');
      if(resourcePreviewMeta) resourcePreviewMeta.textContent = '';
      if(resourcePreviewOpen){
        resourcePreviewOpen.href = '#';
        resourcePreviewOpen.classList.add('disabled');
      }
    });
  }

  if(attachmentRenameModalEl){
    attachmentRenameModalEl.addEventListener('hidden.bs.modal', () => {
      attachmentRenameTarget = null;
      if(attachmentRenameInput) attachmentRenameInput.value = '';
    });
  }

  if(attachmentPreviewModalEl){
    attachmentPreviewModalEl.addEventListener('hidden.bs.modal', () => {
      if(attachmentPreviewImage) attachmentPreviewImage.removeAttribute('src');
      if(attachmentPreviewMeta) attachmentPreviewMeta.textContent = '';
    });
  }

  if(projectCreateModalEl){
    projectCreateModalEl.addEventListener('hidden.bs.modal', () => {
      if(projectCreateNameInput) projectCreateNameInput.value = '';
    });
    projectCreateModalEl.addEventListener('shown.bs.modal', () => {
      if(projectCreateNameInput) projectCreateNameInput.focus();
    });
  }

  if(projectRenameModalEl){
    projectRenameModalEl.addEventListener('hidden.bs.modal', () => {
      projectRenameTarget = '';
      if(projectRenameInput) projectRenameInput.value = '';
    });
    projectRenameModalEl.addEventListener('shown.bs.modal', () => {
      if(projectRenameInput) projectRenameInput.focus();
    });
  }

  if(projectDeleteModalEl){
    projectDeleteModalEl.addEventListener('hidden.bs.modal', () => {
      projectDeleteTarget = '';
      if(projectDeleteConfirmInput){
        projectDeleteConfirmInput.value = '';
        projectDeleteConfirmInput.classList.remove('is-invalid');
      }
    });
    projectDeleteModalEl.addEventListener('shown.bs.modal', () => {
      if(projectDeleteConfirmInput) projectDeleteConfirmInput.focus();
    });
  }

  if(projectPasswordModalEl){
    projectPasswordModalEl.addEventListener('hidden.bs.modal', () => {
      projectPasswordTarget = '';
      if(projectPasswordCurrentInput) projectPasswordCurrentInput.value = '';
      if(projectPasswordNewInput) projectPasswordNewInput.value = '';
      if(projectPasswordConfirmInput) projectPasswordConfirmInput.value = '';
      if(projectPasswordWarning){
        projectPasswordWarning.textContent = '';
        projectPasswordWarning.classList.add('d-none');
      }
    });
    projectPasswordModalEl.addEventListener('shown.bs.modal', () => {
      if(projectPasswordNewInput) projectPasswordNewInput.focus();
    });
  }

  if(projectUnlockModalEl){
    projectUnlockModalEl.addEventListener('hidden.bs.modal', () => {
      projectUnlockTargetName = '';
      if(projectUnlockPasswordInput) projectUnlockPasswordInput.value = '';
      if(projectUnlockErrorBox){
        projectUnlockErrorBox.classList.add('d-none');
        projectUnlockErrorBox.textContent = '';
      }
    });
    projectUnlockModalEl.addEventListener('shown.bs.modal', () => {
      if(projectUnlockPasswordInput) projectUnlockPasswordInput.focus();
    });
  }

  function getProjectMeta(name){
    if(!name) return {};
    if(currentWorkspace){
      const workspaceLabel = currentWorkspace.display_name || currentWorkspace.workspace_id;
      if(name === workspaceLabel || name === currentProject){
        return {
          locked: !!currentWorkspace.locked,
          unlocked: !!currentWorkspace.unlocked,
        };
      }
    }
    return projectMetadata && Object.prototype.hasOwnProperty.call(projectMetadata, name) ? (projectMetadata[name] || {}) : {};
  }

  function closeProjectDropdown(){
    const dropdownToggle = document.getElementById('project-dropdown');
    if(!dropdownToggle) return;
    const dropdown = bootstrap.Dropdown.getInstance(dropdownToggle);
    if(dropdown) dropdown.hide();
  }

  function openProjectUnlockModal(name){
    projectUnlockTargetName = name || currentProject || '';
    if(projectUnlockTargetLabel){
      const labelName = projectUnlockTargetName || '当前工作区';
      projectUnlockTargetLabel.textContent = `工作区「${labelName}」已加密，请输入密码解锁。`;
    }
    if(projectUnlockErrorBox){
      projectUnlockErrorBox.classList.add('d-none');
      projectUnlockErrorBox.textContent = '';
    }
    if(projectUnlockPasswordInput) projectUnlockPasswordInput.value = '';
    if(projectUnlockModalEl){
      const modal = bootstrap.Modal.getOrCreateInstance(projectUnlockModalEl);
      modal.show();
    }
  }

  function handleProjectLocked(message){
    if(currentWorkspace){
      updateWorkspaceSecurityState({locked: true, unlocked: false});
    }
    const info = message || '工作区已加密，请先解锁';
    showStatus(info, 'warning', 6000);
    const target = currentWorkspace ? (currentWorkspace.display_name || currentWorkspace.workspace_id) : currentProject;
    openProjectUnlockModal(target);
  }

  function ensureSearchModal() {
    if (searchModalInstance) return searchModalInstance;
    const modalEl = document.getElementById('searchModal');
    if (!modalEl) return null;
    searchModalInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
    modalEl.addEventListener('shown.bs.modal', () => {
      if (searchInputEl) {
        searchInputEl.focus();
        searchInputEl.select();
      }
    });
    modalEl.addEventListener('hidden.bs.modal', () => {
      const resultsEl = document.getElementById('search-results');
      if (resultsEl) {
        resultsEl.scrollTop = 0;
      }
      if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
        searchDebounceTimer = null;
      }
      if (searchInputEl) {
        searchInputEl.removeAttribute('data-loading');
      }
    });
    return searchModalInstance;
  }

  function setSearchSummary(message, tone = 'muted') {
    const summaryEl = document.getElementById('search-summary');
    if (!summaryEl) return;
    summaryEl.textContent = message || '';
    summaryEl.classList.remove('text-muted', 'text-danger', 'text-success');
    if (tone === 'danger') summaryEl.classList.add('text-danger');
    else if (tone === 'success') summaryEl.classList.add('text-success');
    else summaryEl.classList.add('text-muted');
  }

  function renderSearchResults(results, query) {
    const list = document.getElementById('search-results');
    if (!list) return;
    list.innerHTML = '';

    if (!Array.isArray(results) || results.length === 0) {
      const message = query ? `未找到与“${query}”相关的内容。` : '请输入关键词后检索当前项目。';
      setSearchSummary(message, query ? 'danger' : 'muted');
      return;
    }

    setSearchSummary(`找到 ${results.length} 条与 “${query}” 相关的内容。`, 'success');

    results.forEach((match, idx) => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'list-group-item list-group-item-action text-start';
      item.dataset.searchResultIndex = String(idx);

      const pageLabel = match.pageLabel || `第 ${match.pageIndex + 1} 页`;
      const fieldLabel = match.fieldLabel || match.field || '';
      const matchCount = typeof match.matchCount === 'number' ? match.matchCount : 1;
      const excerptHtml = highlightExcerptText(match.excerpt || '', query);

      item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="fw-semibold">${escapeHtml(pageLabel)}</div>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-primary-subtle text-primary-emphasis border border-primary-subtle">${escapeHtml(fieldLabel)}</span>
            <span class="badge bg-light text-muted border">${matchCount} 次命中</span>
          </div>
        </div>
        <div class="mt-2 text-muted small">${excerptHtml}</div>
      `;

      item.addEventListener('click', () => {
        navigateToSearchMatch(match, query);
      });

      list.appendChild(item);
    });
  }

  function resetSearchState() {
    searchResultsCache = [];
    searchQueryCache = '';
    renderSearchResults([], '');
    setSearchSummary('请输入关键词后检索当前项目。', 'muted');
  }

  function handleSearchError(message) {
    renderSearchResults([], searchQueryCache);
    setSearchSummary(message || '检索失败，请稍后再试。', 'danger');
  }

  function highlightScriptMatch(match, query) {
    const scriptInput = document.getElementById('page-script');
    if (!scriptInput) return;
    const value = scriptInput.value || '';
    let start = typeof match.position === 'number' ? match.position : -1;
    const searchTerm = query || '';
    if (start < 0 && searchTerm) {
      start = value.toLowerCase().indexOf(searchTerm.toLowerCase());
    }
    if (start < 0) return;
    const len = Math.min(match.matchLength || searchTerm.length || 1, value.length - start);
    scriptInput.focus();
    scriptInput.setSelectionRange(start, start + len);
  }

  function highlightEditorMatch(match, query) {
    if (!singleEditor) return;
    const doc = singleEditor.getDoc();
    const value = doc.getValue();
    if (!value) return;
    const searchTerm = query || '';
    let start = typeof match.position === 'number' ? match.position : -1;
    if (start < 0 && searchTerm) {
      start = value.toLowerCase().indexOf(searchTerm.toLowerCase());
    }
    if (start < 0) return;
    const length = Math.min(match.matchLength || searchTerm.length || 1, value.length - start);
    const from = doc.posFromIndex(start);
    const to = doc.posFromIndex(start + length);
    doc.setSelection(from, to);
    singleEditor.focus();
    singleEditor.scrollIntoView({from, to}, 100);
  }

  function navigateToSearchMatch(match, query) {
    if (!match) return;
    let idx = typeof match.pageIndex === 'number' ? match.pageIndex : -1;
    if ((idx < 0 || idx >= pagesData.length) && match.pageId) {
      const foundIdx = pagesData.findIndex(p => p && p.pageId === match.pageId);
      if (foundIdx !== -1) {
        idx = foundIdx;
      }
    }
    if (idx < 0 || idx >= pagesData.length) return;

    currentPageIdx = idx;
    updatePageNumLabel();

    if (match.field === 'script') {
      renderSingleEditor();
      refreshPreview();
      setTimeout(() => highlightScriptMatch(match, query), 80);
      return;
    }

    const desiredMode = match.field === 'notes' ? 'markdown' : 'latex';
    const needSwitch = currentEditMode !== desiredMode;
    if (needSwitch) {
      setEditMode(desiredMode);
      setTimeout(() => {
        refreshPreview();
        highlightEditorMatch(match, query);
      }, 100);
    } else {
      renderSingleEditor();
      refreshPreview();
      setTimeout(() => highlightEditorMatch(match, query), 80);
    }
  }

  function performProjectSearch(rawQuery) {
    if (searchDebounceTimer) {
      clearTimeout(searchDebounceTimer);
      searchDebounceTimer = null;
    }
    const button = document.getElementById('project-search-btn');
    const query = (rawQuery || '').trim();
    if (searchInputEl && searchInputEl.value !== query) {
      searchInputEl.value = query;
    }

    const modal = ensureSearchModal();
    if (modal) modal.show();

    if (searchAbortController) {
      try {
        searchAbortController.abort();
      } catch (err) {}
      searchAbortController = null;
    }

    if (!query) {
      resetSearchState();
      if (searchInputEl) {
        searchInputEl.focus();
        searchInputEl.removeAttribute('data-loading');
      }
      return;
    }

    searchQueryCache = query;
    setSearchSummary(`正在检索 “${query}”…`, 'muted');
    renderSearchResults([], query);

    if (button) button.disabled = true;
    if (searchInputEl) searchInputEl.setAttribute('data-loading', 'true');

    const controller = new AbortController();
    searchAbortController = controller;
    const requestToken = ++searchRequestId;

    if(!ensureWorkspaceReady({silent: true})){
      if (button) button.disabled = false;
      if (searchInputEl) searchInputEl.removeAttribute('data-loading');
      handleSearchError('请先选择工作区');
      return;
    }
    const searchPayload = withWorkspacePayload({query});
    fetch(buildApiUrl('/search'), {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(searchPayload),
      signal: controller.signal,
    }).then(async res => {
      if (requestToken !== searchRequestId) return;
      if (button) button.disabled = false;
      if (searchInputEl) searchInputEl.removeAttribute('data-loading');

      if (res.status === 401 || res.status === 423) {
        handleProjectLocked();
        handleSearchError('工作区已加密，请先解锁。');
        return;
      }

      if (!res.ok) {
        let message = `检索失败：HTTP ${res.status}`;
        try {
          const data = await res.json();
          if (data && data.error) message = data.error;
        } catch (err) {
          try {
            const text = await res.text();
            if (text) message = text;
          } catch (_) {}
        }
        handleSearchError(message);
        return;
      }

      const data = await res.json();
      if (requestToken !== searchRequestId) return;

      searchResultsCache = Array.isArray(data.matches) ? data.matches : [];
      renderSearchResults(searchResultsCache, data.query || query);
    }).catch(err => {
      if (requestToken !== searchRequestId) return;
      if (button) button.disabled = false;
      if (searchInputEl) searchInputEl.removeAttribute('data-loading');
      if (err && err.name === 'AbortError') return;
      handleSearchError(err?.message || '检索失败，请稍后再试。');
    });
  }

  function createMenuAction(menu, {id, label, handler, disabled}) {
    const li = document.createElement('li');
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'dropdown-item';
    if(id) btn.id = id;
    btn.textContent = label;
    if(disabled) btn.disabled = true;
    btn.addEventListener('click', () => {
      closeProjectDropdown();
      if(typeof handler === 'function') handler();
    });
    li.dataset.projectAction = 'item';
    li.appendChild(btn);
    menu.appendChild(li);
    return btn;
  }

  function buildProjectMenu(menu){
    if(!menu) return;
    const name = currentWorkspace ? (currentWorkspace.display_name || currentWorkspace.workspace_id) : '';
    const suffix = currentWorkspace && currentWorkspace.mode === 'cloud' ? '（云端）' : '';
    const lockSuffix = getWorkspaceLockSuffix(currentWorkspace);
    const path = getWorkspaceDisplayPath(currentWorkspace);
    const statusLine = name ? `当前：${escapeHtml(name + suffix + lockSuffix)}` : '当前：未选择';
    const pathLine = path ? `<div class="dropdown-item-text text-muted small text-truncate">路径：${escapeHtml(path)}</div>` : '';
    menu.innerHTML = `
      <li><h6 class="dropdown-header">工作区</h6></li>
      <li><span class="dropdown-item-text text-muted">${statusLine}</span>${pathLine}</li>
      <li><hr class="dropdown-divider"></li>
      <li><button type="button" class="dropdown-item d-flex align-items-center gap-2 workspace-menu-action" data-workspace-action="local">
        <span class="text-primary">📁</span><span>打开本地工作区</span>
      </button></li>
      <li><button type="button" class="dropdown-item d-flex align-items-center gap-2 workspace-menu-action" data-workspace-action="remote">
        <span class="text-info">☁️</span><span>打开远程工作区</span>
      </button></li>
      <li><hr class="dropdown-divider"></li>
      <li><h6 class="dropdown-header">安全</h6></li>
      <li><button type="button" class="dropdown-item d-flex align-items-center gap-2 workspace-menu-action" data-workspace-action="password">
        <span class="text-warning">🔐</span><span>设置 / 管理密码</span>
      </button></li>
      <li><button type="button" class="dropdown-item d-flex align-items-center gap-2 workspace-menu-action" data-workspace-action="unlock">
        <span class="text-success">🔓</span><span>解锁当前工作区</span>
      </button></li>
    `;
  }

  function renderProjectActionsSection(menu){
    buildProjectMenu(menu);
  }
  if(projectMenuEl){
    projectMenuEl.addEventListener('click', event => {
      const actionBtn = event.target.closest('.workspace-menu-action');
      if(!actionBtn) return;
      event.preventDefault();
      closeProjectDropdown();
      const action = actionBtn.dataset.workspaceAction;
      if(action === 'local'){
        setWorkspaceOverlayMessage('');
        showWorkspaceOverlay();
      } else if(action === 'remote'){
        openRemoteWorkspacePanel();
      } else if(action === 'password'){
        openProjectPasswordModal();
      } else if(action === 'unlock'){
        if(!currentWorkspace || !currentWorkspace.workspace_id){
          promptWorkspaceSelection('请先在工作区面板中选择需要解锁的工作区');
          return;
        }
        if(!currentWorkspace.locked || currentWorkspace.unlocked){
          showStatus('当前工作区未加密或已解锁', 'info', 4000);
          return;
        }
        const label = currentWorkspace.display_name || currentWorkspace.workspace_id;
        openProjectUnlockModal(label);
      }
    });
  }

  async function selectProjectByName() {
    promptWorkspaceSelection('项目切换已迁移到工作区模式');
  }

  function openRemoteWorkspacePanel(){
    if(!remoteWorkspaceModalEl){
      showStatus('尚未配置远程工作区支持', 'warning', 5000);
      return;
    }
    if(!remoteWorkspaceModalInstance && typeof bootstrap !== 'undefined' && bootstrap.Modal){
      remoteWorkspaceModalInstance = bootstrap.Modal.getOrCreateInstance(remoteWorkspaceModalEl);
    }
    if(remoteWorkspaceModalInstance){
      remoteWorkspaceModalInstance.show();
    }
    fetchRemoteWorkspaceList();
  }

  function updateModeToggleUI() {
    const switchBtn = document.getElementById('mode-switch-btn');
    if (!switchBtn) return;
    const isMarkdown = currentEditMode === 'markdown';
    switchBtn.textContent = isMarkdown ? 'Markdown 模式' : 'LaTeX 模式';
    switchBtn.setAttribute('aria-pressed', isMarkdown ? 'true' : 'false');
    switchBtn.title = isMarkdown ? '当前为 Markdown 编辑，点击切换至 LaTeX' : '当前为 LaTeX 编辑，点击切换至 Markdown';
    switchBtn.classList.toggle('btn-primary', isMarkdown);
    switchBtn.classList.toggle('btn-outline-primary', !isMarkdown);
  }

  function showStatus(message, type = 'info', timeout = 4000) {
    const area = document.getElementById('status-area');
    if (!area) return;
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show shadow`;
    alertDiv.setAttribute('role', 'alert');
    alertDiv.textContent = message;
    area.appendChild(alertDiv);
    setTimeout(() => {
      alertDiv.classList.remove('show');
      alertDiv.classList.add('fade');
      setTimeout(() => alertDiv.remove(), 200);
    }, timeout);
  }

  async function exportTex() {
    try {
      const res = await fetch(appendWorkspaceQuery('/export_tex'));
      if (!res.ok) {
        const parsed = await parseJsonSafe(res);
        const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || `HTTP ${res.status}`);
        showStatus('导出 TeX 失败：' + message, 'danger', 6000);
        return;
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'exported_full.tex';
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
      showStatus('TeX 导出完成', 'success', 2500);
    } catch (err) {
      console.error('导出 TeX 失败', err);
      showStatus('导出 TeX 失败：' + (err?.message || '未知错误'), 'danger', 6000);
    }
  }

  function updateProjectButtonLabel() {
    const btn = document.getElementById('project-dropdown');
    if (!btn) return;
    if(currentWorkspace){
      const name = currentWorkspace.display_name || currentWorkspace.workspace_id;
      const suffix = currentWorkspace.mode === 'cloud' ? '（云端）' : '';
      const lockSuffix = getWorkspaceLockSuffix(currentWorkspace);
      btn.textContent = `工作区 · ${name}${suffix}${lockSuffix}`;
    } else {
      btn.textContent = '选择工作区';
    }
    renderProjectActionsSection(document.getElementById('project-menu'));
  }

  function normalizeTemplateText(text) {
    return (text || '').replace(/\r\n/g, '\n').trim();
  }

  function normalizeCssText(text) {
    return (text || '').replace(/\r\n/g, '\n').trim();
  }

  function detectCurrentTemplate(mode) {
    if (!templatesLoaded) return;
    if (mode === 'markdown') {
      const css = normalizeCssText(markdownTemplate.css);
      const wrapper = (markdownTemplate.wrapperClass || '').trim();
      const match = (availableTemplates.markdown || []).find(t =>
        normalizeCssText(t.css) === css &&
        (t.wrapperClass || '') === wrapper
      );
      selectedTemplateName.markdown = match ? match.name : '';
      return;
    }

    const header = normalizeTemplateText(latexTemplate.header);
    const before = normalizeTemplateText(latexTemplate.beforePages);
    const footer = normalizeTemplateText(latexTemplate.footer);
    const match = (availableTemplates.latex || []).find(t =>
      normalizeTemplateText(t.header) === header &&
      normalizeTemplateText(t.beforePages) === before &&
      normalizeTemplateText(t.footer) === footer
    );
    selectedTemplateName.latex = match ? match.name : '';
  }

  function detectAllTemplates() {
    detectCurrentTemplate('latex');
    detectCurrentTemplate('markdown');
  }

  function ensureTemplatesLoaded() {
    if (templatesLoaded) return Promise.resolve(availableTemplates);
    return fetch('/templates/list')
      .then(res => res.json())
      .then(data => {
        const templates = data.templates;
        if (templates && typeof templates === 'object') {
          availableTemplates = {
            latex: Array.isArray(templates.latex) ? templates.latex : [],
            markdown: Array.isArray(templates.markdown) ? templates.markdown : [],
          };
        } else {
          // 兼容旧结构
          const fallbackList = Array.isArray(templates) ? templates : [];
          availableTemplates = {
            latex: fallbackList,
            markdown: [],
          };
        }
        templatesLoaded = true;
        detectAllTemplates();
        return availableTemplates;
      })
      .catch(err => {
        showStatus('加载模板列表失败：' + (err?.message || '未知错误'), 'danger', 6000);
        throw err;
      });
  }

  function populateTemplateSelect(mode) {
    const select = document.getElementById('template-select');
    if (!select) return;
    const groups = mode === 'markdown' ? (availableTemplates.markdown || []) : (availableTemplates.latex || []);
    const currentValue = selectedTemplateName[mode] || '';
    select.innerHTML = '';
    const customOption = document.createElement('option');
    customOption.value = '';
    customOption.textContent = '自定义（当前模板）';
    select.appendChild(customOption);
    groups.forEach(t => {
      const opt = document.createElement('option');
      opt.value = t.name;
      opt.textContent = t.name;
      select.appendChild(opt);
    });
    select.value = currentValue;
  }

  function applyTemplateByName(name, mode) {
    const list = mode === 'markdown' ? (availableTemplates.markdown || []) : (availableTemplates.latex || []);
    const tmpl = list.find(t => t.name === name);
    if (!tmpl) return;
    if (mode === 'markdown') {
      document.getElementById('template-markdown-css').value = tmpl.css || '';
      document.getElementById('template-markdown-wrapper').value = tmpl.wrapperClass || '';
      selectedTemplateName.markdown = name;
    } else {
      document.getElementById('template-header').value = tmpl.header || '';
      document.getElementById('template-before-pages').value = tmpl.beforePages || '';
      document.getElementById('template-footer').value = tmpl.footer || '';
      selectedTemplateName.latex = name;
    }
  }

  function applyMarkdownStyles() {
    const styleId = 'markdown-template-style';
    const head = document.head || document.getElementsByTagName('head')[0];
    if (head) {
      let styleEl = document.getElementById(styleId);
      if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = styleId;
        head.appendChild(styleEl);
      }
      styleEl.textContent = markdownTemplate.css || '';
    }
    const previewRoot = document.getElementById('markdown-preview-content');
    if (previewRoot) {
      const baseClasses = ['markdown-preview-content'];
      const extra = (markdownTemplate.wrapperClass || '').trim();
      const classSet = new Set(baseClasses);
      if (extra) {
        extra.split(/\s+/).filter(Boolean).forEach(cls => classSet.add(cls));
      }
      previewRoot.className = Array.from(classSet).join(' ');
    }
  }

  function getMarkdownImageModal() {
    const modalEl = document.getElementById('markdownImageModal');
    if (!modalEl || !window.bootstrap || !window.bootstrap.Modal) {
      return null;
    }
    if (!markdownImageModalInstance) {
      markdownImageModalInstance = new window.bootstrap.Modal(modalEl);
    }
    if (!modalEl.dataset.markdownModalBound) {
      modalEl.addEventListener('hidden.bs.modal', () => {
        const modalImg = document.getElementById('markdownImageModalImg');
        const captionEl = document.getElementById('markdownImageCaption');
        if (modalImg) {
          modalImg.removeAttribute('src');
          modalImg.removeAttribute('srcset');
          modalImg.alt = '';
        }
        if (captionEl) {
          captionEl.textContent = '';
          captionEl.classList.add('d-none');
        }
      });
      modalEl.dataset.markdownModalBound = '1';
    }
    return markdownImageModalInstance;
  }

  function getMarkdownTableModal() {
    const modalEl = document.getElementById('markdownTableModal');
    if (!modalEl || !window.bootstrap || !window.bootstrap.Modal) {
      return null;
    }
    if (!markdownTableModalInstance) {
      markdownTableModalInstance = new window.bootstrap.Modal(modalEl);
    }
    if (!modalEl.dataset.markdownTableBound) {
      modalEl.addEventListener('hidden.bs.modal', () => {
        const body = document.getElementById('markdownTableModalBody');
        const caption = document.getElementById('markdownTableModalCaption');
        if (body) {
          body.innerHTML = '';
        }
        if (caption) {
          caption.textContent = '';
          caption.classList.add('d-none');
        }
      });
      modalEl.dataset.markdownTableBound = '1';
    }
    return markdownTableModalInstance;
  }

  function openTableInModal(table) {
    if (!table) return;
    const modalInstance = getMarkdownTableModal();
    const body = document.getElementById('markdownTableModalBody');
    const captionEl = document.getElementById('markdownTableModalCaption');
    if (!modalInstance || !body) return;
    body.innerHTML = '';
    const clonedTable = table.cloneNode(true);
    clonedTable.removeAttribute('id');
    clonedTable.removeAttribute('data-markdown-preview-table-enhanced');
    Array.from(clonedTable.querySelectorAll('[data-markdown-preview-table-enhanced]')).forEach(node => {
      node.removeAttribute('data-markdown-preview-table-enhanced');
    });
    Array.from(clonedTable.querySelectorAll('button.markdown-table-expand-btn')).forEach(btn => btn.remove());
    body.appendChild(clonedTable);
    if (captionEl) {
      const caption = table.querySelector('caption');
      if (caption && caption.textContent.trim()) {
        captionEl.textContent = caption.textContent.trim();
        captionEl.classList.remove('d-none');
      } else {
        captionEl.textContent = '';
        captionEl.classList.add('d-none');
      }
    }
    modalInstance.show();
  }

  function enhanceMarkdownImages(container) {
    if (!container) return;
    const modalEl = document.getElementById('markdownImageModal');
    const modalImg = document.getElementById('markdownImageModalImg');
    const captionEl = document.getElementById('markdownImageCaption');
    if (!modalEl || !modalImg) return;
    container.querySelectorAll('img').forEach(img => {
      if (!(img instanceof HTMLImageElement)) return;
      if (img.dataset.markdownPreviewEnhanced === '1') return;
      img.dataset.markdownPreviewEnhanced = '1';
      if (!img.getAttribute('loading')) {
        img.setAttribute('loading', 'lazy');
      }
      if (!img.getAttribute('decoding')) {
        img.setAttribute('decoding', 'async');
      }
      img.classList.add('markdown-preview-image');
      if (!img.hasAttribute('tabindex')) {
        img.setAttribute('tabindex', '0');
      }
      if (!img.hasAttribute('role')) {
        img.setAttribute('role', 'button');
      }
      const openModal = event => {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        const modalInstance = getMarkdownImageModal();
        if (!modalInstance) return;
        const source = img.currentSrc || img.src || img.getAttribute('data-src');
        if (source) {
          modalImg.src = source;
        } else {
          modalImg.removeAttribute('src');
        }
        if (img.srcset) {
          modalImg.srcset = img.srcset;
        } else {
          modalImg.removeAttribute('srcset');
        }
        const altText = img.getAttribute('alt') || img.getAttribute('title') || '';
        modalImg.alt = altText || '';
        if (captionEl) {
          if (altText) {
            captionEl.textContent = altText;
            captionEl.classList.remove('d-none');
          } else {
            captionEl.textContent = '';
            captionEl.classList.add('d-none');
          }
        }
        modalInstance.show();
      };
      img.addEventListener('click', openModal);
      img.addEventListener('keydown', event => {
        if (event.key === 'Enter' || event.key === ' ') {
          openModal(event);
        }
      });
      const parentLink = img.closest('a');
      if (parentLink) {
        parentLink.addEventListener('click', event => {
          if (event.target === img || event.currentTarget === event.target) {
            openModal(event);
          }
        });
        parentLink.addEventListener('keydown', event => {
          if (event.key === 'Enter' || event.key === ' ') {
            openModal(event);
          }
        });
      }
    });
  }

  function enhanceMarkdownTables(container) {
    if (!container) return;
    container.querySelectorAll('table').forEach(table => {
      if (!(table instanceof HTMLTableElement)) return;
      if (table.dataset.markdownPreviewTableEnhanced === '1') {
        return;
      }
      table.dataset.markdownPreviewTableEnhanced = '1';
      let wrapper = table.closest('.markdown-preview-table-wrapper');
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.className = 'markdown-preview-table-wrapper';
        table.parentNode.insertBefore(wrapper, table);
        wrapper.appendChild(table);
      }
      if (!wrapper.getAttribute('tabindex')) {
        wrapper.setAttribute('tabindex', '0');
      }
      if (!wrapper.hasAttribute('role')) {
        wrapper.setAttribute('role', 'region');
      }
      if (!wrapper.hasAttribute('aria-label')) {
        wrapper.setAttribute('aria-label', '表格预览区域，可滚动，按 Enter 放大查看');
      }
      if (!wrapper.dataset.markdownTableHotkeyBound) {
        wrapper.addEventListener('keydown', event => {
          if ((event.key === 'Enter' || event.key === ' ') && event.target === wrapper) {
            event.preventDefault();
            openTableInModal(table);
          }
        });
        wrapper.dataset.markdownTableHotkeyBound = '1';
      }
      let expandBtn = wrapper.querySelector('.markdown-table-expand-btn');
      if (!expandBtn) {
        expandBtn = document.createElement('button');
        expandBtn.type = 'button';
        expandBtn.className = 'markdown-table-expand-btn';
        expandBtn.innerHTML = '<span class="fw-semibold">放大表格</span>';
        expandBtn.title = '放大查看完整表格 (Enter)';
        expandBtn.setAttribute('aria-label', '放大查看完整表格');
        expandBtn.addEventListener('click', event => {
          event.preventDefault();
          openTableInModal(table);
        });
        wrapper.appendChild(expandBtn);
      }
    });
  }

  function parseCssColorToRgb(color) {
    if (!color || !document.body) return null;
    const probe = document.createElement('div');
    probe.style.color = color;
    probe.style.display = 'none';
    document.body.appendChild(probe);
    const computed = getComputedStyle(probe).color || '';
    probe.remove();
    const match = computed.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
    if (!match) return null;
    return match.slice(1, 4).map(val => Number(val));
  }

  function syncAccentThemeTokens() {
    const root = document.documentElement;
    if (!root) return;
    const styles = getComputedStyle(root);
    const accent = (styles.getPropertyValue('--accent') || '').trim() || '#2563eb';
    const accentStrong = (styles.getPropertyValue('--accent-strong') || '').trim() || accent;
    const shellText = (styles.getPropertyValue('--shell-text') || '').trim() || '#0f172a';
    const accentRgb = parseCssColorToRgb(accent) || [37, 99, 235];
    const accentStrongRgb = parseCssColorToRgb(accentStrong) || accentRgb;
    root.style.setProperty('--bs-primary', accent);
    root.style.setProperty('--bs-primary-rgb', accentRgb.join(','));
    root.style.setProperty('--bs-link-color', accent);
    root.style.setProperty('--bs-link-hover-color', accentStrong);
    root.style.setProperty('--bs-focus-ring-color', `color-mix(in srgb, ${accent} 45%, transparent)`);
    root.style.setProperty('--bs-primary-bg-subtle', `color-mix(in srgb, ${accent} 14%, transparent)`);
    root.style.setProperty('--bs-primary-border-subtle', `color-mix(in srgb, ${accentStrong} 28%, transparent)`);
    root.style.setProperty('--bs-primary-text-emphasis', accentStrong);
    root.style.setProperty('--bs-accordion-active-bg', `color-mix(in srgb, ${accent} 16%, transparent)`);
    root.style.setProperty('--bs-accordion-active-color', shellText);
    root.style.setProperty('--bs-accordion-btn-focus-border-color', `color-mix(in srgb, ${accentStrong} 65%, transparent)`);
    root.style.setProperty('--bs-accordion-btn-focus-box-shadow', `0 0 0 0.15rem color-mix(in srgb, ${accent} 30%, transparent)`);
    root.style.setProperty('--bs-btn-focus-shadow-rgb', accentStrongRgb.join(','));
    root.style.setProperty('--bs-list-group-active-bg', `color-mix(in srgb, ${accent} 16%, transparent)`);
    root.style.setProperty('--bs-list-group-active-color', shellText);
    root.style.setProperty('--bs-list-group-active-border-color', `color-mix(in srgb, ${accentStrong} 45%, transparent)`);
  }

  function applyNavbarTheme() {
    const theme = window.BENORT_UI_THEME || {};
    const config = theme.navbar_buttons || {};
    const skin = (document.body.getAttribute('data-ui-skin') || theme.skin || 'default').toLowerCase();
    const colorMode = (theme.color_mode || 'light').toLowerCase();
    const style = (config.style || 'uniform').toLowerCase() === 'palette' ? 'palette' : 'uniform';
    const variant = (config.variant || 'outline').toLowerCase() === 'solid' ? 'solid' : 'outline';
    const preset = (config.preset || '').toLowerCase();
    const skinDefaultPalette = {
      default: ['primary', 'secondary', 'info', 'success'],
      pastel: ['rose', 'amber', 'primary'],
      paper: ['amber', 'secondary', 'primary'],
      ocean: ['teal', 'info', 'primary'],
      forest: ['emerald', 'teal', 'secondary'],
      sunset: ['amber', 'primary', 'secondary'],
      slate: ['slate', 'info', 'primary'],
    };
    const skinDefaultColor = {
      default: 'primary',
      pastel: 'rose',
      paper: 'amber',
      ocean: 'teal',
      forest: 'emerald',
      sunset: 'amber',
      slate: 'slate',
    };
    const paletteFromConfig = Array.isArray(config.palette)
      ? config.palette
          .map(c => (c || '').toString().trim().toLowerCase())
          .filter(c => c && c !== 'auto' && c !== 'skin' && c !== 'default')
      : [];
    const palette = paletteFromConfig.length ? paletteFromConfig : (skinDefaultPalette[skin] || ['primary', 'secondary']);
    const rawUniformColor = (config.color || skinDefaultColor[skin] || palette[0] || 'primary').toString().trim().toLowerCase();
    const uniformColor = ['auto', 'skin', 'default'].includes(rawUniformColor)
      ? (skinDefaultColor[skin] || palette[0] || 'primary')
      : rawUniformColor;
    const paletteLight = {
      primary: { bg: '#2563eb', hover: '#1d4ed8', text: '#ffffff', border: '#1d4ed8', outlineHover: 'rgba(37, 99, 235, 0.12)' },
      success: { bg: '#16a34a', hover: '#15803d', text: '#ffffff', border: '#15803d', outlineHover: 'rgba(34, 197, 94, 0.12)' },
      warning: { bg: '#f59e0b', hover: '#d97706', text: '#1f2937', border: '#d97706', outlineHover: 'rgba(245, 158, 11, 0.18)' },
      danger: { bg: '#ef4444', hover: '#dc2626', text: '#ffffff', border: '#dc2626', outlineHover: 'rgba(248, 113, 113, 0.18)' },
      info: { bg: '#0ea5e9', hover: '#0284c7', text: '#ffffff', border: '#0284c7', outlineHover: 'rgba(14, 165, 233, 0.15)' },
      secondary: { bg: '#64748b', hover: '#475569', text: '#ffffff', border: '#475569', outlineHover: 'rgba(100, 116, 139, 0.18)' },
      dark: { bg: '#1f2937', hover: '#111827', text: '#f8fafc', border: '#111827', outlineHover: 'rgba(15, 23, 42, 0.12)' },
      rose: { bg: '#ec4899', hover: '#db2777', text: '#fff1f5', border: '#db2777', outlineHover: 'rgba(236, 72, 153, 0.14)' },
      amber: { bg: '#d97706', hover: '#b45309', text: '#1f1304', border: '#b45309', outlineHover: 'rgba(217, 119, 6, 0.18)' },
      teal: { bg: '#0d9488', hover: '#0f766e', text: '#ecfeff', border: '#0f766e', outlineHover: 'rgba(13, 148, 136, 0.16)' },
      emerald: { bg: '#059669', hover: '#047857', text: '#ecfdf3', border: '#047857', outlineHover: 'rgba(5, 150, 105, 0.18)' },
      slate: { bg: '#475569', hover: '#334155', text: '#e2e8f0', border: '#334155', outlineHover: 'rgba(51, 65, 85, 0.18)' },
    };
    const paletteDark = {
      primary: { bg: '#1d4ed8', hover: '#2563eb', text: '#dbeafe', border: '#3b82f6', outlineHover: 'rgba(59, 130, 246, 0.18)' },
      success: { bg: '#166534', hover: '#17813f', text: '#bbf7d0', border: '#34d399', outlineHover: 'rgba(52, 211, 153, 0.2)' },
      warning: { bg: '#9a4f06', hover: '#c97a0e', text: '#fde68a', border: '#fbbf24', outlineHover: 'rgba(251, 191, 36, 0.22)' },
      danger: { bg: '#991b1b', hover: '#c81e1e', text: '#fecaca', border: '#f87171', outlineHover: 'rgba(248, 113, 113, 0.24)' },
      info: { bg: '#0f4c81', hover: '#1f6ad9', text: '#bae6fd', border: '#60a5fa', outlineHover: 'rgba(96, 165, 250, 0.24)' },
      secondary: { bg: '#283347', hover: '#3b465e', text: '#f8fafc', border: '#94a3b8', outlineHover: 'rgba(148, 163, 184, 0.22)' },
      dark: { bg: '#111827', hover: '#1c2940', text: '#e2e8f0', border: '#334155', outlineHover: 'rgba(148, 163, 184, 0.2)' },
      rose: { bg: '#e11d48', hover: '#be123c', text: '#ffe4e6', border: '#f472b6', outlineHover: 'rgba(244, 114, 182, 0.26)' },
      amber: { bg: '#c2410c', hover: '#ea580c', text: '#fff7ed', border: '#f59e0b', outlineHover: 'rgba(245, 158, 11, 0.24)' },
      teal: { bg: '#0f766e', hover: '#14b8a6', text: '#ecfeff', border: '#2dd4bf', outlineHover: 'rgba(45, 212, 191, 0.22)' },
      emerald: { bg: '#047857', hover: '#059669', text: '#ecfdf3', border: '#34d399', outlineHover: 'rgba(52, 211, 153, 0.24)' },
      slate: { bg: '#1f2937', hover: '#334155', text: '#e2e8f0', border: '#475569', outlineHover: 'rgba(148, 163, 184, 0.22)' },
    };
    const paletteTokens = colorMode === 'dark' ? paletteDark : paletteLight;
    const fallbackTokens = paletteTokens.primary;
    const resolveTokens = name => {
      const key = name && paletteTokens[name] ? name : 'primary';
      return paletteTokens[key] || fallbackTokens;
    };
    const buttons = document.querySelectorAll('.js-nav-btn');
    const navbar = document.querySelector('nav.navbar');
    if (navbar) {
      navbar.classList.remove('nav-modern', 'nav-neo');
      if (preset) {
        navbar.dataset.navPreset = preset;
      }
    }
    if (!buttons.length) return;
    buttons.forEach((btn, idx) => {
      ['btn-primary','btn-secondary','btn-success','btn-danger','btn-warning','btn-info','btn-light','btn-dark','btn-outline-primary','btn-outline-secondary','btn-outline-success','btn-outline-danger','btn-outline-warning','btn-outline-info','btn-outline-light','btn-outline-dark','btn-theme'].forEach(cls => btn.classList.remove(cls));
      ['--btn-bg', '--btn-hover', '--btn-text', '--btn-border', '--btn-outline-hover'].forEach(prop => btn.style.removeProperty(prop));
      btn.style.removeProperty('color');
      btn.style.removeProperty('background');
      btn.style.removeProperty('border-color');
      const sourceColor = btn.dataset.themeColor || (style === 'palette' ? palette[idx % palette.length] : uniformColor) || 'primary';
      const normalized = sourceColor.trim().toLowerCase() || 'primary';
      const tokens = resolveTokens(normalized);
      btn.classList.add('btn', 'btn-theme');
      btn.style.setProperty('--btn-bg', tokens.bg);
      btn.style.setProperty('--btn-hover', tokens.hover);
      btn.style.setProperty('--btn-text', variant === 'outline' ? tokens.border : tokens.text);
      btn.style.setProperty('--btn-border', tokens.border);
      btn.style.setProperty('--btn-outline-hover', tokens.outlineHover || (colorMode === 'dark' ? 'rgba(148, 163, 184, 0.16)' : 'rgba(15, 23, 42, 0.08)'));
      btn.dataset.themeActiveVariant = variant;
      btn.dataset.themeActiveColor = normalized;
      btn.dataset.themeActiveStyle = style;
    });
  }

  function applyColorMode(mode) {
    const normalized = (mode || '').toLowerCase() === 'dark' ? 'dark' : 'light';
    const isDark = normalized === 'dark';
    document.body.classList.toggle('theme-dark', isDark);
    document.body.setAttribute('data-bs-theme', normalized);
    const remoteModal = document.getElementById('remoteWorkspaceModal');
    if (remoteModal) {
      remoteModal.setAttribute('data-bs-theme', normalized);
    }
    const navbar = document.querySelector('nav.navbar');
    if (navbar) {
      ['bg-light', 'bg-dark'].forEach(cls => navbar.classList.remove(cls));
      navbar.classList.toggle('navbar-dark', isDark);
      navbar.classList.toggle('navbar-light', !isDark);
    }
    window.BENORT_UI_THEME = window.BENORT_UI_THEME || {};
    window.BENORT_UI_THEME.color_mode = normalized;
    syncAccentThemeTokens();
    applyNavbarTheme();
    window.applyBenortColorMode = applyColorMode;
  }

  /* === UI config (skins, ratios, font tiers) === */
  const UI_CONFIG_STORAGE_KEY = 'benort.ui.config';
  const envTheme = window.BENORT_UI_THEME || {};
  const envSkin = (envTheme.skin || 'default').toLowerCase();
  const envColor = (envTheme.color_mode || 'light').toLowerCase();
  const envTier = (envTheme.fontSize || envTheme.tier || envTheme.navDensity || '').toLowerCase();
  const envPaneRatio = (envTheme.pane_ratio || envTheme.paneRatio || '').toLowerCase();
  const envNavbar = envTheme.navbar_buttons || {};
  const defaultColorMode = ['light', 'dark', 'system'].includes(envColor) ? envColor : 'light';
  const UI_PRESET_META = {
    default: { skin: 'default', recommendedMode: 'light' },
    pastel: { skin: 'pastel', recommendedMode: 'light' },
    paper: { skin: 'paper', recommendedMode: 'light' },
    ocean: { skin: 'ocean', recommendedMode: 'dark' },
    forest: { skin: 'forest', recommendedMode: 'dark' },
    sunset: { skin: 'sunset', recommendedMode: 'light' },
    slate: { skin: 'slate', recommendedMode: 'dark' },
  };
    const UI_FONT_SCALES = { compact: 0.94, standard: 1, relaxed: 1.08 };
    const UI_NAV_FONT_SCALES = UI_FONT_SCALES;
    const UI_NAV_PADDING = {
      compact: { y: 4, x: 10 },
      standard: { y: 6, x: 14 },
      relaxed: { y: 8, x: 18 },
    };
  const UI_SKIN_PRIMARY = {
    default: 'primary',
    pastel: 'rose',
    paper: 'amber',
    ocean: 'teal',
    forest: 'emerald',
    sunset: 'amber',
    slate: 'slate',
  };
  const UI_PANE_RATIOS = {
    'editor-wide': { editor: 8, script: 2 },
    balanced: { editor: 7, script: 3 },
    'preview-wide': { editor: 6, script: 4 },
    equal: { editor: 5, script: 5 },
  };
  const DEFAULT_UI_CONFIG = {
    preset: UI_PRESET_META[envSkin] ? envSkin : 'default',
    colorMode: defaultColorMode,
    paneRatio: UI_PANE_RATIOS[envPaneRatio] ? envPaneRatio : 'balanced',
    fontSize: ['compact', 'standard', 'relaxed'].includes(envTier) ? envTier : 'standard',
  };
  let systemColorWatcher = null;
  const handleSystemColorChange = () => {
    const cached = loadUiConfig();
    if (cached && cached.colorMode === 'system') {
      applyUiConfig(cached, {persist: false, silent: true});
    }
  };

  function loadUiConfig() {
    try {
      const raw = localStorage.getItem(UI_CONFIG_STORAGE_KEY);
      if (!raw) return {...DEFAULT_UI_CONFIG};
      const parsed = JSON.parse(raw);
      // migrate old navDensity/navButtonStyle into fontSize
      if (!parsed.fontSize && parsed.navDensity) {
        parsed.fontSize = parsed.navDensity;
      }
      if (parsed.navButtonStyle) {
        delete parsed.navButtonStyle;
      }
      delete parsed.navDensity;
      return {...DEFAULT_UI_CONFIG, ...parsed};
    } catch (err) {
      console.warn('读取 UI 配置失败，使用默认值', err);
      return {...DEFAULT_UI_CONFIG};
    }
  }

  function persistUiConfig(config) {
    try {
      localStorage.setItem(UI_CONFIG_STORAGE_KEY, JSON.stringify(config));
    } catch (err) {
      console.warn('保存 UI 配置失败', err);
    }
  }

  function applyUiConfig(config, options = {}) {
    const {persist = true, silent = false} = options;
    const merged = {...DEFAULT_UI_CONFIG, ...(config || {})};
    const meta = UI_PRESET_META[merged.preset] || UI_PRESET_META.default;
    let rawColorMode = merged.colorMode || 'light';
    if (!['light', 'dark', 'system'].includes(rawColorMode)) {
      rawColorMode = 'light';
    }
    let resolvedColorMode = rawColorMode;
    if (rawColorMode === 'system') {
      try {
        resolvedColorMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      } catch (_) {
        resolvedColorMode = 'light';
      }
    }
    if (rawColorMode === 'system' && typeof window.matchMedia === 'function') {
      if (!systemColorWatcher) {
        systemColorWatcher = window.matchMedia('(prefers-color-scheme: dark)');
        systemColorWatcher.addEventListener('change', handleSystemColorChange);
      }
    } else if (systemColorWatcher) {
      systemColorWatcher.removeEventListener('change', handleSystemColorChange);
      systemColorWatcher = null;
    }
    applyColorMode(resolvedColorMode);
    const skin = meta.skin || 'default';
    if (skin === 'default') {
      document.body.removeAttribute('data-ui-skin');
    } else {
      document.body.setAttribute('data-ui-skin', skin);
    }
    syncAccentThemeTokens();
    const ratio = UI_PANE_RATIOS[merged.paneRatio] || UI_PANE_RATIOS.balanced;
    document.documentElement.style.setProperty('--editor-preview-weight', ratio.editor);
    document.documentElement.style.setProperty('--script-pane-weight', ratio.script);
    const scale = UI_FONT_SCALES[merged.fontSize] || UI_FONT_SCALES.standard;
    const baseSize = Math.round(16 * scale * 100) / 100;
    document.documentElement.style.setProperty('--app-font-size', `${baseSize}px`);
    const navScale = UI_NAV_FONT_SCALES[merged.fontSize] || UI_NAV_FONT_SCALES.standard;
    const navBase = Math.round(16 * navScale * 100) / 100;
    document.documentElement.style.setProperty('--nav-btn-font-size', `${navBase}px`);
    const navPad = UI_NAV_PADDING[merged.fontSize] || UI_NAV_PADDING.standard;
    document.documentElement.style.setProperty('--nav-btn-padding-y', `${navPad.y}px`);
    document.documentElement.style.setProperty('--nav-btn-padding-x', `${navPad.x}px`);
    window.BENORT_UI_THEME = window.BENORT_UI_THEME || {};
    window.BENORT_UI_THEME.skin = skin;
    window.BENORT_UI_THEME.color_mode = resolvedColorMode;
    window.BENORT_UI_THEME.pane_ratio = merged.paneRatio;
    window.BENORT_UI_THEME.paneRatio = merged.paneRatio;
    const envNavbarColor = (envNavbar.color || '').toString().trim();
    const navbarColor = ['auto', 'skin', 'default', ''].includes(envNavbarColor.toLowerCase())
      ? (UI_SKIN_PRIMARY[skin] || 'primary')
      : envNavbarColor;
    const navbarPalette = Array.isArray(envNavbar.palette)
      ? envNavbar.palette.filter(c => !!c && c.toString().trim().toLowerCase() !== 'auto')
      : [];
    window.BENORT_UI_THEME.navbar_buttons = {
      style: (envNavbar.style || 'uniform').toLowerCase() === 'palette' ? 'palette' : 'uniform',
      variant: (envNavbar.variant || 'outline').toLowerCase() === 'solid' ? 'solid' : 'outline',
      color: navbarColor,
      palette: navbarPalette.length ? navbarPalette : undefined,
      preset: envNavbar.preset || 'modern',
    };
    if (persist) {
      persistUiConfig(merged);
    }
    applyNavbarTheme();
    if (!silent) {
      showStatus('已应用外观设置', 'success', 2000);
    }
  }

  function bindUiConfigModal() {
    const btn = document.getElementById('ui-settings-btn');
    const modalEl = document.getElementById('uiConfigModal');
    const themeSelect = document.getElementById('ui-theme-select');
    const colorModeSelect = document.getElementById('ui-color-mode-select');
    const ratioSelect = document.getElementById('ui-pane-ratio-select');
    const fontSelect = document.getElementById('ui-font-size-select');
    const applyBtn = document.getElementById('ui-config-apply');
    const resetBtn = document.getElementById('ui-config-reset');

    if (!modalEl || !themeSelect || !colorModeSelect || !ratioSelect || !fontSelect) return;
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    const syncForm = cfg => {
      themeSelect.value = cfg.preset || 'default';
      colorModeSelect.value = cfg.colorMode || 'light';
      ratioSelect.value = cfg.paneRatio || 'balanced';
      fontSelect.value = cfg.fontSize || 'standard';
    };
    const hydrateAndApply = cfg => {
      applyUiConfig(cfg);
      syncForm(cfg);
    };
    const cached = loadUiConfig();
    syncForm(cached);
    if (btn && !btn.dataset.bound) {
      btn.dataset.bound = 'true';
      btn.addEventListener('click', () => {
        syncForm(loadUiConfig());
        modal.show();
      });
    }
    if (applyBtn && !applyBtn.dataset.bound) {
      applyBtn.dataset.bound = 'true';
      applyBtn.addEventListener('click', () => {
        const next = {
          preset: themeSelect.value || 'default',
          colorMode: colorModeSelect.value || 'light',
          paneRatio: ratioSelect.value || 'balanced',
          fontSize: fontSelect.value || 'standard',
        };
        hydrateAndApply(next);
        modal.hide();
      });
    }
    if (resetBtn && !resetBtn.dataset.bound) {
      resetBtn.dataset.bound = 'true';
      resetBtn.addEventListener('click', () => {
        hydrateAndApply({...DEFAULT_UI_CONFIG, colorMode: 'light'});
      });
    }
  }

  function countMarkdownNewlines(text) {
    if (!text) return 0;
    const matches = text.match(/\r\n|\r|\n/g);
    return matches ? matches.length : 0;
  }

  function cloneMarkedTokens(tokens) {
    if (!Array.isArray(tokens)) return [];
    if (typeof structuredClone === 'function') {
      try {
        return structuredClone(tokens);
      } catch (_) {
        // ignore and fall back
      }
    }
    try {
      return JSON.parse(JSON.stringify(tokens));
    } catch (_) {
      return tokens.map(token => ({...token}));
    }
  }

  function resolveEditorScrollElement(editor) {
    if (!editor) {
      return document.getElementById('editor-container');
    }
    let scroller = typeof editor.getScrollerElement === 'function' ? editor.getScrollerElement() : null;
    const needsFallback = !scroller || Math.abs(scroller.scrollHeight - scroller.clientHeight) < 1;
    if (needsFallback) {
      const wrapper = typeof editor.getWrapperElement === 'function' ? editor.getWrapperElement() : null;
      const container = document.getElementById('editor-container');
      if (wrapper && wrapper.parentElement && wrapper.parentElement.scrollHeight > wrapper.parentElement.clientHeight + 1) {
        return wrapper.parentElement;
      }
      if (container) {
        return container;
      }
    }
    return scroller || document.getElementById('editor-container');
  }

  function annotateMarkdownTokenSourceLines(tokens, source) {
    if (!Array.isArray(tokens)) return;
    let cursor = 0;
    let line = 0;
    tokens.forEach(token => {
      if (!token || typeof token !== 'object') return;
      const raw = typeof token.raw === 'string' ? token.raw : '';
      let startIndex = cursor;
      if (raw) {
        const idx = source.indexOf(raw, cursor);
        if (idx !== -1) {
          startIndex = idx;
        }
      }
      if (startIndex > cursor) {
        line += countMarkdownNewlines(source.slice(cursor, startIndex));
      }
      cursor = startIndex;
      token.__sourceLine = line;
      if (raw) {
        line += countMarkdownNewlines(raw);
        cursor = startIndex + raw.length;
      }
    });
  }

  function buildMarkdownScrollAnchors(tokens, preview, container) {
    if (!preview) return [];
    const elements = Array.from(preview.children || []).filter(child => child instanceof HTMLElement);
    elements.forEach(el => {
      if (el.dataset && 'markdownSourceLine' in el.dataset) {
        delete el.dataset.markdownSourceLine;
      }
    });
    const anchors = [];
    if (!Array.isArray(tokens) || !tokens.length) {
      return anchors;
    }
    let elementIdx = 0;
    for (const token of tokens) {
      if (!token || !MARKDOWN_SCROLL_BLOCK_TYPES.has(token.type)) {
        continue;
      }
      while (elementIdx < elements.length && !(elements[elementIdx] instanceof HTMLElement)) {
        elementIdx += 1;
      }
      if (elementIdx >= elements.length) {
        break;
      }
      const element = elements[elementIdx];
      const sourceLine = typeof token.__sourceLine === 'number' ? token.__sourceLine : 0;
      element.dataset.markdownSourceLine = String(sourceLine);
      const top = container ? getElementTopRelative(element, container) : element.offsetTop || 0;
      anchors.push({
        line: sourceLine,
        element,
        top,
        type: token.type,
        level: typeof token.depth === 'number' ? token.depth : 0
      });
      elementIdx += 1;
    }
    anchors.sort((a, b) => a.line - b.line);
    for (let i = 0; i < anchors.length; i++) {
      const current = anchors[i];
      const next = anchors[i + 1];
      current.lineEnd = next ? next.line : null;
    }
    return anchors;
  }

  function getHeadingAnchors(anchors) {
    if (!Array.isArray(anchors)) return [];
    return anchors.filter(anchor => MARKDOWN_HEADING_TYPES.has(anchor.type));
  }

  function getActiveAnchors(preferHeadings = true) {
    const anchors = markdownScrollSyncState.anchors || [];
    if (!anchors.length) return anchors;
    if (!preferHeadings) return anchors;
    const headingAnchors = getHeadingAnchors(anchors);
    if (headingAnchors.length >= 2) {
      const rawTotalLines = typeof markdownScrollSyncState.sourceLineCount === 'number'
        ? markdownScrollSyncState.sourceLineCount
        : 0;
      const totalLines = Math.max(rawTotalLines - 1, 0);
      return headingAnchors.map((anchor, idx) => {
        const clone = {...anchor};
        const next = headingAnchors[idx + 1];
        if (next) {
          clone.lineEnd = next.line;
        } else if (typeof clone.lineEnd !== 'number') {
          clone.lineEnd = totalLines;
        }
        return clone;
      });
    }
    return anchors;
  }

  function getElementTopRelative(element, container) {
    if (!element || !container || typeof element.getBoundingClientRect !== 'function') {
      return 0;
    }
    const elementRect = element.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();
    return (elementRect.top - containerRect.top) + container.scrollTop;
  }

  function computeScrollTargetFromAnchors(line, anchors, container, totalLines) {
    if (!anchors.length) return 0;
    const maxScroll = Math.max(container.scrollHeight - container.clientHeight, 0);
    const resolveTop = anchor => {
      if (!anchor) return 0;
      if (typeof anchor.top === 'number' && Number.isFinite(anchor.top)) return anchor.top;
      if (anchor.element instanceof HTMLElement) return getElementTopRelative(anchor.element, container);
      return 0;
    };
    if (line <= anchors[0].line) {
      return Math.min(resolveTop(anchors[0]), maxScroll);
    }
    for (let i = 1; i < anchors.length; i++) {
      const current = anchors[i];
      const previous = anchors[i - 1];
      if (line <= current.line) {
        const prevTop = resolveTop(previous);
        const nextTop = resolveTop(current);
        const spanStart = previous.line;
        const spanEnd = typeof previous.lineEnd === 'number' ? previous.lineEnd : current.line;
        const span = Math.max(spanEnd - spanStart, 1);
        const ratio = Math.min(Math.max((line - spanStart) / span, 0), 1);
        const interpolated = prevTop + ratio * (nextTop - prevTop);
        return Math.min(Math.max(interpolated, 0), maxScroll);
      }
    }
    const last = anchors[anchors.length - 1];
    const lastTop = resolveTop(last);
    const endLine = typeof last.lineEnd === 'number' ? last.lineEnd : totalLines - 1;
    const remainingLines = Math.max(endLine - last.line, 1);
    const overflowRatio = Math.min(Math.max((line - last.line) / remainingLines, 0), 1);
    const extended = lastTop + overflowRatio * Math.max(maxScroll - lastTop, 0);
    return Math.min(Math.max(extended, lastTop), maxScroll);
  }

  function refreshMarkdownAnchorPositions(container) {
    if (!container) return;
    const anchors = markdownScrollSyncState.anchors || [];
    if (!Array.isArray(anchors) || !anchors.length) return;
    anchors.forEach(anchor => {
      if (!anchor || !(anchor.element instanceof HTMLElement)) return;
      anchor.top = getElementTopRelative(anchor.element, container);
    });
    if (anchors.length) {
      const last = anchors[anchors.length - 1];
      if (typeof last.lineEnd !== 'number') {
        const fallbackEnd = Math.max(markdownScrollSyncState.sourceLineCount - 1, last.line);
        last.lineEnd = fallbackEnd;
      }
    }
  }

  function estimateMarkdownLineFromAnchors(targetPosition, anchors, container, totalLines, useCenter = true) {
    if (!container) {
      return 0;
    }
    if (!anchors.length) {
      const maxScroll = Math.max(container.scrollHeight - container.clientHeight, 1);
      const ratio = maxScroll ? targetPosition / maxScroll : 0;
      return Math.round(ratio * Math.max(totalLines - 1, 0));
    }
    const resolveTop = anchor => {
      if (!anchor) return 0;
      if (typeof anchor.top === 'number' && Number.isFinite(anchor.top)) return anchor.top;
      if (anchor.element instanceof HTMLElement) return getElementTopRelative(anchor.element, container);
      return 0;
    };
    const maxScroll = Math.max(container.scrollHeight - container.clientHeight, 0);
    const clamped = Math.min(Math.max(targetPosition, 0), maxScroll);
    const targetPoint = useCenter ? (clamped + container.clientHeight / 2) : clamped;
    if (targetPoint <= resolveTop(anchors[0])) {
      return anchors[0].line;
    }
    for (let i = 1; i < anchors.length; i++) {
      const current = anchors[i];
      const previous = anchors[i - 1];
      const prevTop = resolveTop(previous);
      const currentTop = resolveTop(current);
      if (targetPoint <= currentTop) {
        const spanTop = Math.max(currentTop - prevTop, 1);
        const ratio = (targetPoint - prevTop) / spanTop;
        const lineStart = previous.line;
        const lineEnd = typeof previous.lineEnd === 'number' ? previous.lineEnd : current.line;
        const lineSpan = Math.max(lineEnd - lineStart, 0);
        return Math.round(lineStart + ratio * lineSpan);
      }
    }
    const last = anchors[anchors.length - 1];
    const lastTop = resolveTop(last);
    const remainingSpan = Math.max(maxScroll - lastTop, 1);
    const overflowRatio = remainingSpan ? (targetPoint - lastTop) / remainingSpan : 0;
    const endLine = typeof last.lineEnd === 'number' ? last.lineEnd : totalLines - 1;
    const totalLinesSpan = Math.max(endLine - last.line, 1);
    return Math.round(last.line + overflowRatio * totalLinesSpan);
  }

  function syncMarkdownPreviewScroll(editor) {
    const cm = editor || markdownScrollSyncState.boundEditor;
    if (!cm || typeof cm.getScrollInfo !== 'function') return;
    if (!markdownScrollSyncState.enabled) return;
    if (currentEditMode !== 'markdown') return;
    const preview = document.getElementById('markdown-preview-content');
    const wrapper = document.getElementById('markdown-preview');
    const container = getMarkdownScrollContainer(preview, wrapper);
    if (!container) return;
    const rawCMScroller = typeof cm.getScrollerElement === 'function' ? cm.getScrollerElement() : null;
    const scroller = markdownScrollSyncState.editorScroller || resolveEditorScrollElement(cm);
    const usingCMScroller = rawCMScroller && scroller === rawCMScroller;
    if (!scroller) return;
    const scrollerTop = scroller.scrollTop;
    const scrollerHeight = scroller.scrollHeight;
    const scrollerClient = scroller.clientHeight;
    const docScrollable = Math.max(scrollerHeight - scrollerClient, 1);
    const docLineCount = typeof cm.lineCount === 'function' ? cm.lineCount() : Math.max(markdownScrollSyncState.sourceLineCount, 1);
    const maxLineIndex = Math.max(docLineCount - 1, 0);
    let referenceLine = docScrollable ? (scrollerTop / docScrollable) * maxLineIndex : 0;
    if (usingCMScroller && typeof cm.lineAtHeight === 'function') {
      const midpoint = scrollerTop + (scrollerClient / 2);
      referenceLine = cm.lineAtHeight(midpoint, 'local');
      if (!Number.isFinite(referenceLine)) {
        referenceLine = docScrollable ? (scrollerTop / docScrollable) * maxLineIndex : referenceLine;
      }
    }
    referenceLine = Math.floor(Number.isFinite(referenceLine) ? referenceLine : 0);
    referenceLine = Math.min(Math.max(referenceLine, 0), maxLineIndex);
    const anchors = getActiveAnchors(true);
    const previewLeading = markdownScrollSyncState.lastScrollLeader === 'preview';
    if (previewLeading && !markdownScrollSyncState.isSyncingFromPreview) {
      return;
    }
    refreshMarkdownAnchorPositions(container);
    const maxContainerScroll = Math.max(container.scrollHeight - container.clientHeight, 0);
    let targetTop;
    if (anchors.length >= 2) {
      targetTop = computeScrollTargetFromAnchors(referenceLine, anchors, container, docLineCount);
    } else {
      const ratio = docScrollable ? scrollerTop / docScrollable : 0;
      targetTop = ratio * maxContainerScroll;
    }
    if (!Number.isFinite(targetTop)) return;

    const clampedTarget = Math.max(Math.min(targetTop, maxContainerScroll), 0);
    const currentTop = container.scrollTop;
    if (Math.abs(currentTop - clampedTarget) <= MARKDOWN_SCROLL_THRESHOLD) {
      return;
    }

    markdownScrollSyncState.isSyncingFromEditor = true;
    if (typeof container.scrollTo === 'function') {
      container.scrollTo({top: clampedTarget, behavior: 'auto'});
    } else {
      container.scrollTop = clampedTarget;
    }
    markdownScrollSyncState.lastScrollLeader = 'editor';
    window.requestAnimationFrame(() => {
      markdownScrollSyncState.isSyncingFromEditor = false;
    });
  }

  function scheduleMarkdownPreviewSync(editor) {
    if (!markdownScrollSyncState.enabled) return;
    markdownScrollSyncState.pendingEditor = editor || null;
    if (markdownScrollSyncState.rafHandle) return;
    markdownScrollSyncState.rafHandle = window.requestAnimationFrame(() => {
      markdownScrollSyncState.rafHandle = 0;
      syncMarkdownPreviewScroll(markdownScrollSyncState.pendingEditor);
      markdownScrollSyncState.pendingEditor = null;
    });
  }

function syncMarkdownEditorToPreview(container) {
    if (!markdownScrollSyncState.enabled) return;
    if (!singleEditor) return;
    if (!container) return;

    const rawCMScroller = typeof singleEditor.getScrollerElement === 'function' ? singleEditor.getScrollerElement() : null;
    const scroller = markdownScrollSyncState.editorScroller || resolveEditorScrollElement(singleEditor);
    const usingCMScroller = rawCMScroller && scroller === rawCMScroller;
    const docScrollable = scroller ? Math.max(scroller.scrollHeight - scroller.clientHeight, 0) : 0;

    const totalLines = typeof singleEditor.lineCount === 'function' ? singleEditor.lineCount() : Math.max(markdownScrollSyncState.sourceLineCount, 1);
    if (totalLines <= 0) return;

    const anchors = getActiveAnchors(true);
    refreshMarkdownAnchorPositions(container);

    const targetLine = estimateMarkdownLineFromAnchors(container.scrollTop, anchors, container, totalLines, false);
    const maxLineIndex = Math.max(totalLines - 1, 0);
    const clampedLine = Math.min(Math.max(targetLine, 0), maxLineIndex);

    const previewLeading = markdownScrollSyncState.lastScrollLeader === 'preview';

    if (!scroller) return;

    const containerScrollable = Math.max(container.scrollHeight - container.clientHeight, 1);
    const ratioTarget = containerScrollable ? (container.scrollTop / containerScrollable) * docScrollable : 0;

    let desiredTop = ratioTarget;
    if (!previewLeading) {
      if (usingCMScroller && typeof singleEditor.heightAtLine === 'function') {
        const lineTop = singleEditor.heightAtLine(clampedLine, 'local');
        desiredTop = Math.min(Math.max(lineTop - scroller.clientHeight * 0.5, 0), docScrollable);
      } else if (anchors.length >= 2 && maxLineIndex > 0) {
        const ratio = clampedLine / maxLineIndex;
        desiredTop = ratio * docScrollable;
      }

      if (anchors.length >= 2) {
        const discrepancy = Math.abs(desiredTop - ratioTarget);
        const allowed = Math.max(docScrollable * 0.02, MARKDOWN_SCROLL_THRESHOLD * 6);
        if (!Number.isFinite(desiredTop) || discrepancy > allowed) {
          desiredTop = ratioTarget;
        } else {
          desiredTop = (desiredTop * 0.5) + (ratioTarget * 0.5);
        }
      }
    }

    const clampedTop = Math.max(Math.min(desiredTop, docScrollable), 0);
    const currentEditorTop = scroller.scrollTop;
    const threshold = previewLeading ? 0.5 : MARKDOWN_SCROLL_THRESHOLD;
    if (Math.abs(currentEditorTop - clampedTop) <= threshold) {
      if (previewLeading) {
        markdownScrollSyncState.lastScrollLeader = 'preview';
      }
      return;
    }

    markdownScrollSyncState.isSyncingFromPreview = true;
    scroller.scrollTop = clampedTop;
    if (usingCMScroller && typeof singleEditor.scrollTo === 'function') {
      singleEditor.scrollTo(null, clampedTop);
    }
    markdownScrollSyncState.lastScrollLeader = 'preview';
    window.requestAnimationFrame(() => {
      markdownScrollSyncState.isSyncingFromPreview = false;
    });
  }

  function bindMarkdownEditorScrollSync(editor) {
    if (!editor || typeof editor.getScrollerElement !== 'function') return;
    if (markdownScrollSyncState.editorScroller && markdownScrollSyncState.editorScrollHandler) {
      markdownScrollSyncState.editorScroller.removeEventListener('scroll', markdownScrollSyncState.editorScrollHandler);
    }
    if (markdownScrollSyncState.boundEditor && typeof markdownScrollSyncState.boundEditor.off === 'function' && markdownScrollSyncState.editorCMHandler) {
      markdownScrollSyncState.boundEditor.off('scroll', markdownScrollSyncState.editorCMHandler);
    }

    const scroller = resolveEditorScrollElement(editor);
    const handleScroll = () => {
      if (!markdownScrollSyncState.enabled) return;
      if (markdownScrollSyncState.isSyncingFromPreview) return;
      if (currentEditMode !== 'markdown') return;
      if (markdownScrollSyncState.lastScrollLeader === 'preview') return;
      if (markdownScrollSyncState.previewLeaderTimer) {
        window.clearTimeout(markdownScrollSyncState.previewLeaderTimer);
        markdownScrollSyncState.previewLeaderTimer = null;
      }
      markdownScrollSyncState.lastScrollLeader = 'editor';
      scheduleMarkdownPreviewSync(editor);
    };

    const scrollerHandler = () => handleScroll();
    scroller.addEventListener('scroll', scrollerHandler, {passive: true});

    const cmHandler = () => handleScroll();
    if (typeof editor.on === 'function') {
      editor.on('scroll', cmHandler);
    }

    markdownScrollSyncState.boundEditor = editor;
    markdownScrollSyncState.editorScroller = scroller;
    markdownScrollSyncState.editorScrollHandler = scrollerHandler;
    markdownScrollSyncState.editorHandler = cmHandler;
    markdownScrollSyncState.editorCMHandler = cmHandler;

    if (markdownScrollSyncState.enabled) {
      scheduleMarkdownPreviewSync(editor);
    }
  }

  function clearMarkdownScrollAnchors() {
    markdownScrollSyncState.anchors = [];
    markdownScrollSyncState.sourceLineCount = 0;
  }

  function bindMarkdownPreviewScrollSync(container) {
    if (!container) {
      if (markdownScrollSyncState.previewContainer && markdownScrollSyncState.previewHandler) {
        markdownScrollSyncState.previewContainer.removeEventListener('scroll', markdownScrollSyncState.previewHandler);
      }
      markdownScrollSyncState.previewContainer = null;
      markdownScrollSyncState.previewHandler = null;
      return;
    }
    if (markdownScrollSyncState.previewContainer && markdownScrollSyncState.previewHandler) {
      markdownScrollSyncState.previewContainer.removeEventListener('scroll', markdownScrollSyncState.previewHandler);
    }
    const handler = () => {
      if (!markdownScrollSyncState.enabled) return;
      if (markdownScrollSyncState.isSyncingFromEditor) return;
      if (currentEditMode !== 'markdown') return;
      if (markdownScrollSyncState.previewLeaderTimer) {
        window.clearTimeout(markdownScrollSyncState.previewLeaderTimer);
      }
      markdownScrollSyncState.lastScrollLeader = 'preview';
      markdownScrollSyncState.previewLeaderTimer = window.setTimeout(() => {
        markdownScrollSyncState.previewLeaderTimer = null;
        if (!markdownScrollSyncState.isSyncingFromPreview) {
          markdownScrollSyncState.lastScrollLeader = '';
        }
      }, 180);
      syncMarkdownEditorToPreview(container);
    };
    container.addEventListener('scroll', handler, {passive: true});
    markdownScrollSyncState.previewContainer = container;
    markdownScrollSyncState.previewHandler = handler;
  }

  function shouldShowMarkdownSyncToggle() {
    if (typeof window === 'undefined') return false;
    if (currentEditMode !== 'markdown') return false;
    const previewPane = document.querySelector('.preview-pane');
    if (!previewPane) return false;
    const style = window.getComputedStyle(previewPane);
    if (style.display === 'none' || style.visibility === 'hidden') return false;
    const rect = previewPane.getBoundingClientRect();
    if (rect.width <= 0 || rect.height <= 0) return false;
    return true;
  }

  function updateMarkdownSyncVisualState() {
    const showToggle = shouldShowMarkdownSyncToggle();
    const button = markdownScrollSyncState.button || document.getElementById('markdown-sync-toggle');
    if (button) {
      markdownScrollSyncState.button = button;
      const isEnabled = !!markdownScrollSyncState.enabled;
      button.classList.toggle('active', isEnabled);
      button.setAttribute('aria-pressed', isEnabled ? 'true' : 'false');
      button.dataset.syncActive = isEnabled ? '1' : '0';
      const label = isEnabled ? '已启用 Markdown 同步滚动，点击可关闭' : '点击启用 Markdown 与预览同步滚动';
      button.setAttribute('title', label);
      button.setAttribute('aria-label', label);
      button.style.display = showToggle ? '' : 'none';
      button.disabled = !showToggle;
    }
    const shouldGlow = !!markdownScrollSyncState.enabled && currentEditMode === 'markdown' && showToggle;
    const editorContainer = document.getElementById('editor-container');
    const markdownContainer = document.getElementById('markdown-preview');
    [editorContainer, markdownContainer].forEach(el => {
      if (!el) return;
      el.classList.toggle('markdown-sync-glow', shouldGlow);
    });
  }

  function setMarkdownScrollSyncEnabled(enabled) {
    const normalized = !!enabled;
    if (markdownScrollSyncState.enabled === normalized) {
      updateMarkdownSyncVisualState();
      if (normalized && currentEditMode === 'markdown' && singleEditor) {
        scheduleMarkdownPreviewSync(singleEditor);
      }
      return;
    }
    markdownScrollSyncState.enabled = normalized;
    updateMarkdownSyncVisualState();
    if (normalized && currentEditMode === 'markdown' && singleEditor) {
      scheduleMarkdownPreviewSync(singleEditor);
    }
    if (!normalized) {
      markdownScrollSyncState.lastScrollLeader = '';
      if (markdownScrollSyncState.previewLeaderTimer) {
        window.clearTimeout(markdownScrollSyncState.previewLeaderTimer);
        markdownScrollSyncState.previewLeaderTimer = null;
      }
    }
  }

  function toggleMarkdownScrollSync() {
    setMarkdownScrollSyncEnabled(!markdownScrollSyncState.enabled);
  }

  function initMarkdownScrollSyncToggle() {
    const button = document.getElementById('markdown-sync-toggle');
    if (!button || button.dataset.syncToggleBound === '1') {
      updateMarkdownSyncVisualState();
      return;
    }
    markdownScrollSyncState.button = button;
    button.dataset.syncToggleBound = '1';
    button.addEventListener('click', event => {
      event.preventDefault();
      toggleMarkdownScrollSync();
    });
    updateMarkdownSyncVisualState();
  }

  function resolveAttachmentHref(rawHref) {
    if (!rawHref || typeof rawHref !== 'string') return null;
    let href = rawHref.trim();
    if (!href) return null;
    const hasScheme = /^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(href);
    let name = '';
    if (href.startsWith('attachment://')) {
      name = href.slice('attachment://'.length);
    } else if (!hasScheme || href.startsWith('uploads/') || href.startsWith('/uploads/') || href.startsWith('./uploads/')) {
      let candidate = href;
      candidate = candidate.replace(/^\.\/+/, '');
      if (candidate.startsWith('/')) {
        candidate = candidate.replace(/^\/+/, '');
      }
      if (candidate.toLowerCase().startsWith('uploads/')) {
        candidate = candidate.slice('uploads/'.length);
      }
      if (!candidate.includes('/')) {
        name = candidate;
      }
    } else if (!hasScheme && !href.startsWith('/')) {
      name = href.replace(/^\.\/+/, '');
      if (name.includes('/')) {
        name = '';
      }
    }
    if (!name) {
      return null;
    }
    try {
      name = decodeURIComponent(name);
    } catch (_) {
      name = name;
    }
    if (!name) {
      return null;
    }
    if (!attachmentUrlIndex.has(name)) {
      if (!attachmentIndexPromise) {
        primeAttachmentUrlIndex({reRender: currentEditMode === 'markdown'});
      }
      return null;
    }
    return attachmentUrlIndex.get(name);
  }

  function rewriteMarkdownTokensForAttachments(tokens) {
    if (!Array.isArray(tokens)) return;
    const visit = token => {
      if (!token || typeof token !== 'object') return;
      if (token.href) {
        const resolved = resolveAttachmentHref(token.href);
        if (resolved) {
          token.href = resolved;
        }
      }
      if (Array.isArray(token.tokens)) {
        token.tokens.forEach(visit);
      }
      if (Array.isArray(token.items)) {
        token.items.forEach(item => {
          if (item && Array.isArray(item.tokens)) {
            item.tokens.forEach(visit);
          }
        });
      }
      if (Array.isArray(token.cells)) {
        token.cells.forEach(row => {
          if (Array.isArray(row)) {
            row.forEach(cell => {
              if (cell && Array.isArray(cell.tokens)) {
                cell.tokens.forEach(visit);
              }
            });
          }
        });
      }
      if (Array.isArray(token.header)) {
        token.header.forEach(cell => {
          if (cell && Array.isArray(cell.tokens)) {
            cell.tokens.forEach(visit);
          }
        });
      }
    };
    tokens.forEach(visit);
    if (tokens.links && typeof tokens.links === 'object') {
      Object.keys(tokens.links).forEach(key => {
        const entry = tokens.links[key];
        if (entry && entry.href) {
          const resolved = resolveAttachmentHref(entry.href);
          if (resolved) {
            entry.href = resolved;
          }
        }
      });
    }
  }

  function renderMarkdownPreview() {
    const wrapper = document.getElementById('markdown-preview');
    const preview = document.getElementById('markdown-preview-content') || wrapper;
    if (!wrapper || !preview) return;
    const container = getMarkdownScrollContainer(preview, wrapper);
    const md = pagesData[currentPageIdx]?.notes || '';
    applyMarkdownStyles();
    if (md.trim()) {
      const tokensForAnchors = marked.lexer(md);
      rewriteMarkdownTokensForAttachments(tokensForAnchors);
      annotateMarkdownTokenSourceLines(tokensForAnchors, md);
      const tokensForHtml = cloneMarkedTokens(tokensForAnchors);
      if (tokensForAnchors && typeof tokensForAnchors === 'object' && 'links' in tokensForAnchors) {
        tokensForHtml.links = tokensForAnchors.links;
      }
      preview.innerHTML = marked.parser(tokensForHtml);
      markdownScrollSyncState.anchors = buildMarkdownScrollAnchors(tokensForAnchors, preview, container);
      markdownScrollSyncState.sourceLineCount = md.split(/\r?\n/).length;
    } else {
      preview.innerHTML = '<p class="text-muted mb-0">暂无 Markdown 内容</p>';
      clearMarkdownScrollAnchors();
    }
    enhanceMarkdownHeadingAnchors(preview, wrapper);
    enhanceMarkdownImages(preview);
    enhanceMarkdownTables(preview);
    if (window.hljs && preview.querySelectorAll) {
      preview.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
      });
    }
    enhanceCodeCopy(preview);
    if (window.MathJax && typeof window.MathJax.typesetPromise === 'function') {
      try {
        if (typeof window.MathJax.typesetClear === 'function') {
          window.MathJax.typesetClear([preview]);
        }
      } catch (err) {
        console.warn('清理 MathJax 队列失败', err);
      }
      window.MathJax.typesetPromise([preview])
        .then(() => enhanceMathCopy(preview))
        .catch(err => console.warn('MathJax 渲染失败', err));
    }
    if (markdownScrollSyncState.enabled && currentEditMode === 'markdown' && singleEditor) {
      scheduleMarkdownPreviewSync(singleEditor);
    }
    if (container) {
      refreshMarkdownAnchorPositions(container);
      bindMarkdownPreviewScrollSync(container);
    }
    updateMarkdownSyncVisualState();
  }

  function safeDecodeURIComponent(value) {
    if (typeof value !== 'string') return '';
    try {
      return decodeURIComponent(value);
    } catch (_) {
      return value;
    }
  }

  function cssEscapeIdent(value) {
    if (typeof value !== 'string') return '';
    if (window.CSS && typeof window.CSS.escape === 'function') {
      try {
        return window.CSS.escape(value);
      } catch (_) {
        return value;
      }
    }
    return value;
  }

  function slugifyMarkdownHeading(text, registry) {
    const raw = typeof text === 'string' ? text.trim() : '';
    if (!raw) return '';
    const normalized = typeof raw.normalize === 'function' ? raw.normalize('NFKC') : raw;
    let slug = normalized.replace(/\s+/g, '-');
    slug = slug.replace(/[\u0000-\u001F\u007F]/g, '');
    slug = slug.replace(/[^A-Za-z0-9\u00C0-\uFFFD\-_]/g, '');
    slug = slug.replace(/-+/g, '-').replace(/^-+|-+$/g, '');
    if (!slug) {
      slug = 'heading';
    }
    const base = slug.toLowerCase();
    if (!registry[base] && registry[base] !== 0) {
      registry[base] = 0;
      return base;
    }
    registry[base] += 1;
    return `${base}-${registry[base]}`;
  }

  function getMarkdownScrollContainer(preview, wrapper) {
    const isScrollable = el => {
      if (!el || typeof el.scrollTop !== 'number') return false;
      return Math.abs(el.scrollHeight - el.clientHeight) > 1;
    };
    if (isScrollable(preview)) return preview;
    if (isScrollable(wrapper)) return wrapper;
    if (preview && typeof preview.scrollTop === 'number') return preview;
    if (wrapper && typeof wrapper.scrollTop === 'number') return wrapper;
    return null;
  }

  function focusMarkdownHeading(headingId, {silent = false, instant = false} = {}) {
    if (!headingId) return false;
    const preview = document.getElementById('markdown-preview-content');
    const wrapper = document.getElementById('markdown-preview');
    if (!preview) return false;
    const attemptSelect = (id) => {
      if (!id) return null;
      const selector = `[id="${cssEscapeIdent(id)}"]`;
      return preview.querySelector(selector) || document.getElementById(id);
    };
    let target = attemptSelect(headingId);
    if (!target && headingId) {
      const fallbackId = slugifyMarkdownHeading(headingId, Object.create(null));
      if (fallbackId) {
        target = attemptSelect(fallbackId);
      }
    }
    if (!target) {
      if (!silent && typeof showStatus === 'function') {
        showStatus(`未找到标题 “${headingId}”`, 'warning', 2600);
      }
      return false;
    }

    const scrollContainer = getMarkdownScrollContainer(preview, wrapper);
    if (scrollContainer) {
      const containerRect = scrollContainer.getBoundingClientRect();
      const targetRect = target.getBoundingClientRect();
      const delta = targetRect.top - containerRect.top;
      const desired = scrollContainer.scrollTop + delta - 16;
      if (typeof scrollContainer.scrollTo === 'function') {
        scrollContainer.scrollTo({top: Math.max(desired, 0), behavior: instant ? 'auto' : 'smooth'});
      } else {
        scrollContainer.scrollTop = Math.max(desired, 0);
      }
    } else if (typeof target.scrollIntoView === 'function') {
      target.scrollIntoView({behavior: instant ? 'auto' : 'smooth', block: 'start', inline: 'nearest'});
    }

    if (markdownHeadingActiveEl && markdownHeadingActiveEl !== target) {
      markdownHeadingActiveEl.classList.remove('markdown-heading-highlight');
    }
    markdownHeadingActiveEl = target;
    target.classList.add('markdown-heading-highlight');
    if (markdownHeadingHighlightTimer) {
      clearTimeout(markdownHeadingHighlightTimer);
    }
    markdownHeadingHighlightTimer = setTimeout(() => {
      if (markdownHeadingActiveEl) {
        markdownHeadingActiveEl.classList.remove('markdown-heading-highlight');
        markdownHeadingActiveEl = null;
      }
    }, instant ? 1200 : 2200);
    return true;
  }

  function findPageIndexById(pageId) {
    if (!pageId) return -1;
    const normalized = String(pageId).trim().toLowerCase();
    if (!normalized) return -1;
    for (let idx = 0; idx < pagesData.length; idx++) {
      const page = pagesData[idx];
      if (!page || typeof page !== 'object') continue;
      const rawPid = typeof page.pageId === 'string' ? page.pageId : '';
      const normalizedPid = rawPid ? rawPid.trim().toLowerCase() : '';
      if (normalizedPid && normalizedPid === normalized) {
        return idx;
      }
    }
    return -1;
  }

  function parseMarkdownInternalLink(href) {
    if (typeof href !== 'string') return null;
    let trimmed = href.trim();
    if (!trimmed) return null;

    if (/^(?:https?:|mailto:|tel:|ftp:|file:|data:|\/\/)/i.test(trimmed)) {
      return null;
    }

    if (trimmed.startsWith('#')) {
      const headingId = safeDecodeURIComponent(trimmed.slice(1));
      return headingId ? {headingId, pageIndex: null, pageId: null} : null;
    }

    let working = trimmed;
    if (working.startsWith('./')) working = working.slice(2);
    working = working.replace(/^\/+/, '');

    const hashIndex = working.indexOf('#');
    let headingId = '';
    if (hashIndex !== -1) {
      headingId = safeDecodeURIComponent(working.slice(hashIndex + 1));
      working = working.slice(0, hashIndex);
    }

    if (!working) {
      return headingId ? {headingId, pageIndex: null, pageId: null} : null;
    }

    working = safeDecodeURIComponent(working);
    if (working.startsWith('?')) working = working.slice(1);
    working = working.replace(/\.md$/i, '');

    let pageIndex = null;
    let pageId = null;

    if (working.includes('=')) {
      try {
        const params = new URLSearchParams(working);
        const mapped = Object.create(null);
        params.forEach((value, key) => {
          if (typeof key === 'string') {
            mapped[key.toLowerCase()] = value;
          }
        });
        const getParam = (...keys) => {
          for (const key of keys) {
            const lookup = key.toLowerCase();
            if (Object.prototype.hasOwnProperty.call(mapped, lookup)) {
              return mapped[lookup];
            }
          }
          return undefined;
        };

        const pageParam = getParam('page', 'p');
        if (pageParam !== undefined) {
          const parsed = parseInt(pageParam, 10);
          if (!Number.isNaN(parsed)) pageIndex = parsed - 1;
        }
        const pageIndexParam = getParam('pageindex', 'page_idx', 'index');
        if (pageIndexParam !== undefined) {
          const parsed = parseInt(pageIndexParam, 10);
          if (!Number.isNaN(parsed)) pageIndex = parsed - 1;
        }
        const pageIdParam = getParam('pageid', 'page_id', 'pid', 'id');
        if (pageIdParam !== undefined && pageIdParam !== null) {
          const trimmedPid = String(pageIdParam).trim();
          if (trimmedPid) {
            pageId = trimmedPid;
          }
        }
        if (!headingId) {
          const headingParam = getParam('heading', 'title', 'h');
          if (headingParam !== undefined && headingParam !== null) {
            headingId = String(headingParam).trim();
          }
        }
      } catch (_) {
        // ignore parsing failure, fall back to pattern matching
      }
    }

    if (pageIndex === null && !pageId) {
      let match = working.match(/^(?:page[-_]?|p)(\d+)$/i);
      if (match) {
        pageIndex = parseInt(match[1], 10) - 1;
      } else {
        match = working.match(/^(\d+)$/);
        if (match) {
          pageIndex = parseInt(match[1], 10) - 1;
        } else {
          match = working.match(/^page(?:Id)?[-_:]?([0-9a-f]{32})$/i);
          if (match) {
            pageId = match[1];
          } else {
            match = working.match(/^page(?:Id)?[-_:]?(.+)$/i);
            if (match) {
              const candidate = match[1].trim();
              if (candidate) {
                pageId = candidate;
              }
            } else {
              match = working.match(/^([0-9a-f]{32})$/i);
              if (match) {
                pageId = match[1];
              } else if (!headingId) {
                const candidate = working.trim();
                if (candidate) {
                  // Treat plain text as same-page heading reference
                  return {headingId: candidate, pageIndex: null, pageId: null};
                }
              }
            }
          }
        }
      }
    }

    if (pageIndex !== null && (Number.isNaN(pageIndex) || pageIndex < 0)) {
      pageIndex = null;
    }
    if (!headingId) headingId = '';
    if (!pageId && pageIndex === null) {
      return {headingId, pageIndex: null, pageId: null};
    }
    return {headingId, pageIndex, pageId};
  }

  function navigateMarkdownLinkTarget(target) {
    if (!target) return false;
    const {pageIndex, pageId, headingId} = target;
    if (pageIndex === null && !pageId) {
      if (!headingId) return false;
      return focusMarkdownHeading(headingId, {silent: false});
    }

    let idx = null;
    if (typeof pageIndex === 'number' && pageIndex >= 0 && pageIndex < pagesData.length) {
      idx = pageIndex;
    }
    if (idx === null && pageId) {
      const found = findPageIndexById(pageId);
      if (found !== -1) {
        idx = found;
      }
    }
    if (idx === null || idx < 0 || idx >= pagesData.length) {
      if (typeof showStatus === 'function') {
        showStatus('未找到目标页面', 'warning', 2600);
      }
      return false;
    }

    const performHighlight = () => {
      if (headingId) {
        if (!focusMarkdownHeading(headingId, {silent: true})) {
          if (typeof showStatus === 'function') {
            showStatus(`未找到标题 “${headingId}”`, 'warning', 2600);
          }
        }
      } else {
        const container = document.getElementById('markdown-preview');
        if (container) {
          if (typeof container.scrollTo === 'function') container.scrollTo({top: 0, behavior: 'smooth'});
          else container.scrollTop = 0;
        }
      }
    };

    if (idx === currentPageIdx && currentEditMode === 'markdown') {
      performHighlight();
      return true;
    }

    const needsModeSwitch = currentEditMode !== 'markdown';
    currentPageIdx = idx;
    updatePageNumLabel();
    if (needsModeSwitch) {
      setEditMode('markdown');
    } else {
      renderSingleEditor();
    }
    const delay = needsModeSwitch ? 280 : 160;
    setTimeout(() => {
      if (currentPageIdx !== idx) return;
      performHighlight();
    }, delay);
    return true;
  }

  function handleMarkdownPreviewLinkClick(event) {
    if (event.defaultPrevented) return;
    if (event.button !== 0) return;
    if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return;
    const anchor = event.target.closest('a[href]');
    if (!anchor) return;
    if (anchor.target && anchor.target.toLowerCase() === '_blank') return;
    const href = anchor.getAttribute('href');
    if (!href) return;
    const target = parseMarkdownInternalLink(href);
    if (!target) return;
    event.preventDefault();
    navigateMarkdownLinkTarget(target);
  }

  function applyInitialDeepLinkIfNeeded() {
    if (initialDeepLinkApplied) return;
    if (!initialDeepLinkTarget) {
      initialDeepLinkApplied = true;
      return;
    }
    const handled = navigateMarkdownLinkTarget(initialDeepLinkTarget);
    if (!handled && initialDeepLinkTarget.headingId) {
      focusMarkdownHeading(initialDeepLinkTarget.headingId, {silent: true, instant: true});
    }
    initialDeepLinkTarget = null;
    initialDeepLinkApplied = true;
  }

  function enhanceMarkdownHeadingAnchors(preview, wrapper) {
    if (!preview) return;
    if (markdownHeadingHighlightTimer) {
      clearTimeout(markdownHeadingHighlightTimer);
      markdownHeadingHighlightTimer = null;
    }
    markdownHeadingActiveEl = null;
    const slugRegistry = Object.create(null);
    const headings = preview.querySelectorAll('h1, h2, h3, h4, h5, h6');
    headings.forEach(heading => {
      if (!(heading instanceof HTMLElement)) return;
      const currentId = (heading.getAttribute('id') || '').trim();
      const sourceText = heading.textContent ? heading.textContent.trim() : '';
      if (sourceText && !heading.dataset.markdownHeadingText) {
        heading.dataset.markdownHeadingText = sourceText;
      }
      const source = currentId || sourceText || '';
      const slug = slugifyMarkdownHeading(source, slugRegistry);
      if (!slug) return;
      heading.id = slug;
      heading.dataset.markdownHeadingId = slug;
      attachHeadingCopyControl(heading);
    });
    if (!preview.dataset.markdownLinksBound) {
      preview.addEventListener('click', handleMarkdownPreviewLinkClick);
      preview.dataset.markdownLinksBound = '1';
    }
    const container = getMarkdownScrollContainer(preview, wrapper);
    if (container && !container.dataset.markdownLinksBound) {
      container.dataset.markdownLinksBound = '1';
    }
  }

  function buildMarkdownHeadingLinkSnippet(heading) {
    if (!heading) return null;
    const page = pagesData[currentPageIdx] || {};
    const pageId = typeof page.pageId === 'string' ? page.pageId.trim() : '';
    if (!pageId) return null;
    const slug = ((heading.dataset && heading.dataset.markdownHeadingId) || heading.id || '').trim();
    if (!slug) return null;
    return `[${slug}](?pageId=${pageId}#${slug})`;
  }

  async function copyMarkdownHeadingLink(heading) {
    const snippet = buildMarkdownHeadingLinkSnippet(heading);
    if (!snippet) {
      showStatus('无法生成标题链接，请稍后再试', 'warning', 3200);
      return;
    }
    const ok = await copyTextToClipboard(snippet);
    if (ok) {
      showStatus('跳转链接已复制', 'success', 2400);
    } else {
      window.prompt('当前浏览器无法自动复制，请手动复制链接：', snippet);
    }
  }

  function attachHeadingCopyControl(heading) {
    if (!heading || heading.dataset.headingCopyAttached === '1') return;
    heading.dataset.headingCopyAttached = '1';
    heading.classList.add('markdown-heading-with-copy');
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'markdown-heading-copy-btn';
    btn.textContent = '复制链接';
    btn.title = '复制跳转 Markdown 链接';
    btn.addEventListener('click', (event) => {
      event.preventDefault();
      event.stopPropagation();
      copyMarkdownHeadingLink(heading);
    });
    heading.appendChild(btn);
  }

  async function copyCurrentPageIdToClipboard() {
    const page = pagesData[currentPageIdx] || {};
    const rawId = typeof page.pageId === 'string' ? page.pageId.trim() : '';
    if (!rawId) {
      showStatus('当前页缺少 pageId，无法复制', 'warning', 3200);
      return;
    }
    const ok = await copyTextToClipboard(rawId);
    if (ok) {
      showStatus('pageId 已复制到剪贴板', 'success', 2400);
    } else {
      window.prompt('当前浏览器无法自动复制，请手动复制 pageId：', rawId);
    }
  }

  function buildCurrentPageShareLink() {
    const page = pagesData[currentPageIdx] || {};
    const rawId = typeof page.pageId === 'string' ? page.pageId.trim() : '';
    if (!rawId) return null;
    try {
      const url = new URL(window.location.href);
      url.hash = '';
      url.searchParams.set('pageId', rawId);
      const projectName = typeof currentProject === 'string' ? currentProject.trim() : '';
      if (projectName) {
        url.searchParams.set('project', projectName);
      } else {
        url.searchParams.delete('project');
      }
      url.searchParams.delete('page');
      url.searchParams.delete('p');
      url.searchParams.delete('pageIndex');
      url.searchParams.delete('pageindex');
      return url.toString();
    } catch (err) {
      console.warn('生成分享链接失败', err);
      return null;
    }
  }

  async function copyCurrentPageShareLink() {
    const link = buildCurrentPageShareLink();
    if (!link) {
      showStatus('无法生成当前页链接', 'warning', 3200);
      return;
    }
    const ok = await copyTextToClipboard(link);
    if (ok) {
      showStatus('打开链接已复制，可直接分享', 'success', 2400);
    } else {
      window.prompt('当前浏览器无法自动复制，请手动复制链接：', link);
    }
  }

  function confirmDeleteCurrentPage() {
    if (pagesData.length <= 1) {
      showStatus('至少保留一页内容，删除已取消', 'warning', 3200);
      return;
    }
    const pageNumber = currentPageIdx + 1;
    if (!window.confirm(`确定删除第 ${pageNumber} 页吗？此操作无法撤销。`)) {
      return;
    }
    removeCurrentPage();
    renderTabsModal();
    showStatus(`已删除第 ${pageNumber} 页`, 'success', 2400);
  }

  async function copyTextToClipboard(text) {
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(text);
      } else {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        document.execCommand('copy');
        textarea.remove();
      }
      return true;
    } catch (err) {
      console.warn('复制失败', err);
      return false;
    }
  }

  function attachCopyButton(target, text, label, inline = false) {
    if (!target || !text) return;
    const parent = target.parentElement;
    if (!parent) return;
    const wrapper = document.createElement(inline ? 'span' : 'div');
    wrapper.className = 'copy-trigger-wrapper' + (inline ? ' inline-copy' : '');
    parent.insertBefore(wrapper, target);
    wrapper.appendChild(target);

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'copy-trigger-btn btn btn-sm btn-outline-secondary';
    btn.textContent = '复制';
    btn.setAttribute('aria-label', `复制${label}`);
    btn.addEventListener('click', async (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      const ok = await copyTextToClipboard(text);
      if (ok) {
        showStatus(`${label}已复制`, 'success', 2000);
      } else {
        showStatus(`复制${label}失败`, 'warning', 3000);
      }
    });
    wrapper.appendChild(btn);
  }

  function enhanceCodeCopy(preview) {
    if (!preview || !preview.querySelectorAll) return;
    preview.querySelectorAll('pre').forEach(pre => {
      if (pre.closest('.copy-trigger-wrapper')) return;
      const code = pre.querySelector('code');
      const text = code ? code.textContent || '' : pre.textContent || '';
      if (!text.trim()) return;
      attachCopyButton(pre, text, '代码');
    });
  }

  function enhanceMathCopy(preview) {
    if (!preview || !window.MathJax || !MathJax.startup || !MathJax.startup.document) return;
    const items = MathJax.startup.document.math || [];
    items.forEach(item => {
      const root = item && item.typesetRoot;
      if (!root || !preview.contains(root)) return;
      if (!item.display) return; // 仅对块级公式启用复制按钮
      let tex = (item.math || item.originalText || '').trim();
      if (!tex) return;
      if (!/^((\$\$)|(\\\[)|(\\begin))/i.test(tex)) {
        tex = `$$${tex}$$`;
      }
      if (root.closest('.copy-trigger-wrapper')) return;
      attachCopyButton(root, tex, '公式');
    });
  }

  function syncPaneHeights() {
    if (singleEditor) {
      setTimeout(() => singleEditor.refresh(), 0);
    }
  }

  function queueCompile(delay = 600) {
    if (currentEditMode !== 'latex') {
      if (compileTimer) {
        clearTimeout(compileTimer);
        compileTimer = null;
      }
      return;
    }
    if (compileTimer) clearTimeout(compileTimer);
    compileTimer = setTimeout(runCompile, delay);
  }

  function runCompile() {
    if (isCompiling) {
      compilePending = true;
      return;
    }
    if (!ensureWorkspaceReady({silent: true})) {
      return;
    }
    isCompiling = true;
    compilePending = false;
    const payload = withWorkspacePayload({page: currentPageIdx});
    fetch(buildApiUrl('/compile_page'), {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    }).then(res => res.json()).then(data => {
      if (data.success) {
        loadCurrentPagePDF();
      } else {
        showStatus('编译失败：' + (data.error || '未知错误'), 'danger', 6000);
      }
    }).catch(err => {
      showStatus('编译失败：' + (err?.message || '网络错误'), 'danger', 6000);
    }).finally(() => {
      isCompiling = false;
      if (compilePending) {
        compilePending = false;
        runCompile();
      }
    });
  }

  function refreshPreview() {
    const pdfContainer = document.getElementById('pdf-container');
    const markdownContainer = document.getElementById('markdown-preview');
    if (currentEditMode === 'latex') {
      pdfContainer?.classList.remove('d-none');
      markdownContainer?.classList.add('d-none');
      loadCurrentPagePDF();
    } else {
      pdfContainer?.classList.add('d-none');
      markdownContainer?.classList.remove('d-none');
      renderMarkdownPreview();
    }
    updateModeToggleUI();
    syncPaneHeights();
    updateMarkdownSyncVisualState();
  }

  function setEditMode(mode) {
    if (currentEditMode === mode) return;
    currentEditMode = mode;
    renderSingleEditor();
    updateMarkdownSyncVisualState();
  }

  updateModeToggleUI();
  window.addEventListener('resize', () => {
    syncPaneHeights();
    updateMarkdownSyncVisualState();
  });
  requestAnimationFrame(syncPaneHeights);
  initMarkdownScrollSyncToggle();
  
  function renderTabsModal() {
    const tabs = document.getElementById('page-tabs');
    tabs.innerHTML = '';
    pagesData.forEach((_, idx) => {
      const tab = document.createElement('div');
      tab.className = 'page-tab badge rounded-pill' + (idx === currentPageIdx ? ' is-active' : '');
      tab.textContent = idx + 1;
      tab.setAttribute('draggable', 'true');
      tab.style.cursor = 'grab';
      tab.ondragstart = e => {
        e.dataTransfer.setData('text/plain', idx);
        tab.classList.add('opacity-50');
      };
      tab.ondragend = e => tab.classList.remove('opacity-50');
      tab.ondragover = e => e.preventDefault();
      tab.ondrop = e => {
        e.preventDefault();
        const from = parseInt(e.dataTransfer.getData('text/plain'));
        const to = idx;
        if (from !== to) {
          const moved = pagesData.splice(from, 1)[0];
          pagesData.splice(to, 0, moved);
          if (currentPageIdx === from) currentPageIdx = to;
          else if (from < currentPageIdx && to >= currentPageIdx) currentPageIdx--;
          else if (from > currentPageIdx && to <= currentPageIdx) currentPageIdx++;
          saveProject();
          renderTabsModal();
          renderSingleEditor();
          updatePageNumLabel();
          refreshPreview();
        }
      };
      tab.onclick = () => {
        currentPageIdx = idx;
        renderSingleEditor();
        refreshPreview();
        updatePageNumLabel();
        renderTabsModal();
      };
      tabs.appendChild(tab);
    });
  }

  function guessImageExtension(file) {
    const name = file && typeof file.name === 'string' ? file.name.toLowerCase() : '';
    if (name) {
      const match = name.match(/\.([a-z0-9]{2,8})$/);
      if (match && match[1]) {
        const ext = match[1];
        if (ext === 'jpeg') return 'jpg';
        return ext;
      }
    }
    const type = file && typeof file.type === 'string' ? file.type.toLowerCase() : '';
    if (type.startsWith('image/')) {
      const subtype = type.split('/')[1] || '';
      if (!subtype) return 'png';
      if (subtype === 'jpeg' || subtype === 'pjpeg') return 'jpg';
      if (subtype === 'svg+xml') return 'svg';
      return subtype.replace(/[^a-z0-9]/g, '') || 'png';
    }
    return 'png';
  }

  function buildPastedImageFilename(file, index) {
    const date = new Date();
    const pad = (num) => String(num).padStart(2, '0');
    const timestamp = [
      date.getFullYear(),
      pad(date.getMonth() + 1),
      pad(date.getDate()),
      pad(date.getHours()),
      pad(date.getMinutes()),
      pad(date.getSeconds()),
    ].join('');
    const randomPart = Math.random().toString(36).slice(2, 6);
    const extension = guessImageExtension(file);
    return `pasted-${timestamp}-${index + 1}-${randomPart}.${extension}`;
  }

  async function uploadPastedImageFile(file, index) {
    const fd = new FormData();
    const filename = buildPastedImageFilename(file, index);
    fd.append('file', file, filename);
    if(!ensureWorkspaceReady({silent: true})){
      throw new Error('请选择工作区后再上传图片');
    }
    withWorkspacePayload(fd);
    const res = await fetch(buildApiUrl('/attachments/upload'), {method: 'POST', body: fd});
    const parsed = await parseJsonSafe(res);
    if (res.ok && (!parsed.json || parsed.json.success !== false)) {
      const payload = parsed.json || {};
      if (!payload.filename) {
        payload.filename = filename;
      }
      return payload;
    }
    const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || `HTTP ${res.status}`);
    throw new Error(message);
  }

  function buildPastedImageSnippet(payload) {
    if (!payload || typeof payload !== 'object') {
      return {snippet: '', filename: '', warning: '上传结果无效'};
    }
    rememberAttachmentUrl(payload);
    const filename = payload.filename || payload.name || 'pasted-image';
    const localUrl = payload.localUrl || '';
    const isCloudWorkspace = workspaceIsCloud();
    const preferredUrl = isCloudWorkspace ? (payload.url || payload.ossUrl || localUrl) : (localUrl || '');
    const mode = (typeof currentEditMode === 'string' && currentEditMode === 'markdown') ? 'markdown' : 'latex';
    if (mode === 'latex') {
      if (!localUrl) {
        return {snippet: '', filename, warning: '图片已上传，但缺少本地路径，无法在 LaTeX 中引用。'};
      }
      const latexPath = urlToLatexPath(localUrl);
      const snippet = `\\begin{center}\n  \\includegraphics[width=0.7\\textwidth]{${latexPath}}\n\\end{center}\n`;
      return {snippet, filename};
    }
    if (!preferredUrl) {
      return {snippet: '', filename, warning: '图片已上传，但缺少可用链接。'};
    }
    const relativePath = filename || '';
    const target = relativePath || preferredUrl;
    return {snippet: `![${filename}](${target})\n`, filename};
  }

  async function handleEditorPaste(cm, event) {
    const originalEvent = event && event.originalEvent ? event.originalEvent : event;
    const clipboard = (event && event.clipboardData) || (originalEvent && originalEvent.clipboardData);
    const items = clipboard && clipboard.items ? Array.from(clipboard.items) : [];
    const imageItems = items.filter(item => item && item.kind === 'file' && typeof item.type === 'string' && item.type.startsWith('image/'));
    if (!imageItems.length) {
      return;
    }
    event.preventDefault();
    const files = imageItems.map(item => (typeof item.getAsFile === 'function' ? item.getAsFile() : null)).filter(Boolean);
    if (!files.length) {
      return;
    }
    showStatus(files.length > 1 ? `检测到 ${files.length} 张图片，正在上传...` : '检测到图片，正在上传...', 'info', 2500);
    const doc = cm.getDoc();
    let bookmark = doc.setBookmark(doc.getCursor(), {insertLeft: false});
    let insertedCount = 0;
    for (let idx = 0; idx < files.length; idx++) {
      const file = files[idx];
      try {
        const result = await uploadPastedImageFile(file, idx);
        const {snippet, filename, warning} = buildPastedImageSnippet(result);
        if (warning) {
          showStatus(warning, 'warning', 3500);
        }
        if (!snippet) {
          continue;
        }
        const anchorPos = bookmark && typeof bookmark.find === 'function' ? bookmark.find() : null;
        const insertPos = anchorPos || doc.getCursor();
        const startIndex = doc.indexFromPos(insertPos);
        doc.replaceRange(snippet, insertPos);
        const endPos = doc.posFromIndex(startIndex + snippet.length);
        if (bookmark && typeof bookmark.clear === 'function') {
          bookmark.clear();
        }
        bookmark = doc.setBookmark(endPos, {insertLeft: false});
        doc.setCursor(endPos);
        insertedCount += 1;
        showStatus(`图片已上传并插入：${filename || file.name || '图片'}`, 'success', 2200);
      } catch (err) {
        console.error('粘贴图片上传失败', err);
        showStatus('粘贴图片上传失败：' + (err?.message || '未知错误'), 'danger', 4000);
      }
    }
    if (bookmark && typeof bookmark.clear === 'function') {
      bookmark.clear();
    }
    if (insertedCount > 0 && typeof loadAttachmentsModal === 'function') {
      const attachmentsModalEl = document.getElementById('attachmentsModal');
      if (attachmentsModalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal && typeof bootstrap.Modal.getInstance === 'function' && bootstrap.Modal.getInstance(attachmentsModalEl)) {
        try {
          await loadAttachmentsModal();
        } catch (refreshErr) {
          console.warn('刷新附件列表失败', refreshErr);
        }
      }
    }
  }

  function renderSingleEditor() {
    const list = document.getElementById('pages-list');
    list.innerHTML = '';
    const wrapper = document.createElement('div');
    wrapper.className = 'mb-3';
    wrapper.innerHTML = `<textarea id="page-single" class="form-control"></textarea>`;
    list.appendChild(wrapper);
    if (!pagesData[currentPageIdx]) {
      pagesData[currentPageIdx] = {content: '', script: '', notes: '', bib: [], resources: [], pageId: generatePageId()};
    }
    const page = pagesData[currentPageIdx];
    singleEditor = CodeMirror.fromTextArea(wrapper.querySelector('textarea'), {
      mode: currentEditMode === 'markdown' ? 'markdown' : 'stex',
      lineNumbers: true,
      theme: 'default',
      viewportMargin: Infinity,
      lineWrapping: true
    });
    const initialValue = currentEditMode === 'markdown' ? (page.notes || '') : (page.content || '');
    singleEditor.setValue(initialValue);
    singleEditor.setSize('100%', '100%');
    singleEditor.setOption('readOnly', false);
    singleEditor.on('paste', handleEditorPaste);
    singleEditor.on('change', function() {
      const value = singleEditor.getValue();
      if (currentEditMode === 'markdown') {
        pagesData[currentPageIdx].notes = value;
        renderMarkdownPreview();
      } else {
        pagesData[currentPageIdx].content = value;
      }
      saveProject();
      queueCompile();
    });
    bindMarkdownEditorScrollSync(singleEditor);
    const scriptInput = document.getElementById('page-script');
    scriptInput.value = page.script || '';
    updateModeToggleUI();
    refreshPreview();
    // refresh resources list for this page
    setTimeout(()=>{ if(window.refreshResourceLists) refreshResourceLists(); }, 50);
    queueCompile();
  }
  
  const pageStatusBtn = document.getElementById('page-status');
  if (pageStatusBtn) {
    let pageStatusClickTimer = null;
    pageStatusBtn.addEventListener('click', event => {
      if (pageStatusClickTimer) {
        clearTimeout(pageStatusClickTimer);
        pageStatusClickTimer = null;
      }
      if (event.detail > 1) {
        return;
      }
      pageStatusClickTimer = setTimeout(() => {
        renderTabsModal();
        const modalEl = document.getElementById('tabsModal');
        if (modalEl && typeof bootstrap !== 'undefined' && bootstrap?.Modal) {
          const modal = typeof bootstrap.Modal.getOrCreateInstance === 'function'
            ? bootstrap.Modal.getOrCreateInstance(modalEl)
            : new bootstrap.Modal(modalEl);
          modal.show();
        }
        pageStatusClickTimer = null;
      }, 180);
    });
    pageStatusBtn.addEventListener('dblclick', event => {
      if (pageStatusClickTimer) {
        clearTimeout(pageStatusClickTimer);
        pageStatusClickTimer = null;
      }
      event.preventDefault();
      event.stopPropagation();
      jumpToPage(0);
    });
  }

  const tabsCopyPageIdBtn = document.getElementById('tabs-copy-page-id');
  if (tabsCopyPageIdBtn && !tabsCopyPageIdBtn.dataset.bound) {
    tabsCopyPageIdBtn.dataset.bound = '1';
    tabsCopyPageIdBtn.addEventListener('click', () => {
      copyCurrentPageIdToClipboard();
    });
  }
  const tabsDeletePageBtn = document.getElementById('tabs-delete-page');
  if (tabsDeletePageBtn && !tabsDeletePageBtn.dataset.bound) {
    tabsDeletePageBtn.dataset.bound = '1';
    tabsDeletePageBtn.addEventListener('click', () => {
      confirmDeleteCurrentPage();
    });
  }
  const tabsCopyPageLinkBtn = document.getElementById('tabs-copy-page-link');
  if (tabsCopyPageLinkBtn && !tabsCopyPageLinkBtn.dataset.bound) {
    tabsCopyPageLinkBtn.dataset.bound = '1';
    tabsCopyPageLinkBtn.addEventListener('click', () => {
      copyCurrentPageShareLink();
    });
  }

  function removeCurrentPage() {
    if(pagesData.length <= 1) return;
    pagesData.splice(currentPageIdx, 1);
    if(currentPageIdx >= pagesData.length) currentPageIdx = pagesData.length - 1;
    saveProject();
    renderSingleEditor();
    updatePageNumLabel();
  }


  
  document.getElementById('add-page').onclick = function() {
    if(!ensureWorkspaceReady()){
      return;
    }
    const payload = withWorkspacePayload({idx: currentPageIdx + 1});
    fetch(buildApiUrl('/add_page'), {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    }).then(res => res.json()).then(data => {
      pagesData = (data.pages || []).map((p) => {
        if (typeof p !== 'object' || p === null) {
          return {content: String(p || ''), script: '', notes: '', bib: [], resources: [], pageId: generatePageId()};
        }
        const pageObj = {...p};
        pageObj.content = pageObj.content || '';
        pageObj.script = pageObj.script || '';
        pageObj.notes = pageObj.notes || '';
        pageObj.bib = normalizeBibList(pageObj.bib);
        pageObj.resources = Array.isArray(pageObj.resources) ? pageObj.resources : [];
        const pidSource = (typeof pageObj.pageId === 'string' && pageObj.pageId) || (typeof pageObj.id === 'string' && pageObj.id);
        pageObj.pageId = pidSource && pidSource.trim() ? pidSource.trim() : generatePageId();
        delete pageObj.id;
        return pageObj;
      });
      currentPageIdx++;
      renderSingleEditor();
      updatePageNumLabel();
      refreshPreview();
    });
  };

  const projectSearchBtn = document.getElementById('project-search-btn');
  if (projectSearchBtn) {
    projectSearchBtn.addEventListener('click', () => {
      const modal = ensureSearchModal();
      if (modal) modal.show();
      if (searchInputEl) {
        searchInputEl.focus();
        searchInputEl.select();
      }
    });
  }

  if (searchSubmitBtn) {
    searchSubmitBtn.addEventListener('click', () => {
      performProjectSearch(searchInputEl ? searchInputEl.value : '');
    });
  }

  if (searchInputEl) {
    searchInputEl.addEventListener('keydown', (event) => {
      if (event.key === 'Enter') {
        event.preventDefault();
        performProjectSearch(searchInputEl.value);
      } else if (event.key === 'Escape') {
        event.preventDefault();
        const modal = ensureSearchModal();
        if (modal) modal.hide();
      }
    });
    searchInputEl.addEventListener('input', () => {
      if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
      searchDebounceTimer = setTimeout(() => {
        const value = searchInputEl.value;
        const trimmed = value.trim();
        const cached = (searchQueryCache || '').trim();
        if (!trimmed && !cached) {
          performProjectSearch('');
          return;
        }
        if (trimmed === cached) return;
        performProjectSearch(value);
      }, 350);
    });
  }

  const modeSwitchBtn = document.getElementById('mode-switch-btn');
  if (modeSwitchBtn) {
    modeSwitchBtn.addEventListener('click', () => {
      const nextMode = currentEditMode === 'latex' ? 'markdown' : 'latex';
      setEditMode(nextMode);
    });
  }
  updateModeToggleUI();
  const initialColorMode = document.body.classList.contains('theme-dark')
    ? 'dark'
    : (document.body.getAttribute('data-bs-theme') || (window.BENORT_UI_THEME && window.BENORT_UI_THEME.color_mode) || 'light');
  applyColorMode(initialColorMode);
  
  document.getElementById('edit-template').onclick = function() {
    const mode = currentEditMode === 'markdown' ? 'markdown' : 'latex';
    const latexFields = document.getElementById('template-latex-fields');
    const markdownFields = document.getElementById('template-markdown-fields');
    const helper = document.getElementById('template-helper-text');

    if (mode === 'markdown') {
      latexFields?.classList.add('d-none');
      markdownFields?.classList.remove('d-none');
      if (helper) helper.textContent = 'CSS 将实时作用于 Markdown 预览区域。';
      document.getElementById('template-markdown-css').value = markdownTemplate.css || '';
      document.getElementById('template-markdown-wrapper').value = markdownTemplate.wrapperClass || '';
    } else {
      markdownFields?.classList.add('d-none');
      latexFields?.classList.remove('d-none');
      if (helper) helper.textContent = '选择后仍可在下方继续调整。';
      document.getElementById('template-header').value = latexTemplate.header || '';
      document.getElementById('template-before-pages').value = latexTemplate.beforePages || '';
      document.getElementById('template-footer').value = latexTemplate.footer || '';
    }

    ensureTemplatesLoaded().finally(() => {
      detectCurrentTemplate(mode);
      populateTemplateSelect(mode);
    });
    var modal = new bootstrap.Modal(document.getElementById('templateModal'));
    modal.show();
  };
  document.getElementById('save-template').onclick = function() {
    const mode = currentEditMode === 'markdown' ? 'markdown' : 'latex';
    const selectEl = document.getElementById('template-select');

    if (mode === 'markdown') {
      const cssVal = document.getElementById('template-markdown-css').value;
      const wrapperVal = document.getElementById('template-markdown-wrapper').value.trim();
      markdownTemplate.css = cssVal;
      markdownTemplate.wrapperClass = wrapperVal;
      if (typeof markdownTemplate.customHead === 'string' && !markdownTemplate.customHead.trim()) {
        delete markdownTemplate.customHead;
      }
      const chosen = selectEl ? selectEl.value : '';
      let matchedTemplate = null;
      if (chosen) {
        const tmpl = (availableTemplates.markdown || []).find(t => t.name === chosen);
        if (
          tmpl &&
          normalizeCssText(tmpl.css) === normalizeCssText(cssVal) &&
          (tmpl.wrapperClass || '') === wrapperVal
        ) {
          selectedTemplateName.markdown = chosen;
          matchedTemplate = tmpl;
        } else {
          selectedTemplateName.markdown = '';
          if (selectEl) selectEl.value = '';
        }
      } else {
        selectedTemplateName.markdown = '';
      }
      if (matchedTemplate && matchedTemplate.customHead) {
        markdownTemplate.customHead = matchedTemplate.customHead;
      }
      detectCurrentTemplate('markdown');
      saveProject();
      applyMarkdownStyles();
      renderMarkdownPreview();
    } else {
      const headerVal = document.getElementById('template-header').value;
      const beforeVal = document.getElementById('template-before-pages').value;
      const footerVal = document.getElementById('template-footer').value;
      latexTemplate.header = headerVal;
      latexTemplate.beforePages = beforeVal;
      latexTemplate.footer = footerVal;
      const chosen = selectEl ? selectEl.value : '';
      if (chosen) {
        const tmpl = (availableTemplates.latex || []).find(t => t.name === chosen);
        if (
          tmpl &&
          normalizeTemplateText(tmpl.header) === normalizeTemplateText(headerVal) &&
          normalizeTemplateText(tmpl.beforePages) === normalizeTemplateText(beforeVal) &&
          normalizeTemplateText(tmpl.footer) === normalizeTemplateText(footerVal)
        ) {
          selectedTemplateName.latex = chosen;
        } else {
          selectedTemplateName.latex = '';
          if (selectEl) selectEl.value = '';
        }
      } else {
        selectedTemplateName.latex = '';
      }
      detectCurrentTemplate('latex');
      saveProject();
      queueCompile();
    }
    var modal = bootstrap.Modal.getInstance(document.getElementById('templateModal'));
    modal.hide();
  };

  
  document.getElementById('tex-form').onsubmit = function(e) {
    e.preventDefault();
    saveProject();
  };

  
  // export-tex button removed; unified export flow handled by export modal

  // New unified export flow
  const exportBtn = document.getElementById('export-btn');
  if(exportBtn) exportBtn.addEventListener('click', function(){
    var modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
  });

  const templateSelectEl = document.getElementById('template-select');
  if (templateSelectEl) templateSelectEl.addEventListener('change', function(){
    const name = this.value;
    const mode = currentEditMode === 'markdown' ? 'markdown' : 'latex';
    if (name) {
      applyTemplateByName(name, mode);
    } else {
      selectedTemplateName[mode] = '';
      if (mode === 'markdown') {
        applyMarkdownStyles();
      }
    }
  });

  document.getElementById('doExportBtn').addEventListener('click', function(){
    const opt = document.querySelector('input[name="exportOption"]:checked').value;
    var modalEl = document.getElementById('exportModal');
    var modal = bootstrap.Modal.getInstance(modalEl);
    modal.hide();
    if(opt === 'page_pdf') {
      const pageNumber = currentPageIdx + 1;
      const requestUrl = appendWorkspaceQuery(`/export_page_pdf?page=${pageNumber}`);
      fetch(requestUrl).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `slide_page_${pageNumber}.pdf`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus(`第 ${pageNumber} 页 PDF 已导出`, 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'page_notes') {
      const pageNumber = currentPageIdx + 1;
      const requestUrl = appendWorkspaceQuery(`/export_page_notes?page=${pageNumber}`);
      fetch(requestUrl).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `page_${pageNumber}_notes.md`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus(`第 ${pageNumber} 页 Markdown 已导出`, 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'page_notes_html') {
      const pageNumber = currentPageIdx + 1;
      const requestUrl = appendWorkspaceQuery(`/export_page_markdown_html?page=${pageNumber}`);
      fetch(requestUrl).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `page_${pageNumber}_notes.html`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus(`第 ${pageNumber} 页 HTML 已导出`, 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'page_audio'){
      const pageNumber = currentPageIdx + 1;
      const requestUrl = appendWorkspaceQuery(`/export_page_audio?page=${pageNumber}`);
      fetch(requestUrl).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `page_${pageNumber}_script.mp3`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus(`第 ${pageNumber} 页讲稿语音已导出`, 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'notes'){
      fetch(appendWorkspaceQuery('/export_notes')).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'notes.md'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus('全部页 Markdown 已导出', 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'notes_html'){
      fetch(appendWorkspaceQuery('/export_notes_html')).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'notes.html'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus('全部页 HTML 已导出', 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'learn'){
      fetch(appendWorkspaceQuery('/export_learn_project')).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'learning_records.yaml'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus('学习记录已导出', 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'tex') return exportTex();
    if(opt === 'project_bundle_data') {
      const bundleUrl = appendWorkspaceQuery('/export_project_bundle');
      fetch(bundleUrl).then(res => {
        if(res.ok) {
          return res.blob().then(blob => ({blob, res}));
        }
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(({blob, res}) => {
        const projectSlug = (typeof currentProject === 'string' && currentProject.trim()) ? currentProject.trim() : 'workspace';
        let filename = `${projectSlug}.benort`;
        const disposition = res.headers.get('Content-Disposition');
        if (disposition) {
          const match = disposition.match(/filename="?([^";]+)"?/i);
          if (match && match[1]) {
            filename = match[1];
          }
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        showStatus('.benort 工作区已导出', 'success', 3000);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
    if(opt === 'audio'){
      const requestUrl = appendWorkspaceQuery('/export_audio');
      fetch(requestUrl).then(res => {
        if(res.ok) return res.blob();
        return res.json().then(data=>{throw new Error(data.error||'导出失败')});
      }).then(blob => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'all_notes.mp3'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        showStatus('全部讲稿语音已导出', 'success', 2500);
      }).catch(e=>alert('导出失败：'+e.message));
      return;
    }
  });
  
  function flushProjectSave(callbacks) {
    if(!ensureWorkspaceReady({silent: true})){
      return;
    }
    const targetEndpoint = PROJECT_ENDPOINTS.projectSave;
    if(!targetEndpoint){
      promptWorkspaceSelection('请先选择工作区后再保存项目');
      return;
    }
    const payload = {
      template: {...latexTemplate},
      markdownTemplate: {...markdownTemplate},
      pages: pagesData,
      resources: globalResources,
      llm: getLlmPayload(),
    };
    saveRequestQueue = saveRequestQueue
      .catch(() => {})
      .then(() => fetch(targetEndpoint, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      }))
      .then(async response => {
        if (!response.ok) {
          let message = '保存接口返回错误';
          try {
            const parsed = await parseJsonSafe(response);
            if(parsed.json && parsed.json.error){
              message = parsed.json.error;
            } else if(parsed.text){
              message = parsed.text;
            } else {
              message = `HTTP ${response.status}`;
            }
          } catch (e) {
            message = `HTTP ${response.status}`;
          }
          throw new Error(message);
        }
        callbacks.forEach(cb => {
          try {
            cb();
          } catch (err) {
            console.error('saveProject 回调执行失败:', err);
          }
        });
      })
      .catch(err => {
        console.error('保存项目失败:', err);
        showStatus('保存失败：' + (err?.message || '网络错误'), 'danger', 6000);
      });
  }

  function saveProject(cb) {
    if (typeof cb === 'function') {
      pendingSaveCallbacks.push(cb);
    }
    if (saveProjectTimer) {
      clearTimeout(saveProjectTimer);
    }
    saveProjectTimer = setTimeout(() => {
      saveProjectTimer = null;
      const callbacks = pendingSaveCallbacks.slice();
      pendingSaveCallbacks = [];
      flushProjectSave(callbacks);
    }, 400);
  }

  
  function loadProject(cb) {
    if(!ensureWorkspaceReady({silent: true})){
      return Promise.resolve(null);
    }
    const targetProject = typeof currentProject === 'string' ? currentProject : '';
    const promptsChanged = handleLearningProjectSwitch(targetProject, {force: false});
    const projectUrl = PROJECT_ENDPOINTS.project;
    if(!projectUrl){
      promptWorkspaceSelection('请先选择工作区后再加载项目');
      return Promise.resolve(null);
    }
    return fetch(projectUrl)
      .then(async res => {
        let data;
        try {
          data = await res.json();
        } catch (e) {
          data = {};
        }
        if (res.status === 401 || res.status === 423) {
          const lockedMessage = data && data.error ? data.error : '';
          handleProjectLocked(lockedMessage);
          return null;
        }
        if (!res.ok) {
          const message = data && data.error ? data.error : `HTTP ${res.status}`;
          throw new Error(message);
        }
        return data;
      })
      .then(data => {
        if (!data) return;
        if(Object.prototype.hasOwnProperty.call(data, 'locked')){
          updateWorkspaceSecurityState({locked: !!data.locked, unlocked: !!data.unlocked});
        }
        if(data.llm && typeof data.llm === 'object'){
          llmSettings = normalizeLlmSettings(data.llm);
        } else {
          llmSettings = normalizeLlmSettings({});
        }
        refreshLlmUi();
        latexTemplate = typeof data.template === 'string' ? {
          header: data.template,
          beforePages: '\\begin{document}',
          footer: '\\end{document}'
        } : (data.template || latexTemplate);
        const mdTemplate = data.markdownTemplate;
        if (typeof mdTemplate === 'string') {
          markdownTemplate = { css: mdTemplate, wrapperClass: '' };
        } else if (mdTemplate && typeof mdTemplate === 'object') {
          markdownTemplate = {
            css: mdTemplate.css || '',
            wrapperClass: mdTemplate.wrapperClass || '',
          };
          if (mdTemplate.customHead) {
            markdownTemplate.customHead = mdTemplate.customHead;
          } else if ('customHead' in markdownTemplate) {
            delete markdownTemplate.customHead;
          }
        } else {
          markdownTemplate = { css: '', wrapperClass: '' };
        }

        pagesData = (data.pages || []).map((p, index) => {
          if (typeof p !== 'object' || p === null) {
            return {content: String(p || ''), script: '', notes: '', bib: [], resources: [], pageId: generatePageId()};
          }
          const pageObj = {...p};
          pageObj.content = pageObj.content || '';
          pageObj.script = pageObj.script || '';
          pageObj.notes = pageObj.notes || '';
          pageObj.bib = normalizeBibList(pageObj.bib);
          pageObj.resources = Array.isArray(pageObj.resources) ? pageObj.resources : [];
          const pidSource = (typeof pageObj.pageId === 'string' && pageObj.pageId) || (typeof pageObj.id === 'string' && pageObj.id);
          pageObj.pageId = pidSource && pidSource.trim() ? pidSource.trim() : generatePageId();
          delete pageObj.id;
          return pageObj;
        });
        if(pagesData.length === 0) pagesData = [{content: '', script: '', notes: '', bib: [], resources: [], pageId: generatePageId()}];
        globalResources = Array.isArray(data.resources) ? data.resources.slice() : [];
        bibData = normalizeBibList(data.bib || []);
        currentPageIdx = Math.min(currentPageIdx, pagesData.length - 1);
        updateProjectButtonLabel();
        renderSingleEditor();
        updatePageNumLabel();
        ensureTemplatesLoaded().then(() => detectAllTemplates()).catch(() => {});
        applyMarkdownStyles();
        const liveProject = typeof currentProject === 'string' ? currentProject : '';
        if (liveProject === targetProject) {
          const needsReload = promptsChanged || !learningAssistantState.loaded || learningAssistantState.project !== targetProject;
          if (targetProject && needsReload) {
            loadLearningPrompts(true);
          } else if (targetProject) {
            learningAssistantState.pendingProject = targetProject;
          }
        }
        resetSearchState();
        applyInitialDeepLinkIfNeeded();
        primeAttachmentUrlIndex({reRender: currentEditMode === 'markdown'});
        if(cb) cb();
      })
      .catch(err => {
        if(!err) return;
        console.error(err);
        showStatus('加载项目失败：' + (err?.message || '未知错误'), 'danger', 6000);
      });
  }
  
  document.addEventListener('input', function(e) {
    if(!e.target) return;
    if(e.target.id === 'page-script') {
      pagesData[currentPageIdx].script = e.target.value;
      saveProject();
      queueCompile();
    }
  });



  
  const pdfPagesContainer = document.getElementById('pdf-pages');
  let currentPdfRequestId = 0;

  function resetPdfViewer() {
    if (pdfPagesContainer) {
      pdfPagesContainer.innerHTML = '';
    }
  }

  function renderMessage(message, requestId) {
    if (!pdfPagesContainer || requestId !== currentPdfRequestId) return;
    resetPdfViewer();
    const holder = document.createElement('div');
    holder.className = 'text-muted small';
    holder.style.padding = '2rem';
    holder.textContent = message;
    pdfPagesContainer.appendChild(holder);
  }

  async function renderPdfDocument(pdf, requestId) {
    if (!pdfPagesContainer || requestId !== currentPdfRequestId) return;
    resetPdfViewer();
    const total = pdf.numPages;
    if (!total) {
      renderMessage('PDF 没有页面', requestId);
      return;
    }
    for (let i = 1; i <= total; i += 1) {
      if (requestId !== currentPdfRequestId) {
        return;
      }
      try {
        const page = await pdf.getPage(i);
        if (requestId !== currentPdfRequestId) {
          return;
        }
        const viewport = page.getViewport({ scale: 1.5 });
        const canvas = document.createElement('canvas');
        canvas.className = 'pdf-page-canvas shadow-sm';
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        pdfPagesContainer.appendChild(canvas);
        const ctx = canvas.getContext('2d');
        if (ctx) {
          await page.render({ canvasContext: ctx, viewport }).promise;
        }
      } catch (err) {
        console.error(`渲染 PDF 第 ${i} 页失败:`, err);
        renderMessage('PDF 渲染失败', requestId);
        return;
      }
    }
  }

  function loadCurrentPagePDF(retry = 0) {
    if (!pdfPagesContainer) return;
    const requestId = ++currentPdfRequestId;
    renderMessage('加载中...', requestId);
    const project = currentProject || '';
    const baseUrl = `/page_pdf/${currentPageIdx + 1}?project=${encodeURIComponent(project)}&t=${Date.now()}`;
    const pdfUrl = appendWorkspaceQuery(baseUrl);
    fetch(pdfUrl, { method: 'HEAD' }).then(res => {
      if (requestId !== currentPdfRequestId) {
        return;
      }
      if (res.ok) {
        pdfjsLib.getDocument(pdfUrl).promise
          .then(pdf => renderPdfDocument(pdf, requestId))
          .catch(err => {
            console.error('加载 PDF 失败:', err);
            renderMessage('PDF 加载失败', requestId);
          });
      } else {
        if (retry < 3) {
          setTimeout(() => loadCurrentPagePDF(retry + 1), 800);
        } else {
          renderMessage('本页未编译', requestId);
        }
      }
    }).catch(err => {
      console.error('请求 PDF 失败:', err);
      if (retry < 3) {
        setTimeout(() => loadCurrentPagePDF(retry + 1), 800);
      } else if (requestId === currentPdfRequestId) {
        renderMessage('无法加载预览', requestId);
      }
    });
    document.getElementById('page-num').textContent = currentPageIdx + 1;
    document.getElementById('page-count').textContent = pagesData.length;
  }

// --- multi-project client helpers ---
(function(){
  function getSelectedProject() {
    return currentProject || '';
  }

  function appendProjectQuery(url, key, value) {
    if(typeof url !== 'string') return url;
    const sep = url.indexOf('?') > -1 ? '&' : '?';
    return url + sep + encodeURIComponent(key) + '=' + encodeURIComponent(value);
  }

  function extractContentType(headers){
    if(!headers) return '';
    if(headers instanceof Headers){
      return headers.get('Content-Type') || headers.get('content-type') || '';
    }
    if(Array.isArray(headers)){
      for(const entry of headers){
        if(Array.isArray(entry) && entry.length >= 2 && typeof entry[0] === 'string' && entry[0].toLowerCase() === 'content-type'){
          return entry[1];
        }
      }
      return '';
    }
    if(typeof headers === 'object'){
      return headers['Content-Type'] || headers['content-type'] || '';
    }
    return '';
  }

  const _origFetch = window.fetch.bind(window);
  window.fetch = function(input, init){
    let requestUrl = input;
    let requestInit = init;
    let shouldTrack401 = false;

    try {
      if(typeof requestUrl === 'string' && requestUrl.startsWith('/')){
        shouldTrack401 = true;
        const project = getSelectedProject();
        if(project){
          if(requestInit && requestInit.body instanceof FormData){
            requestUrl = appendProjectQuery(requestUrl, 'project', project);
          } else if(requestInit && requestInit.headers){
            const contentType = extractContentType(requestInit.headers) || '';
            if(contentType.indexOf('application/json') > -1 && requestInit.body){
              try{
                const obj = JSON.parse(requestInit.body);
                obj.project = project;
                requestInit = Object.assign({}, requestInit, { body: JSON.stringify(obj) });
              }catch(e){}
            } else {
              requestUrl = appendProjectQuery(requestUrl, 'project', project);
            }
          } else {
            requestUrl = appendProjectQuery(requestUrl, 'project', project);
          }
        }
      }
    } catch(e) {
      // ignore and fall back to default fetch
    }

    const fetchPromise = _origFetch(requestUrl, requestInit);
    if(shouldTrack401){
      return fetchPromise.then(async res => {
        if(res.status === 401 || res.status === 423){
          let message = '';
          try{
            const header = res.headers.get('content-type') || res.headers.get('Content-Type') || '';
            if(header && header.indexOf('application/json') > -1){
              const data = await res.clone().json();
              if(data && data.error) message = data.error;
            } else {
              message = await res.clone().text();
            }
          }catch(err){
            message = '';
          }
          handleProjectLocked(message);
        }
        return res;
      });
    }
    return fetchPromise;
  };

  window.loadProjects = async function(){
    projectMetadata = {};
    projectListCache = [];
    try{
      const res = await _origFetch(WORKSPACE_ENDPOINTS.list);
      if(res.ok){
        const data = await res.json();
        registeredWorkspaces = Array.isArray(data.workspaces) ? data.workspaces : [];
      }
    }catch(err){
      console.warn('loadProjects failed', err);
      registeredWorkspaces = [];
    }
    updateProjectButtonLabel();
    return registeredWorkspaces;
  };
})();

  function openProjectCreateModal(){
    promptWorkspaceSelection('请通过“选择工作区”面板新建 .benort 文件');
  }

  function openProjectRenameModal(){
    promptWorkspaceSelection('请在工作区面板中重命名项目');
  }

  function openProjectDeleteModal(){
    promptWorkspaceSelection('请在工作区面板中删除项目');
  }

  function openProjectPasswordModal(){
    if(!currentWorkspace || !currentWorkspace.workspace_id){
      promptWorkspaceSelection('请在工作区面板中管理密码/加密');
      return;
    }
    if(projectPasswordWarning){
      projectPasswordWarning.textContent = '';
      projectPasswordWarning.classList.add('d-none');
    }
    if(projectPasswordModalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal){
      bootstrap.Modal.getOrCreateInstance(projectPasswordModalEl).show();
    }
  }

  async function lockCurrentProject(){
    openProjectPasswordModal();
  }

  if(projectCreateConfirmBtn){
    projectCreateConfirmBtn.addEventListener('click', function(){
      promptWorkspaceSelection('请在工作区面板中完成创建操作');
    });
  }

  if(projectRenameConfirmBtn){
    projectRenameConfirmBtn.addEventListener('click', function(){
      promptWorkspaceSelection('请在工作区面板中重命名项目');
    });
  }

  if(projectDeleteConfirmBtn){
    projectDeleteConfirmBtn.addEventListener('click', function(){
      promptWorkspaceSelection('请在工作区面板中删除项目');
    });
  }

  if(projectPasswordSaveBtn){
    projectPasswordSaveBtn.addEventListener('click', async function(){
      if(!currentWorkspace || !currentWorkspace.workspace_id){
        promptWorkspaceSelection('请在工作区面板中设置访问密码');
        return;
      }
      if(projectPasswordWarning){
        projectPasswordWarning.textContent = '';
        projectPasswordWarning.classList.add('d-none');
      }
      const newPassword = projectPasswordNewInput ? projectPasswordNewInput.value.trim() : '';
      const confirmPassword = projectPasswordConfirmInput ? projectPasswordConfirmInput.value.trim() : '';
      if(!newPassword){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = '请输入新密码';
          projectPasswordWarning.classList.remove('d-none');
        }
        return;
      }
      if(newPassword !== confirmPassword){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = '两次输入的密码不一致';
          projectPasswordWarning.classList.remove('d-none');
        }
        return;
      }
      const endpoint = WORKSPACE_ENDPOINTS.password(currentWorkspace.workspace_id);
      if(!endpoint){
        showStatus('无法定位当前工作区', 'danger', 5000);
        return;
      }
      const currentPassword = projectPasswordCurrentInput ? projectPasswordCurrentInput.value : '';
      this.disabled = true;
      try{
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            currentPassword: currentPassword || undefined,
            newPassword,
          }),
        });
        const data = await res.json().catch(() => ({}));
        if(!res.ok){
          throw new Error((data && data.error) ? data.error : `HTTP ${res.status}`);
        }
        updateWorkspaceSecurityState({locked: data.locked, unlocked: data.unlocked});
        showStatus('工作区密码已更新', 'success', 4000);
        if(projectPasswordModalEl && typeof bootstrap !== 'undefined'){
          const modal = bootstrap.Modal.getInstance(projectPasswordModalEl);
          modal?.hide();
        }
        if(projectPasswordCurrentInput) projectPasswordCurrentInput.value = '';
        if(projectPasswordNewInput) projectPasswordNewInput.value = '';
        if(projectPasswordConfirmInput) projectPasswordConfirmInput.value = '';
      }catch(err){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = err && err.message ? err.message : '操作失败，请稍后再试';
          projectPasswordWarning.classList.remove('d-none');
        }
      }finally{
        this.disabled = false;
      }
    });
  }

  if(projectPasswordRemoveBtn){
    projectPasswordRemoveBtn.addEventListener('click', async function(){
      if(!currentWorkspace || !currentWorkspace.workspace_id){
        promptWorkspaceSelection('请在工作区面板中管理密码');
        return;
      }
      if(projectPasswordWarning){
        projectPasswordWarning.textContent = '';
        projectPasswordWarning.classList.add('d-none');
      }
      const endpoint = WORKSPACE_ENDPOINTS.password(currentWorkspace.workspace_id);
      if(!endpoint){
        showStatus('无法定位当前工作区', 'danger', 5000);
        return;
      }
      const currentPassword = projectPasswordCurrentInput ? projectPasswordCurrentInput.value : '';
      this.disabled = true;
      try{
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            clear: true,
            currentPassword: currentPassword || undefined,
          }),
        });
        const data = await res.json().catch(() => ({}));
        if(!res.ok){
          throw new Error((data && data.error) ? data.error : `HTTP ${res.status}`);
        }
        updateWorkspaceSecurityState({locked: data.locked, unlocked: data.unlocked});
        showStatus('已移除工作区密码', 'success', 4000);
        if(projectPasswordModalEl && typeof bootstrap !== 'undefined'){
          const modal = bootstrap.Modal.getInstance(projectPasswordModalEl);
          modal?.hide();
        }
        if(projectPasswordCurrentInput) projectPasswordCurrentInput.value = '';
        if(projectPasswordNewInput) projectPasswordNewInput.value = '';
        if(projectPasswordConfirmInput) projectPasswordConfirmInput.value = '';
      }catch(err){
        if(projectPasswordWarning){
          projectPasswordWarning.textContent = err && err.message ? err.message : '操作失败，请稍后再试';
          projectPasswordWarning.classList.remove('d-none');
        }
      }finally{
        this.disabled = false;
      }
    });
  }

  if(projectUnlockConfirmBtn){
    projectUnlockConfirmBtn.addEventListener('click', async function(){
      if(!currentWorkspace || !currentWorkspace.workspace_id){
        promptWorkspaceSelection('请在工作区面板中处理解锁/密码');
        return;
      }
      if(projectUnlockErrorBox){
        projectUnlockErrorBox.textContent = '';
        projectUnlockErrorBox.classList.add('d-none');
      }
      const password = projectUnlockPasswordInput ? projectUnlockPasswordInput.value.trim() : '';
      if(!password){
        if(projectUnlockErrorBox){
          projectUnlockErrorBox.textContent = '请输入密码';
          projectUnlockErrorBox.classList.remove('d-none');
        }
        return;
      }
      const endpoint = WORKSPACE_ENDPOINTS.unlock(currentWorkspace.workspace_id);
      if(!endpoint){
        showStatus('无法定位当前工作区', 'danger', 5000);
        return;
      }
      this.disabled = true;
      try{
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({password}),
        });
        const data = await res.json().catch(() => ({}));
        if(!res.ok){
          throw new Error((data && data.error) ? data.error : `HTTP ${res.status}`);
        }
        updateWorkspaceSecurityState({locked: data.locked, unlocked: data.unlocked});
        showStatus('工作区已解锁', 'success', 3000);
        if(projectUnlockModalEl && typeof bootstrap !== 'undefined'){
          const modal = bootstrap.Modal.getInstance(projectUnlockModalEl);
          modal?.hide();
        }
        if(projectUnlockPasswordInput) projectUnlockPasswordInput.value = '';
        loadProject();
      }catch(err){
        if(projectUnlockErrorBox){
          projectUnlockErrorBox.textContent = err && err.message ? err.message : '解锁失败，请重试';
          projectUnlockErrorBox.classList.remove('d-none');
        }
      }finally{
        this.disabled = false;
      }
    });
  }

// 初始化工作区 UI
updateWorkspaceUi();
if(window.BENORT_PORTABLE_ERROR && window.BENORT_PORTABLE_ERROR.trim()){
  showStatus(window.BENORT_PORTABLE_ERROR, 'danger', 6000);
}
applyDefaultWorkspaceIfNeeded();
(async () => {
  const restored = defaultWorkspaceApplied ? true : await restoreWorkspaceFromPreference();
  await loadProjects();
  if(currentWorkspace && currentWorkspace.workspace_id){
    if(!restored){
      loadProject();
    }
  } else {
    promptWorkspaceSelection('请通过“打开本地工作区”按钮选择 .benort 文件');
  }
})();

  
  document.getElementById('ai-optimize').onclick = function() {
    const content = pagesData[currentPageIdx]?.content || '';
    const note = pagesData[currentPageIdx]?.notes || '';
    this.disabled = true;
    this.textContent = '优化中...';
    fetch('/ai_optimize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(withWorkspacePayload(withLlmConfig({latex: content, markdown: note, type: 'latex'})))
    }).then(res => res.json()).then(data => {
      if(data.success && data.result) {
        document.getElementById('ai-result').value = data.result;
        var modal = new bootstrap.Modal(document.getElementById('aiModal'));
        modal.show();
      } else {
        alert('AI优化失败：' + (data.error || '未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = 'tex优化';
    });
  };
  document.getElementById('apply-ai-result').onclick = function() {
    const val = document.getElementById('ai-result').value;
    if(val) {
      pagesData[currentPageIdx].content = val;
      renderSingleEditor();
      saveProject();
      queueCompile();
    }
    var modal = bootstrap.Modal.getInstance(document.getElementById('aiModal'));
    modal.hide();
  };

  // AI script optimization (讲稿)
  const aiScriptBtn = document.getElementById('ai-script-optimize');
  if(aiScriptBtn) aiScriptBtn.addEventListener('click', function(){
    const content = pagesData[currentPageIdx]?.script || '';
    const page_tex = pagesData[currentPageIdx]?.content || '';
    const note = pagesData[currentPageIdx]?.notes || '';
    this.disabled = true;
    this.textContent = '优化中...';
    fetch('/ai_optimize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(withWorkspacePayload(withLlmConfig({script: content, latex: page_tex, markdown: note, type: 'script'})))
    }).then(res => res.json()).then(data => {
      if(data.success && data.result) {
        document.getElementById('ai-script-result').value = data.result;
        var modal = new bootstrap.Modal(document.getElementById('aiScriptModal'));
        modal.show();
      } else {
        alert('AI讲稿优化失败：' + (data.error || '未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = 'script优化';
    });
  });

  document.getElementById('apply-ai-script-result').onclick = function(){
    const val = document.getElementById('ai-script-result').value;
    if(val){
      pagesData[currentPageIdx].script = val;
      document.getElementById('page-script').value = val;
      saveProject();
      queueCompile();
    }
    var modal = bootstrap.Modal.getInstance(document.getElementById('aiScriptModal'));
    modal.hide();
  };
  
  document.getElementById('ai-note-optimize').onclick = function() {
    const note = pagesData[currentPageIdx]?.notes || '';
    const page_tex = pagesData[currentPageIdx]?.content || '';
    this.disabled = true;
    this.textContent = '优化中...';
    fetch('/ai_optimize', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(withWorkspacePayload(withLlmConfig({markdown: note, latex: page_tex, type: 'note'})))
    }).then(res => res.json()).then(data => {
      if(data.success && data.result) {
        document.getElementById('ai-note-result').value = data.result;
        var modal = new bootstrap.Modal(document.getElementById('aiNoteModal'));
        modal.show();
      } else {
        alert('AI优化失败：' + (data.error || '未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = 'md优化';
    });
  };
  document.getElementById('apply-ai-note-result').onclick = function() {
    const val = document.getElementById('ai-note-result').value;
    if(val) {
      pagesData[currentPageIdx].notes = val;
      if(currentEditMode === 'markdown' && singleEditor) {
        singleEditor.setValue(val);
      }
      renderMarkdownPreview();
      saveProject();
      queueCompile();
    }
    var modal = bootstrap.Modal.getInstance(document.getElementById('aiNoteModal'));
    modal.hide();
  };

  const learningAssistantState = {
    modal: null,
    promptModal: null,
    resultModal: null,
    reviewModal: null,
    loaded: false,
    loadingPrompts: false,
    prompts: [],
    editingPrompt: null,
    project: '',
    pendingProject: '',
    resultQueue: [],
    activeResult: null,
    review: {
      loading: false,
      initialized: false,
      records: [],
      categories: [],
      filters: {
        method: '',
        favoriteOnly: false,
        search: '',
        dueOnly: false,
      },
    },
    reviewSession: {
      modal: null,
      active: null,
      locked: false,
      backdrop: null,
    },
  };

  const DEFAULT_TEMP_LEARN_TEMPLATE = "请围绕以下内容提供结构化讲解、要点拆解和练习建议：\n{content}\n\n上下文：\n{context}";
  const REVIEW_DEFAULT_STATE = {
    ease: 2.5,
    interval: 0,
    streak: 0,
    lapses: 0,
    lastRating: '',
    lastReviewAt: null,
    nextReviewAt: null,
    note: '',
    effect: 3,
  };
  const REVIEW_RATING_LABELS = {
    again: '再来',
    hard: '较难',
    good: '良好',
    easy: '轻松',
  };
  const REVIEW_RATING_EFFECT = {
    again: 1,
    hard: 2,
    good: 4,
    easy: 5,
  };

  // Cache the last selection (text + images) before focus moves away (e.g., clicking AI 学习)
  let lastLearningSelectionSnapshot = null;
  let lastLearningApplyMeta = null;

  const aiAssistantState = {
    modal: null,
    running: false,
    contexts: [],
    ragNotice: '',
    ragUsed: false,
    ragScope: 'off',
    lastModel: '',
    lastEmbedding: '',
    modalVisible: false,
    autoShowOnFinish: false,
  };

  function handleLearningProjectSwitch(nextProject, options = {}) {
    const normalized = typeof nextProject === 'string' ? nextProject : '';
    const force = options && options.force === true;
    const changed = force || learningAssistantState.project !== normalized;
    learningAssistantState.pendingProject = normalized;
    if (changed) {
      learningAssistantState.loaded = false;
      learningAssistantState.prompts = [];
      learningAssistantState.review.initialized = false;
      learningAssistantState.review.records = [];
      learningAssistantState.review.categories = [];
      learningAssistantState.review.filters = {
        method: '',
        favoriteOnly: false,
        search: '',
        dueOnly: false,
      };
      learningAssistantState.reviewSession.active = null;
      learningAssistantState.reviewSession.backdrop = null;
      if (typeof renderLearningPrompts === 'function') {
        renderLearningPrompts();
      }
    }
    return changed;
  }

  function ensureLearningModal() {
    if (!learningAssistantState.modal) {
      const modalEl = document.getElementById('aiLearnModal');
      if (!modalEl) return null;
      learningAssistantState.modal = new bootstrap.Modal(modalEl);
    }
    return learningAssistantState.modal;
  }

  function ensureLearningPromptModal() {
    if (!learningAssistantState.promptModal) {
      const modalEl = document.getElementById('aiLearnPromptModal');
      if (!modalEl) return null;
      learningAssistantState.promptModal = new bootstrap.Modal(modalEl);
    }
    return learningAssistantState.promptModal;
  }

  function getLearningSelection() {
    const scriptEl = document.getElementById('page-script');
    if (scriptEl && document.activeElement === scriptEl && typeof scriptEl.selectionStart === 'number') {
      const start = typeof scriptEl.selectionStart === 'number' ? scriptEl.selectionStart : 0;
      const end = typeof scriptEl.selectionEnd === 'number' ? scriptEl.selectionEnd : start;
      if (end > start && scriptEl.value) {
        return scriptEl.value.slice(start, end).trim();
      }
    }
    let selected = '';
    if (singleEditor && typeof singleEditor.getSelection === 'function') {
      selected = singleEditor.getSelection();
    }
    if (!selected) {
      try {
        selected = window.getSelection ? (window.getSelection()?.toString() || '') : '';
      } catch (e) {
        selected = '';
      }
    }
    return (selected || '').trim();
  }

  const MAX_LEARNING_IMAGES = 4;
  const MAX_LEARNING_IMAGE_BYTES = 900 * 1024;

  function blobToDataUrl(blob) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  async function fetchImageDataUrl(src) {
    if (!src) {
      return {dataUrl: '', skipped: '无效图片地址'};
    }
    if (src.startsWith('data:')) {
      return {dataUrl: src, skipped: ''};
    }
    try {
      const res = await fetch(src);
      if (!res.ok) {
        return {dataUrl: '', skipped: `加载失败（${res.status}）`};
      }
      const blob = await res.blob();
      if (blob.size > MAX_LEARNING_IMAGE_BYTES) {
        const sizeKb = Math.round(blob.size / 1024);
        return {dataUrl: '', skipped: `过大：${sizeKb}KB`};
      }
      const dataUrl = await blobToDataUrl(blob);
      return {dataUrl: dataUrl || '', skipped: ''};
    } catch (err) {
      return {dataUrl: '', skipped: err?.message || '加载失败'};
    }
  }

  async function collectSelectionWithAssets(limit = MAX_LEARNING_IMAGES) {
    const selectionText = getLearningSelection();
    const result = {text: selectionText, images: [], skipped: 0};
    let fragments = [];
    try {
      const sel = window.getSelection ? window.getSelection() : null;
      if (sel && sel.rangeCount) {
        for (let i = 0; i < sel.rangeCount; i++) {
          const frag = sel.getRangeAt(i).cloneContents();
          fragments.push(frag);
        }
      }
    } catch (_) {
      fragments = [];
    }
    if (!fragments.length) return result;
    const seen = new Set();
    for (const frag of fragments) {
      const imgs = frag.querySelectorAll ? frag.querySelectorAll('img') : [];
      for (const img of imgs) {
        const rawSrc = (img.currentSrc || img.src || '').trim();
        if (!rawSrc || seen.has(rawSrc)) continue;
        seen.add(rawSrc);
        if (result.images.length >= limit) {
          result.skipped += 1;
          continue;
        }
        const alt = (img.getAttribute('alt') || img.getAttribute('title') || '').trim();
        const {dataUrl, skipped} = await fetchImageDataUrl(rawSrc);
        result.images.push({src: rawSrc, alt, dataUrl, note: skipped});
        if (skipped) {
          result.skipped += 1;
        }
      }
    }
    return result;
  }

  function snapshotLearningSelection() {
    // capture apply target before focus changes
    lastLearningApplyMeta = captureLearningApplyMeta();
    return collectSelectionWithAssets()
      .then(payload => {
        lastLearningSelectionSnapshot = payload;
        return payload;
      })
      .catch(err => {
        console.warn('快照选区失败', err);
        lastLearningSelectionSnapshot = null;
      });
  }

  function buildLearningContext() {
    const page = pagesData[currentPageIdx] || {};
    const chunks = [];
    if (page.content) chunks.push('LaTeX:\n' + page.content);
    if (page.notes) chunks.push('Markdown:\n' + page.notes);
    if (page.script) chunks.push('Script:\n' + page.script);
    const context = chunks.join('\n\n');
    return context.length > 3000 ? context.slice(0, 3000) + '\n\n…（上下文已截断）' : context;
  }

  function updateLearningContext(auto = false, showMessage = false) {
    const contextEl = document.getElementById('ai-learn-context');
    if (!contextEl) return;
    if (auto) return;
    const context = buildLearningContext();
    contextEl.value = context || '';
    if (!showMessage) return;
    if (context) {
      showStatus('已获取当前页上下文', 'info', 2200);
    } else {
      showStatus('当前页没有可用的上下文', 'warning', 2500);
    }
  }

  function normalizeTempPromptTemplate(raw) {
    const template = (raw || '').trim();
    if (!template) return '';
    const hasContent = template.includes('{content}');
    const hasContext = template.includes('{context}');
    if (hasContent && hasContext) return template;
    const suffix = [];
    if (!hasContent) suffix.push('学习内容：\n{content}');
    if (!hasContext) suffix.push('上下文：\n{context}');
    return [template, ...suffix].join('\n\n');
  }

  function ensureTempPromptDefault(force = false) {
    const textarea = document.getElementById('ai-learn-temp-prompt');
    if (!textarea) return;
    if (force || !textarea.value.trim()) {
      textarea.value = DEFAULT_TEMP_LEARN_TEMPLATE;
    }
  }

  function deriveTempPromptName(raw) {
    const cleaned = (raw || '').trim().replace(/\s+/g, ' ');
    if (!cleaned) return '临时提示词';
    if (cleaned.length > 36) return `${cleaned.slice(0, 36)}…`;
    return cleaned;
  }

  function toPlainPos(pos) {
    if (!pos || typeof pos.line !== 'number' || typeof pos.ch !== 'number') return null;
    return {line: pos.line, ch: pos.ch};
  }

  function captureLearningApplyMeta() {
    const page = pagesData[currentPageIdx] || {};
    const meta = {
      pageIdx: currentPageIdx,
      pageId: typeof page.pageId === 'string' ? page.pageId : '',
      mode: currentEditMode,
      project: currentProject || '',
      selection: null,
      cursor: null,
      plainSelection: null,
      target: 'editor',
    };
    const scriptEl = document.getElementById('page-script');
    if (scriptEl && document.activeElement === scriptEl && typeof scriptEl.selectionStart === 'number') {
      const start = typeof scriptEl.selectionStart === 'number' ? scriptEl.selectionStart : 0;
      const end = typeof scriptEl.selectionEnd === 'number' ? scriptEl.selectionEnd : start;
      meta.target = 'script';
      meta.plainSelection = {start, end};
      meta.cursor = {index: start};
      return meta;
    }
    if (!singleEditor || typeof singleEditor.getDoc !== 'function') {
      return meta;
    }
    const doc = singleEditor.getDoc();
    if (!doc) {
      return meta;
    }
    if (typeof doc.getCursor === 'function') {
      const cursor = toPlainPos(doc.getCursor());
      if (cursor) {
        meta.cursor = cursor;
      }
    }
    if (typeof doc.listSelections === 'function') {
      const selections = doc.listSelections();
      if (Array.isArray(selections) && selections.length) {
        const primary = selections[0];
        const anchorPos = toPlainPos(primary.anchor);
        const headPos = toPlainPos(primary.head);
        if (anchorPos && headPos) {
          const anchorIdx = doc.indexFromPos(anchorPos);
          const headIdx = doc.indexFromPos(headPos);
          if (anchorIdx !== headIdx) {
            const from = anchorIdx <= headIdx ? anchorPos : headPos;
            const to = anchorIdx <= headIdx ? headPos : anchorPos;
            meta.selection = {from, to};
          }
        }
      }
    }
    return meta;
  }

  function setLearningPrompts(prompts) {
    learningAssistantState.prompts = Array.isArray(prompts) ? prompts : [];
    renderLearningPrompts();
    refreshLearningMethodOptions();
    const activeProject = typeof currentProject === 'string' ? currentProject : '';
    if (activeProject || learningAssistantState.pendingProject) {
      learningAssistantState.project = activeProject || learningAssistantState.pendingProject || '';
    }
    learningAssistantState.loaded = true;
  }

  async function loadLearningPrompts(force = false) {
    const targetProject = typeof currentProject === 'string' ? currentProject : '';
    const cacheValid = learningAssistantState.loaded && learningAssistantState.project === targetProject;
    if (!force && cacheValid) {
      return;
    }
    if (learningAssistantState.loadingPrompts) {
      learningAssistantState.pendingProject = targetProject;
      return;
    }
    learningAssistantState.loadingPrompts = true;
    learningAssistantState.pendingProject = targetProject;
    let staleResult = false;
    try {
      const res = await fetch(appendWorkspaceQuery('/learn/config'));
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      const data = await res.json();
      if (!data || data.success === false || !Array.isArray(data.prompts)) {
        const message = data && data.error ? data.error : '未知错误';
        throw new Error(message);
      }
      const current = typeof currentProject === 'string' ? currentProject : '';
      if (learningAssistantState.pendingProject !== targetProject || targetProject !== current) {
        staleResult = true;
        return;
      }
      setLearningPrompts(data.prompts);
    } catch (err) {
      console.error('加载学习提示词失败:', err);
      showStatus('加载学习提示词失败：' + (err?.message || err || '未知错误'), 'danger', 6000);
    } finally {
      learningAssistantState.loadingPrompts = false;
      if (staleResult && learningAssistantState.pendingProject && learningAssistantState.pendingProject !== learningAssistantState.project) {
        loadLearningPrompts(true);
      }
    }
  }

  function renderLearningPrompts() {
    closeActionBubble('prompts-refresh');
    const defaultContainer = document.getElementById('ai-learn-default-prompts');
    const customContainer = document.getElementById('ai-learn-custom-prompts');
    if (defaultContainer) defaultContainer.innerHTML = '';
    if (customContainer) customContainer.innerHTML = '';
    const defaults = learningAssistantState.prompts.filter(item => item.source === 'default');
    const customs = learningAssistantState.prompts.filter(item => item.source === 'custom');
    if (defaultContainer) {
      if (!defaults.length) {
        defaultContainer.innerHTML = '<div class="text-muted small">暂无默认提示词。</div>';
      } else {
        defaults.forEach(prompt => {
          defaultContainer.appendChild(buildLearningPromptItem(prompt));
        });
      }
    }
    if (customContainer) {
      if (!customs.length) {
        customContainer.innerHTML = '<div class="text-muted small">尚未创建自定义提示词。</div>';
      } else {
        customs.forEach(prompt => {
          customContainer.appendChild(buildLearningPromptItem(prompt, true));
        });
      }
    }
  }

  function buildLearningPromptItem(prompt, stacked = false) {
    const card = document.createElement('div');
    card.className = 'learning-prompt-card';
    if (stacked) {
      card.classList.add('learning-prompt-card--stacked');
    }
    if (prompt && prompt.id) {
      card.dataset.promptId = prompt.id;
    }

    const titleEl = document.createElement('div');
    titleEl.className = 'learning-prompt-card__title';
    titleEl.textContent = prompt && (prompt.name || prompt.id) ? (prompt.name || prompt.id) : '未命名提示词';
    card.appendChild(titleEl);

    if (prompt && prompt.description) {
      const descEl = document.createElement('div');
      descEl.className = 'learning-prompt-card__description';
      descEl.textContent = prompt.description;
      card.appendChild(descEl);
    }

    const metaParts = [];
    if (prompt && prompt.source) {
      metaParts.push(prompt.source === 'custom' ? '自定义提示' : '默认提示');
    }
    if (prompt && prompt.id) {
      metaParts.push(`ID: ${prompt.id}`);
    }
    if (metaParts.length) {
      const metaEl = document.createElement('div');
      metaEl.className = 'learning-prompt-card__meta';
      metaEl.textContent = metaParts.join(' · ');
      card.appendChild(metaEl);
    }

    bindActionBubbleTrigger(card, () => {
      const actions = [];
      actions.push({
        label: '运行提示词',
        icon: '🚀',
        variant: 'primary',
        onClick: () => runLearningPrompt(prompt, null),
      });
      actions.push({
        label: '编辑',
        icon: '✏️',
        variant: 'outline-secondary',
        onClick: () => openPromptEditor(prompt),
      });
      actions.push({
        label: '删除',
        icon: '🗑️',
        variant: 'outline-danger',
        disabled: !prompt?.allowDelete,
        onClick: () => {
          if (!prompt?.allowDelete) return;
          deletePrompt(prompt);
        },
      });
      return actions;
    });

    return card;
  }

  async function openLearningModal() {
    const modal = ensureLearningModal();
    if (!modal) return;
    const contentEl = document.getElementById('ai-learn-content');
    let selectionPayload = lastLearningSelectionSnapshot;
    if (!selectionPayload) {
      selectionPayload = await collectSelectionWithAssets();
      lastLearningSelectionSnapshot = selectionPayload;
    }
    if (contentEl) {
      const selection = selectionPayload?.text || '';
      if (selection) {
        const parts = [selection];
        if (selectionPayload?.images?.length) {
          selectionPayload.images.forEach((img, idx) => {
            const alt = img.alt || `图片${idx + 1}`;
            if (img.dataUrl) {
              parts.push(`![${alt}](${img.dataUrl})`);
            } else if (img.src) {
              parts.push(`[${alt}](${img.src})${img.note ? `（${img.note}）` : ''}`);
            }
          });
        }
        contentEl.value = parts.join('\n\n');
      } else if (!contentEl.value.trim()) {
        contentEl.value = '';
      }
    }
    ensureTempPromptDefault(false);
    updateLearningContext(true);
    modal.show();
    loadLearningPrompts(false);
  }

  function runTempLearningPrompt(triggerBtn) {
    const textarea = document.getElementById('ai-learn-temp-prompt');
    if (!textarea) return;
    const rawTemplate = textarea.value.trim();
    if (!rawTemplate) {
      alert('请先填写临时提示词');
      textarea.focus();
      return;
    }
    const normalizedTemplate = normalizeTempPromptTemplate(rawTemplate);
    const tempName = deriveTempPromptName(rawTemplate);
    runLearningPrompt(
      {id: '__temp__', name: tempName},
      triggerBtn,
      {tempTemplate: normalizedTemplate, tempName}
    );
  }

  async function runLearningPrompt(prompt, triggerBtn, options = {}) {
    const contentEl = document.getElementById('ai-learn-content');
    if (!contentEl) return;
    const baseContent = contentEl.value.trim();
    if (!baseContent) {
      alert('请输入或选择需要学习的内容');
      return;
    }
    const contextEl = document.getElementById('ai-learn-context');
    const baseContext = contextEl ? contextEl.value.trim() : '';
    const tempTemplate = options.tempTemplate || '';
    const tempName = options.tempName || '';
    const tempSystem = options.tempSystem || '';
    const promptId = prompt && prompt.id ? prompt.id : '__temp__';
    const promptName = prompt && prompt.name ? prompt.name : (tempName || '临时提示词');
    let applyMeta = captureLearningApplyMeta();
    if (applyMeta && applyMeta.target === 'editor' && lastLearningApplyMeta && lastLearningApplyMeta.target) {
      // 如果点击按钮前已捕获选区，但此时焦点丢失，则回落到上次快照
      applyMeta = lastLearningApplyMeta;
    }

    const modal = ensureLearningModal();
    if (modal) {
      modal.hide();
    }

    let buttonLabel = '';
    if (triggerBtn) {
      buttonLabel = triggerBtn.textContent;
      triggerBtn.disabled = true;
      triggerBtn.textContent = '学习中...';
    }

    try {
      const payload = withWorkspacePayload(withLlmConfig({
        content: baseContent,
        context: baseContext,
        promptId,
        promptName,
        tempPromptTemplate: tempTemplate,
        tempPromptName: tempName || promptName,
        tempSystemPrompt: tempSystem,
      }));
      const res = await fetch(appendWorkspaceQuery('/learn/query'), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const text = (await res.text()) || `HTTP ${res.status}`;
        throw new Error(text);
      }
      const data = await res.json();
      if (!data || data.success === false) {
        throw new Error((data && data.error) || 'AI 学习失败');
      }
      const resultText = data.result || '';
      enqueueLearningResult({
        promptId: data.promptId || promptId,
        promptName: data.promptName || promptName,
        content: baseContent,
        context: baseContext,
        result: resultText,
        applyMeta,
        project: typeof currentProject === 'string' ? currentProject : '',
        createdAt: Date.now(),
      });
      showStatus('AI 学习完成', 'success', 2400);
    } catch (err) {
      console.error('AI 学习失败:', err);
      showStatus('AI 学习失败：' + (err?.message || err || '未知错误'), 'danger', 6000);
    } finally {
      if (triggerBtn) {
        triggerBtn.disabled = false;
        triggerBtn.textContent = buttonLabel || (prompt ? prompt.name : '临时提示词');
      }
    }
  }

  function ensureLearningResultModal() {
    if (!learningAssistantState.resultModal) {
      const modalEl = document.getElementById('aiLearnResultModal');
      if (!modalEl) return null;
      learningAssistantState.resultModal = new bootstrap.Modal(modalEl);
      modalEl.addEventListener('hidden.bs.modal', () => {
        learningAssistantState.activeResult = null;
        drainLearningResultQueue();
      });
    }
    return learningAssistantState.resultModal;
  }

  function ensureLearningReviewModal() {
    if (!learningAssistantState.reviewModal) {
      const modalEl = document.getElementById('aiLearnReviewModal');
      if (!modalEl) return null;
      learningAssistantState.reviewModal = new bootstrap.Modal(modalEl);
    }
    return learningAssistantState.reviewModal;
  }

  function clearReviewSessionBackdrop() {
    if (learningAssistantState.reviewSession.backdrop) {
      learningAssistantState.reviewSession.backdrop.classList.remove('review-session-backdrop');
      learningAssistantState.reviewSession.backdrop = null;
    }
    document.querySelectorAll('.modal-backdrop.review-session-backdrop').forEach(el => {
      el.classList.remove('review-session-backdrop');
    });
  }

  function ensureLearningReviewSessionModal() {
    if (!learningAssistantState.reviewSession.modal) {
      const modalEl = document.getElementById('aiLearnReviewSessionModal');
      if (!modalEl) return null;
      learningAssistantState.reviewSession.modal = new bootstrap.Modal(modalEl);
      modalEl.addEventListener('hidden.bs.modal', () => {
        learningAssistantState.reviewSession.active = null;
        learningAssistantState.reviewSession.locked = false;
        clearReviewSessionBackdrop();
        toggleReviewButtons(false);
        const sessionBadge = document.getElementById('ai-review-session-status');
        if (sessionBadge) {
          sessionBadge.classList.add('d-none');
          sessionBadge.textContent = '';
        }
        const reviewModal = ensureLearningReviewModal();
        if (reviewModal) {
          reviewModal.show();
        }
      });
      modalEl.addEventListener('shown.bs.modal', () => {
        clearReviewSessionBackdrop();
        const backdrops = document.querySelectorAll('.modal-backdrop');
        const activeBackdrop = backdrops[backdrops.length - 1];
        if (activeBackdrop) {
          activeBackdrop.classList.add('review-session-backdrop');
          learningAssistantState.reviewSession.backdrop = activeBackdrop;
        }
      });
    }
    return learningAssistantState.reviewSession.modal;
  }

  function enqueueLearningResult(payload) {
    if (!payload) return;
    const entry = Object.assign({}, payload);
    entry.applyMeta = payload.applyMeta || {
      project: typeof currentProject === 'string' ? currentProject : '',
      mode: currentEditMode,
      pageIdx: currentPageIdx,
      pageId: pagesData[currentPageIdx]?.pageId || '',
      selection: null,
      cursor: null,
      plainSelection: null,
      target: 'editor',
    };
    if (!entry.method || !entry.method.trim()) {
      entry.method = entry.promptName || '';
    }
    learningAssistantState.resultQueue.push(entry);
    drainLearningResultQueue();
  }

  function drainLearningResultQueue() {
    if (learningAssistantState.activeResult) return;
    if (!learningAssistantState.resultQueue.length) return;
    const next = learningAssistantState.resultQueue.shift();
    showLearningResultModal(next);
  }

  function showLearningResultModal(payload) {
    const modal = ensureLearningResultModal();
    if (!modal) return;
    const resolvedMethod = (payload.method && payload.method.trim()) || (payload.promptName || '');
    learningAssistantState.activeResult = Object.assign(
      {
        recordId: payload.recordId || null,
        project: payload.project || (typeof currentProject === 'string' ? currentProject : ''),
        createdAt: payload.createdAt || Date.now(),
      },
      payload,
      {method: resolvedMethod}
    );
    const textarea = document.getElementById('ai-learn-result-text');
    if (textarea) {
      textarea.value = payload.result || payload.output || '';
    }
    const methodInput = document.getElementById('ai-learn-result-method');
    if (methodInput) {
      methodInput.value = resolvedMethod;
    }
    const categoryInput = document.getElementById('ai-learn-result-category');
    if (categoryInput) {
      categoryInput.value = payload.category || '';
    }
    const favoriteInput = document.getElementById('ai-learn-result-favorite');
    if (favoriteInput) {
      favoriteInput.checked = !!payload.favorite;
    }
    refreshLearningCategoryOptions();
    const metaEl = document.getElementById('ai-learn-result-meta');
    if (metaEl) {
      const savedAt = payload.savedAt ? new Date(payload.savedAt * 1000) : null;
      const createdAt = new Date(payload.createdAt || Date.now());
      const timestamp = savedAt || createdAt;
      const pieces = [];
      if (payload.promptName) pieces.push(`提示词：${payload.promptName}`);
      if (timestamp) pieces.push(timestamp.toLocaleString());
      if (payload.category) pieces.push(`分类：${payload.category}`);
      metaEl.textContent = pieces.join(' · ') || 'AI 学习结果';
    }
    modal.show();
  }

  function ensureAssistantModal() {
    if (!aiAssistantState.modal) {
      const modalEl = document.getElementById('aiAssistantModal');
      if (!modalEl) return null;
      aiAssistantState.modal = new bootstrap.Modal(modalEl);
      modalEl.addEventListener('shown.bs.modal', () => {
        aiAssistantState.modalVisible = true;
        aiAssistantState.autoShowOnFinish = false;
      });
      modalEl.addEventListener('hidden.bs.modal', () => {
        aiAssistantState.modalVisible = false;
        aiAssistantState.autoShowOnFinish = aiAssistantState.running;
      });
    }
    return aiAssistantState.modal;
  }

  function setAssistantStatus(text, variant = 'muted') {
    const statusEl = document.getElementById('ai-assistant-status');
    if (!statusEl) return;
    statusEl.textContent = text || '';
    statusEl.className = `small ai-assistant-status ai-assistant-status--${variant}`;
  }

  function setAssistantMeta(meta = {}) {
    const metaEl = document.getElementById('ai-assistant-meta');
    if (!metaEl) return;
    const parts = [];
    if (meta.llmModel) parts.push(`LLM: ${meta.llmModel}`);
    if (meta.embeddingModel) parts.push(`Embedding: ${meta.embeddingModel}`);
    const ragScope = meta.ragScope || (meta.ragUsed ? 'all' : 'off');
    if (ragScope === 'page') {
      parts.push('RAG: 当前页');
    } else {
      parts.push(ragScope === 'off' ? 'RAG: OFF' : 'RAG: ON');
    }
    metaEl.textContent = parts.join(' · ');
  }

  function setAssistantAnswer(text) {
    const answerEl = document.getElementById('ai-assistant-answer');
    if (answerEl) {
      answerEl.value = text || '';
    }
  }

  function getAssistantAnswerText() {
    const answerEl = document.getElementById('ai-assistant-answer');
    return answerEl ? (answerEl.value || '') : '';
  }

  function syncAssistantRagScope() {
    const useRagEl = document.getElementById('ai-assistant-use-rag');
    const pageOnlyEl = document.getElementById('ai-assistant-page-only');
    const useRag = useRagEl ? !!useRagEl.checked : false;
    const pageOnly = useRag && pageOnlyEl ? !!pageOnlyEl.checked : false;
    if (pageOnlyEl) {
      pageOnlyEl.disabled = !useRag;
      if (!useRag) {
        pageOnlyEl.checked = false;
      }
    }
    const statusLabel = useRag ? (pageOnly ? '仅检索当前页 Markdown' : '将优先使用 Markdown RAG') : '已关闭 RAG，直接对话';
    setAssistantStatus(statusLabel, useRag ? 'info' : 'warning');
    const ragScope = useRag ? (pageOnly ? 'page' : 'all') : 'off';
    const scopeForMeta = aiAssistantState.ragScope || ragScope;
    setAssistantMeta({
      ragUsed: scopeForMeta !== 'off',
      llmModel: aiAssistantState.lastModel,
      embeddingModel: aiAssistantState.lastEmbedding,
      ragScope: scopeForMeta,
    });
  }

  function buildAssistantContextCard(ctx) {
    const card = document.createElement('div');
    card.className = 'ai-assistant-context';
    const title = document.createElement('div');
    title.className = 'ai-assistant-context__title';
    const rankLabel = ctx.rank ? `[#${ctx.rank}] ` : '';
    title.textContent = `${rankLabel}${ctx.label || '上下文片段'}`;
    const meta = document.createElement('div');
    meta.className = 'ai-assistant-context__meta';
    const metaParts = [];
    if (typeof ctx.pageIdx === 'number') metaParts.push(`页 ${ctx.pageIdx + 1}`);
    if (typeof ctx.score === 'number') metaParts.push(`距离 ${ctx.score.toFixed(3)}`);
    meta.textContent = metaParts.join(' · ') || 'Markdown 片段';
    const body = document.createElement('div');
    body.textContent = ctx.text || '';
    card.appendChild(title);
    card.appendChild(meta);
    card.appendChild(body);
    return card;
  }

  function renderAssistantContexts(contexts, notice = '') {
    const container = document.getElementById('ai-assistant-contexts');
    const countEl = document.getElementById('ai-assistant-context-count');
    const safeContexts = Array.isArray(contexts) ? contexts : [];
    if (countEl) countEl.textContent = safeContexts.length;
    if (!container) return;
    container.innerHTML = '';
    if (!safeContexts.length) {
      if (notice) {
        const hint = document.createElement('div');
        hint.className = 'text-muted small';
        hint.textContent = notice;
        container.appendChild(hint);
      }
      return;
    }
    const visible = safeContexts.slice(0, 3);
    const hidden = safeContexts.slice(3);
    visible.forEach(ctx => container.appendChild(buildAssistantContextCard(ctx)));
    if (hidden.length) {
      const toggle = document.createElement('button');
      toggle.type = 'button';
      toggle.className = 'btn btn-link btn-sm ai-assistant-context-toggle px-0';
      toggle.textContent = `展开剩余 ${hidden.length} 条上下文`;
      const hiddenBox = document.createElement('div');
      hiddenBox.className = 'ai-assistant-contexts-collapsed d-none';
      hidden.forEach(ctx => hiddenBox.appendChild(buildAssistantContextCard(ctx)));
      toggle.addEventListener('click', () => {
        const collapsed = hiddenBox.classList.contains('d-none');
        hiddenBox.classList.toggle('d-none');
        toggle.textContent = collapsed ? '收起额外上下文' : `展开剩余 ${hidden.length} 条上下文`;
      });
      container.appendChild(toggle);
      container.appendChild(hiddenBox);
    }
    if (notice) {
      const hint = document.createElement('div');
      hint.className = 'text-muted small mt-1';
      hint.textContent = notice;
      container.appendChild(hint);
    }
  }

  function openAssistantModal() {
    const modal = ensureAssistantModal();
    if (!modal) return;
    const messageEl = document.getElementById('ai-assistant-message');
    const isRunning = aiAssistantState.running;
    if (messageEl && !messageEl.value.trim() && !isRunning) {
      const selection = getLearningSelection();
      if (selection) {
        messageEl.value = selection;
      }
    }
    if (!isRunning) {
      aiAssistantState.ragUsed = false;
      aiAssistantState.ragNotice = '';
      aiAssistantState.contexts = [];
      aiAssistantState.lastModel = '';
      aiAssistantState.lastEmbedding = '';
      aiAssistantState.ragScope = '';
      setAssistantStatus('准备就绪', 'muted');
      renderAssistantContexts([], '开启 RAG 可从 Markdown 中检索上下文。');
      setAssistantAnswer('');
      syncAssistantRagScope();
    } else {
      setAssistantStatus('处理中，请稍候...', 'secondary');
    }
    aiAssistantState.autoShowOnFinish = true;
    modal.show();
  }

  async function runAssistant(triggerBtn) {
    if (aiAssistantState.running) return;
    const messageEl = document.getElementById('ai-assistant-message');
    const useRagEl = document.getElementById('ai-assistant-use-rag');
    const pageOnlyEl = document.getElementById('ai-assistant-page-only');
    if (!messageEl) return;
    const content = (messageEl.value || '').trim();
    if (!content) {
      alert('请先输入问题或内容');
      return;
    }
    aiAssistantState.running = true;
    aiAssistantState.autoShowOnFinish = true;
    const useRag = useRagEl ? !!useRagEl.checked : true;
    const pageOnly = useRag && pageOnlyEl ? !!pageOnlyEl.checked : false;
    const currentPage = pagesData[currentPageIdx] || {};
    const pageId = typeof currentPage.pageId === 'string' ? currentPage.pageId : '';
    const statusText = useRag
      ? (pageOnly ? '仅检索当前页 Markdown 中...' : '检索工作区 Markdown 中...')
      : '已关闭 RAG，直接对话';
    setAssistantStatus(statusText, useRag ? 'info' : 'warning');
    if (triggerBtn) {
      triggerBtn.disabled = true;
      triggerBtn.dataset.originalLabel = triggerBtn.dataset.originalLabel || triggerBtn.textContent || '发送';
      triggerBtn.textContent = '处理中...';
    }
    try {
      const payloadBody = {
        message: content,
        useRag,
        ragPageOnly: pageOnly,
        currentPageOnly: pageOnly,
        pageId,
      };
      if (typeof currentPageIdx === 'number') {
        payloadBody.pageIdx = currentPageIdx;
        payloadBody.pageIndex = currentPageIdx;
      }
      const payload = withWorkspacePayload(withLlmConfig(payloadBody));
      const res = await fetch(appendWorkspaceQuery('/assistant/query'), {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const text = (await res.text()) || `HTTP ${res.status}`;
        throw new Error(text);
      }
      const data = await res.json();
      if (!data || data.success === false) {
        throw new Error((data && data.error) || 'AI 助理请求失败');
      }
      setAssistantAnswer(data.result || '');
      renderAssistantContexts(data.contexts || [], data.ragNotice || '');
      const ragScope = data.ragScope || (useRag ? (pageOnly ? 'page' : 'all') : 'off');
      const ragUsed = !!data.ragUsed;
      const statusLabel = data.ragNotice
        ? data.ragNotice
        : (ragUsed
          ? (ragScope === 'page' ? '已使用当前页 Markdown 上下文' : '已使用 RAG 命中工作区 Markdown')
          : (useRag ? '未命中 RAG，上下文为空' : '未使用 RAG'));
      const statusVariant = ragUsed ? 'success' : (data.ragNotice ? 'warning' : (useRag ? 'secondary' : 'muted'));
      setAssistantStatus(statusLabel, statusVariant);
      setAssistantMeta({
        llmModel: data.llmModel,
        embeddingModel: data.embeddingModel,
        ragUsed,
        ragScope,
      });
      aiAssistantState.ragUsed = ragUsed;
      aiAssistantState.ragNotice = data.ragNotice || '';
      aiAssistantState.contexts = data.contexts || [];
      aiAssistantState.lastModel = data.llmModel || '';
      aiAssistantState.lastEmbedding = data.embeddingModel || '';
      aiAssistantState.ragScope = ragScope;
    } catch (err) {
      console.error('AI 助理失败:', err);
      showStatus('AI 助理失败：' + (err?.message || err || '未知错误'), 'danger', 6000);
      setAssistantStatus(err?.message || '请求失败', 'danger');
    } finally {
      const shouldReveal = aiAssistantState.autoShowOnFinish && !aiAssistantState.modalVisible;
      if (shouldReveal) {
        const modal = ensureAssistantModal();
        if (modal) {
          modal.show();
        }
      }
      aiAssistantState.autoShowOnFinish = false;
      aiAssistantState.running = false;
      if (triggerBtn) {
        triggerBtn.disabled = false;
        triggerBtn.textContent = triggerBtn.dataset.originalLabel || '发送';
      }
    }
  }

  function copyAssistantAnswer() {
    const text = getAssistantAnswerText();
    if (!text.trim()) {
      showStatus('没有可复制的内容', 'warning', 2000);
      return;
    }
    navigator.clipboard.writeText(text).then(() => {
      showStatus('已复制 AI 助理回复', 'success', 2200);
    }).catch(err => {
      console.error('复制失败', err);
      showStatus('复制失败，请手动复制', 'warning', 2400);
    });
  }

  function summarizeAssistantContextsForReview(contexts, limit = 6) {
    const list = Array.isArray(contexts) ? contexts.slice(0, limit) : [];
    if (!list.length) return '';
    return list.map(ctx => {
      const metaParts = [];
      if (typeof ctx.pageIdx === 'number') metaParts.push(`页 ${ctx.pageIdx + 1}`);
      if (ctx.label) metaParts.push(ctx.label);
      const meta = metaParts.length ? `[${metaParts.join(' · ')}]` : '';
      const score = typeof ctx.score === 'number' ? ` (距离 ${ctx.score.toFixed(3)})` : '';
      const body = (ctx.text || '').trim();
      return `${meta}${score}\n${body}`;
    }).join('\n\n');
  }

  function pushAssistantToReview() {
    const question = (document.getElementById('ai-assistant-message')?.value || '').trim();
    const answer = getAssistantAnswerText().trim();
    if (!question) {
      alert('请先填写问题');
      return;
    }
    if (!answer) {
      alert('请先填写或编辑答案后再保存');
      return;
    }
    const useRagEl = document.getElementById('ai-assistant-use-rag');
    const pageOnlyEl = document.getElementById('ai-assistant-page-only');
    const requestedScope = useRagEl && useRagEl.checked ? (pageOnlyEl && pageOnlyEl.checked ? 'page' : 'all') : 'off';
    const scopeForRecord = aiAssistantState.ragScope || requestedScope;
    const contextText = summarizeAssistantContextsForReview(aiAssistantState.contexts || [], 6);
    const noticeText = aiAssistantState.ragNotice ? `提示：${aiAssistantState.ragNotice}` : '';
    const combinedContext = [contextText, noticeText].filter(Boolean).join('\n\n');
    const scopeLabel = scopeForRecord === 'page'
      ? 'AI 助理（当前页）'
      : (scopeForRecord === 'all' || aiAssistantState.ragUsed ? 'AI 助理（RAG）' : 'AI 助理');
    enqueueLearningResult({
      promptId: '__assistant__',
      promptName: scopeLabel,
      content: question,
      context: combinedContext,
      result: answer,
      method: scopeLabel,
      category: 'AI助理',
      applyMeta: captureLearningApplyMeta(),
    });
    const assistantModal = ensureAssistantModal();
    if (assistantModal) {
      assistantModal.hide();
    }
    showStatus('已将当前问答推送到 AI 复习面板，可继续编辑后保存', 'success', 2200);
    openLearningReviewModal();
  }

  function gatherLearningResultFormValues() {
    const textarea = document.getElementById('ai-learn-result-text');
    const methodInput = document.getElementById('ai-learn-result-method');
    const categoryInput = document.getElementById('ai-learn-result-category');
    const favoriteInput = document.getElementById('ai-learn-result-favorite');
    const promptFallback = (learningAssistantState.activeResult && learningAssistantState.activeResult.promptName) || '';
    const methodRaw = methodInput ? methodInput.value.trim() : '';
    return {
      output: textarea ? textarea.value.trim() : '',
      method: methodRaw || promptFallback,
      category: categoryInput ? categoryInput.value.trim() : '',
      favorite: favoriteInput ? !!favoriteInput.checked : false,
    };
  }

  function copyActiveLearningResult() {
    const textarea = document.getElementById('ai-learn-result-text');
    if (!textarea || !textarea.value.trim()) {
      alert('没有可复制的学习结果');
      return;
    }
    navigator.clipboard.writeText(textarea.value).then(() => {
      showStatus('已复制学习结果', 'success', 2500);
    }).catch(err => {
      console.warn('复制失败', err);
      alert('复制失败，请手动复制。');
    });
  }

  function applyLearningResultText(text, meta = {}) {
    const content = (text || '').trim();
    if (!content) {
      alert('学习结果为空，无法替换');
      return;
    }
    const target = typeof meta.target === 'string' ? meta.target : 'editor';
    const targetProject = typeof meta.project === 'string' ? meta.project : '';
    if (targetProject && currentProject && targetProject !== currentProject) {
      showStatus('当前项目已变更，请切换至生成该结果的项目后再试。', 'warning', 3200);
      return;
    }
    const targetMode = typeof meta.mode === 'string' ? meta.mode : '';
    if (target === 'editor' && targetMode && targetMode !== currentEditMode) {
      const modeLabel = targetMode === 'markdown' ? 'Markdown' : 'LaTeX';
      showStatus(`请先切换到 ${modeLabel} 编辑模式后再执行一键替换。`, 'warning', 3200);
      return;
    }
    const pageId = typeof meta.pageId === 'string' ? meta.pageId : '';
    const pageIdx = typeof meta.pageIdx === 'number' ? meta.pageIdx : null;
    const currentPage = pagesData[currentPageIdx] || {};
    const currentPageId = typeof currentPage.pageId === 'string' ? currentPage.pageId : '';
    if (pageId && currentPageId && currentPageId !== pageId) {
      showStatus('请切换到生成该结果的页面后再执行一键替换。', 'warning', 3200);
      return;
    }
    if (pageIdx !== null && pageIdx !== currentPageIdx) {
      showStatus('请切换到生成该结果的页面后再执行一键替换。', 'warning', 3200);
      return;
    }
    if (target === 'script') {
      const scriptEl = document.getElementById('page-script');
      if (!scriptEl) {
        alert('未找到讲稿编辑区，无法替换');
        return;
      }
      const value = scriptEl.value || '';
      const selection = meta.plainSelection || meta.selection || {};
      const startRaw = typeof selection.start === 'number' ? selection.start : (typeof selection.from === 'number' ? selection.from : (typeof selection.index === 'number' ? selection.index : 0));
      const endRaw = typeof selection.end === 'number' ? selection.end : (typeof selection.to === 'number' ? selection.to : startRaw);
      const safeStart = Math.max(0, Math.min(startRaw, value.length));
      const safeEnd = Math.max(safeStart, Math.min(endRaw, value.length));
      const nextValue = value.slice(0, safeStart) + content + value.slice(safeEnd);
      scriptEl.value = nextValue;
      if (pagesData[currentPageIdx]) {
        pagesData[currentPageIdx].script = nextValue;
      }
      const selectionEnd = safeStart + content.length;
      if (typeof scriptEl.setSelectionRange === 'function') {
        scriptEl.setSelectionRange(safeStart, selectionEnd);
        scriptEl.focus();
      }
      saveProject();
      queueCompile();
      showStatus('已将学习结果写入讲稿', 'success', 2600);
      return;
    }
    if (!singleEditor || typeof singleEditor.getDoc !== 'function') {
      alert('当前编辑器不可用，无法替换内容');
      return;
    }
    const doc = singleEditor.getDoc();
    if (!doc) {
      alert('无法访问编辑器，替换失败');
      return;
    }
    const resolvePos = (pos) => {
      const plain = toPlainPos(pos);
      if (!plain) return null;
      return {line: plain.line, ch: plain.ch};
    };
    const selection = meta.selection || null;
    const cursor = meta.cursor || null;
    let from = selection && selection.from ? resolvePos(selection.from) : null;
    let to = selection && selection.to ? resolvePos(selection.to) : null;
    if (!from || !to) {
      const fallback = resolvePos(cursor) || resolvePos(doc.getCursor());
      from = fallback;
      to = fallback;
    }
    if (!from) {
      from = resolvePos(doc.getCursor());
      to = from;
    }
    if (!from || !to) {
      alert('未能确定替换位置，请手动粘贴结果。');
      return;
    }
    const startIndex = doc.indexFromPos(from);
    const endIndex = doc.indexFromPos(to);
    let start = from;
    let end = to;
    if (endIndex < startIndex) {
      start = to;
      end = from;
    }
    const startIdx = doc.indexFromPos(start);
    doc.replaceRange(content, start, end);
    const endPos = doc.posFromIndex(startIdx + content.length);
    doc.setSelection(start, endPos);
    if (typeof singleEditor.focus === 'function') {
      singleEditor.focus();
    }
    if (typeof singleEditor.scrollIntoView === 'function') {
      singleEditor.scrollIntoView({from: start, to: endPos});
    }
    showStatus('已将学习结果替换到编辑器', 'success', 2600);
  }

  function applyActiveLearningResult() {
    const state = learningAssistantState.activeResult;
    if (!state) {
      alert('当前没有待应用的学习结果');
      return;
    }
    const textarea = document.getElementById('ai-learn-result-text');
    const text = textarea ? textarea.value : '';
    applyLearningResultText(text, state.applyMeta || {});
  }

  async function saveActiveLearningResult(button) {
    const state = learningAssistantState.activeResult;
    if (!state) {
      alert('当前没有学习结果可保存');
      return;
    }
    const {output, method, category, favorite} = gatherLearningResultFormValues();
    if (!output) {
      alert('请先填写要保存的学习结果文本');
      return;
    }
    if (button) {
      button.disabled = true;
      button.textContent = state.recordId ? '更新中...' : '保存中...';
    }
    try {
      if (state.recordId) {
        const body = withWorkspacePayload({
          method,
          category,
          favorite,
          output,
        });
        const res = await fetch(appendWorkspaceQuery(`/learn/records/${encodeURIComponent(state.recordId)}`), {
          method: 'PATCH',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          const text = (await res.text()) || `HTTP ${res.status}`;
          throw new Error(text);
        }
        const data = await res.json();
        if (data && data.success === false) {
          throw new Error(data.error || '更新失败');
        }
      } else {
        const payload = withWorkspacePayload({
          content: state.content || '',
          context: state.context || '',
          promptId: state.promptId || '',
          promptName: state.promptName || '',
          output,
          method,
          category,
          favorite,
        });
        const res = await fetch(appendWorkspaceQuery('/learn/record'), {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        if (!res.ok) {
          const text = (await res.text()) || `HTTP ${res.status}`;
          throw new Error(text);
        }
        const data = await res.json();
        if (data && data.success === false) {
          throw new Error(data.error || '保存失败');
        }
        if (data.recordId) {
          state.recordId = data.recordId;
        }
      }
      showStatus(state.recordId ? '学习记录已更新' : '学习记录已保存', 'success', 2600);
      learningAssistantState.review.initialized = false;
      loadLearningReviewData(true);
    } catch (err) {
      console.error('保存学习记录失败:', err);
      showStatus('保存学习记录失败：' + (err?.message || err || '未知错误'), 'danger', 6000);
    } finally {
      if (button) {
        button.disabled = false;
        button.textContent = '保存记录';
      }
    }
  }

  function openLearningReviewModal() {
    const modal = ensureLearningReviewModal();
    if (!modal) return;
    modal.show();
    loadLearningPrompts(false).then(() => {
      refreshLearningMethodOptions();
      renderLearningReviewList();
    });
    loadLearningReviewData(!learningAssistantState.review.initialized);
  }

  function refreshLearningCategoryOptions() {
    const categories = learningAssistantState.review.categories || [];
    const datalist = document.getElementById('ai-learn-category-options');
    if (datalist) {
      datalist.innerHTML = '';
      categories.forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        datalist.appendChild(option);
      });
    }
  }

  function getKnownPromptIds() {
    const prompts = Array.isArray(learningAssistantState.prompts) ? learningAssistantState.prompts : [];
    const ids = new Set();
    prompts.forEach(prompt => {
      if (prompt && !prompt.removed && prompt.id) {
        ids.add(String(prompt.id));
      }
    });
    return ids;
  }

  function isTempReviewRecord(record, knownPromptIds = null) {
    if (!record) return false;
    const promptId = (record.promptId || '').trim();
    if (!promptId || promptId === '__temp__') {
      return true;
    }
    const ids = knownPromptIds || getKnownPromptIds();
    if (!ids || !ids.size) return false;
    return !ids.has(promptId);
  }

  function refreshLearningMethodOptions() {
    const select = document.getElementById('ai-learn-review-method');
    if (!select) return;
    const prompts = Array.isArray(learningAssistantState.prompts) ? learningAssistantState.prompts : [];
    const records = Array.isArray(learningAssistantState.review.records) ? learningAssistantState.review.records : [];
    const knownPromptIds = getKnownPromptIds();
    const seen = new Set();
    const current = learningAssistantState.review.filters.method || select.value || '';
    select.innerHTML = '';

    const appendOption = (value, label, parent) => {
      if (seen.has(value)) return;
      const option = document.createElement('option');
      option.value = value;
      option.textContent = label;
      seen.add(value);
      (parent || select).appendChild(option);
    };

    appendOption('', '全部方法');

    const appendGroup = (label, items) => {
      if (!items.length) return;
      const group = document.createElement('optgroup');
      group.label = label;
      items.forEach(prompt => {
        if (!prompt || !prompt.id) return;
        const value = `p:${prompt.id}`;
        appendOption(value, prompt.name || prompt.id, group);
      });
      if (group.children.length) {
        select.appendChild(group);
      }
    };

    const defaults = prompts.filter(p => p && p.source === 'default' && !p.removed);
    const customs = prompts.filter(p => p && p.source === 'custom' && !p.removed);
    appendGroup('默认提示词', defaults);
    appendGroup('自定义提示词', customs);

    const otherMethods = new Set();
    records.forEach(rec => {
      const promptId = (rec.promptId || '').trim();
      const method = (rec.method || '').trim();
      const promptName = (rec.promptName || '').trim();
      if (isTempReviewRecord(rec, knownPromptIds)) {
        return;
      }
      if (promptId && knownPromptIds.has(promptId)) {
        return;
      }
      if (method || promptName) {
        otherMethods.add(method || promptName);
      }
    });

    if (otherMethods.size) {
      const group = document.createElement('optgroup');
      group.label = '其他方法';
      otherMethods.forEach(name => {
        const value = `m:${encodeURIComponent(name)}`;
        appendOption(value, name, group);
      });
      if (group.children.length) {
        select.appendChild(group);
      }
    }

    appendOption('temp', '临时提示词');

    if (seen.has(current)) {
      select.value = current;
    } else {
      select.value = '';
      learningAssistantState.review.filters.method = '';
    }
  }

  function recordMatchesMethodFilter(record, filterValue, knownPromptIds = null) {
    const key = (filterValue || '').trim();
    if (!key) return true;
    const promptId = (record.promptId || '').trim();
    const method = (record.method || '').trim();
    const promptName = (record.promptName || '').trim();
    const ids = knownPromptIds || getKnownPromptIds();
    if (key === 'temp') {
      return isTempReviewRecord(record, ids);
    }
    if (key.startsWith('p:')) {
      const targetId = key.slice(2);
      return promptId === targetId;
    }
    if (key.startsWith('m:')) {
      const target = decodeURIComponent(key.slice(2)).toLowerCase();
      return (
        (method && method.toLowerCase() === target) ||
        (!method && promptName && promptName.toLowerCase() === target)
      );
    }
    return false;
  }

  async function loadLearningReviewData(force = false) {
    const state = learningAssistantState.review;
    if (state.loading) return;
    if (!force && state.initialized) {
      renderLearningReviewList();
      return;
    }
    state.loading = true;
    const params = new URLSearchParams();
    if (state.filters.favoriteOnly) {
      params.set('favorite', 'true');
    }
    if (state.filters.search) {
      params.set('q', state.filters.search);
    }
    try {
      const url = appendWorkspaceQuery(`/learn/records${params.toString() ? `?${params.toString()}` : ''}`);
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      const data = await res.json();
      if (!data || data.success === false) {
        throw new Error((data && data.error) || '加载失败');
      }
      state.records = Array.isArray(data.records) ? data.records : [];
      state.categories = Array.isArray(data.categories) ? data.categories : [];
      state.initialized = true;
      refreshLearningCategoryOptions();
      refreshLearningMethodOptions();
      renderLearningReviewList();
    } catch (err) {
      console.error('加载学习记录失败:', err);
      showStatus('加载学习记录失败：' + (err?.message || err || '未知错误'), 'danger', 6000);
    } finally {
      state.loading = false;
    }
  }

  function normalizeReviewState(raw) {
    const state = Object.assign({}, REVIEW_DEFAULT_STATE);
    if (raw && typeof raw === 'object') {
      if (typeof raw.ease === 'number' && isFinite(raw.ease)) state.ease = raw.ease;
      if (typeof raw.interval === 'number' && isFinite(raw.interval)) state.interval = raw.interval;
      if (typeof raw.streak === 'number' && isFinite(raw.streak)) state.streak = raw.streak;
      if (typeof raw.lapses === 'number' && isFinite(raw.lapses)) state.lapses = raw.lapses;
      if (typeof raw.lastRating === 'string') state.lastRating = raw.lastRating;
      if (typeof raw.lastReviewAt === 'number' && isFinite(raw.lastReviewAt)) state.lastReviewAt = raw.lastReviewAt;
      if (typeof raw.nextReviewAt === 'number' && isFinite(raw.nextReviewAt)) state.nextReviewAt = raw.nextReviewAt;
      if (typeof raw.note === 'string') state.note = raw.note;
      if (typeof raw.effect === 'number' && isFinite(raw.effect)) state.effect = raw.effect;
    }
    return state;
  }

  function describeReviewSchedule(raw) {
    const state = normalizeReviewState(raw);
    const now = Date.now();
    const nextMs = state.nextReviewAt ? state.nextReviewAt * 1000 : null;
    const lastMs = state.lastReviewAt ? state.lastReviewAt * 1000 : null;
    let dueLabel = '未排期';
    let dueClass = 'bg-secondary text-light';
    if (nextMs) {
      const diffMs = nextMs - now;
      const diffDays = diffMs / 86400000;
      if (diffMs < -3600000) {
        dueLabel = `逾期 ${Math.abs(diffDays).toFixed(1)} 天`;
        dueClass = 'bg-danger';
      } else if (diffMs < 86400000) {
        dueLabel = '今日复习';
        dueClass = 'bg-warning text-dark';
      } else if (diffDays < 2.5) {
        dueLabel = '即将复习';
        dueClass = 'bg-info text-dark';
      } else {
        dueLabel = `${diffDays.toFixed(1)} 天后`;
        dueClass = 'bg-success';
      }
    }
    const intervalLabel = state.interval ? `间隔 ${state.interval.toFixed(1)} 天 · 难度系数 ${state.ease.toFixed(2)}` : '尚未安排间隔';
    const lastLabel = lastMs ? new Date(lastMs).toLocaleString() : '未复习';
    const nextLabel = nextMs ? new Date(nextMs).toLocaleString() : '尚未排期';
    const isDue = !nextMs || nextMs <= now;
    return {state, dueLabel, dueClass, intervalLabel, lastLabel, nextLabel, isDue};
  }

  function computeNextReviewState(current, rating) {
    const nowSec = Math.floor(Date.now() / 1000);
    const base = normalizeReviewState(current);
    let ease = typeof base.ease === 'number' && isFinite(base.ease) ? base.ease : REVIEW_DEFAULT_STATE.ease;
    let interval = typeof base.interval === 'number' && isFinite(base.interval) ? base.interval : 0;
    let streak = typeof base.streak === 'number' && isFinite(base.streak) ? base.streak : 0;
    let lapses = typeof base.lapses === 'number' && isFinite(base.lapses) ? base.lapses : 0;
    const ratingKey = rating in REVIEW_RATING_LABELS ? rating : 'good';
    if (ratingKey === 'again') {
      interval = 0.5;
      ease = Math.max(1.3, ease - 0.2);
      streak = 0;
      lapses += 1;
    } else if (ratingKey === 'hard') {
      interval = Math.max(1, interval ? interval * 1.2 : 1);
      ease = Math.max(1.3, ease - 0.15);
      streak += 1;
    } else if (ratingKey === 'good') {
      interval = Math.max(1, (interval || 1) * ease);
      streak += 1;
    } else if (ratingKey === 'easy') {
      interval = Math.max(2, (interval || 1) * (ease + 0.15));
      ease = ease + 0.05;
      streak += 1;
    }
    const nextState = Object.assign({}, base, {
      ease: Number(ease.toFixed(2)),
      interval: Number(interval.toFixed(2)),
      streak,
      lapses,
      lastRating: ratingKey,
      effect: REVIEW_RATING_EFFECT[ratingKey] || REVIEW_DEFAULT_STATE.effect,
      lastReviewAt: nowSec,
      nextReviewAt: nowSec + Math.max(3600, Math.round(interval * 86400)),
    });
    return nextState;
  }

  function reviewRatingLabel(key) {
    return REVIEW_RATING_LABELS[key] || '复习';
  }

  function toggleReviewButtons(disabled) {
    document.querySelectorAll('[data-review-score]').forEach(btn => {
      btn.disabled = !!disabled;
    });
  }

  function ellipsizeText(text, limit = 160) {
    const raw = (text || '').trim();
    if (raw.length <= limit) return raw;
    return raw.slice(0, limit) + '…';
  }

  function renderLearningReviewList() {
    const list = document.getElementById('ai-learn-review-list');
    const empty = document.getElementById('ai-learn-review-empty');
    if (!list || !empty) return;
    list.innerHTML = '';
    const records = learningAssistantState.review.records || [];
    const filters = learningAssistantState.review.filters || {};
    const dueOnly = !!filters.dueOnly;
    const methodFilter = filters.method || '';
    const knownPromptIds = getKnownPromptIds();
    if (!records.length) {
      empty.classList.remove('d-none');
      return;
    }
    empty.classList.add('d-none');
    const sorted = records
      .map(rec => {
        const normalizedReview = normalizeReviewState(rec.review);
        const schedule = describeReviewSchedule(normalizedReview);
        return Object.assign({}, rec, {review: normalizedReview, _schedule: schedule});
      })
      .filter(rec => recordMatchesMethodFilter(rec, methodFilter, knownPromptIds))
      .filter(rec => !dueOnly || rec._schedule.isDue)
      .sort((a, b) => {
        const dueA = a._schedule.isDue ? 0 : 1;
        const dueB = b._schedule.isDue ? 0 : 1;
        if (dueA !== dueB) return dueA - dueB;
        const aTime = a.savedAt || 0;
        const bTime = b.savedAt || 0;
        return bTime - aTime;
      });
    if (!sorted.length) {
      empty.classList.remove('d-none');
      return;
    }
    sorted.forEach(rec => {
      const normalizedReview = normalizeReviewState(rec.review);
      const schedule = rec._schedule || describeReviewSchedule(normalizedReview);
      const card = document.createElement('div');
      card.className = 'card shadow-sm ai-learn-review-item';
      card.dataset.recordId = rec.id || '';
      card._record = Object.assign({}, rec, {review: normalizedReview});
      const body = document.createElement('div');
      body.className = 'card-body';
      const header = document.createElement('div');
      header.className = 'd-flex flex-wrap justify-content-between align-items-start gap-2';
      const titleBox = document.createElement('div');
      const title = document.createElement('h6');
      title.className = 'mb-1';
      title.textContent = rec.promptName || '临时提示词';
      titleBox.appendChild(title);
      const meta = document.createElement('div');
      meta.className = 'text-muted small';
      const savedAt = rec.savedAt ? new Date(rec.savedAt * 1000).toLocaleString() : '';
      const metaParts = [];
      if (savedAt) metaParts.push(savedAt);
      if (rec.category) metaParts.push(`分类：${rec.category}`);
      if (rec.method) metaParts.push(`方法：${rec.method}`);
      meta.textContent = metaParts.join(' · ') || '学习记录';
      titleBox.appendChild(meta);
      header.appendChild(titleBox);
      const actions = document.createElement('div');
      actions.className = 'btn-group btn-group-sm';
      const favActiveClass = rec.favorite ? 'btn btn-primary ai-learn-review-fav active' : 'btn btn-outline-primary ai-learn-review-fav';
      actions.innerHTML = `
        <button type="button" class="btn btn-outline-primary ai-learn-review-open">复习</button>
        <button type="button" class="${favActiveClass}" data-fav="${rec.favorite ? '1' : '0'}">${rec.favorite ? '取消收藏' : '收藏'}</button>
        <button type="button" class="btn btn-outline-danger ai-learn-review-delete">删除</button>
      `;
      header.appendChild(actions);
      body.appendChild(header);
      const preview = document.createElement('p');
      preview.className = 'mt-3 mb-2 text-muted';
      preview.textContent = ellipsizeText(rec.output || '', 280);
      body.appendChild(preview);
      const scheduleRow = document.createElement('div');
      scheduleRow.className = 'd-flex flex-wrap align-items-center gap-2 text-muted small';
      const badge = document.createElement('span');
      badge.className = `badge ${schedule.dueClass} review-badge`;
      badge.textContent = schedule.dueLabel;
      scheduleRow.appendChild(badge);
      const interval = document.createElement('span');
      interval.textContent = schedule.intervalLabel;
      scheduleRow.appendChild(interval);
      if (schedule.state.note) {
        const note = document.createElement('span');
        note.textContent = '复习笔记：' + ellipsizeText(schedule.state.note, 120);
        scheduleRow.appendChild(note);
      }
      body.appendChild(scheduleRow);
      card.appendChild(body);
      list.appendChild(card);
    });
  }

  function handleLearningReviewClick(event) {
    const target = event.target;
    const card = target.closest('.ai-learn-review-item');
    if (!card || !card._record) return;
    const record = card._record;
    if (target.closest('.ai-learn-review-open')) {
      openLearningReviewSession(record);
    } else if (target.closest('.ai-learn-review-fav')) {
      toggleLearningRecordFavorite(record, !record.favorite);
    } else if (target.closest('.ai-learn-review-delete')) {
      if (confirm('确定要删除这条学习记录吗？')) {
        deleteLearningRecord(record);
      }
    }
  }

  function setReviewBadge(id, text, extraClass = '') {
    const el = document.getElementById(id);
    if (!el) return;
    if (text) {
      el.textContent = text;
      el.className = `badge review-badge ${extraClass}`.trim();
      el.classList.remove('d-none');
    } else {
      el.classList.add('d-none');
    }
  }

  function setActiveReviewRecord(record) {
    if (!record) return null;
    const sessionRecord = Object.assign({}, record, {review: normalizeReviewState(record.review)});
    learningAssistantState.reviewSession.active = {record: sessionRecord};
    learningAssistantState.reviewSession.locked = false;
    renderLearningReviewSession(sessionRecord);
    return sessionRecord;
  }

  function renderLearningReviewSession(record) {
    if (!record) return;
    const review = normalizeReviewState(record.review);
    record.review = review;
    const summary = describeReviewSchedule(review);
    const metaEl = document.getElementById('ai-review-meta');
    if (metaEl) {
      const savedAt = record.savedAt ? new Date(record.savedAt * 1000).toLocaleString() : '';
      const parts = [];
      if (record.promptName) parts.push(`提示词：${record.promptName}`);
      if (savedAt) parts.push(savedAt);
      metaEl.textContent = parts.join(' · ') || '复习卡片';
    }
    setReviewBadge('ai-review-category-badge', record.category, 'bg-primary-subtle text-primary');
    setReviewBadge('ai-review-method-badge', record.method, 'bg-secondary-subtle text-secondary');
    setReviewBadge('ai-review-due-badge', summary.dueLabel, summary.dueClass);
    setReviewBadge('ai-review-status-badge', record.favorite ? '已收藏，长期保留' : '', record.favorite ? 'bg-primary-subtle text-primary' : '');
    const lastChoiceLabel = review.lastRating ? `上次选择：${reviewRatingLabel(review.lastRating)}` : '首次复习';
    const lastChoiceClass = review.lastRating ? 'bg-dark-subtle text-body' : 'bg-secondary-subtle text-secondary';
    setReviewBadge('ai-review-last-badge', lastChoiceLabel, lastChoiceClass);
    const outputEl = document.getElementById('ai-review-output');
    if (outputEl) {
      outputEl.textContent = record.output || '（暂无学习结果）';
    }
    const inputEl = document.getElementById('ai-review-input');
    if (inputEl) {
      inputEl.textContent = record.input || '（未保存原始输入）';
    }
    const contextEl = document.getElementById('ai-review-context');
    if (contextEl) {
      contextEl.textContent = record.context || '（未保存上下文）';
    }
    const noteEl = document.getElementById('ai-review-note');
    if (noteEl) {
      noteEl.value = review.note || '';
    }
    const categoryEl = document.getElementById('ai-review-category');
    if (categoryEl) {
      categoryEl.value = record.category || '';
    }
    const lastEl = document.getElementById('ai-review-last');
    if (lastEl) lastEl.textContent = summary.lastLabel;
    const nextEl = document.getElementById('ai-review-next');
    if (nextEl) nextEl.textContent = summary.nextLabel;
    const intervalEl = document.getElementById('ai-review-interval');
    if (intervalEl) intervalEl.textContent = summary.intervalLabel;
    const footEl = document.getElementById('ai-review-footnote');
    if (footEl) footEl.textContent = '记忆状态会立即保存并安排下一次复习';
    const sessionBadge = document.getElementById('ai-review-session-status');
    if (sessionBadge) sessionBadge.classList.add('d-none');
    toggleReviewButtons(false);
  }

  function openLearningReviewSession(record) {
    if (!record) return;
    const modal = ensureLearningReviewSessionModal();
    if (!modal) return;
    setActiveReviewRecord(record);
    modal.show();
  }

  async function persistReviewState(record, reviewState, options = {}) {
    if (!record || !record.id) return false;
    const silent = options && options.silent;
    const categoryVal = options && typeof options.category === 'string' ? options.category : undefined;
    try {
      const payload = {review: reviewState};
      if (typeof categoryVal === 'string') {
        payload.category = categoryVal;
      }
      const res = await fetch(appendWorkspaceQuery(`/learn/records/${encodeURIComponent(record.id)}`), {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(withWorkspacePayload(payload)),
      });
      if (!res.ok) {
        const text = (await res.text()) || `HTTP ${res.status}`;
        throw new Error(text);
      }
      const data = await res.json();
      if (data && data.success === false) {
        throw new Error(data.error || '保存失败');
      }
      if (data && data.record && typeof data.record === 'object' && 'review' in data.record) {
        record.review = normalizeReviewState(data.record.review);
        if (typeof data.record.category === 'string') {
          record.category = data.record.category;
        }
      }
      if (typeof categoryVal === 'string') {
        record.category = categoryVal;
      }
      learningAssistantState.review.initialized = false;
      if (!silent) {
        showStatus('复习进度已保存', 'success', 2400);
      }
      return true;
    } catch (err) {
      console.error('保存复习进度失败:', err);
      if (!silent) {
        showStatus('保存复习进度失败：' + (err?.message || err || '未知错误'), 'danger', 6000);
      }
      return false;
    }
  }

  async function saveReviewNoteOnly() {
    const active = learningAssistantState.reviewSession.active;
    if (!active || !active.record) return;
    const review = normalizeReviewState(active.record.review);
    const noteEl = document.getElementById('ai-review-note');
    review.note = noteEl ? noteEl.value.trim() : '';
    const categoryEl = document.getElementById('ai-review-category');
    const categoryVal = categoryEl ? categoryEl.value.trim() : '';
    const ok = await persistReviewState(active.record, review, {silent: true, category: categoryVal});
    if (ok) {
      active.record.review = review;
      active.record.category = categoryVal;
      renderLearningReviewSession(active.record);
      loadLearningReviewData(true);
      showStatus('已保存复习笔记', 'success', 2000);
    }
  }

  function findNextDueRecord(excludeId) {
    const records = learningAssistantState.review.records || [];
    const now = Date.now();
    const dueList = records
      .filter(rec => !excludeId || rec.id !== excludeId)
      .map(rec => {
        const normalizedReview = normalizeReviewState(rec.review);
        const schedule = describeReviewSchedule(normalizedReview);
        return {rec, schedule};
      })
      .filter(item => item.schedule.isDue);
    if (!dueList.length) return null;
    dueList.sort((a, b) => {
      const nextA = a.schedule.state.nextReviewAt ? a.schedule.state.nextReviewAt * 1000 : 0;
      const nextB = b.schedule.state.nextReviewAt ? b.schedule.state.nextReviewAt * 1000 : 0;
      if (nextA !== nextB) return nextA - nextB;
      return (b.rec.savedAt || now) - (a.rec.savedAt || now);
    });
    return dueList[0].rec;
  }

  async function applyReviewDecision(rating) {
    const active = learningAssistantState.reviewSession.active;
    if (!active || !active.record) return;
    if (learningAssistantState.reviewSession.locked) {
      showStatus('本次复习已记录，如需调整请重新打开该卡片', 'info', 2600);
      return;
    }
    const review = normalizeReviewState(active.record.review);
    const noteEl = document.getElementById('ai-review-note');
    review.note = noteEl ? noteEl.value.trim() : '';
    const categoryEl = document.getElementById('ai-review-category');
    const categoryVal = categoryEl ? categoryEl.value.trim() : '';
    review.effect = REVIEW_RATING_EFFECT[rating] || REVIEW_DEFAULT_STATE.effect;
    const nextState = computeNextReviewState(review, rating);
    learningAssistantState.reviewSession.locked = true;
    toggleReviewButtons(true);
    const ok = await persistReviewState(active.record, nextState, {category: categoryVal});
    if (ok) {
      active.record.review = nextState;
      active.record.category = categoryVal;
      await loadLearningReviewData(true);
      const nextRecord = findNextDueRecord(active.record.id);
      const sessionBadge = document.getElementById('ai-review-session-status');
      if (nextRecord) {
        setActiveReviewRecord(nextRecord);
        if (sessionBadge) {
          sessionBadge.textContent = '已跳转到下一个到期卡片';
          sessionBadge.classList.remove('d-none');
        }
      } else {
        const modal = ensureLearningReviewSessionModal();
        if (modal) modal.hide();
        showStatus('本次复习已记录，暂无到期卡片', 'success', 2400);
      }
    } else {
      learningAssistantState.reviewSession.locked = false;
      toggleReviewButtons(false);
    }
  }

  function copyReviewOutput() {
    const outputEl = document.getElementById('ai-review-output');
    const text = outputEl ? (outputEl.textContent || '') : '';
    if (!text.trim()) {
      showStatus('没有可复制的内容', 'warning', 2000);
      return;
    }
    navigator.clipboard.writeText(text).then(() => {
      showStatus('已复制复习卡片内容', 'success', 2200);
    }).catch(err => {
      console.error('复制失败', err);
      showStatus('复制失败，请手动复制', 'warning', 2400);
    });
  }

  async function toggleLearningRecordFavorite(record, nextState) {
    if (!record || !record.id) return;
    try {
      const res = await fetch(appendWorkspaceQuery(`/learn/records/${encodeURIComponent(record.id)}`), {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(withWorkspacePayload({favorite: nextState})),
      });
      if (!res.ok) {
        const text = (await res.text()) || `HTTP ${res.status}`;
        throw new Error(text);
      }
      const data = await res.json();
      if (data && data.success === false) {
        throw new Error(data.error || '更新失败');
      }
      record.favorite = nextState;
      loadLearningReviewData(true);
    } catch (err) {
      console.error('更新收藏状态失败:', err);
      showStatus('更新收藏状态失败：' + (err?.message || err || '未知错误'), 'danger', 6000);
    }
  }

  async function deleteLearningRecord(record) {
    if (!record || !record.id) return;
    try {
      const res = await fetch(appendWorkspaceQuery(`/learn/records/${encodeURIComponent(record.id)}`), {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(withWorkspacePayload({})),
      });
      if (!res.ok) {
        const text = (await res.text()) || `HTTP ${res.status}`;
        throw new Error(text);
      }
      const data = await res.json();
      if (data && data.success === false) {
        throw new Error(data.error || '删除失败');
      }
      showStatus('学习记录已删除', 'success', 2500);
      loadLearningReviewData(true);
    } catch (err) {
      console.error('删除学习记录失败:', err);
      showStatus('删除学习记录失败：' + (err?.message || err || '未知错误'), 'danger', 6000);
    }
  }

  function openRecordInResultModal(record) {
    if (!record) return;
    enqueueLearningResult({
      recordId: record.id,
      promptId: record.promptId,
      promptName: record.promptName || '历史学习记录',
      content: record.input || '',
      context: record.context || '',
      result: record.output || '',
      method: record.method || '',
      category: record.category || '',
      favorite: !!record.favorite,
      savedAt: record.savedAt,
      project: typeof currentProject === 'string' ? currentProject : '',
      applyMeta: {
        project: typeof currentProject === 'string' ? currentProject : '',
        mode: currentEditMode,
        pageIdx: currentPageIdx,
        pageId: pagesData[currentPageIdx]?.pageId || '',
        selection: null,
        cursor: null,
      },
    });
  }


  function resetPromptEditor() {
    const nameEl = document.getElementById('ai-learn-prompt-name');
    const descEl = document.getElementById('ai-learn-prompt-description');
    const sysEl = document.getElementById('ai-learn-prompt-system');
    const tplEl = document.getElementById('ai-learn-prompt-template');
    if (nameEl) nameEl.value = '';
    if (descEl) descEl.value = '';
    if (sysEl) sysEl.value = '';
    if (tplEl) tplEl.value = '请针对以下内容提供学习说明：\n{content}\n\n上下文：\n{context}\n';
  }

  function openPromptEditor(prompt) {
    const modal = ensureLearningPromptModal();
    if (!modal) return;
    resetPromptEditor();
    learningAssistantState.editingPrompt = prompt || null;
    const title = document.getElementById('aiLearnPromptModalLabel');
    if (title) title.textContent = prompt ? '编辑提示词' : '新增提示词';
    if (prompt) {
      const nameEl = document.getElementById('ai-learn-prompt-name');
      const descEl = document.getElementById('ai-learn-prompt-description');
      const sysEl = document.getElementById('ai-learn-prompt-system');
      const tplEl = document.getElementById('ai-learn-prompt-template');
      if (nameEl) nameEl.value = prompt.name || '';
      if (descEl) descEl.value = prompt.description || '';
      if (sysEl) sysEl.value = prompt.system || '';
      if (tplEl) tplEl.value = prompt.template || '';
    }
    modal.show();
  }

  async function submitPromptEditor() {
    const nameEl = document.getElementById('ai-learn-prompt-name');
    const tplEl = document.getElementById('ai-learn-prompt-template');
    if (!nameEl || !tplEl) return;
    const name = nameEl.value.trim();
    const template = tplEl.value.trim();
    if (!name || !template) {
      alert('提示词名称和模板均不能为空');
      return;
    }
    const descEl = document.getElementById('ai-learn-prompt-description');
    const sysEl = document.getElementById('ai-learn-prompt-system');
    const description = descEl ? descEl.value.trim() : '';
    const systemText = sysEl ? sysEl.value.trim() : '';
    const payload = {
      name,
      template,
      description,
      system: systemText,
    };
    const isEdit = !!learningAssistantState.editingPrompt;
    const url = isEdit
      ? appendWorkspaceQuery(`/learn/prompts/${encodeURIComponent(learningAssistantState.editingPrompt.id)}`)
      : appendWorkspaceQuery('/learn/prompts');
    const method = isEdit ? 'PUT' : 'POST';
    try {
      const res = await fetch(url, {
        method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(withWorkspacePayload(payload)),
      });
      if (!res.ok) {
        const text = (await res.text()) || `HTTP ${res.status}`;
        throw new Error(text);
      }
      const data = await res.json();
      if (!data || data.success === false) {
        throw new Error((data && data.error) || '保存提示词失败');
      }
      if (Array.isArray(data.prompts)) {
        learningAssistantState.loaded = true;
        setLearningPrompts(data.prompts);
      }
      showStatus(isEdit ? '提示词已更新' : '提示词已创建', 'success', 3000);
      learningAssistantState.editingPrompt = null;
      const modal = ensureLearningPromptModal();
      if (modal) modal.hide();
    } catch (err) {
      console.error('保存提示词失败:', err);
      alert('保存提示词失败：' + (err?.message || err || '未知错误'));
    }
  }

  async function deletePrompt(prompt) {
    if (!prompt || !prompt.id) return;
    if (!confirm(`确定要删除提示词“${prompt.name || prompt.id}”吗？`)) return;
    try {
      const res = await fetch(appendWorkspaceQuery(`/learn/prompts/${encodeURIComponent(prompt.id)}`), {
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(withWorkspacePayload({})),
      });
      if (!res.ok) {
        const text = (await res.text()) || `HTTP ${res.status}`;
        throw new Error(text);
      }
      const data = await res.json();
      if (!data || data.success === false) {
        throw new Error((data && data.error) || '删除失败');
      }
      if (Array.isArray(data.prompts)) {
        learningAssistantState.loaded = true;
        setLearningPrompts(data.prompts);
      }
      showStatus('提示词已删除', 'success', 3000);
    } catch (err) {
      console.error('删除提示词失败:', err);
      alert('删除提示词失败：' + (err?.message || err || '未知错误'));
    }
  }

  const aiLearnBtn = document.getElementById('ai-learn-helper');
  if (aiLearnBtn) {
    aiLearnBtn.addEventListener('mousedown', () => snapshotLearningSelection());
    aiLearnBtn.addEventListener('click', openLearningModal);
  }

  const aiLearnFillSelection = document.getElementById('ai-learn-fill-selection');
  if (aiLearnFillSelection) {
    aiLearnFillSelection.addEventListener('click', async () => {
      const contentEl = document.getElementById('ai-learn-content');
      if (!contentEl) return;
      let payload = lastLearningSelectionSnapshot;
      if (!payload) {
        payload = await collectSelectionWithAssets();
        lastLearningSelectionSnapshot = payload;
      }
      const parts = [];
      if (payload.text) {
        parts.push(payload.text);
      }
      if (Array.isArray(payload.images) && payload.images.length) {
        payload.images.forEach((img, idx) => {
          const alt = img.alt || `图片${idx + 1}`;
          if (img.dataUrl) {
            parts.push(`![${alt}](${img.dataUrl})`);
          } else {
            const reason = img.note ? `（${img.note}）` : '';
            parts.push(`[${alt}](${img.src || '#'}) ${reason}`.trim());
          }
        });
      }
      const combined = parts.join('\n\n').trim();
      contentEl.value = combined;
      if (combined) {
        const hints = [];
        if (payload.images && payload.images.length) {
          hints.push(`附带 ${payload.images.length} 张图片`);
        }
        if (payload.skipped) {
          hints.push(`有 ${payload.skipped} 张未内嵌`);
        }
        showStatus(hints.length ? hints.join('，') : '已填充选中的内容', 'info', 2400);
      } else {
        showStatus('未检测到选中的文本，请手动粘贴。', 'warning', 3000);
      }
    });
  }

  const aiLearnFetchContext = document.getElementById('ai-learn-fetch-context');
  if (aiLearnFetchContext) {
    aiLearnFetchContext.addEventListener('click', () => {
      updateLearningContext(false, true);
    });
  }

  const aiLearnRefreshBtn = document.getElementById('ai-learn-refresh-prompts');
  if (aiLearnRefreshBtn) {
    aiLearnRefreshBtn.addEventListener('click', () => loadLearningPrompts(true));
  }

  const aiLearnRunTempBtn = document.getElementById('ai-learn-run-temp');
  if (aiLearnRunTempBtn) {
    aiLearnRunTempBtn.addEventListener('click', () => runTempLearningPrompt(aiLearnRunTempBtn));
  }

  const aiLearnTempResetBtn = document.getElementById('ai-learn-temp-reset');
  if (aiLearnTempResetBtn) {
    aiLearnTempResetBtn.addEventListener('click', () => {
      ensureTempPromptDefault(true);
      showStatus('已恢复临时提示词模板', 'info', 2000);
    });
  }

  const aiLearnAddPromptBtn = document.getElementById('ai-learn-add-prompt');
  if (aiLearnAddPromptBtn) {
    aiLearnAddPromptBtn.addEventListener('click', () => openPromptEditor(null));
  }

  const aiLearnPromptSaveBtn = document.getElementById('ai-learn-prompt-save');
  if (aiLearnPromptSaveBtn) {
    aiLearnPromptSaveBtn.addEventListener('click', submitPromptEditor);
  }

  const aiLearnResultCopyBtn = document.getElementById('ai-learn-result-copy');
  if (aiLearnResultCopyBtn) {
    aiLearnResultCopyBtn.addEventListener('click', copyActiveLearningResult);
  }

  const aiLearnResultApplyBtn = document.getElementById('ai-learn-result-apply');
  if (aiLearnResultApplyBtn) {
    aiLearnResultApplyBtn.addEventListener('click', applyActiveLearningResult);
  }

  const aiLearnResultSaveBtn = document.getElementById('ai-learn-result-save');
  if (aiLearnResultSaveBtn) {
    aiLearnResultSaveBtn.addEventListener('click', () => saveActiveLearningResult(aiLearnResultSaveBtn));
  }

  const aiLearnReviewBtn = document.getElementById('ai-learn-review-btn');
  if (aiLearnReviewBtn) {
    aiLearnReviewBtn.addEventListener('click', openLearningReviewModal);
  }

  const aiLearnReviewList = document.getElementById('ai-learn-review-list');
  if (aiLearnReviewList) {
    aiLearnReviewList.addEventListener('click', handleLearningReviewClick);
  }

  const aiLearnReviewSearch = document.getElementById('ai-learn-review-search');
  let aiLearnReviewSearchTimer = null;
  if (aiLearnReviewSearch) {
    aiLearnReviewSearch.addEventListener('input', () => {
      clearTimeout(aiLearnReviewSearchTimer);
      aiLearnReviewSearchTimer = setTimeout(() => {
        learningAssistantState.review.filters.search = aiLearnReviewSearch.value.trim();
        loadLearningReviewData(true);
      }, 350);
    });
  }

  const aiLearnReviewMethod = document.getElementById('ai-learn-review-method');
  if (aiLearnReviewMethod) {
    aiLearnReviewMethod.addEventListener('change', () => {
      learningAssistantState.review.filters.method = aiLearnReviewMethod.value || '';
      renderLearningReviewList();
    });
  }

  const aiLearnReviewFavorite = document.getElementById('ai-learn-review-favorite');
  if (aiLearnReviewFavorite) {
    aiLearnReviewFavorite.addEventListener('change', () => {
      learningAssistantState.review.filters.favoriteOnly = !!aiLearnReviewFavorite.checked;
      loadLearningReviewData(true);
    });
  }
  const aiLearnReviewDue = document.getElementById('ai-learn-review-due');
  if (aiLearnReviewDue) {
    aiLearnReviewDue.addEventListener('change', () => {
      learningAssistantState.review.filters.dueOnly = !!aiLearnReviewDue.checked;
      renderLearningReviewList();
    });
  }

  const aiReviewSaveNote = document.getElementById('ai-review-save-note');
  if (aiReviewSaveNote) {
    aiReviewSaveNote.addEventListener('click', saveReviewNoteOnly);
  }

  const aiReviewCopyOutput = document.getElementById('ai-review-copy-output');
  if (aiReviewCopyOutput) {
    aiReviewCopyOutput.addEventListener('click', copyReviewOutput);
  }

  const aiReviewOpenResult = document.getElementById('ai-review-open-result');
  document.querySelectorAll('[data-review-score]').forEach(btn => {
    btn.addEventListener('click', () => {
      const value = btn.dataset.reviewScore;
      applyReviewDecision(value);
    });
  });

  const aiLearnModalEl = document.getElementById('aiLearnModal');
  if (aiLearnModalEl) {
    aiLearnModalEl.addEventListener('shown.bs.modal', () => {
      const contentEl = document.getElementById('ai-learn-content');
      if (contentEl) {
        contentEl.focus();
      }
      ensureTempPromptDefault(false);
      updateLearningContext(true);
    });
  }

  const aiLearnPromptModalEl = document.getElementById('aiLearnPromptModal');
  if (aiLearnPromptModalEl) {
    aiLearnPromptModalEl.addEventListener('hidden.bs.modal', () => {
      learningAssistantState.editingPrompt = null;
    });
  }

  const aiAssistantBtn = document.getElementById('ai-assistant-btn');
  if (aiAssistantBtn) {
    aiAssistantBtn.addEventListener('click', openAssistantModal);
  }

  const aiAssistantRun = document.getElementById('ai-assistant-run');
  if (aiAssistantRun) {
    aiAssistantRun.addEventListener('click', () => runAssistant(aiAssistantRun));
  }

  const aiAssistantSave = document.getElementById('ai-assistant-save');
  if (aiAssistantSave) {
    aiAssistantSave.addEventListener('click', pushAssistantToReview);
  }

  const aiAssistantCopy = document.getElementById('ai-assistant-copy');
  if (aiAssistantCopy) {
    aiAssistantCopy.addEventListener('click', copyAssistantAnswer);
  }

  const aiAssistantUseRag = document.getElementById('ai-assistant-use-rag');
  if (aiAssistantUseRag) {
    aiAssistantUseRag.addEventListener('change', syncAssistantRagScope);
  }

  const aiAssistantPageOnly = document.getElementById('ai-assistant-page-only');
  if (aiAssistantPageOnly) {
    aiAssistantPageOnly.addEventListener('change', syncAssistantRagScope);
  }

  if (aiAssistantUseRag || aiAssistantPageOnly) {
    syncAssistantRagScope();
  }

  document.getElementById('play-note').onclick = function() {
    const script = pagesData[currentPageIdx]?.script || '';
    if(!script.trim()) return alert('当前页讲稿为空');
    this.disabled = true;
    this.textContent = '生成中...';
    const url = appendWorkspaceQuery('/tts');
    fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(withLlmConfig({text: script}))
    }).then(res=>res.json()).then(data=>{
      if(data.success && data.audio) {
        const audio = new Audio('data:audio/mp3;base64,' + data.audio);
        audio.play();
      } else {
        alert('TTS失败：'+(data.error||'未知错误'));
      }
    }).catch(()=>alert('TTS请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = '播放笔记';
    });
  };
  
  // legacy export-audio removed (use unified export modal)
  
  
  function normalizeBibEntry(raw) {
    if (!raw) return null;
    let entryText = '';
    let note = '';
    let label = '';
    let link = '';
    let id = '';
    let metadata = null;

    if (typeof raw === 'string') {
      entryText = raw;
    } else if (typeof raw === 'object') {
      entryText = (raw.entry || raw.bib || '').trim();
      note = (raw.note || '').trim();
      label = (raw.label || raw.name || raw.title || '').trim();
      link = (raw.link || '').trim();
      id = (raw.id || '').trim();
      if (raw.metadata && typeof raw.metadata === 'object' && !Array.isArray(raw.metadata)) {
        try {
          metadata = JSON.parse(JSON.stringify(raw.metadata));
        } catch (e) {
          metadata = {...raw.metadata};
        }
      }
    }

    entryText = (entryText || '').trim();
    const hasInfo = entryText || note || label || link || (metadata && Object.keys(metadata).length);
    if (!hasInfo) return null;

    const keyMatch = entryText.match(/@\w+\s*\{\s*([^,\s]+)/);
    if (!id) {
      id = keyMatch && keyMatch[1] ? keyMatch[1].trim() : '';
    }
    if (!id) {
      id = `ref${Date.now()}${Math.floor(Math.random() * 1000)}`;
    }

    if (!label) {
      const titleMatch = entryText.match(/title\s*=\s*[{"]([^}\"]+)[}"]/i);
      label = titleMatch && titleMatch[1] ? titleMatch[1].trim() : id;
    }

    if (!link) {
      const urlMatch = entryText.match(/url\s*=\s*[{"]([^}\"]+)[}"]/i);
      if (urlMatch && urlMatch[1]) {
        link = urlMatch[1].split('?')[0].split('#')[0].trim();
      } else {
        const doiMatch = entryText.match(/doi\s*=\s*[{"]([^}\"]+)[}"]/i);
        if (doiMatch && doiMatch[1]) {
          link = `https://doi.org/${doiMatch[1].trim()}`;
        }
      }
    }

    return {
      id,
      entry: entryText,
      label,
      note,
      link,
      metadata: metadata || null,
    };
  }

  function normalizeBibList(list) {
    if (!Array.isArray(list)) return [];
    const seen = new Set();
    const normalized = [];
    list.forEach(item => {
      const entry = normalizeBibEntry(item);
      if (!entry) return;
      if (seen.has(entry.id)) return;
      seen.add(entry.id);
      normalized.push(entry);
    });
    return normalized;
  }

  function findBibIndex(collection, id) {
    return collection.findIndex(item => item && item.id === id);
  }

  function insertBibIntoEditor(entry, mode) {
    if (!singleEditor || !entry) return;
    const doc = singleEditor.getDoc();
    const cursor = doc.getCursor();
    const label = entry.label || entry.id;
    const format = mode || (currentEditMode === 'markdown' ? 'markdown' : 'latex');
    if (format === 'markdown') {
      let snippet = entry.link ? `[${label}](${entry.link})` : `[${label}]`;
      if (entry.note) snippet += ` (${entry.note})`;
      doc.replaceRange(snippet + ' ', cursor);
    } else {
      let snippet = entry.link ? `\\href{${entry.link}}{${label}}` : `\\cite{${entry.id}}`;
      if (entry.note && entry.link) {
        snippet += `\\footnote{${entry.note}}`;
      }
      doc.replaceRange(snippet + ' ', cursor);
    }
  }

  let bibData = [];
  const bibEditState = { entry: null, scope: 'page' };
  let bibEditModalInstance = null;

  function getBibEditModal() {
    const modalEl = document.getElementById('bibEntryModal');
    if (!modalEl) return null;
    if (!bibEditModalInstance) {
      bibEditModalInstance = new bootstrap.Modal(modalEl);
      modalEl.addEventListener('hidden.bs.modal', () => {
        bibEditState.entry = null;
        bibEditState.scope = 'page';
        const labelInput = document.getElementById('bib-edit-label');
        const noteInput = document.getElementById('bib-edit-note');
        const infoEl = document.getElementById('bib-edit-details');
        if (labelInput) labelInput.value = '';
        if (noteInput) noteInput.value = '';
        if (infoEl) infoEl.innerHTML = '<div class="text-muted">暂无文献信息</div>';
      });
    }
    return bibEditModalInstance;
  }

  function buildBibMetadataHtml(entry, scope) {
    const infoChunks = [];
    if (scope) {
      const scopeLabel = scope === 'page' ? '所属：本页' : '所属：全局';
      infoChunks.push(`<div class="mb-2 text-muted small">${scopeLabel}</div>`);
    }
    const idText = entry.id ? escapeHtml(entry.id) : '—';
    infoChunks.push(`<div class="mb-2"><div class="text-muted small">引用标识</div><div>${idText}</div></div>`);
    if (entry.link) {
      const safeLink = escapeHtml(entry.link);
      infoChunks.push(`<div class="mb-2"><div class="text-muted small">链接</div><div><a href="${safeLink}" target="_blank" rel="noopener">${safeLink}</a></div></div>`);
    }
    const metadata = entry.metadata && typeof entry.metadata === 'object' ? entry.metadata : null;
    if (metadata) {
      if (Array.isArray(metadata.authors) && metadata.authors.length) {
        infoChunks.push(`<div class="mb-2"><div class="text-muted small">作者</div><div>${escapeHtml(metadata.authors.join(', '))}</div></div>`);
      }
      if (metadata.venue) {
        infoChunks.push(`<div class="mb-2"><div class="text-muted small">发表</div><div>${escapeHtml(metadata.venue)}</div></div>`);
      }
      if (metadata.year) {
        infoChunks.push(`<div class="mb-2"><div class="text-muted small">年份</div><div>${escapeHtml(String(metadata.year))}</div></div>`);
      }
      if (metadata.doi) {
        const trimmedDoi = String(metadata.doi).trim();
        const doiLink = trimmedDoi ? `https://doi.org/${trimmedDoi}` : '';
        const doiHtml = trimmedDoi ? `<a href="${escapeHtml(doiLink)}" target="_blank" rel="noopener">${escapeHtml(trimmedDoi)}</a>` : '—';
        infoChunks.push(`<div class="mb-2"><div class="text-muted small">DOI</div><div>${doiHtml}</div></div>`);
      }
      const extraKeys = Object.keys(metadata).filter(k => !['authors', 'venue', 'year', 'doi'].includes(k));
      extraKeys.forEach(key => {
        const value = metadata[key];
        if (value === undefined || value === null) return;
        const text = typeof value === 'string' ? value : JSON.stringify(value, null, 2);
        infoChunks.push(`<div class="mb-2"><div class="text-muted small">${escapeHtml(key)}</div><div>${escapeHtml(text)}</div></div>`);
      });
    }
    if (entry.entry) {
      const raw = escapeHtml(entry.entry);
      infoChunks.push(`<div class="mb-0"><div class="text-muted small">原始 BibTeX</div><pre class="mb-0 small bg-white border rounded p-2">${raw}</pre></div>`);
    }
    if (!infoChunks.length) {
      infoChunks.push('<div class="text-muted">暂无文献信息</div>');
    }
    return infoChunks.join('');
  }

  function openBibEditModal(entry, scope) {
    const modal = getBibEditModal();
    if (!modal || !entry) return;
    bibEditState.entry = entry;
    bibEditState.scope = scope;
    const labelInput = document.getElementById('bib-edit-label');
    const noteInput = document.getElementById('bib-edit-note');
    if (labelInput) labelInput.value = entry.label || '';
    if (noteInput) noteInput.value = entry.note || '';
    const infoEl = document.getElementById('bib-edit-details');
    if (infoEl) infoEl.innerHTML = buildBibMetadataHtml(entry, scope);
    modal.show();
  }

  function currentPageBib() {
    if (!pagesData[currentPageIdx]) {
      pagesData[currentPageIdx] = {content: '', script: '', notes: '', bib: [], resources: [], pageId: generatePageId()};
    }
    if (!Array.isArray(pagesData[currentPageIdx].bib)) {
      pagesData[currentPageIdx].bib = [];
    }
    pagesData[currentPageIdx].bib = normalizeBibList(pagesData[currentPageIdx].bib);
    return pagesData[currentPageIdx].bib;
  }

  function saveGlobalBib() {
    if(!ensureWorkspaceReady({silent: true})){
      return Promise.resolve();
    }
    if(!PROJECT_ENDPOINTS.projectSave){
      promptWorkspaceSelection('请先选择工作区后再保存文献信息');
      return Promise.resolve();
    }
    const payload = { bib: bibData };
    return fetch(PROJECT_ENDPOINTS.projectSave, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload)
    });
  }

  function clearBibForm() {
    document.getElementById('bib-input').value = '';
    document.getElementById('bib-label-input').value = '';
    document.getElementById('bib-note-input').value = '';
  }

  function renderBibList() {
    const pageList = document.getElementById('bib-page-list');
    const globalList = document.getElementById('bib-global-list');
    const pageCount = document.getElementById('bib-page-count');
    const globalCount = document.getElementById('bib-global-count');
    const pageEntries = currentPageBib();
    bibData = normalizeBibList(bibData);
    closeActionBubble('bib-refresh');

    pageList.innerHTML = '';
    globalList.innerHTML = '';
    if (pageCount) pageCount.textContent = pageEntries.length ? `${pageEntries.length} 条` : '暂无';
    if (globalCount) globalCount.textContent = bibData.length ? `${bibData.length} 条` : '暂无';

    const buildItem = (entry, scope) => {
      const item = document.createElement('div');
      item.className = 'list-group-item';

      const header = document.createElement('div');
      header.className = 'd-flex justify-content-between align-items-start gap-2';

      const meta = document.createElement('div');
      meta.className = 'flex-grow-1';
      const title = document.createElement('div');
      title.className = 'fw-semibold';
      if (entry.link) {
        const anchor = document.createElement('a');
        anchor.href = entry.link;
        anchor.target = '_blank';
        anchor.rel = 'noopener';
        anchor.textContent = entry.label || entry.id;
        title.appendChild(anchor);
      } else {
        title.textContent = entry.label || entry.id;
      }
      meta.appendChild(title);

      if (entry.note) {
        const note = document.createElement('div');
        note.className = 'text-muted small';
        note.textContent = entry.note;
        meta.appendChild(note);
      }

      const idLine = document.createElement('div');
      idLine.className = 'text-muted small';
      idLine.textContent = scope === 'page' ? `本页 · ${entry.id}` : `全局 · ${entry.id}`;
      meta.appendChild(idLine);

      if (entry.metadata) {
        const infoParts = [];
        const authors = Array.isArray(entry.metadata.authors) ? entry.metadata.authors : [];
        if (authors.length) {
          const shortAuthors = authors.slice(0, 3).join(', ');
          infoParts.push(authors.length > 3 ? `${shortAuthors} 等` : shortAuthors);
        }
        if (entry.metadata.venue) infoParts.push(entry.metadata.venue);
        if (entry.metadata.year) infoParts.push(entry.metadata.year);
        if (entry.metadata.doi) infoParts.push(entry.metadata.doi);
        if (infoParts.length) {
          const metaLine = document.createElement('div');
          metaLine.className = 'text-muted small';
          metaLine.textContent = infoParts.join(' · ');
          meta.appendChild(metaLine);
        }
      }

      header.appendChild(meta);

      item.appendChild(header);
      bindActionBubbleTrigger(item, () => {
        const actions = [];
        actions.push({
          label: '插入引用',
          icon: '➕',
          variant: 'primary',
          onClick: () => insertBibIntoEditor(entry),
        });
        actions.push({
          label: '编辑信息',
          icon: '✏️',
          variant: 'outline-secondary',
          onClick: () => openBibEditModal(entry, scope),
        });
        actions.push({
          label: '删除',
          icon: '🗑️',
          variant: 'outline-danger',
          onClick: () => {
            if (!confirm('确认删除这条文献吗？')) return;
            if (scope === 'page') {
              const idx = findBibIndex(pageEntries, entry.id);
              if (idx > -1) {
                pageEntries.splice(idx, 1);
                saveProject();
                queueCompile();
              }
            } else {
              const idx = findBibIndex(bibData, entry.id);
              if (idx > -1) {
                bibData.splice(idx, 1);
                saveGlobalBib();
              }
            }
            renderBibList();
          },
        });
        if (entry.link) {
          actions.unshift({
            label: '打开链接',
            icon: '🔗',
            variant: 'outline-secondary',
            onClick: () => {
              window.open(entry.link, '_blank', 'noopener');
            },
          });
        }
        return actions;
      });
      return item;
    };

    pageEntries.forEach(entry => {
      const item = buildItem(entry, 'page');
      pageList.appendChild(item);
    });

    bibData.forEach(entry => {
      const item = buildItem(entry, 'global');
      globalList.appendChild(item);
    });
  }

  document.getElementById('edit-bib').onclick = function() {
    if(!ensureWorkspaceReady()){
      return;
    }
    if(!PROJECT_ENDPOINTS.project){
      promptWorkspaceSelection('请先选择工作区后再编辑文献');
      return;
    }
    fetch(PROJECT_ENDPOINTS.project).then(res=>res.json()).then(data=>{
      bibData = normalizeBibList(data.bib || []);
      renderBibList();
      var modal = new bootstrap.Modal(document.getElementById('bibModal'));
      modal.show();
    });
  };

  const bibEditSaveBtn = document.getElementById('bib-edit-save');
  if (bibEditSaveBtn) {
    bibEditSaveBtn.addEventListener('click', () => {
      const entry = bibEditState.entry;
      if (!entry) return;
      const labelInput = document.getElementById('bib-edit-label');
      const noteInput = document.getElementById('bib-edit-note');
      const newLabel = labelInput ? labelInput.value.trim() : '';
      const newNote = noteInput ? noteInput.value.trim() : '';
      entry.label = newLabel || entry.id;
      if (newNote) {
        entry.note = newNote;
      } else {
        delete entry.note;
      }
      if (bibEditState.scope === 'page') {
        saveProject();
        queueCompile();
      } else {
        saveGlobalBib();
      }
      renderBibList();
      const modal = getBibEditModal();
      if (modal) modal.hide();
    });
  }

  document.getElementById('add-bib-btn').onclick = function() {
    const val = document.getElementById('bib-input').value.trim();
    if(!val) return;
    this.disabled = true;
    this.textContent = '生成中...';
    const scope = document.getElementById('bib-scope').value;
    const labelInput = document.getElementById('bib-label-input');
    const noteInput = document.getElementById('bib-note-input');
    fetch('/ai_bib', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(withLlmConfig({ref: val}))
    }).then(res=>res.json()).then(data=>{
      if(data.success && (data.entry || data.bib)) {
        const payload = data.entry ? {...data.entry} : {entry: data.bib};
        if (labelInput.value.trim()) payload.label = labelInput.value.trim();
        if (noteInput.value.trim()) payload.note = noteInput.value.trim();
        if (!payload.link && val.startsWith('http')) payload.link = val;
        const entry = normalizeBibEntry(payload);
        if(entry){
          if(scope === 'page') {
            const pageEntries = currentPageBib();
            pageEntries.push(entry);
            saveProject();
            queueCompile();
          } else {
            bibData.push(entry);
            saveGlobalBib();
          }
        }
        renderBibList();
        clearBibForm();
      } else {
        alert('AI生成失败：'+(data.error||'未知错误'));
      }
    }).catch(()=>alert('AI请求失败')).finally(()=>{
      this.disabled = false;
      this.textContent = 'AI生成';
    });
  };

  document.getElementById('add-url-bib-btn').onclick = function() {
    let val = document.getElementById('bib-input').value.trim();
    if(!val) return;
    const scope = document.getElementById('bib-scope').value;
    const labelInput = document.getElementById('bib-label-input');
    const noteInput = document.getElementById('bib-note-input');
    let cleanVal = val;
    try {
      const parsed = new URL(cleanVal);
      parsed.search = '';
      parsed.hash = '';
      cleanVal = parsed.toString();
    } catch(e) {
      const noQuery = cleanVal.split('?')[0];
      cleanVal = noQuery.split('#')[0];
    }
    const bib = `@misc{url${Date.now()},\n  url={${cleanVal}}\n}`;
    const entry = normalizeBibEntry({
      entry: bib,
      label: labelInput.value,
      note: noteInput.value,
      link: cleanVal,
      metadata: {
        type: 'web',
        source: 'manual',
      },
    });
    if(entry){
      if(scope === 'page') {
        const pageEntries = currentPageBib();
        pageEntries.push(entry);
        saveProject();
        queueCompile();
      } else {
        bibData.push(entry);
        saveGlobalBib();
      }
    }
    renderBibList();
    clearBibForm();
  };

  // Resource upload & listing
  function getCurrentPageIndex() {
    return currentPageIdx; // zero-based
  }

  async function parseJsonSafe(input) {
    if (input instanceof Response) {
      try {
        const json = await input.clone().json();
        return { json };
      } catch (e) {
        try {
          const text = await input.clone().text();
          return { text };
        } catch (_) {
          return { text: '' };
        }
      }
    }
    if (typeof input === 'string') {
      try {
        return { json: JSON.parse(input) };
      } catch (e) {
        return { text: input };
      }
    }
    return { text: String(input || '') };
  }

  function urlToLatexPath(url){
    if(!url) return '';
    const withoutQuery = url.split('?')[0];
    const normalized = withoutQuery.replace(/\\/g, '/');
    const parts = normalized.split('/').filter(Boolean);
    return parts.length ? parts[parts.length - 1] : normalized;
  }

  async function refreshResourceLists() {
    // If resources modal is open, refresh its content. Otherwise no-op.
    const modalEl = document.getElementById('resourcesModal');
    if(modalEl && bootstrap.Modal.getInstance(modalEl)){
      await loadResourcesModal();
    }
  }

  // Manage Resources Modal handlers
  document.getElementById('manage-resources').addEventListener('click', async function(){
    await loadResourcesModal();
    var modal = new bootstrap.Modal(document.getElementById('resourcesModal'));
    modal.show();
  });

  function createResourceListItem(file, options){
    const f = file || {};
    const opts = options || {};
    const scope = typeof opts.scope === 'string' ? opts.scope : '';
    const pageIndex = typeof opts.pageIndex === 'number' ? opts.pageIndex : null;
    const item = document.createElement('div');
    item.className = 'list-group-item resource-item';
    const wrapper = document.createElement('div');
    wrapper.className = 'd-flex flex-column flex-md-row justify-content-between align-items-start gap-2';
    const left = document.createElement('div');
    left.className = 'resource-name me-md-3 flex-grow-1';
    const resourcePath = (f.path || '').toString();
    const displayName = (f.name || '').toString().trim() || (resourcePath.includes('/') ? resourcePath.slice(resourcePath.lastIndexOf('/') + 1) : resourcePath);
    const localUrl = f.localUrl || '';
    const ossUrl = f.ossUrl || '';
    const preferredUrl = f.url || f.preferredUrl || localUrl || ossUrl || '';
    const hasLocal = !!localUrl && f.exists !== false ? true : !!localUrl;
    const hasRemote = !!ossUrl;
    const name = document.createElement('a');
    name.href = preferredUrl || '#';
    name.textContent = displayName || resourcePath || '未命名资源';
    if(resourcePath){
      name.title = resourcePath;
    } else if(displayName){
      name.title = displayName;
    }
    if(preferredUrl){
      name.target = '_blank';
      name.rel = 'noopener';
      name.dataset.actionBubbleAllowNav = 'true';
    } else {
      name.classList.add('disabled');
    }
    if(!hasLocal){
      name.classList.add('text-muted');
      name.title = hasRemote ? '本地缺失，仅 OSS 可用' : '文件缺失';
    }
    left.appendChild(name);

    const badge = document.createElement('span');
    badge.className = 'tag-chip ms-2';
    if(workspaceIsCloud()){
      badge.classList.add('tag-chip--info');
      badge.textContent = '云端';
    } else if(hasLocal){
      badge.classList.add('tag-chip--muted');
      badge.textContent = '本地';
    } else {
      badge.classList.add('tag-chip--warning');
      badge.textContent = '缺失';
    }
    left.appendChild(badge);

    if(resourcePath){
      const pathInfo = document.createElement('div');
      pathInfo.className = 'small text-muted text-break mt-1';
      pathInfo.textContent = resourcePath;
      left.appendChild(pathInfo);
    }

    if(workspaceIsCloud() && ossUrl){
      const remoteLink = document.createElement('div');
      remoteLink.className = 'small text-muted';
      const label = hasLocal ? '远程：' : 'OSS：';
      remoteLink.innerHTML = `${label}<a href="${ossUrl}" target="_blank" rel="noopener">${ossUrl}</a>`;
      left.appendChild(remoteLink);
    }

    if(typeof f.refCount === 'number'){
      const usageBadge = document.createElement('span');
      usageBadge.className = 'tag-chip ms-2 ' + (f.refCount > 0 ? 'tag-chip--info' : 'tag-chip--muted');
      usageBadge.textContent = f.refCount > 0 ? `引用 ${f.refCount}` : '未引用';
      const usagePieces = [];
      if(Array.isArray(f.usedOnPages) && f.usedOnPages.length){
        usagePieces.push(`页面：${f.usedOnPages.join('、')}`);
      }
      if(f.usedGlobally){
        usagePieces.push('全局资源列表');
      }
      if(usagePieces.length){
        usageBadge.title = usagePieces.join('；');
      }
      left.appendChild(usageBadge);
    }

    if(scope === 'page' && Array.isArray(f.otherPages) && f.otherPages.length){
      const info = document.createElement('div');
      info.className = 'small text-muted';
      info.textContent = `同时用于页面：${f.otherPages.join('、')}`;
      left.appendChild(info);
    } else if(scope !== 'page' && Array.isArray(f.usedOnPages) && f.usedOnPages.length){
      const info = document.createElement('div');
      info.className = 'small text-muted';
      info.textContent = `引用页面：${f.usedOnPages.join('、')}`;
      left.appendChild(info);
    } else if(scope === 'page' && f.usedGlobally){
      const info = document.createElement('div');
      info.className = 'small text-muted';
      info.textContent = '同时存在于全局资源';
      left.appendChild(info);
    }

    wrapper.appendChild(left);
    item.appendChild(wrapper);

    bindActionBubbleTrigger(item, () => {
      const actions = [];
      const targetUrl = f.localUrl || preferredUrl;
      const nameLabel = displayName || resourcePath || f.name || '';
      actions.push({
        label: '预览',
        icon: '👁️',
        variant: 'outline-secondary',
        disabled: !targetUrl,
        onClick: () => {
          if(!targetUrl){
            alert('当前资源没有可用的链接');
            return;
          }
          const isImage = /\.(png|jpe?g|gif|svg|webp|bmp|heic|heif)$/i.test(nameLabel);
          if(isImage && resourcePreviewModalEl && resourcePreviewImage){
            resourcePreviewImage.src = targetUrl;
            if(resourcePreviewMeta){
              const parts = [];
              if(f.exists){
                parts.push(workspaceIsCloud() ? '来源：云端' : '来源：本地');
              } else {
                parts.push('来源：未知');
              }
              resourcePreviewMeta.textContent = nameLabel ? `${nameLabel}${parts.length ? '（' + parts.join('，') + '）' : ''}` : parts.join('，');
            }
            if(resourcePreviewOpen){
              resourcePreviewOpen.href = targetUrl;
              resourcePreviewOpen.classList.toggle('disabled', !targetUrl);
            }
            const modal = bootstrap.Modal.getOrCreateInstance(resourcePreviewModalEl);
            modal.show();
          } else {
            window.open(targetUrl, '_blank');
          }
        },
      });
      actions.push({
        label: '重命名',
        icon: '✏️',
        variant: 'outline-secondary',
        onClick: () => {
          if(!resourceRenameModalEl || !resourceRenameInput){
            alert('当前界面不支持重命名');
            return;
          }
          const fullPath = resourcePath || displayName || '';
          resourceRenameTarget = fullPath;
          resourceRenameBasePath = fullPath && fullPath.includes('/') ? fullPath.slice(0, fullPath.lastIndexOf('/')) : '';
          const initialName = f.name || (fullPath.includes('/') ? fullPath.slice(fullPath.lastIndexOf('/') + 1) : fullPath);
          resourceRenameInput.value = initialName || '';
          if(fullPath){
            resourceRenameInput.title = fullPath;
          } else if(initialName){
            resourceRenameInput.title = initialName;
          } else {
            resourceRenameInput.removeAttribute('title');
          }
          updateResourceRenamePreviewText(initialName);
          const modal = bootstrap.Modal.getOrCreateInstance(resourceRenameModalEl);
          modal.show();
        },
      });
      actions.push({
        label: scope === 'page' ? '移除关联' : (scope === 'global' ? '移除全局' : '删除'),
        icon: '🗑️',
        variant: 'outline-danger',
        onClick: async () => {
          const confirmText = scope === 'page'
            ? '确认移除当前页对该资源的关联吗？'
            : (scope === 'global' ? '确认从全局资源中移除此文件吗？' : '确认删除此资源及其文件吗？');
          if(!confirm(confirmText)) return;
          const identifier = resourcePath || displayName;
          if(!identifier){
            alert('无法确定资源标识');
            return;
          }
          const baseName = identifier.includes('/') ? identifier.slice(identifier.lastIndexOf('/') + 1) : identifier;
          const matchesEntry = value => {
            if(typeof value !== 'string') return false;
            const normalized = value.trim();
            return normalized === identifier || normalized === resourcePath || normalized === baseName;
          };
          try{
            const payload = {path: identifier, name: identifier};
            if(scope === 'page' && pageIndex !== null){
              payload.scope = 'page';
              payload.page = pageIndex;
            } else if(scope === 'global'){
              payload.scope = 'global';
            }
            const res = await fetch(buildApiUrl('/resources/delete'), {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(withWorkspacePayload(payload))});
            const parsed = await parseJsonSafe(res);
            if(res.ok){
              if(parsed.json && parsed.json.success === false){
                alert('删除失败：' + (parsed.json.error || (parsed.text ? parsed.text : '未知错误')));
              } else {
                const body = parsed.json || {};
                if(body.globalRemoved){
                  globalResources = globalResources.filter(name => !matchesEntry(name));
                }
                if(Array.isArray(body.pagesRemoved)){
                  body.pagesRemoved.forEach(num => {
                    const idx = Number(num) - 1;
                    if(idx >= 0 && pagesData[idx] && Array.isArray(pagesData[idx].resources)){
                      pagesData[idx].resources = pagesData[idx].resources.filter(name => !matchesEntry(name));
                    }
                  });
                }
                if(body.fileRemoved){
                  globalResources = globalResources.filter(name => !matchesEntry(name));
                  pagesData.forEach(p => {
                    if(Array.isArray(p.resources)){
                      p.resources = p.resources.filter(name => !matchesEntry(name));
                    }
                  });
                }
                if(body.stillReferenced && body.stillReferenced.refCount){
                  const refs = [];
                  if(Array.isArray(body.stillReferenced.pages) && body.stillReferenced.pages.length){
                    refs.push(`页面：${body.stillReferenced.pages.join('、')}`);
                  }
                  if(body.stillReferenced.global){
                    refs.push('全局资源列表');
                  }
                  if(refs.length){
                    alert(`资源仍被引用（${refs.join('，')}），文件未删除。`);
                  }
                }
                await loadResourcesModal();
                await refreshResourceLists();
                queueCompile();
              }
            } else {
              const message = parsed.json && parsed.json.error ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
              alert('删除失败：' + message);
            }
          }catch(e){
            console.error(e);
            alert('删除失败：' + e.message);
          }
        },
      });
      return actions;
    });

    return item;
  }

  function renderResourceList(container, files, options){
    if(!container) return;
    closeActionBubble('resources-refresh');
    container.innerHTML = '';
    const list = Array.isArray(files) ? files : [];
    if(list.length === 0){
      container.innerHTML = '<div class="text-muted p-2">没有资源</div>';
      return;
    }
    list.forEach(f => {
      container.appendChild(createResourceListItem(f, options));
    });
  }

  async function loadResourcesModal(){
    const pageListEl = document.getElementById('resources-page-list');
    const globalListEl = document.getElementById('resources-global-list');
    const pageCountEl = document.getElementById('resources-page-count');
    const globalCountEl = document.getElementById('resources-global-count');
    if(!ensureWorkspaceReady({silent: true})){
      if(pageListEl) pageListEl.innerHTML = '<div class="text-warning p-2">请先选择工作区</div>';
      if(globalListEl) globalListEl.innerHTML = '<div class="text-warning p-2">请先选择工作区</div>';
      return;
    }
    if(pageListEl) pageListEl.innerHTML = '<div class="text-muted p-2">加载中...</div>';
    if(globalListEl) globalListEl.innerHTML = '<div class="text-muted p-2">加载中...</div>';
    const pageIdx = getCurrentPageIndex();
    const cpEl = document.getElementById('resources-current-page');
    if(cpEl) cpEl.textContent = pageIdx + 1;
    try{
      const pageUrl = appendWorkspaceQuery(buildApiUrl(`/resources/list?page=${pageIdx}`));
      const globalUrl = appendWorkspaceQuery(buildApiUrl('/resources/list'));
      const [pageRes, globalRes] = await Promise.all([
        fetch(pageUrl),
        fetch(globalUrl)
      ]);
      const pageData = pageRes.ok ? await pageRes.json() : {files: []};
      const globalData = globalRes.ok ? await globalRes.json() : {files: []};
      if(pageData.ossError || globalData.ossError){
        console.warn('资源 OSS 状态:', pageData.ossError || globalData.ossError);
      }
      const pageFiles = Array.isArray(pageData.files) ? pageData.files : [];
      const globalFiles = Array.isArray(globalData.files) ? globalData.files : [];
      const pageNames = pageFiles.map(f => {
        if(f && (f.path || f.name)) return String(f.path || f.name);
        return '';
      }).filter(Boolean);
      const globalNames = globalFiles.map(f => {
        if(f && (f.path || f.name)) return String(f.path || f.name);
        return '';
      }).filter(Boolean);
      const serverPageId = pageData && typeof pageData.pageId === 'string' ? pageData.pageId : null;
      const currentPage = pagesData[pageIdx];
      if(currentPage && typeof currentPage === 'object' && typeof currentPage.pageId === 'string' && serverPageId && currentPage.pageId === serverPageId) {
        currentPage.resources = pageNames.slice();
      }
      globalResources = globalNames.slice();
      renderResourceList(pageListEl, pageFiles, {scope: 'page', pageIndex: pageIdx});
      renderResourceList(globalListEl, globalFiles, {scope: 'global'});
      if(pageCountEl) pageCountEl.textContent = pageFiles.length ? `${pageFiles.length} 个` : '暂无';
      if(globalCountEl) globalCountEl.textContent = globalFiles.length ? `${globalFiles.length} 个` : '暂无';
    } catch (e){
      console.error(e);
      if(pageListEl) pageListEl.innerHTML = '<div class="text-danger p-2">加载失败</div>';
      if(globalListEl) globalListEl.innerHTML = '<div class="text-danger p-2">加载失败</div>';
      if(pageCountEl) pageCountEl.textContent = '--';
      if(globalCountEl) globalCountEl.textContent = '--';
    }
  }

  function getSelectedResourceFiles(){
    const files = [];
    if(resourceUploadInput && resourceUploadInput.files){
      files.push(...resourceUploadInput.files);
    }
    if(resourceUploadDirInput && resourceUploadDirInput.files){
      files.push(...resourceUploadDirInput.files);
    }
    return files;
  }

  function updateResourceUploadHint(){
    if(!resourceUploadHint) return;
    const files = getSelectedResourceFiles();
    if(!files.length){
      resourceUploadHint.textContent = '可一次选择多个文件，或使用“选择文件夹”上传整个目录结构。';
      return;
    }
    const count = files.length;
    const hasNested = files.some(file => {
      const rel = file.webkitRelativePath || file.relativePath || '';
      return rel && rel.includes('/');
    });
    if(hasNested){
      const roots = new Set();
      files.forEach(file => {
        const rel = file.webkitRelativePath || file.relativePath || '';
        if(rel && rel.includes('/')){
          roots.add(rel.split('/')[0]);
        }
      });
      const folderCount = roots.size || 1;
      resourceUploadHint.textContent = `已选择 ${count} 个文件，覆盖 ${folderCount} 个目录。`;
    } else {
      resourceUploadHint.textContent = `已选择 ${count} 个文件。`;
    }
  }

  function resetResourceUploadInputs(){
    if(resourceUploadInput){
      resourceUploadInput.value = '';
    }
    if(resourceUploadDirInput){
      resourceUploadDirInput.value = '';
    }
    updateResourceUploadHint();
  }

  async function performResourceUpload(triggerBtn, options){
    const files = getSelectedResourceFiles();
    if(!files.length){
      alert('请选择文件或文件夹');
      return;
    }
    const scope = options && options.scope === 'page' ? 'page' : 'global';
    const pageIndex = scope === 'page' ? (typeof options.pageIndex === 'number' ? options.pageIndex : getCurrentPageIndex()) : null;
    const formData = new FormData();
    files.forEach((file, idx) => {
      formData.append('files[]', file);
      const rel = file.webkitRelativePath || file.relativePath || file.name || `file_${idx}`;
      formData.append('paths[]', rel);
    });
    formData.append('scope', scope);
    if(scope === 'page' && pageIndex !== null){
      formData.append('page', String(pageIndex));
    }

    const otherBtn = triggerBtn === modalUploadBtn ? modalUploadGlobalBtn : modalUploadBtn;
    const originalText = triggerBtn.textContent;
    triggerBtn.disabled = true;
    triggerBtn.textContent = '上传中...';
    if(otherBtn){
      otherBtn.disabled = true;
    }

    try{
      if(!ensureWorkspaceReady({silent: true})){
        alert('请先选择工作区');
        return;
      }
      withWorkspacePayload(formData);
      const res = await fetch(buildApiUrl('/upload_resource'), {method: 'POST', body: formData});
      const parsed = await parseJsonSafe(res);
      if(res.ok && (!parsed.json || parsed.json.success !== false)){
        const payload = parsed.json || {};
        const uploaded = Array.isArray(payload.files) ? payload.files : [];
        uploaded.forEach(entry => {
          if(!entry) return;
          const rawPath = entry.path || entry.name;
          if(!rawPath) return;
          const relPath = String(rawPath);
          const entryScope = entry.scope || payload.scope || scope;
          const entryPage = typeof entry.page === 'number' ? entry.page : (typeof payload.page === 'number' ? payload.page : null);
          if(entryScope === 'page' && typeof entryPage === 'number'){
            const idx = entryPage;
            if(pagesData[idx]){
              const list = Array.isArray(pagesData[idx].resources) ? pagesData[idx].resources : (pagesData[idx].resources = []);
              if(!list.includes(relPath)) list.push(relPath);
            }
          } else if(!globalResources.includes(relPath)){
            globalResources.push(relPath);
          }
        });
        resetResourceUploadInputs();
        await loadResourcesModal();
        await refreshResourceLists();
        queueCompile();
      } else {
        const message = parsed.json && parsed.json.error ? parsed.json.error : (parsed.text || (`HTTP ${res.status}`));
        alert('上传失败：' + message);
      }
    } catch (e){
      console.error(e);
      alert('上传失败：' + (e && e.message ? e.message : String(e || '未知错误')));
    } finally {
      triggerBtn.textContent = originalText || '上传';
      triggerBtn.disabled = false;
      if(otherBtn){
        otherBtn.disabled = false;
      }
    }
  }

  // modal upload handlers
  const modalUploadBtn = document.getElementById('modal-resource-upload-btn');
  if(modalUploadBtn) modalUploadBtn.addEventListener('click', async () => {
    await performResourceUpload(modalUploadBtn, {scope: 'page', pageIndex: getCurrentPageIndex()});
  });

  const modalUploadGlobalBtn = document.getElementById('modal-resource-upload-global-btn');
  if(modalUploadGlobalBtn) modalUploadGlobalBtn.addEventListener('click', async () => {
    await performResourceUpload(modalUploadGlobalBtn, {scope: 'global'});
  });

  function updateAttachmentsUsageHint(data) {
    const hintEl = document.getElementById('attachments-usage-hint');
    if(!hintEl) return;
    const unused = data && Array.isArray(data.unused) ? data.unused : [];
    unusedAttachmentsCache = unused.slice();
    if(unusedAttachmentsCache.length){
      hintEl.classList.remove('d-none');
      hintEl.innerHTML = '';
      const preview = unusedAttachmentsCache.slice(0, 5).join('、');
      const message = unusedAttachmentsCache.length > 5 ? `有 ${unusedAttachmentsCache.length} 个附件未被引用，例如：${preview}` : `有 ${unusedAttachmentsCache.length} 个附件未被引用：${preview}`;
      const textSpan = document.createElement('span');
      textSpan.textContent = message;
      hintEl.appendChild(textSpan);
      const clearBtn = document.createElement('button');
      clearBtn.type = 'button';
      clearBtn.id = 'clear-unused-attachments-button';
      clearBtn.className = 'btn btn-sm btn-outline-danger ms-3';
      clearBtn.textContent = clearingUnusedAttachments ? '清除中...' : '一键清除';
      clearBtn.disabled = clearingUnusedAttachments;
      clearBtn.addEventListener('click', clearUnusedAttachments);
      hintEl.appendChild(clearBtn);
    } else {
      hintEl.classList.add('d-none');
      hintEl.innerHTML = '';
      hintEl.textContent = '';
    }
  }

  async function clearUnusedAttachments(){
    if(clearingUnusedAttachments || !unusedAttachmentsCache.length) return;
    const pendingNames = unusedAttachmentsCache.slice();
    const hintEl = document.getElementById('attachments-usage-hint');
    const clearBtn = hintEl ? hintEl.querySelector('#clear-unused-attachments-button') : null;
    clearingUnusedAttachments = true;
    if(clearBtn){
      clearBtn.disabled = true;
      clearBtn.textContent = '清除中...';
    }
    const failures = [];
    for(const name of pendingNames){
      const attachment = Array.isArray(attachmentsCache) ? attachmentsCache.find(item => item && item.name === name) : null;
      const path = attachment && attachment.path ? attachment.path : name;
      try{
        const payload = withWorkspacePayload({path});
        const res = await fetch(buildApiUrl('/attachments/delete'), {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        const parsed = await parseJsonSafe(res);
        if(!(res.ok && (!parsed.json || parsed.json.success !== false))){
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
          failures.push({name, message});
        }
      }catch(err){
        failures.push({name, message: err && err.message ? err.message : String(err)});
      }
    }
    if(failures.length){
      const lines = failures.map(item => `${item.name}：${item.message}`);
      alert(`以下附件删除失败：\n${lines.join('\n')}`);
    }
    clearingUnusedAttachments = false;
    unusedAttachmentsCache = failures.map(item => item.name);
    if(clearBtn){
      clearBtn.disabled = false;
      clearBtn.textContent = '一键清除';
    }
    await loadAttachmentsModal();
  }

  function computeResourceRenameDestination(inputValue) {
    const raw = (inputValue || '').toString().trim().replace(/\\/g, '/');
    if(!raw) return '';
    if(raw.startsWith('/')){
      return raw.replace(/^\/+/, '');
    }
    if(raw.includes('/')){
      return raw;
    }
    if(resourceRenameBasePath){
      return `${resourceRenameBasePath}/${raw}`.replace(/\/+/g, '/');
    }
    if(resourceRenameTarget && resourceRenameTarget.includes('/')){
      const dir = resourceRenameTarget.slice(0, resourceRenameTarget.lastIndexOf('/'));
      if(dir){
        return `${dir}/${raw}`.replace(/\/+/g, '/');
      }
    }
    return raw;
  }

  function updateResourceRenamePreviewText(value) {
    if(!resourceRenamePreview) return;
    const proposal = computeResourceRenameDestination(value);
    if(proposal){
      resourceRenamePreview.textContent = `新路径：${proposal}`;
    } else if(resourceRenameTarget){
      resourceRenamePreview.textContent = `当前路径：${resourceRenameTarget}`;
    } else {
      resourceRenamePreview.textContent = '';
    }
  }

  function setAttachmentsFilter(term) {
    attachmentsFilterTerm = (term || '').trim().toLowerCase();
    renderAttachmentsList();
  }

  function getFilteredAttachments() {
    if (!Array.isArray(attachmentsCache)) return [];
    const tokens = attachmentsFilterTerm.split(/\s+/).filter(Boolean);
    if (!tokens.length) return attachmentsCache.slice();
    return attachmentsCache.filter(f => {
      if (!f) return false;
      const preferredUrl = (f.preferredUrl || f.localUrl || f.ossUrl || '').toString();
      const haystack = [
        f.name || '',
        preferredUrl,
        f.localUrl || '',
        f.ossUrl || '',
        f.path || '',
      ]
        .join(' ')
        .toLowerCase();
      return tokens.every(token => haystack.includes(token));
    });
  }

  function renderAttachmentsList(){
    const listEl = document.getElementById('attachments-list-modal');
    if(!listEl) return;
    closeActionBubble('attachments-refresh');
    listEl.innerHTML = '';
    const files = getFilteredAttachments();

    if((attachmentsCache || []).length === 0){
      listEl.innerHTML = '<div class="text-muted p-2">没有附件</div>';
      return;
    }

    if(files.length === 0){
      listEl.innerHTML = '<div class="text-muted p-2">未找到匹配的附件</div>';
      return;
    }

    files.forEach(f => {
      const preferredUrl = f.preferredUrl || f.localUrl || f.ossUrl || '';
      const item = document.createElement('div');
      item.className = 'list-group-item';
      const wrapper = document.createElement('div');
      wrapper.className = 'd-flex flex-column flex-md-row justify-content-between align-items-start gap-2';
      const left = document.createElement('div');
      left.className = 'me-md-3 flex-grow-1';
      const name = document.createElement('a');
      name.textContent = f.name;
      if(preferredUrl){
        name.href = preferredUrl;
        name.target = '_blank';
        name.rel = 'noopener';
        name.dataset.actionBubbleAllowNav = 'true';
      } else {
        name.href = '#';
        name.classList.add('disabled');
      }
      left.appendChild(name);

      const locationBadge = document.createElement('span');
      locationBadge.className = 'tag-chip ms-2';
      if(workspaceIsCloud()){
        locationBadge.classList.add('tag-chip--info');
        locationBadge.textContent = '云端';
      } else {
        locationBadge.classList.add('tag-chip--muted');
        locationBadge.textContent = '本地';
      }
      left.appendChild(locationBadge);

      if(typeof f.refCount === 'number'){
        const usageBadge = document.createElement('span');
        usageBadge.className = 'tag-chip ms-2 ' + (f.refCount > 0 ? 'tag-chip--info' : 'tag-chip--muted');
        usageBadge.textContent = f.refCount > 0 ? `引用 ${f.refCount}` : '未引用';
        if(Array.isArray(f.references) && f.references.length){
          usageBadge.title = f.references.join('；');
        }
        left.appendChild(usageBadge);
        if(Array.isArray(f.references) && f.references.length){
          const info = document.createElement('div');
          info.className = 'small text-muted';
          const preview = f.references.slice(0, 3).join('、');
          info.textContent = f.references.length > 3 ? `引用位置：${preview} 等` : `引用位置：${preview}`;
          left.appendChild(info);
        }
      }

      if(workspaceIsCloud() && f.ossUrl && f.localUrl && f.ossUrl !== f.localUrl){
        const remoteLink = document.createElement('div');
        remoteLink.className = 'small text-muted';
        remoteLink.innerHTML = `远程：<a href="${f.ossUrl}" target="_blank" rel="noopener">${f.ossUrl}</a>`;
        left.appendChild(remoteLink);
      }

      wrapper.appendChild(left);
      item.appendChild(wrapper);
      listEl.appendChild(item);

      bindActionBubbleTrigger(item, () => {
        const actions = [];
        const isImage = /\.(png|jpe?g|gif|svg|webp|bmp|heic|heif)$/i.test(f.name || '');
        const targetUrl = f.localUrl || preferredUrl;
        const displayName = f.name || '附件';
        rememberAttachmentUrl(f);
        const relativeAttachmentPath = f.name || '';
        actions.push({
          label: isImage ? '插入图片' : '插入引用',
          icon: '➕',
          variant: 'primary',
          onClick: () => {
            if(!singleEditor) return;
            const mode = typeof currentEditMode === 'string' && currentEditMode === 'markdown' ? 'markdown' : 'latex';
            const doc = singleEditor.getDoc();
            const cursor = doc.getCursor();
            let snippet = '';
            if(mode === 'latex'){
              if(isImage){
                if(!f.localUrl){
                  alert('该图片本地链接暂不可用，请稍后重试。');
                  return;
                }
                const path = urlToLatexPath(f.localUrl);
                snippet = `\\begin{center}\n  \\includegraphics[width=0.7\\textwidth]{${path}}\n\\end{center}\n`;
              } else {
                snippet = `\\textbf{附件：}${displayName}\\par\n`;
              }
            } else {
              if(isImage){
                const logicalPath = relativeAttachmentPath || preferredUrl;
                if(!logicalPath){
                  alert('当前附件没有可用的访问链接');
                  return;
                }
                snippet = `![${displayName}](${logicalPath})\n`;
              } else {
                snippet = `**附件：**${displayName}\n`;
              }
            }
            doc.replaceRange(snippet, cursor);
          },
        });
        actions.push({
          label: '预览',
          icon: '👁️',
          variant: 'outline-secondary',
          disabled: !targetUrl,
          onClick: () => {
            const finalUrl = targetUrl;
            if(!finalUrl){
              alert('当前附件没有可用的访问链接');
              return;
            }
            if(isImage && attachmentPreviewModalEl && attachmentPreviewImage){
              attachmentPreviewImage.src = finalUrl;
              if(attachmentPreviewMeta){
                const parts = [];
        parts.push(workspaceIsCloud() ? '来源：云端' : '来源：本地');
                attachmentPreviewMeta.textContent = `${f.name}${parts.length ? '（' + parts.join('，') + '）' : ''}`;
              }
              if(attachmentPreviewOpen){
                attachmentPreviewOpen.href = finalUrl;
                attachmentPreviewOpen.classList.toggle('disabled', !finalUrl);
              }
              const modal = bootstrap.Modal.getOrCreateInstance(attachmentPreviewModalEl);
              modal.show();
            } else {
              window.open(finalUrl, '_blank');
            }
          },
        });
        actions.push({
          label: '复制名称',
          icon: '📋',
          variant: 'outline-secondary',
          onClick: () => {
            navigator.clipboard.writeText(f.name || '').then(()=>{
              showStatus('附件名称已复制', 'success', 2000);
            }).catch(()=>alert('复制失败，请手动复制'));
          },
        });
        actions.push({
          label: '重命名',
          icon: '✏️',
          variant: 'outline-secondary',
          onClick: () => {
            if(!attachmentRenameModalEl || !attachmentRenameInput){
              alert('当前界面不支持重命名');
              return;
            }
            attachmentRenameTarget = f.name;
            attachmentRenameInput.value = f.name;
            const modal = bootstrap.Modal.getOrCreateInstance(attachmentRenameModalEl);
            modal.show();
          },
        });
        actions.push({
          label: '删除',
          icon: '🗑️',
          variant: 'outline-danger',
          onClick: async () => {
            if(typeof f.refCount === 'number' && f.refCount > 0){
              const refs = Array.isArray(f.references) && f.references.length ? f.references.join('、') : '';
              alert(refs ? `该附件仍被引用：${refs}` : '该附件仍被引用，无法删除。');
              return;
            }
            if(!confirm('确认删除此附件吗？')) return;
            try{
              const res = await fetch(buildApiUrl('/attachments/delete'), {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(withWorkspacePayload({path: f.path}))});
              const parsed = await parseJsonSafe(res);
              if(res.ok && (!parsed.json || parsed.json.success !== false)){
                await loadAttachmentsModal();
              } else {
                const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
                alert('删除失败：' + message);
              }
            }catch(e){ console.error(e); alert('删除失败：' + e.message); }
          },
        });
        return actions;
      });
    });
  }

  const attachmentFilterInput = document.getElementById('attachment-filter-input');
  const attachmentFilterClear = document.getElementById('attachment-filter-clear');

  if(attachmentFilterInput && !attachmentFilterInput.dataset.bound){
    attachmentFilterInput.dataset.bound = 'true';
    attachmentFilterInput.addEventListener('input', () => {
      setAttachmentsFilter(attachmentFilterInput.value);
    });
    attachmentFilterInput.addEventListener('keydown', (event) => {
      if(event.key === 'Escape'){
        attachmentFilterInput.value = '';
        setAttachmentsFilter('');
        event.preventDefault();
      }
    });
  }

  if(attachmentFilterClear && !attachmentFilterClear.dataset.bound){
    attachmentFilterClear.dataset.bound = 'true';
    attachmentFilterClear.addEventListener('click', () => {
      if(attachmentFilterInput){
        attachmentFilterInput.value = '';
        attachmentFilterInput.focus();
      }
      setAttachmentsFilter('');
    });
  }

  async function loadAttachmentsModal(){
    const listEl = document.getElementById('attachments-list-modal');
    if(!listEl) return;
    if(!ensureWorkspaceReady({silent: true})){
      listEl.innerHTML = '<div class="text-warning p-2">请先选择工作区</div>';
      return;
    }
    listEl.innerHTML = '<div class="text-muted p-2">加载中...</div>';
    try{
      const res = await fetch(appendWorkspaceQuery(buildApiUrl('/attachments/list')));
      const data = res.ok ? await res.json() : {files: []};
      attachmentsCache = Array.isArray(data.files) ? data.files : [];
      bulkSetAttachmentUrls(attachmentsCache);
      if(currentEditMode === 'markdown'){
        renderMarkdownPreview();
      }
      updateAttachmentsUsageHint(data);
      if(attachmentFilterInput && typeof attachmentFilterInput.value === 'string'){
        setAttachmentsFilter(attachmentFilterInput.value);
      } else {
        renderAttachmentsList();
      }
    }catch(e){
      console.warn('加载附件失败', e);
      listEl.innerHTML = '<div class="text-danger p-2">加载失败</div>';
      updateAttachmentsUsageHint({unused: []});
    }
  }

  const manageAttachmentsBtn = document.getElementById('manage-attachments');
  if(manageAttachmentsBtn) manageAttachmentsBtn.addEventListener('click', async function(){
    await loadAttachmentsModal();
    var modal = new bootstrap.Modal(document.getElementById('attachmentsModal'));
    modal.show();
  });

  const attachmentUploadBtn = document.getElementById('modal-attachment-upload-btn');
  if(attachmentUploadBtn) attachmentUploadBtn.addEventListener('click', async function(){
    const input = document.getElementById('modal-attachment-upload-input');
    if(!input.files || input.files.length === 0) return alert('请选择文件');
    const file = input.files[0];
    const fd = new FormData();
    fd.append('file', file);
    this.disabled = true;
    this.textContent = '上传中...';
    if(!ensureWorkspaceReady({silent: true})){
      this.disabled = false;
      this.textContent = '上传附件';
      return;
    }
    withWorkspacePayload(fd);
    try{
      const res = await fetch(buildApiUrl('/attachments/upload'), {method: 'POST', body: fd});
      const text = await res.text();
      const parsed = await parseJsonSafe(text);
      if(res.ok){
        const payload = parsed.json || {};
        if(payload.success === false){
          alert('上传失败：' + (payload.error || parsed.text || '未知错误'));
        } else {
          input.value = '';
          await loadAttachmentsModal();
        }
      } else {
        const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
        alert('上传失败：' + message);
      }
    }catch(e){ console.error(e); alert('上传失败：' + e.message); }
    this.disabled = false;
    this.textContent = '上传附件';
  });

  if(resourceRenameConfirm && !resourceRenameConfirm.dataset.bound){
    resourceRenameConfirm.dataset.bound = 'true';
    resourceRenameConfirm.addEventListener('click', async function(){
      if(!resourceRenameTarget){
        alert('请先选择要重命名的资源');
        return;
      }
      if(!resourceRenameInput){
        alert('无法读取新文件名');
        return;
      }
      const trimmedInput = resourceRenameInput.value.trim();
      if(!trimmedInput){
        alert('文件名不能为空');
        return;
      }
      const proposedPath = computeResourceRenameDestination(trimmedInput);
      if(!proposedPath){
        alert('文件名或路径无效');
        return;
      }
      const originalText = this.textContent;
      this.disabled = true;
      this.textContent = '保存中...';
      const requestBody = {
        oldPath: resourceRenameTarget,
        newPath: proposedPath,
        oldName: resourceRenameTarget,
        newName: trimmedInput,
      };
      try{
        const res = await fetch(buildApiUrl('/resources/rename'), {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(withWorkspacePayload(requestBody))});
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          if(parsed.json && parsed.json.name && parsed.json.name !== trimmedInput){
            alert(`文件名已更新为：${parsed.json.name}`);
          }
          const modal = resourceRenameModalEl ? bootstrap.Modal.getInstance(resourceRenameModalEl) : null;
          if(modal) modal.hide();
          resourceRenameTarget = null;
          resourceRenameBasePath = '';
          await loadResourcesModal();
          await refreshResourceLists();
          queueCompile();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
          alert('重命名失败：' + message);
        }
      }catch(e){
        alert('重命名失败：' + e.message);
      }
      this.disabled = false;
      this.textContent = originalText || '保存';
    });
  }

  if(attachmentRenameConfirm && !attachmentRenameConfirm.dataset.bound){
    attachmentRenameConfirm.dataset.bound = 'true';
    attachmentRenameConfirm.addEventListener('click', async function(){
      if(!attachmentRenameTarget){
        alert('请先选择要重命名的附件');
        return;
      }
      if(!attachmentRenameInput){
        alert('无法读取新文件名');
        return;
      }
      const newName = attachmentRenameInput.value.trim();
      if(!newName){
        alert('文件名不能为空');
        return;
      }
      const originalText = this.textContent;
      this.disabled = true;
      this.textContent = '保存中...';
      try{
        const res = await fetch(buildApiUrl('/attachments/rename'), {method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(withWorkspacePayload({oldName: attachmentRenameTarget, newName}))});
        const parsed = await parseJsonSafe(res);
        if(res.ok && (!parsed.json || parsed.json.success !== false)){
          if(parsed.json){
            const payload = parsed.json;
            if(payload.name && payload.name !== newName){
              alert(`文件名已更新为：${payload.name}`);
            }
            const status = payload.ossStatus;
            if(status && (status.error || status.delete_error)){
              const msg = status.error || status.delete_error;
              alert('OSS 同步出现问题：' + msg);
            }
          }
          const modal = attachmentRenameModalEl ? bootstrap.Modal.getInstance(attachmentRenameModalEl) : null;
          if(modal) modal.hide();
          attachmentRenameTarget = null;
          await loadAttachmentsModal();
        } else {
          const message = (parsed.json && parsed.json.error) ? parsed.json.error : (parsed.text || ('HTTP ' + res.status));
          alert('重命名失败：' + message);
        }
      }catch(e){
        alert('重命名失败：' + e.message);
      }
      this.disabled = false;
      this.textContent = originalText || '保存';
    });
  }

  // Apply stored UI choices and bind the modal controls
  (function initUiSkinControls(){
    try{
      applyUiConfig(loadUiConfig(), {persist: false, silent: true});
    }catch(err){
      console.warn('初始化外观设置失败', err);
    }
    bindUiConfigModal();
  })();

  // Side-panel upload handlers removed — resource management is modal-only

  // ensure modal content refreshes when page changes
  const origRenderSingleEditor = renderSingleEditor;
  renderSingleEditor = function(){ origRenderSingleEditor(); if(document.getElementById('resourcesModal') && bootstrap.Modal.getInstance(document.getElementById('resourcesModal'))) loadResourcesModal(); };

</script>
</div> <!-- /app-shell -->
</body>
</html>
